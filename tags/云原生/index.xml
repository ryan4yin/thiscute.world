<rss xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0"><channel><title>äº‘åŸç”Ÿ - æ ‡ç­¾ - Ryan4Yin's Space</title><link>https://ryan4yin.space/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/</link><description>äº‘åŸç”Ÿ - æ ‡ç­¾ - Ryan4Yin's Space</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>xiaoyin_c@qq.com (ryan4yin)</managingEditor><webMaster>xiaoyin_c@qq.com (ryan4yin)</webMaster><lastBuildDate>Tue, 25 Jan 2022 01:37:00 +0800</lastBuildDate><atom:link href="https://ryan4yin.space/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" rel="self" type="application/rss+xml"/><item><title>éƒ¨ç½²ä¸€ä¸ª Kubernetes é›†ç¾¤</title><link>https://ryan4yin.space/posts/kubernetes-deployemnt-using-kubeadm/</link><pubDate>Tue, 25 Jan 2022 01:37:00 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/kubernetes-deployemnt-using-kubeadm/</guid><description><![CDATA[<blockquote>
<p>æœ¬æ–‡ç”±ä¸ªäººç¬”è®° <a href="https://github.com/ryan4yin/knowledge/tree/master/kubernetes" target="_blank" rel="noopener noreferrer">ryan4yin/knowledge</a> æ•´ç†è€Œæ¥ï¼Œä¸ä¿è¯æ­£ç¡®</p>
</blockquote>
<h2 id="æœ¬åœ°-kubernetes-é›†ç¾¤å®‰è£…å·¥å…·">æœ¬åœ° Kubernetes é›†ç¾¤å®‰è£…å·¥å…·</h2>
<blockquote>
<p>äº‘ä¸Šçš„ Kubernetes é›†ç¾¤ï¼ŒåŸºæœ¬ä¸Šå„äº‘å‚å•†éƒ½æ”¯æŒä¸€é”®éƒ¨ç½²ã€‚è¿™é‡Œä¸»è¦å…³æ³¨æœ¬åœ°éƒ¨ç½²ï¼Œæˆ–è€…å«åšè£¸æœº(baremetal)éƒ¨ç½²</p>
</blockquote>
<blockquote>
<p>æœ¬æ–‡ä»‹ç»çš„æ–¹æ³•é€‚åˆå¼€å‘æµ‹è¯•ä½¿ç”¨ï¼Œå®‰å…¨æ€§ã€ç¨³å®šæ€§ã€é•¿æœŸå¯ç”¨æ€§ç­‰æ–¹æ¡ˆéƒ½å¯èƒ½è¿˜æœ‰é—®é¢˜ã€‚</p>
</blockquote>
<blockquote>
<p>æœ¬æ–‡æœªè€ƒè™‘å›½å†…ç½‘ç»œç¯å¢ƒï¼Œå»ºè®®åœ¨è·¯ç”±å™¨ä¸Šæ•´ä¸ªç§‘å­¦ä»£ç†ï¼Œæˆ–è€…è‡ªè¡Œè°ƒæ•´æ–‡ä¸­çš„éƒ¨åˆ†å‘½ä»¤ã€‚</p>
</blockquote>
<p>kubernetes æ˜¯ä¸€ä¸ªç»„ä»¶åŒ–çš„ç³»ç»Ÿï¼Œå®‰è£…è¿‡ç¨‹æœ‰å¾ˆå¤§çš„çµæ´»æ€§ï¼Œå¾ˆå¤šç»„ä»¶éƒ½æœ‰å¤šç§å®ç°ï¼Œè¿™äº›å®ç°å„æœ‰ç‰¹ç‚¹ï¼Œè®©åˆå­¦è€…çœ¼èŠ±ç¼­ä¹±ã€‚</p>
<p>è€Œä¸”è¦æŠŠè¿™äº›ç»„ä»¶ä¸€ä¸ªä¸ªå®‰è£…é…ç½®å¥½å¹¶ä¸”èƒ½ååŒå·¥ä½œï¼Œä¹Ÿæ˜¯å¾ˆä¸å®¹æ˜“çš„ã€‚</p>
<p>å› æ­¤ç¤¾åŒºå‡ºç°äº†å„ç§å„æ ·çš„å®‰è£…æ–¹æ¡ˆï¼Œä¸‹é¢ä»‹ç»ä¸‹å‡ ç§æ”¯æŒè£¸æœºï¼ˆBaremetalï¼‰éƒ¨ç½²çš„å·¥å…·ï¼š</p>
<ol>
<li><a href="https://kuboard.cn/install/install-k8s.html" target="_blank" rel="noopener noreferrer">kubeadm</a>: ç¤¾åŒºçš„é›†ç¾¤å®‰è£…å·¥å…·ï¼Œç›®å‰å·²ç»å¾ˆæˆç†Ÿäº†ã€‚
<ol>
<li>ä½¿ç”¨éš¾åº¦ï¼šç®€å•</li>
</ol>
</li>
<li><a href="https://github.com/k3s-io/k3s" target="_blank" rel="noopener noreferrer">k3s</a>: è½»é‡çº§ kubernetesï¼Œèµ„æºéœ€æ±‚å°ï¼Œéƒ¨ç½²éå¸¸ç®€å•ï¼Œé€‚åˆå¼€å‘æµ‹è¯•ç”¨æˆ–è€…è¾¹ç¼˜ç¯å¢ƒ
<ol>
<li>æ”¯æŒ airgap ç¦»çº¿éƒ¨ç½²</li>
<li>ä½¿ç”¨éš¾åº¦ï¼šè¶…çº§ç®€å•</li>
</ol>
</li>
<li><a href="https://github.com/alibaba/sealer" target="_blank" rel="noopener noreferrer">alibaba/sealer</a>: æ”¯æŒå°†æ•´ä¸ª kubernetes æ‰“åŒ…æˆä¸€ä¸ªé•œåƒè¿›è¡Œäº¤ä»˜ï¼Œè€Œä¸”éƒ¨ç½²ä¹Ÿéå¸¸ç®€å•ã€‚
<ol>
<li>ä½¿ç”¨éš¾åº¦ï¼šè¶…çº§ç®€å•</li>
<li>è¿™ä¸ªé¡¹ç›®ç›®å‰è¿˜åœ¨å‘å±•ä¸­ï¼Œä¸è¿‡è²Œä¼¼å·²ç»æœ‰å¾ˆå¤š toB çš„å…¬å¸åœ¨ä½¿ç”¨å®ƒè¿›è¡Œ k8s åº”ç”¨çš„äº¤ä»˜äº†ã€‚</li>
</ol>
</li>
<li><a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener noreferrer">kubespray</a>: é€‚åˆè‡ªå»ºç”Ÿäº§çº§åˆ«çš„é›†ç¾¤ï¼Œæ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„ kubernetes å®‰è£…æ–¹æ¡ˆï¼Œè‡ªåŠ¨å®‰è£…å®¹å™¨è¿è¡Œæ—¶ã€k8sã€ç½‘ç»œæ’ä»¶ç­‰ç»„ä»¶ï¼Œè€Œä¸”å„ç»„ä»¶éƒ½æœ‰å¾ˆå¤šæ–¹æ¡ˆå¯é€‰ï¼Œä½†æ˜¯æ„Ÿè§‰æœ‰ç‚¹å¤æ‚ã€‚
<ol>
<li>ä½¿ç”¨éš¾åº¦ï¼šä¸­ç­‰</li>
<li>æ”¯æŒ airgap ç¦»çº¿éƒ¨ç½²ï¼Œä½†æ˜¯ä»¥å‰æˆ‘è¯•ç”¨è¿‡æ˜¯æœ‰å‘ï¼Œç°åœ¨ä¸çŸ¥é“å’‹æ ·äº†</li>
<li>åº•å±‚ä½¿ç”¨äº† kubeadm éƒ¨ç½²é›†ç¾¤</li>
</ol>
</li>
</ol>
<p>ç¬”è€…ä¸ºäº†å­¦ä¹  Kuberntesï¼Œä¸‹é¢é‡‡ç”¨å®˜æ–¹çš„ kubeadm è¿›è¡Œéƒ¨ç½²ï¼ˆä¸è¦é—®ä¸ºå•¥ä¸äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œé—®å°±æ˜¯æ‡’ï¼‰ï¼Œå®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ containerdï¼Œç½‘ç»œæ’ä»¶åˆ™ä½¿ç”¨ç›®å‰æœ€æ½®çš„åŸºäº eBPF çš„ Cilium.</p>
<p>kubernetes å®˜æ–¹ä»‹ç»äº†ä¸¤ç§é«˜å¯ç”¨é›†ç¾¤çš„æ‹“æ‰‘ç»“æ„ï¼šã€ŒStacked etcd topologyã€å’Œã€ŒExternal etcd topologyã€ï¼Œç®€å•èµ·è§ï¼Œæœ¬æ–‡ä½¿ç”¨ç¬¬ä¸€ç§ã€Œå †å  Etcd æ‹“æ‰‘ã€ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªä¸‰ master çš„é«˜å¯ç”¨é›†ç¾¤ã€‚</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener noreferrer">Kubernetes Docs - Installing kubeadm</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/" target="_blank" rel="noopener noreferrer">Kubernetes Docs - Creating Highly Available clusters with kubeadm</a></li>
</ul>
<h2 id="1-èŠ‚ç‚¹çš„ç¯å¢ƒå‡†å¤‡">1. èŠ‚ç‚¹çš„ç¯å¢ƒå‡†å¤‡</h2>
<p>é¦–å…ˆå‡†å¤‡ä¸‰å° Linux è™šæ‹Ÿæœºï¼Œç³»ç»ŸæŒ‰éœ€é€‰æ‹©ï¼Œç„¶åè°ƒæ•´è¿™ä¸‰å°æœºå™¨çš„è®¾ç½®ï¼š</p>
<ul>
<li>èŠ‚ç‚¹é…ç½®ï¼š
<ul>
<li>masterï¼šä¸ä½äº 2c/3gï¼Œç¡¬ç›˜ 20G
<ul>
<li>ä¸»èŠ‚ç‚¹æ€§èƒ½ä¹Ÿå—é›†ç¾¤ Pods ä¸ªæ•°çš„å½±å“ï¼Œä¸Šè¿°é…ç½®åº”è¯¥å¯ä»¥æ”¯æ’‘åˆ°æ¯ä¸ª Worker èŠ‚ç‚¹è·‘ 100 ä¸ª Pod.</li>
</ul>
</li>
<li>workerï¼šçœ‹éœ€æ±‚ï¼Œå»ºè®®ä¸ä½äº 2c/4gï¼Œç¡¬ç›˜ä¸å°äº 20Gï¼Œèµ„æºå……åˆ†çš„è¯å»ºè®® 40G.</li>
</ul>
</li>
<li>å¤„äºåŒä¸€ç½‘ç»œå†…å¹¶å¯äº’é€šï¼ˆé€šå¸¸æ˜¯åŒä¸€å±€åŸŸç½‘ï¼‰</li>
<li>å„ä¸»æœºçš„ hostname å’Œ mac/ip åœ°å€ä»¥åŠ <code>/sys/class/dmi/id/product_uuid</code>ï¼Œéƒ½å¿…é¡»å”¯ä¸€
<ul>
<li>è¿™é‡Œæœ€å®¹æ˜“å‡ºé—®é¢˜çš„ï¼Œé€šå¸¸æ˜¯ hostname å†²çªï¼</li>
</ul>
</li>
<li><strong>å¿…é¡»</strong>å…³é—­ swapï¼Œkubelet æ‰èƒ½æ­£å¸¸å·¥ä½œï¼</li>
</ul>
<p>æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ç›´æ¥ä½¿ç”¨ <a href="https://github.com/ryan4yin/pulumi-libvirt#examples" target="_blank" rel="noopener noreferrer">ryan4yin/pulumi-libvirt</a> è‡ªåŠ¨åˆ›å»ºäº†äº”ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶è®¾ç½®å¥½äº† ip/hostname.</p>
<p>æœ¬æ–‡ä½¿ç”¨äº† opensuse leap 15.3 çš„ KVM cloud image è¿›è¡Œå®‰è£…æµ‹è¯•ã€‚</p>
<h3 id="11-iptables-è®¾ç½®">1.1 iptables è®¾ç½®</h3>
<p>ç›®å‰ kubernetes çš„å®¹å™¨ç½‘ç»œï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ bridge æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹ï¼Œéœ€è¦ä½¿ <code>iptables</code> èƒ½å¤Ÿæ¥ç®¡ bridge ä¸Šçš„æµé‡ã€‚</p>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo modprobe br_netfilter
cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span><span class="s">br_netfilter
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span><span class="s">EOF</span>
sudo sysctl --system
</code></pre></td></tr></table>
</div>
</div><h3 id="12-å¼€æ”¾èŠ‚ç‚¹ç«¯å£">1.2 å¼€æ”¾èŠ‚ç‚¹ç«¯å£</h3>
<blockquote>
<p>å±€åŸŸç½‘ç¯å¢ƒçš„è¯ï¼Œå»ºè®®ç›´æ¥å…³é—­é˜²ç«å¢™ã€‚è¿™æ ·æ‰€æœ‰ç«¯å£éƒ½å¯ç”¨ï¼Œæ–¹ä¾¿å¿«æ·ã€‚</p>
</blockquote>
<blockquote>
<p>é€šå¸¸æˆ‘ä»¬çš„äº‘ä¸Šé›†ç¾¤ï¼Œä¹Ÿæ˜¯å…³é—­é˜²ç«å¢™çš„ï¼Œåªæ˜¯ä¼šé€šè¿‡äº‘æœåŠ¡æä¾›çš„ã€Œå®‰å…¨ç»„ã€æ¥é™åˆ¶å®¢æˆ·ç«¯ ip</p>
</blockquote>
<p>Control-plane èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ masterï¼Œéœ€è¦å¼€æ”¾å¦‚ä¸‹ç«¯å£ï¼š</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>6443*</td>
<td>Kubernetes API server</td>
<td>All</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>Self</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>Self</td>
</tr>
</tbody>
</table>
<p>Worker èŠ‚ç‚¹éœ€è¦å¼€å‘å¦‚ä¸‹ç«¯å£ï¼š</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>30000-32767</td>
<td>NodePort Servicesâ€ </td>
<td>All</td>
</tr>
</tbody>
</table>
<p>å¦å¤–é€šå¸¸æˆ‘ä»¬æœ¬åœ°æµ‹è¯•çš„æ—¶å€™ï¼Œå¯èƒ½æ›´æƒ³ç›´æ¥åœ¨ <code>80</code> <code>443</code> <code>8080</code> ç­‰ç«¯å£ä¸Šä½¿ç”¨ <code>NodePort</code>ï¼Œ
å°±éœ€è¦ä¿®æ”¹ kube-apiserver çš„ <code>--service-node-port-range</code> å‚æ•°æ¥è‡ªå®šä¹‰ NodePort çš„ç«¯å£èŒƒå›´ï¼Œç›¸åº”çš„ Worker èŠ‚ç‚¹ä¹Ÿå¾—å¼€æ”¾è¿™äº›ç«¯å£ã€‚</p>
<h2 id="2-å®‰è£…-containerd">2. å®‰è£… containerd</h2>
<p>é¦–å…ˆæ˜¯ç¯å¢ƒé…ç½®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span><span class="s">overlay
</span><span class="s">br_netfilter
</span><span class="s">nf_conntrack
</span><span class="s">EOF</span>

sudo modprobe overlay
sudo modprobe br_netfilter
sudo modprobe nf_conntrack

<span class="c1"># Setup required sysctl params, these persist across reboots.</span>
cat <span class="s">&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span><span class="s">net.bridge.bridge-nf-call-iptables  = 1
</span><span class="s">net.ipv4.ip_forward                 = 1
</span><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span><span class="s">EOF</span>

<span class="c1"># Apply sysctl params without reboot</span>
sudo sysctl --system
</code></pre></td></tr></table>
</div>
</div><p>å®‰è£… containerd+nerdctl:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">wget https://github.com/containerd/nerdctl/releases/download/v0.11.1/nerdctl-full-0.11.1-linux-amd64.tar.gz
tar -axvf nerdctl-full-0.11.1-linux-amd64.tar.gz
<span class="c1"># è¿™é‡Œç®€å•èµ·è§ï¼Œrootless ç›¸å…³çš„ä¸œè¥¿ä¹Ÿä¸€èµ·è£…è¿›å»äº†ï¼Œæµ‹è¯•å˜›å°±æ— æ‰€è°“äº†...</span>
mv bin/* /usr/local/bin/
mv lib/systemd/system/containerd.service /usr/lib/systemd/system/

systemctl <span class="nb">enable</span> containerd
systemctl start containerd
</code></pre></td></tr></table>
</div>
</div><p><code>nerdctl</code> æ˜¯ä¸€ä¸ª containerd çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä½†æ˜¯å®ƒçš„å®¹å™¨ã€é•œåƒä¸ Kubernetes çš„å®¹å™¨ã€é•œåƒæ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œä¸èƒ½äº’é€šï¼</p>
<p>ç›®å‰åªèƒ½é€šè¿‡ <code>crictl</code> æ¥æŸ¥çœ‹ã€æ‹‰å– Kubernetes çš„å®¹å™¨ã€é•œåƒï¼Œä¸‹ä¸€èŠ‚ä¼šä»‹ç» crictl çš„å®‰è£…ã€‚</p>
<h2 id="3-å®‰è£…-kubeletkubeadmkubectl">3. å®‰è£… kubelet/kubeadm/kubectl</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ä¸€äº›å…¨å±€éƒ½éœ€è¦ç”¨çš„å˜é‡</span>
<span class="nv">CNI_VERSION</span><span class="o">=</span><span class="s2">&#34;v0.8.2&#34;</span>
<span class="nv">CRICTL_VERSION</span><span class="o">=</span><span class="s2">&#34;v1.17.0&#34;</span>
<span class="c1"># kubernetes çš„ç‰ˆæœ¬å·</span>
<span class="c1"># RELEASE=&#34;$(curl -sSL https://dl.k8s.io/release/stable.txt)&#34;</span>
<span class="nv">RELEASE</span><span class="o">=</span><span class="s2">&#34;1.22.1&#34;</span>
<span class="c1"># kubelet é…ç½®æ–‡ä»¶çš„ç‰ˆæœ¬å·</span>
<span class="nv">RELEASE_VERSION</span><span class="o">=</span><span class="s2">&#34;v0.4.0&#34;</span>
<span class="c1"># æ¶æ„</span>
<span class="nv">ARCH</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span>
<span class="c1">#ã€€å®‰è£…ç›®å½•</span>
<span class="nv">DOWNLOAD_DIR</span><span class="o">=</span>/usr/local/bin


<span class="c1"># CNI æ’ä»¶</span>
sudo mkdir -p /opt/cni/bin
curl -L <span class="s2">&#34;https://github.com/containernetworking/plugins/releases/download/</span><span class="si">${</span><span class="nv">CNI_VERSION</span><span class="si">}</span><span class="s2">/cni-plugins-linux-</span><span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">CNI_VERSION</span><span class="si">}</span><span class="s2">.tgz&#34;</span> <span class="p">|</span> sudo tar -C /opt/cni/bin -xz

<span class="c1"># crictl ç›¸å…³å·¥å…·</span>
curl -L <span class="s2">&#34;https://github.com/kubernetes-sigs/cri-tools/releases/download/</span><span class="si">${</span><span class="nv">CRICTL_VERSION</span><span class="si">}</span><span class="s2">/crictl-</span><span class="si">${</span><span class="nv">CRICTL_VERSION</span><span class="si">}</span><span class="s2">-linux-</span><span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span><span class="s2">.tar.gz&#34;</span> <span class="p">|</span> sudo tar -C <span class="nv">$DOWNLOAD_DIR</span> -xz

<span class="c1"># kubelet/kubeadm/kubectl</span>
<span class="nb">cd</span> <span class="nv">$DOWNLOAD_DIR</span>
sudo curl -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>/bin/linux/<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>/<span class="o">{</span>kubeadm,kubelet,kubectl<span class="o">}</span>
sudo chmod +x <span class="o">{</span>kubeadm,kubelet,kubectl<span class="o">}</span>

<span class="c1"># kubelet/kubeadm é…ç½®</span>
curl -sSL <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes/release/</span><span class="si">${</span><span class="nv">RELEASE_VERSION</span><span class="si">}</span><span class="s2">/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service&#34;</span> <span class="p">|</span> sed <span class="s2">&#34;s:/usr/bin:</span><span class="si">${</span><span class="nv">DOWNLOAD_DIR</span><span class="si">}</span><span class="s2">:g&#34;</span> <span class="p">|</span> sudo tee /etc/systemd/system/kubelet.service
sudo mkdir -p /etc/systemd/system/kubelet.service.d
curl -sSL <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes/release/</span><span class="si">${</span><span class="nv">RELEASE_VERSION</span><span class="si">}</span><span class="s2">/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf&#34;</span> <span class="p">|</span> sed <span class="s2">&#34;s:/usr/bin:</span><span class="si">${</span><span class="nv">DOWNLOAD_DIR</span><span class="si">}</span><span class="s2">:g&#34;</span> <span class="p">|</span> sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

systemctl <span class="nb">enable</span> --now kubelet
<span class="c1"># éªŒè¯ kubelet å¯åŠ¨èµ·æ¥äº†ï¼Œä½†æ˜¯ç›®å‰è¿˜æ²¡æœ‰åˆå§‹åŒ–é…ç½®ï¼Œè¿‡ä¸€é˜µå°±ä¼šé‡å¯ä¸€æ¬¡</span>
systemctl status kubelet
</code></pre></td></tr></table>
</div>
</div><p>è¯•ç”¨ crictl:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">CONTAINER_RUNTIME_ENDPOINT</span><span class="o">=</span><span class="s1">&#39;unix:///var/run/containerd/containerd.sock&#39;</span>
<span class="c1"># åˆ—å‡ºæ‰€æœ‰ podsï¼Œç°åœ¨åº”è¯¥å•¥ä¹Ÿæ²¡</span>
crictl  pods

<span class="c1"># åˆ—å‡ºæ‰€æœ‰é•œåƒ</span>
crictl images
</code></pre></td></tr></table>
</div>
</div><h2 id="4-ä¸º-master-çš„-kube-apiserver-åˆ›å»ºè´Ÿè½½å‡è¡¡å®ç°é«˜å¯ç”¨">4. ä¸º master çš„ kube-apiserver åˆ›å»ºè´Ÿè½½å‡è¡¡å®ç°é«˜å¯ç”¨</h2>
<p>æ ¹æ® kubeadm å®˜æ–¹æ–‡æ¡£ <a href="https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md#kube-vip" target="_blank" rel="noopener noreferrer">Kubeadm Docs - High Availability Considerations</a> ä»‹ç»ï¼Œè¦å®ç° kube-apiserver çš„é«˜å¯ç”¨ï¼Œç›®å‰æœ€çŸ¥åçš„è´Ÿè½½å‡è¡¡æ–¹å¼æ˜¯ keepalived+haproxyï¼Œå¦å¤–ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ kube-vip ç­‰æ›´ç®€å•çš„å·¥å…·ã€‚</p>
<p>ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ kube-vip å§ï¼Œå‚è€ƒäº† kube-vip çš„å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://kube-vip.io/install_static/" target="_blank" rel="noopener noreferrer">Kube-vip as a Static Pod with Kubelet</a>.</p>
<blockquote>
<p>P.S. æˆ‘ä¹Ÿè§è¿‡æœ‰çš„å®‰è£…å·¥å…·ä¼šç›´æ¥æŠ›å¼ƒ keepalivedï¼Œç›´æ¥åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè·‘ä¸€ä¸ª nginx åšè´Ÿè½½å‡è¡¡ï¼Œé…ç½®é‡Œå†™æ­»äº†æ‰€æœ‰ master çš„åœ°å€&hellip;</p>
</blockquote>
<p>é¦–å…ˆä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ kube-vip çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ ARP ä¸ºä¾‹ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®æ¢æˆ BGPï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF | sudo tee add-kube-vip.sh
</span><span class="s"># ä½ çš„è™šæ‹Ÿæœºç½‘å¡ï¼Œopensuse/centos ç­‰éƒ½æ˜¯ eth0ï¼Œä½†æ˜¯ ubuntu å¯èƒ½æ˜¯ ens3
</span><span class="s">export INTERFACE=eth0
</span><span class="s">
</span><span class="s"># ç”¨äºå®ç°é«˜å¯ç”¨çš„ vipï¼Œéœ€è¦å’Œå‰é¢çš„ç½‘ç»œæ¥å£åœ¨åŒä¸€ç½‘æ®µå†…ï¼Œå¦åˆ™å°±æ— æ³•è·¯ç”±äº†ã€‚
</span><span class="s">export VIP=192.168.122.200
</span><span class="s">
</span><span class="s"># ç”Ÿæˆ static-pod çš„é…ç½®æ–‡ä»¶
</span><span class="s">mkdir -p /etc/kubernetes/manifests
</span><span class="s">nerdctl run --rm --network=host --entrypoint=/kube-vip ghcr.io/kube-vip/kube-vip:v0.3.8 \
</span><span class="s">  manifest pod \
</span><span class="s">  --interface $INTERFACE \
</span><span class="s">  --vip $VIP \
</span><span class="s">  --controlplane \
</span><span class="s">  --services \
</span><span class="s">  --arp \
</span><span class="s">  --leaderElection | tee  /etc/kubernetes/manifests/kube-vip.yaml
</span><span class="s">EOF</span>

bash add-kube-vip.sh
</code></pre></td></tr></table>
</div>
</div><p>ä¸‰ä¸ª master èŠ‚ç‚¹éƒ½éœ€è¦è·‘ä¸‹ä¸Šé¢çš„å‘½ä»¤ï¼ˆworker ä¸éœ€è¦ï¼‰ï¼Œåˆ›å»ºå¥½ kube-vip çš„ static-pod é…ç½®æ–‡ä»¶ã€‚
åœ¨å®Œæˆ kubeadm åˆå§‹åŒ–åï¼Œkubelet ä¼šè‡ªåŠ¨æŠŠå®ƒä»¬æ‹‰èµ·ä¸º static pod.</p>
<h2 id="5-ä½¿ç”¨-kubeadm-åˆ›å»ºé›†ç¾¤">5. ä½¿ç”¨ kubeadm åˆ›å»ºé›†ç¾¤</h2>
<p>å…¶å®éœ€è¦è¿è¡Œçš„å°±æ˜¯è¿™æ¡å‘½ä»¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># æç®€é…ç½®ï¼š</span>
cat <span class="s">&lt;&lt;EOF | sudo tee kubeadm-config.yaml
</span><span class="s">apiVersion: kubeadm.k8s.io/v1beta3
</span><span class="s">kind: InitConfiguration
</span><span class="s">nodeRegistration:
</span><span class="s">  criSocket: &#34;/var/run/containerd/containerd.sock&#34;
</span><span class="s">  imagePullPolicy: IfNotPresent
</span><span class="s">---
</span><span class="s">kind: ClusterConfiguration
</span><span class="s">apiVersion: kubeadm.k8s.io/v1beta3
</span><span class="s">kubernetesVersion: v1.22.1
</span><span class="s">clusterName: kubernetes
</span><span class="s">certificatesDir: /etc/kubernetes/pki
</span><span class="s">imageRepository: k8s.gcr.io
</span><span class="s">controlPlaneEndpoint: &#34;192.168.122.200:6443&#34;  # å¡« apiserver çš„ vip åœ°å€ï¼Œæˆ–è€…æ•´ä¸ªåŸŸåä¹Ÿè¡Œï¼Œä½†æ˜¯å°±å¾—åŠ  /etc/hosts æˆ–è€…å†…ç½‘ DNS è§£æ
</span><span class="s">networking:
</span><span class="s">  serviceSubnet: &#34;10.96.0.0/16&#34;
</span><span class="s">  podSubnet: &#34;10.244.0.0/16&#34;
</span><span class="s">etcd:
</span><span class="s">  local:
</span><span class="s">    dataDir: /var/lib/etcd
</span><span class="s">---
</span><span class="s">apiVersion: kubelet.config.k8s.io/v1beta1
</span><span class="s">kind: KubeletConfiguration
</span><span class="s">cgroupDriver: systemd
</span><span class="s"># è®© kubelet ä» certificates.k8s.io ç”³è¯·ç”±é›†ç¾¤ CA Root ç­¾åçš„ tls è¯ä¹¦ï¼Œè€Œéç›´æ¥ä½¿ç”¨è‡ªç­¾åè¯ä¹¦
</span><span class="s"># å¦‚æœä¸å¯ç”¨è¿™ä¸ªï¼Œ å®‰è£… metrics-server æ—¶å°±ä¼šé‡åˆ°è¯ä¹¦æŠ¥é”™ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚
</span><span class="s">serverTLSBootstrap: true
</span><span class="s">EOF</span>

<span class="c1"># æŸ¥çœ‹ kubeadm é»˜è®¤çš„å®Œæ•´é…ç½®ï¼Œä¾›å‚è€ƒ</span>
kubeadm config print init-defaults &gt; init.default.yaml

<span class="c1"># æ‰§è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ï¼Œè¿™ä¼šç›´æ¥å°†å½“å‰èŠ‚ç‚¹åˆ›å»ºä¸º master</span>
<span class="c1"># æˆåŠŸè¿è¡Œçš„å‰æï¼šå‰é¢è¯¥è£…çš„ä¸œè¥¿éƒ½è£…å¥½äº†ï¼Œè€Œä¸” kubelet å·²ç»åœ¨åå°è¿è¡Œäº†</span>
<span class="c1"># `--upload-certs` ä¼šå°†ç”Ÿæˆçš„é›†ç¾¤è¯ä¹¦ä¸Šä¼ åˆ° kubeadm æœåŠ¡å™¨ï¼Œåœ¨ä¸¤å°æ—¶å†…åŠ å…¥é›†ç¾¤çš„ master èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ‹‰è¯ä¹¦ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿é›†ç¾¤åˆ›å»ºã€‚</span>
kubeadm init --config kubeadm-config.yaml --upload-certs
</code></pre></td></tr></table>
</div>
</div><p>kubeadm åº”è¯¥ä¼šæŠ¥é”™ï¼Œæç¤ºä½ æœ‰äº›ä¾èµ–ä¸å­˜åœ¨ï¼Œä¸‹é¢å…ˆå®‰è£…å¥½ä¾èµ–é¡¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo zypper in -y socat ebtables conntrack-tools
</code></pre></td></tr></table>
</div>
</div><p>å†é‡æ–°è¿è¡Œå‰é¢çš„ kubeadm å‘½ä»¤ï¼Œåº”è¯¥å°±èƒ½æ­£å¸¸æ‰§è¡Œäº†ï¼Œå®ƒåšçš„æ“ä½œæœ‰ï¼š</p>
<ul>
<li>æ‹‰å–æ§åˆ¶é¢çš„å®¹å™¨é•œåƒ</li>
<li>ç”Ÿæˆ ca æ ¹è¯ä¹¦</li>
<li>ä½¿ç”¨æ ¹è¯ä¹¦ä¸º etcd/apiserver ç­‰ä¸€ç¥¨å·¥å…·ç”Ÿæˆ tls è¯ä¹¦</li>
<li>ä¸ºæ§åˆ¶é¢çš„å„ä¸ªç»„ä»¶ç”Ÿæˆ kubeconfig é…ç½®</li>
<li>ç”Ÿæˆ static pod é…ç½®ï¼Œkubelet ä¼šæ ¹æ®è¿™äº›é…ç½®è‡ªåŠ¨æ‹‰èµ· kube-proxy ä»¥åŠå…¶ä»–æ‰€æœ‰çš„ k8s master ç»„ä»¶</li>
</ul>
<p>è¿è¡Œå®Œä¼šç»™å‡ºä¸‰éƒ¨åˆ†å‘½ä»¤ï¼š</p>
<ul>
<li>å°† <code>kubeconfig</code> æ”¾åˆ° <code>$HOME/.kube/config</code> ä¸‹ï¼Œ<code>kubectl</code> éœ€è¦ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶è¿æ¥ kube-apiserver</li>
<li>control-plane èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤:
<ul>
<li>è¿™é‡Œç”±äºæˆ‘ä»¬æå‰æ·»åŠ äº† kube-vip çš„ static-pod é…ç½®ï¼Œè¿™é‡Œçš„ preflight-check ä¼šæŠ¥é”™ï¼Œéœ€è¦æ·»åŠ æ­¤å‚æ•°å¿½ç•¥è¯¥æŠ¥é”™ - <code>--ignore-preflight-errors=DirAvailable--etc-kubernetes-manifests</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubeadm join 192.168.122.200:6443 --token &lt;token&gt; <span class="se">\
</span><span class="se"></span>  --discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span class="se">\
</span><span class="se"></span>  --control-plane --certificate-key &lt;key&gt; <span class="se">\
</span><span class="se"></span>  --ignore-preflight-errors<span class="o">=</span>DirAvailable--etc-kubernetes-manifests
</code></pre></td></tr></table>
</div>
</div></li>
<li>worker èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤:
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubeadm join 192.168.122.200:6443 --token &lt;token&gt; <span class="se">\
</span><span class="se"></span>      --discovery-token-ca-cert-hash sha256:&lt;hash&gt; 
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>è·‘å®Œç¬¬ä¸€éƒ¨åˆ† <code>kubeconfig</code> çš„å¤„ç†å‘½ä»¤åï¼Œå°±å¯ä»¥ä½¿ç”¨ kubectl æŸ¥çœ‹é›†ç¾¤çŠ¶å†µäº†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">k8s-master-0:~/kubeadm <span class="c1"># kubectl get no</span>
NAME           STATUS     ROLES                  AGE   VERSION
k8s-master-0   NotReady   control-plane,master   79s   v1.22.1
k8s-master-0:~/kubeadm <span class="c1"># kubectl get po --all-namespaces</span>
NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE
kube-system   coredns-78fcd69978-6tlnw               0/1     Pending   <span class="m">0</span>          83s
kube-system   coredns-78fcd69978-hxtvs               0/1     Pending   <span class="m">0</span>          83s
kube-system   etcd-k8s-master-0                      1/1     Running   <span class="m">6</span>          90s
kube-system   kube-apiserver-k8s-master-0            1/1     Running   <span class="m">4</span>          90s
kube-system   kube-controller-manager-k8s-master-0   1/1     Running   <span class="m">4</span>          90s
kube-system   kube-proxy-6w2bx                       1/1     Running   <span class="m">0</span>          83s
kube-system   kube-scheduler-k8s-master-0            1/1     Running   <span class="m">7</span>          97s
</code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨åœ¨å…¶ä»–èŠ‚ç‚¹è¿è¡Œå‰é¢æ‰“å°å‡ºçš„åŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼Œå°±å¯ä»¥æ­å»ºå¥½ä¸€ä¸ªé«˜å¯ç”¨çš„é›†ç¾¤äº†ã€‚</p>
<p>æ‰€æœ‰èŠ‚ç‚¹éƒ½åŠ å…¥é›†ç¾¤åï¼Œé€šè¿‡ kubectl æŸ¥çœ‹ï¼Œåº”è¯¥æ˜¯ä¸‰ä¸ªæ§åˆ¶é¢ masterï¼Œä¸¤ä¸ª workerï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">k8s-master-0:~/kubeadm <span class="c1"># kubectl get node</span>
NAME           STATUS     ROLES                  AGE     VERSION
k8s-master-0   NotReady   control-plane,master   26m     v1.22.1
k8s-master-1   NotReady   control-plane,master   7m2s    v1.22.1
k8s-master-2   NotReady   control-plane,master   2m10s   v1.22.1
k8s-worker-0   NotReady   &lt;none&gt;                 97s     v1.22.1
k8s-worker-1   NotReady   &lt;none&gt;                 86s     v1.22.1
</code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨å®ƒä»¬éƒ½è¿˜å¤„äº NotReady çŠ¶æ€ï¼Œéœ€è¦ç­‰åˆ°æˆ‘ä»¬æŠŠç½‘ç»œæ’ä»¶å®‰è£…å¥½ï¼Œæ‰ä¼š Ready.</p>
<p>ç°åœ¨å†çœ‹ä¸‹é›†ç¾¤çš„è¯ä¹¦ç­¾å‘çŠ¶æ€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubectl get csr --sort-by<span class="o">=</span><span class="s1">&#39;{.spec.username}&#39;</span>
NAME        AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
csr-95hll   6m58s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-tklnr   7m5s    kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-w92jv   9m15s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-rv7sj   8m11s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-nxkgx   10m     kubernetes.io/kube-apiserver-client-kubelet   system:node:k8s-master-0   &lt;none&gt;              Approved,Issued
csr-cd22c   10m     kubernetes.io/kubelet-serving                 system:node:k8s-master-0   &lt;none&gt;              Pending
csr-wjrnr   9m53s   kubernetes.io/kubelet-serving                 system:node:k8s-master-0   &lt;none&gt;              Pending
csr-sjq42   9m8s    kubernetes.io/kubelet-serving                 system:node:k8s-master-1   &lt;none&gt;              Pending
csr-xtv8f   8m56s   kubernetes.io/kubelet-serving                 system:node:k8s-master-1   &lt;none&gt;              Pending
csr-f2dsf   8m3s    kubernetes.io/kubelet-serving                 system:node:k8s-master-2   &lt;none&gt;              Pending
csr-xl8dg   6m58s   kubernetes.io/kubelet-serving                 system:node:k8s-worker-0   &lt;none&gt;              Pending
csr-p9g24   6m52s   kubernetes.io/kubelet-serving                 system:node:k8s-worker-1   &lt;none&gt;              Pending
</code></pre></td></tr></table>
</div>
</div><p>èƒ½çœ‹åˆ°æœ‰å¥½å‡ ä¸ª <code>kubernetes.io/kubelet-serving</code> çš„è¯ä¹¦è¿˜å¤„äº pending çŠ¶æ€ï¼Œ
è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ kubeadm é…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®äº† <code>serverTLSBootstrap: true</code>ï¼Œè®© Kubelet ä»é›†ç¾¤ä¸­ç”³è¯· CA ç­¾åè¯ä¹¦ï¼Œè€Œä¸æ˜¯è‡ªç­¾åå¯¼è‡´çš„ã€‚</p>
<p>è®¾ç½®è¿™ä¸ªå‚æ•°çš„ä¸»è¦ç›®çš„ï¼Œæ˜¯ä¸ºäº†è®© metrics-server ç­‰ç»„ä»¶èƒ½ä½¿ç”¨ https åè®®ä¸ kubelet é€šä¿¡ï¼Œé¿å…ä¸º metrics-server æ·»åŠ å‚æ•° <code>--kubelet-insecure-tls</code>.</p>
<p>ç›®å‰ kubeadm ä¸æ”¯æŒè‡ªåŠ¨æ‰¹å‡† kubelet ç”³è¯·çš„è¯ä¹¦ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ‰¹å‡†ä¸€ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># æ‰¹å‡† Kubelet ç”³è¯·çš„æ‰€æœ‰è¯ä¹¦</span>
kubectl certificate approve csr-cd22c csr-wjrnr csr-sjq42 csr-xtv8f csr-f2dsf csr-xl8dg csr-p9g24
</code></pre></td></tr></table>
</div>
</div><p>åœ¨æœªæ‰¹å‡†è¿™äº›è¯ä¹¦ä¹‹å‰ï¼Œæ‰€æœ‰éœ€è¦è°ƒç”¨ kubelet api çš„åŠŸèƒ½éƒ½å°†æ— æ³•ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æŸ¥çœ‹ pod æ—¥å¿—</li>
<li>è·å–èŠ‚ç‚¹ metrics</li>
<li>ç­‰ç­‰</li>
</ul>
<h3 id="51-å¸¸è§é—®é¢˜">5.1 å¸¸è§é—®é¢˜</h3>
<h4 id="511-ä½¿ç”¨å›½å†…é•œåƒæº">5.1.1 ä½¿ç”¨å›½å†…é•œåƒæº</h4>
<p>å¦‚æœä½ æ²¡æœ‰ç§‘å­¦ç¯å¢ƒï¼Œkubeadm é»˜è®¤çš„é•œåƒä»“åº“åœ¨å›½å†…æ˜¯æ‹‰ä¸äº†çš„ã€‚
å¦‚æœå¯¹å¯é æ€§è¦æ±‚é«˜ï¼Œæœ€å¥½æ˜¯è‡ªå»ºç§æœ‰é•œåƒä»“åº“ï¼ŒæŠŠé•œåƒæ¨é€åˆ°ç§æœ‰ä»“åº“ã€‚</p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ—å‡ºæ‰€æœ‰éœ€è¦ç”¨åˆ°çš„é•œåƒåœ°å€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubeadm config images list --kubernetes-version v1.22.1
k8s.gcr.io/kube-apiserver:v1.22.1
k8s.gcr.io/kube-controller-manager:v1.22.1
k8s.gcr.io/kube-scheduler:v1.22.1
k8s.gcr.io/kube-proxy:v1.22.1
k8s.gcr.io/pause:3.5
k8s.gcr.io/etcd:3.5.0-0
k8s.gcr.io/coredns/coredns:v1.8.4
</code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ <code>skopeo</code> ç­‰å·¥å…·æˆ–è„šæœ¬å°†ä¸Šè¿°é•œåƒæ‹·è´åˆ°ä½ çš„ç§æœ‰ä»“åº“ï¼Œæˆ–è€…å›¾æ–¹ä¾¿ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰ä¹Ÿå¯ä»¥è€ƒè™‘ç½‘ä¸Šæ‰¾æ‰¾åˆ«äººåŒæ­¥å¥½çš„é•œåƒåœ°å€ã€‚å°†é•œåƒåœ°å€æ·»åŠ åˆ° <code>kubeadm-config.yaml</code> ä¸­å†éƒ¨ç½²ã€‚</p>
<h4 id="512-é‡ç½®é›†ç¾¤é…ç½®">5.1.2 é‡ç½®é›†ç¾¤é…ç½®</h4>
<p>åˆ›å»ºé›†ç¾¤çš„è¿‡ç¨‹ä¸­å‡ºç°ä»»ä½•é—®é¢˜ï¼Œéƒ½å¯ä»¥é€šè¿‡åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ <code>kubeadm reset</code> æ¥è¿˜åŸé…ç½®ï¼Œç„¶åé‡æ–°èµ° kubeadm çš„é›†ç¾¤åˆ›å»ºæµç¨‹ã€‚</p>
<p>ä½†æ˜¯è¦æ³¨æ„å‡ ç‚¹ï¼š</p>
<ul>
<li><code>kubeadm reset</code> ä¼šæ¸…é™¤åŒ…å« kube-vip é…ç½®åœ¨å†…çš„æ‰€æœ‰ static-pod é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥ master èŠ‚ç‚¹éœ€è¦é‡æ–°è·‘ä¸‹å‰é¢ç»™çš„ kube-vip å‘½ä»¤ï¼Œç”Ÿæˆä¸‹ kube-vip é…ç½®ã€‚</li>
<li><code>kubeadm reset</code> ä¸ä¼šé‡ç½®ç½‘ç»œæ¥å£çš„é…ç½®ï¼Œmaster èŠ‚ç‚¹éœ€è¦æ‰‹åŠ¨æ¸…ç†ä¸‹ kube-vip æ·»åŠ çš„ vip: <code>ip addr del 192.168.122.200/32 dev eth0</code>.</li>
<li>å¦‚æœä½ åœ¨å®‰è£…äº†ç½‘ç»œæ’ä»¶ä¹‹åå¸Œæœ›é‡è£…é›†ç¾¤ï¼Œé¡ºåºå¦‚ä¸‹ï¼š
<ul>
<li>é€šè¿‡ <code>kubectl delete -f xxx.yaml</code>/<code>helm uninstall</code> åˆ é™¤æ‰€æœ‰é™¤ç½‘ç»œä¹‹å¤–çš„å…¶ä»–åº”ç”¨é…ç½®</li>
<li>åˆ é™¤ç½‘ç»œæ’ä»¶</li>
<li>å…ˆé‡å¯ä¸€éæ‰€æœ‰èŠ‚ç‚¹ï¼Œæˆ–è€…æ‰‹åŠ¨é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çš„ç½‘ç»œé…ç½®
<ul>
<li>å»ºè®®é‡å¯ï¼Œå› ä¸ºæˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆæ‰‹åŠ¨é‡ç½®&hellip; è¯•äº† <code>systemctl restart network</code> å¹¶ä¸ä¼šæ¸…ç†æ‰€æœ‰è™šæ‹Ÿç½‘ç»œæ¥å£ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¦‚æ­¤æ“ä½œåï¼Œå†é‡æ–°æ‰§è¡Œé›†ç¾¤å®‰è£…ï¼Œåº”è¯¥å°±æ²¡å•¥æ¯›ç—…äº†ã€‚</p>
<h2 id="6-éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§">6. éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§</h2>
<p>è™½ç„¶ç½‘ç»œæ’ä»¶è¿˜æ²¡è£…å¯¼è‡´é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹éƒ½è¿˜æ²¡ readyï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡ kubectl å‘½ä»¤æ¥ç®€å•éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§äº†ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å‰é¢æ”¾ç½®åœ¨ k8s-master-0 çš„è®¤è¯æ–‡ä»¶ <code>$HOME/.kube/config</code> ä»¥åŠ kunbectl å®‰è£…åœ¨å¦ä¸€å°æœºå™¨ä¸Šï¼Œæ¯”å¦‚æˆ‘ç›´æ¥æ”¾æˆ‘çš„å®¿ä¸»æœºã€‚</p>
<p>ç„¶ååœ¨å®¿ä¸»æœºä¸Šè·‘ <code>kubectl get node</code> å‘½ä»¤éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§ï¼š</p>
<ul>
<li>ä¸‰ä¸ªä¸»èŠ‚ç‚¹éƒ½æ­£å¸¸è¿è¡Œæ—¶ï¼Œkubectl å‘½ä»¤ä¹Ÿæ­£å¸¸</li>
<li>pause æˆ–è€… stop å…¶ä¸­ä¸€ä¸ª masterï¼Œkubectl å‘½ä»¤ä»ç„¶èƒ½æ­£å¸¸è¿è¡Œ</li>
<li>å† pause ç¬¬äºŒä¸ª masterï¼Œkubectl å‘½ä»¤åº”è¯¥å°±ä¼šå¡ä½ï¼Œå¹¶ä¸”è¶…æ—¶ï¼Œæ— æ³•ä½¿ç”¨äº†</li>
<li>resume æ¢å¤åœæ‰çš„ä¸¤ä¸ª master ä¹‹ä¸€ï¼Œä¼šå‘ç° kubectl å‘½ä»¤åˆèƒ½æ­£å¸¸è¿è¡Œäº†</li>
</ul>
<p>åˆ°è¿™é‡Œ kubeadm çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å†å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œé›†ç¾¤å°±å¯ç”¨äº†ã€‚</p>
<h2 id="7-å®‰è£…ç½‘ç»œæ’ä»¶">7. å®‰è£…ç½‘ç»œæ’ä»¶</h2>
<p>ç¤¾åŒºæœ‰å¾ˆå¤šç§ç½‘ç»œæ’ä»¶å¯é€‰ï¼Œæ¯”è¾ƒçŸ¥åä¸”æ€§èƒ½ä¹Ÿä¸é”™çš„ï¼Œåº”è¯¥æ˜¯ Calico å’Œ Ciliumï¼Œå…¶ä¸­ Cilium ä¸»æ‰“åŸºäº eBPF çš„é«˜æ€§èƒ½ä¸é«˜å¯è§‚æµ‹æ€§ã€‚</p>
<p>ä¸‹é¢åˆ†åˆ«ä»‹ç»è¿™ä¸¤ä¸ªæ’ä»¶çš„å®‰è£…æ–¹æ³•ã€‚ï¼ˆæ³¨æ„åªèƒ½å®‰è£…å…¶ä¸­ä¸€ä¸ªç½‘ç»œæ’ä»¶ï¼Œä¸èƒ½é‡å¤å®‰è£…ã€‚ï¼‰</p>
<p>éœ€è¦æå‰åœ¨æœ¬æœºå®‰è£…å¥½ helmï¼Œæˆ‘è¿™é‡Œä½¿ç”¨å®¿ä¸»æœºï¼Œå› æ­¤åªéœ€è¦åœ¨å®¿ä¸»æœºå®‰è£…:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ä¸€è¡Œå‘½ä»¤å®‰è£…ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨ä¸‹è½½å®‰è£…åŒ…ï¼Œéƒ½è¡Œ</span>
curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 <span class="p">|</span> bash

<span class="c1"># æˆ–è€… opensuse ç›´æ¥ç”¨åŒ…ç®¡ç†å™¨å®‰è£…</span>
sudo zypper in helm
</code></pre></td></tr></table>
</div>
</div><h3 id="71-å®‰è£…-cilium">7.1 å®‰è£… Cilium</h3>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.cilium.io/en/v1.10/gettingstarted/k8s-install-kubeadm/</p>
</blockquote>
<p>cilium é€šè¿‡ eBPF æä¾›äº†é«˜æ€§èƒ½ä¸é«˜å¯è§‚æµ‹çš„ k8s é›†ç¾¤ç½‘ç»œï¼Œ
å¦å¤– cilium è¿˜æä¾›äº†æ¯” kube-proxy æ›´é«˜æ•ˆçš„å®ç°ï¼Œå¯ä»¥å®Œå…¨æ›¿ä»£ kube-proxy.</p>
<p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯å…ˆä½¿ç”¨ kube-proxy æ¨¡å¼ï¼Œå…ˆç†Ÿæ‚‰ä¸‹ cilium çš„ä½¿ç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm repo add cilium https://helm.cilium.io/
helm search repo cilium/cilium -l <span class="p">|</span> head

helm install cilium cilium/cilium --version 1.10.4 --namespace kube-system
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥é€šè¿‡ <code>kubectl get pod -A</code> æŸ¥çœ‹ cilium çš„å®‰è£…è¿›åº¦ï¼Œå½“æ‰€æœ‰ pod éƒ½ ready åï¼Œé›†ç¾¤å°± ready äº†~</p>
<p>cilium ä¹Ÿæä¾›äº†ä¸“ç”¨çš„å®¢æˆ·ç«¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
sha256sum --check cilium-linux-amd64.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
rm cilium-linux-amd64.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åä½¿ç”¨ cilium å®¢æˆ·ç«¯æ£€æŸ¥ç½‘ç»œæ’ä»¶çš„çŠ¶æ€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"> $ cilium status --wait
    /Â¯Â¯<span class="se">\
</span><span class="se"></span> /Â¯Â¯<span class="se">\_</span>_/Â¯Â¯<span class="se">\ </span>   Cilium:         OK
 <span class="se">\_</span>_/Â¯Â¯<span class="se">\_</span>_/    Operator:       OK
 /Â¯Â¯<span class="se">\_</span>_/Â¯Â¯<span class="se">\ </span>   Hubble:         disabled
 <span class="se">\_</span>_/Â¯Â¯<span class="se">\_</span>_/    ClusterMesh:    disabled
    <span class="se">\_</span>_/

DaemonSet         cilium             Desired: 5, Ready: 5/5, Available: 5/5
Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
Containers:       cilium             Running: <span class="m">5</span>
                  cilium-operator    Running: <span class="m">2</span>
Cluster Pods:     2/2 managed by Cilium
Image versions    cilium             quay.io/cilium/cilium:v1.10.4@sha256:7d354052ccf2a7445101d78cebd14444c7c40129ce7889f2f04b89374dbf8a1d: <span class="m">5</span>
                  cilium-operator    quay.io/cilium/operator-generic:v1.10.4@sha256:c49a14e34634ff1a494c84b718641f27267fb3a0291ce3d74352b44f8a8d2f93: <span class="m">2</span>
</code></pre></td></tr></table>
</div>
</div><p>cilium è¿˜æä¾›äº†å‘½ä»¤ï¼Œè‡ªåŠ¨åˆ›å»º pod è¿›è¡Œé›†ç¾¤ç½‘ç»œçš„è¿æ¥æ€§æµ‹è¯•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ cilium connectivity <span class="nb">test</span>
â„¹ï¸  Monitor aggregation detected, will skip some flow validation steps
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Creating namespace <span class="k">for</span> connectivity check...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying echo-same-node service...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying same-node deployment...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying client deployment...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying client2 deployment...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying echo-other-node service...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying other-node deployment...
...
â„¹ï¸  Expose Relay locally with:
   cilium hubble <span class="nb">enable</span>
   cilium status --wait
   cilium hubble port-forward<span class="p">&amp;</span>
ğŸƒ Running tests...
...
---------------------------------------------------------------------------------------------------------------------
âœ… All <span class="m">11</span> tests <span class="o">(</span><span class="m">134</span> actions<span class="o">)</span> successful, <span class="m">0</span> tests skipped, <span class="m">0</span> scenarios skipped.
</code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ <code>kubectl get po -A</code> èƒ½è§‚å¯Ÿåˆ°ï¼Œè¿™ä¸ªæµ‹è¯•å‘½ä»¤ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª <code>cilium-test</code> åå­—ç©ºé—´ï¼Œå¹¶åœ¨å¯åŠ¨åˆ›å»ºè‹¥å¹² pod è¿›è¡Œè¯¦ç»†çš„æµ‹è¯•ã€‚</p>
<p>æ•´ä¸ªæµ‹è¯•æµç¨‹å¤§æ¦‚ä¼šæŒç»­ 5 åˆ†å¤šé’Ÿï¼Œæµ‹è¯•å®Œæˆåï¼Œç›¸å…³ Pod ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰‹åŠ¨åˆ é™¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl delete namespace cilium-test
</code></pre></td></tr></table>
</div>
</div><h3 id="72-å®‰è£…-calico">7.2 å®‰è£… Calico</h3>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises</p>
</blockquote>
<p>ä¹Ÿå°±ä¸¤ä¸‰è¡Œå‘½ä»¤ã€‚å®‰è£…ç¡®å®ç‰¹åˆ«ç®€å•ï¼Œæ‡’å¾—ä»‹ç»äº†ï¼Œçœ‹å®˜æ–¹æ–‡æ¡£å§ã€‚</p>
<p>ä½†æ˜¯å®é™…ä¸Š calico çš„ç»†èŠ‚è¿˜è›®å¤šçš„ï¼Œå»ºè®®é€šè¯»ä¸‹å®ƒçš„å®˜æ–¹æ–‡æ¡£ï¼Œäº†è§£ä¸‹ calico çš„æ¶æ„ã€‚</p>
<h2 id="8-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€">8. æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h2>
<p>å®˜æ–¹çš„ dashboard ä¸ªäººæ„Ÿè§‰ä¸å¤ªå¥½ç”¨ï¼Œå»ºè®®ç›´æ¥åœ¨æœ¬åœ°è£…ä¸ª k9s ç”¨ï¼Œç‰¹åˆ«çˆ½ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo zypper in k9s
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°ç©è€äº†ã€‚</p>
<h2 id="9-å®‰è£…-metrics-server">9. å®‰è£… metrics-server</h2>
<blockquote>
<p>è¿™ä¸€æ­¥å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#kubelet-serving-certs" target="_blank" rel="noopener noreferrer">Enabling signed kubelet serving certificates</a></p>
</blockquote>
<p>å¦‚æœéœ€è¦ä½¿ç”¨ HPA ä»¥åŠç®€å•çš„é›†ç¾¤ç›‘æ§ï¼Œé‚£ä¹ˆ metrics-server æ˜¯å¿…é¡»å®‰è£…çš„ï¼Œç°åœ¨æˆ‘ä»¬å®‰è£…ä¸€ä¸‹å®ƒã€‚</p>
<p>é¦–å…ˆï¼Œè·‘ kubectl çš„ç›‘æ§å‘½ä»¤åº”è¯¥ä¼šæŠ¥é”™ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubectl top node
error: Metrics API not available
</code></pre></td></tr></table>
</div>
</div><p>k9s é‡Œé¢åº”è¯¥ä¹Ÿçœ‹ä¸åˆ°ä»»ä½•ç›‘æ§æŒ‡æ ‡ã€‚</p>
<p>ç°åœ¨é€šè¿‡ helm å®‰è£…å®ƒï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
helm search repo metrics-server/metrics-server -l <span class="p">|</span> head

helm upgrade --install metrics-server metrics-server/metrics-server --version 3.5.0 --namespace kube-system
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>metrics-server é»˜è®¤åªä¼šéƒ¨ç½²ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚æœå¸Œæœ›é«˜å¯ç”¨ï¼Œè¯·å‚è€ƒå®˜æ–¹é…ç½®ï¼š<a href="https://github.com/kubernetes-sigs/metrics-server/tree/master/manifests/high-availability" target="_blank" rel="noopener noreferrer">metrics-server - high-availability manifests</a></p>
</blockquote>
<p>ç­‰ metrics-server å¯åŠ¨å¥½åï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>kubectl top</code> å‘½ä»¤å•¦ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubectl top node
NAME           CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%   
k8s-master-0   327m         16%    1465Mi          50%       
k8s-master-1   263m         13%    1279Mi          44%       
k8s-master-2   289m         14%    1282Mi          44%       
k8s-worker-0   62m          3%     518Mi           13%       
k8s-worker-1   115m         2%     659Mi           8%        

â¯ kubectl top pod
No resources found in default namespace.

â¯ kubectl top pod -A
NAMESPACE     NAME                                   CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   
kube-system   cilium-45nw4                           9m           135Mi           
kube-system   cilium-5x7jf                           6m           154Mi           
kube-system   cilium-84sr2                           7m           160Mi           
kube-system   cilium-operator-78f45675-dp4b6         2m           30Mi            
kube-system   cilium-operator-78f45675-fpm5g         1m           30Mi            
kube-system   cilium-tkhl4                           6m           141Mi           
kube-system   cilium-zxbvm                           5m           138Mi           
kube-system   coredns-78fcd69978-dpxxk               3m           16Mi            
kube-system   coredns-78fcd69978-ptd9p               1m           18Mi            
kube-system   etcd-k8s-master-0                      61m          88Mi            
kube-system   etcd-k8s-master-1                      50m          85Mi            
kube-system   etcd-k8s-master-2                      55m          83Mi            
kube-system   kube-apiserver-k8s-master-0            98m          462Mi           
kube-system   kube-apiserver-k8s-master-1            85m          468Mi           
kube-system   kube-apiserver-k8s-master-2            85m          423Mi           
kube-system   kube-controller-manager-k8s-master-0   22m          57Mi            
kube-system   kube-controller-manager-k8s-master-1   2m           23Mi            
kube-system   kube-controller-manager-k8s-master-2   2m           23Mi            
kube-system   kube-proxy-j2s76                       1m           24Mi            
kube-system   kube-proxy-k6d6z                       1m           18Mi            
kube-system   kube-proxy-k85rx                       1m           23Mi            
kube-system   kube-proxy-pknsc                       1m           20Mi            
kube-system   kube-proxy-xsq4m                       1m           15Mi            
kube-system   kube-scheduler-k8s-master-0            3m           25Mi            
kube-system   kube-scheduler-k8s-master-1            4m           21Mi            
kube-system   kube-scheduler-k8s-master-2            5m           21Mi            
kube-system   kube-vip-k8s-master-0                  4m           17Mi            
kube-system   kube-vip-k8s-master-1                  2m           16Mi            
kube-system   kube-vip-k8s-master-2                  2m           17Mi            
kube-system   metrics-server-559f85484-5b6xf         7m           27Mi    
</code></pre></td></tr></table>
</div>
</div><h2 id="10-ä¸º-etcd-æ·»åŠ å®šæœŸå¤‡ä»½èƒ½åŠ›">10. ä¸º etcd æ·»åŠ å®šæœŸå¤‡ä»½èƒ½åŠ›</h2>
<p>è¯·ç§»æ­¥ <a href="https://github.com/ryan4yin/knowledge/blob/master/datastore/etcd/etcd%20%E7%9A%84%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.md" target="_blank" rel="noopener noreferrer">etcd çš„å¤‡ä»½ä¸æ¢å¤</a></p>
<h2 id="11-å®‰è£…-volume-provisioner">11. å®‰è£… Volume Provisioner</h2>
<p>åœ¨æˆ‘ä»¬å­¦ä¹ ä½¿ç”¨ Prometheus/MinIO/Tekton ç­‰æœ‰çŠ¶æ€åº”ç”¨æ—¶ï¼Œå®ƒä»¬é»˜è®¤æƒ…å†µä¸‹ä¼šé€šè¿‡ PVC å£°æ˜éœ€è¦çš„æ•°æ®å·ã€‚</p>
<p>ä¸ºäº†æ”¯æŒè¿™ä¸ªèƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ª Volume Provisioner.</p>
<p>å¯¹äºäº‘ä¸Šç¯å¢ƒï¼Œç›´æ¥æ¥å…¥äº‘æœåŠ¡å•†æä¾›çš„ Volume Provisioner å°± OK äº†ï¼Œæ–¹ä¾¿çœäº‹è€Œä¸”è¶³å¤Ÿå¯é ã€‚</p>
<p>è€Œå¯¹äº bare-metal ç¯å¢ƒï¼Œæ¯”è¾ƒæœ‰åçš„åº”è¯¥æ˜¯ rook-cephï¼Œä½†æ˜¯è¿™ä¸ªç©æ„éƒ¨ç½²å¤æ‚ï¼Œç»´æŠ¤éš¾åº¦åˆé«˜ï¼Œä¸é€‚åˆç”¨æ¥æµ‹è¯•å­¦ä¹ ï¼Œä¹Ÿä¸é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚</p>
<p>å¯¹äºå¼€å‘ã€æµ‹è¯•ç¯å¢ƒï¼Œæˆ–è€…ä¸ªäººé›†ç¾¤ï¼Œå»ºè®®ä½¿ç”¨ï¼š</p>
<ul>
<li>local æ•°æ®å·ï¼Œé€‚åˆæ•°æ®å¯ä¸¢å¤±ï¼Œä¸”ä¸è¦æ±‚åˆ†å¸ƒå¼çš„åœºæ™¯ï¼Œå¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒ
<ul>
<li><a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner">https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner</a></li>
<li><a href="https://github.com/rancher/local-path-provisioner">https://github.com/rancher/local-path-provisioner</a></li>
</ul>
</li>
<li>NFS æ•°æ®å·ï¼Œé€‚åˆæ•°æ®å¯ä¸¢å¤±ï¼Œå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œå¹¶ä¸”è¦æ±‚åˆ†å¸ƒå¼çš„åœºæ™¯ã€‚æ¯”å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒã€æˆ–è€…çº¿ä¸Šæ²¡å•¥å‹åŠ›çš„åº”ç”¨
<ul>
<li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></li>
<li><a href="https://github.com/kubernetes-csi/csi-driver-nfs">https://github.com/kubernetes-csi/csi-driver-nfs</a></li>
<li>NFS æ•°æ®çš„å¯é æ€§ä¾èµ–äºå¤–éƒ¨ NFS æœåŠ¡å™¨ï¼Œä¼ä¸šé€šå¸¸ä½¿ç”¨ç¾¤æ™–ç­‰ NAS æ¥åš NFS æœåŠ¡å™¨</li>
<li>å¦‚æœå¤–éƒ¨ NFS æœåŠ¡å™¨å‡ºé—®é¢˜ï¼Œåº”ç”¨å°±ä¼šå´©ã€‚</li>
</ul>
</li>
<li>ç›´æ¥ä½¿ç”¨äº‘ä¸Šçš„å¯¹è±¡å­˜å‚¨ï¼Œé€‚åˆå¸Œæœ›æ•°æ®ä¸ä¸¢å¤±ã€å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚
<ul>
<li>ç›´æ¥ä½¿ç”¨ <a href="https://github.com/rclone/rclone">https://github.com/rclone/rclone</a> mount æ¨¡å¼æ¥ä¿å­˜æ•°æ®ï¼Œæˆ–è€…ç›´æ¥åŒæ­¥æ–‡ä»¶å¤¹æ•°æ®åˆ°äº‘ç«¯ï¼ˆå¯èƒ½ä¼šæœ‰ä¸€å®šæ•°æ®ä¸¢å¤±ï¼‰ã€‚</li>
</ul>
</li>
</ul>
]]></description></item><item><title>Kubernetes å¾®æœåŠ¡æœ€ä½³å®è·µ</title><link>https://ryan4yin.space/posts/kubernetes-best-practices/</link><pubDate>Tue, 25 Jan 2022 00:13:00 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/kubernetes-best-practices/</guid><description><![CDATA[<blockquote>
<p>æœ¬æ–‡ç”±ä¸ªäººç¬”è®° <a href="https://github.com/ryan4yin/knowledge/tree/master/kubernetes" target="_blank" rel="noopener noreferrer">ryan4yin/knowledge</a> æ•´ç†è€Œæ¥</p>
</blockquote>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸‹æˆ‘ä¸ªäººåœ¨ä½¿ç”¨ Kubernetes çš„è¿‡ç¨‹ä¸­ï¼Œæ€»ç»“å‡ºçš„ä¸€å¥—ã€ŒKubernetes é…ç½®ã€ï¼Œæ˜¯æˆ‘ä¸ªäººçš„ã€Œæœ€ä½³å®è·µã€ã€‚
å…¶ä¸­å¤§éƒ¨åˆ†å†…å®¹éƒ½ç»å†è¿‡çº¿ä¸Šç¯å¢ƒçš„è€ƒéªŒï¼Œä½†æ˜¯ä¹Ÿæœ‰å°‘éƒ¨åˆ†è¿˜åªåœ¨æˆ‘è„‘å­é‡Œæ¨¡æ‹Ÿè¿‡ï¼Œè¯·è°¨æ…å‚è€ƒã€‚</p>
<p>é˜…è¯»å‰çš„å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>è¿™ä»½æ–‡æ¡£æ¯”è¾ƒé•¿ï¼Œå›Šæ‹¬äº†å¾ˆå¤šå†…å®¹ï¼Œå»ºè®®å½“æˆå‚è€ƒæ‰‹å†Œä½¿ç”¨ï¼Œå…ˆå‚ç…§ç›®å½•ç®€å•è¯»ä¸€è¯»ï¼Œæœ‰éœ€è¦å†ç»†è¯»ç›¸å…³å†…å®¹ã€‚</li>
<li>è¿™ä»½æ–‡æ¡£éœ€è¦ä¸€å®šçš„ Kubernetes åŸºç¡€æ‰èƒ½ç†è§£ï¼Œè€Œä¸”å¦‚æœæ²¡æœ‰è¿‡å®è·µç»éªŒçš„è¯ï¼Œçœ‹ä¸Šå»å¯èƒ½ä¼šæ¯”è¾ƒæ¯ç‡¥ã€‚
<ul>
<li>è€Œæœ‰è¿‡å®è·µç»éªŒçš„å¤§ä½¬ï¼Œå¯èƒ½ä¼šè·Ÿæˆ‘æœ‰ä¸åŒçš„è§è§£ï¼Œæ¬¢è¿å„è·¯å¤§ä½¬è¯„è®º~</li>
</ul>
</li>
</ul>
<p>æˆ‘ä¼šè§†æƒ…å†µä¸å®šæœŸæ›´æ–°è¿™ä»½æ–‡æ¡£ã€‚</p>
<h2 id="é›¶ç¤ºä¾‹">é›¶ã€ç¤ºä¾‹</h2>
<p>é¦–å…ˆï¼Œè¿™é‡Œç»™å‡ºä¸€äº›æœ¬æ–‡éµå®ˆçš„å‰æï¼Œè¿™äº›å‰æåªæ˜¯å¥‘åˆæˆ‘é‡åˆ°çš„åœºæ™¯ï¼Œå¯çµæ´»å˜é€šï¼š</p>
<ul>
<li>è¿™é‡Œåªè®¨è®ºæ— çŠ¶æ€æœåŠ¡ï¼Œæœ‰çŠ¶æ€æœåŠ¡ä¸åœ¨è®¨è®ºèŒƒå›´å†…</li>
<li>æˆ‘ä»¬ä¸ä½¿ç”¨ Deployment çš„æ»šåŠ¨æ›´æ–°èƒ½åŠ›ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªæœåŠ¡çš„æ¯ä¸ªç‰ˆæœ¬ï¼Œéƒ½åˆ›å»ºä¸åŒçš„ Deployment + HPA + PodDisruptionBudgetï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿åšé‡‘ä¸é›€/ç°åº¦å‘å¸ƒ</li>
<li>æˆ‘ä»¬çš„æœåŠ¡å¯èƒ½ä¼šä½¿ç”¨ IngressController / Service Mesh æ¥è¿›è¡ŒæœåŠ¡çš„è´Ÿè½½å‡è¡¡ã€æµé‡åˆ‡åˆ†</li>
</ul>
<p>ä¸‹é¢å…ˆç»™å‡ºä¸€ä¸ª Deployment + HPA + PodDisruptionBudget çš„ demoï¼Œåé¢å†æ‹†å¼€è¯¦ç»†è¯´ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span><span class="w">    </span><span class="c"># å› ä¸ºæœåŠ¡çš„æ¯ä¸ªç‰ˆæœ¬éƒ½ä½¿ç”¨å„è‡ªçš„ Deploymentï¼ŒæœåŠ¡æ›´æ–°æ—¶å…¶å®æ˜¯ç”¨ä¸ä¸Šè¿™é‡Œçš„æ»šåŠ¨æ›´æ–°ç­–ç•¥çš„</span><span class="w">
</span><span class="w">    </span><span class="c"># è¿™ä¸ªé…ç½®åº”è¯¥åªåœ¨ SRE æ‰‹åŠ¨ä¿®æ”¹ Deployment é…ç½®æ—¶æ‰ä¼šç”Ÿæ•ˆï¼ˆé€šå¸¸ä¸åº”è¯¥å‘ç”Ÿè¿™ç§äº‹ï¼‰</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="l">% </span><span class="w"> </span><span class="c"># æ»šåŠ¨æ›´æ–°æ—¶ï¼Œæ¯æ¬¡æœ€å¤šæ›´æ–° 10% çš„ Pods</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c"># æ»šåŠ¨æ›´æ–°æ—¶ï¼Œä¸å…è®¸å‡ºç°ä¸å¯ç”¨çš„ Podsï¼Œä¹Ÿå°±æ˜¯è¯´å§‹ç»ˆè¦ç»´æŒ 3 ä¸ªå¯ç”¨å‰¯æœ¬</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v3</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v3</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">podAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># éå¼ºåˆ¶æ€§æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹ï¼ˆåªæœ‰ä¸€æ¡è§„åˆ™çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼æ²¡å•¥æ„ä¹‰ï¼‰</span><span class="w">
</span><span class="w">            </span><span class="nt">podAffinityTerm</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">my-app</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">v3</span><span class="w">
</span><span class="w">              </span><span class="c"># pod å°½é‡ä½¿ç”¨åŒä¸€ç§èŠ‚ç‚¹ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å°½é‡ä¿è¯èŠ‚ç‚¹çš„æ€§èƒ½ä¸€è‡´</span><span class="w">
</span><span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">node.kubernetes.io/instance-type</span><span class="w">
</span><span class="w">        </span><span class="nt">podAntiAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># éå¼ºåˆ¶æ€§æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹ï¼ˆåªæœ‰ä¸€æ¡è§„åˆ™çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼æ²¡å•¥æ„ä¹‰ï¼‰</span><span class="w">
</span><span class="w">            </span><span class="nt">podAffinityTerm</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">my-app</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">v3</span><span class="w">
</span><span class="w">              </span><span class="c"># å°† pod å°½é‡æ‰“æ•£åœ¨å¤šä¸ªå¯ç”¨åŒº</span><span class="w">
</span><span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">  </span><span class="c"># å¼ºåˆ¶æ€§è¦æ±‚ï¼ˆè¿™ä¸ªå»ºè®®æŒ‰éœ€æ·»åŠ ï¼‰</span><span class="w">
</span><span class="w">          </span><span class="c"># æ³¨æ„è¿™ä¸ªæ²¡æœ‰ weightsï¼Œå¿…é¡»æ»¡è¶³åˆ—è¡¨ä¸­çš„æ‰€æœ‰æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">my-app</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">v3</span><span class="w">
</span><span class="w">            </span><span class="c"># Pod å¿…é¡»è¿è¡Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š</span><span class="w">
</span><span class="w">            </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># runAsUser: 1000  # è®¾å®šç”¨æˆ·</span><span class="w">
</span><span class="w">        </span><span class="c"># runAsGroup: 1000  # è®¾å®šç”¨æˆ·ç»„</span><span class="w">
</span><span class="w">        </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># Pod å¿…é¡»ä»¥é root ç”¨æˆ·è¿è¡Œ</span><span class="w">
</span><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">  </span><span class="c"># security compute mode</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">eks.amazonaws.com/nodegroup</span><span class="p">:</span><span class="w"> </span><span class="l">common </span><span class="w"> </span><span class="c"># ä½¿ç”¨ä¸“ç”¨èŠ‚ç‚¹ç»„ï¼Œå¦‚æœå¸Œæœ›ä½¿ç”¨å¤šä¸ªèŠ‚ç‚¹ç»„ï¼Œå¯æ”¹ç”¨èŠ‚ç‚¹äº²å’Œæ€§</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir</span><span class="w">
</span><span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">my-app:v3 </span><span class="w"> </span><span class="c"># å»ºè®®ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“ï¼Œè§„é¿ docker.io çš„é•œåƒæ‹‰å–é™åˆ¶</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir</span><span class="w">
</span><span class="w">        </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="l">/bin/sh</span><span class="w">
</span><span class="w">              </span>- -<span class="l">c</span><span class="w">
</span><span class="w">              </span>- <span class="s2">&#34;while [ $(netstat -plunt | grep tcp | wc -l | xargs) -ne 0 ]; do sleep 1; done&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">  </span><span class="c"># èµ„æºè¯·æ±‚ä¸é™åˆ¶</span><span class="w">
</span><span class="w">          </span><span class="c"># å¯¹äºæ ¸å¿ƒæœåŠ¡ï¼Œå»ºè®®è®¾ç½® requests = limitsï¼Œé¿å…èµ„æºç«äº‰</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># HPA ä¼šä½¿ç”¨ requests è®¡ç®—èµ„æºåˆ©ç”¨ç‡</span><span class="w">
</span><span class="w">            </span><span class="c"># å»ºè®®å°† requests è®¾ä¸ºæœåŠ¡æ­£å¸¸çŠ¶æ€ä¸‹çš„ CPU ä½¿ç”¨ç‡ï¼ŒHPA çš„ç›®å‰æŒ‡æ ‡è®¾ä¸º 80%</span><span class="w">
</span><span class="w">            </span><span class="c"># æ‰€æœ‰å®¹å™¨çš„ requests æ€»é‡ä¸å»ºè®®ä¸º 2c/4G 4c/8G ç­‰å¸¸è§å€¼ï¼Œå› ä¸ºèŠ‚ç‚¹é€šå¸¸ä¹Ÿæ˜¯è¿™ä¸ªé…ç½®ï¼Œè¿™ä¼šå¯¼è‡´ Pod åªèƒ½è°ƒåº¦åˆ°æ›´å¤§çš„èŠ‚ç‚¹ä¸Šï¼Œé€‚å½“è°ƒå° requests ç­‰æ‰©å……å¯ç”¨çš„èŠ‚ç‚¹ç±»å‹ï¼Œä»è€Œæ‰©å……èŠ‚ç‚¹æ± ã€‚ </span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># limits - requests ä¸ºå…è®¸è¶…å–çš„èµ„æºé‡ï¼Œå»ºè®®ä¸º requests çš„ 1 åˆ° 2 å€ï¼Œé…Œæƒ…é…ç½®ã€‚</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># å°†å®¹å™¨å±‚è®¾ä¸ºåªè¯»ï¼Œé˜²æ­¢å®¹å™¨æ–‡ä»¶è¢«ç¯¡æ”¹</span><span class="w">
</span><span class="w">          </span><span class="c">## å¦‚æœéœ€è¦å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå»ºè®®é¢å¤–æŒ‚è½½ emptyDir æ¥æä¾›å¯è¯»å†™çš„æ•°æ®å·</span><span class="w">
</span><span class="w">          </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">          </span><span class="c"># ç¦æ­¢ Pod åšä»»ä½•æƒé™æå‡</span><span class="w">
</span><span class="w">          </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">          </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># drop ALL çš„æƒé™æ¯”è¾ƒä¸¥æ ¼ï¼Œå¯æŒ‰éœ€ä¿®æ”¹</span><span class="w">
</span><span class="w">            </span><span class="nt">drop</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">ALL</span><span class="w">
</span><span class="w">        </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w">  </span><span class="c"># è¦æ±‚ kubernetes 1.18+</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç›´æ¥ä½¿ç”¨å¥åº·æ£€æŸ¥æ¥å£å³å¯</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">  </span><span class="c"># æœ€å¤šæä¾›ç»™æœåŠ¡ 5s * 20 çš„å¯åŠ¨æ—¶é—´</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># spring çš„é€šç”¨å¥åº·æ£€æŸ¥è·¯å¾„</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="c"># Readiness probes are very important for a RollingUpdate to work properly,</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç®€å•èµ·è§å¯ç›´æ¥ä½¿ç”¨ livenessProbe ç›¸åŒçš„æ¥å£ï¼Œå½“ç„¶ä¹Ÿå¯é¢å¤–å®šä¹‰</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Utilization</span><span class="w">
</span><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">70</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">policy/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodDisruptionBudget</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">minAvailable</span><span class="p">:</span><span class="w"> </span><span class="m">75</span><span class="l">%</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¸€ä¼˜é›…åœæ­¢gracful-shutdownä¸-502504-æŠ¥é”™">ä¸€ã€ä¼˜é›…åœæ­¢ï¼ˆGracful Shutdownï¼‰ä¸ 502/504 æŠ¥é”™</h2>
<p>å¦‚æœ Pod æ­£åœ¨å¤„ç†å¤§é‡è¯·æ±‚ï¼ˆæ¯”å¦‚ 1000 QPS+ï¼‰æ—¶ï¼Œå› ä¸ºèŠ‚ç‚¹æ•…éšœæˆ–ã€Œç«ä»·èŠ‚ç‚¹ã€è¢«å›æ”¶ç­‰åŸå› è¢«é‡æ–°è°ƒåº¦ï¼Œ
ä½ å¯èƒ½ä¼šè§‚å¯Ÿåˆ°åœ¨å®¹å™¨è¢« terminate çš„ä¸€æ®µæ—¶é—´å†…å‡ºç°å°‘é‡ 502/504ã€‚</p>
<p>ä¸ºäº†ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å…ˆç†è§£æ¸…æ¥š terminate ä¸€ä¸ª Pod çš„æµç¨‹ï¼š</p>
<ol>
<li>Pod çš„çŠ¶æ€è¢«è®¾ä¸ºã€ŒTerminatingã€ï¼Œï¼ˆå‡ ä¹ï¼‰åŒæ—¶è¯¥ Pod è¢«ä»æ‰€æœ‰å…³è”çš„ Service Endpoints ä¸­ç§»é™¤</li>
<li><code>preStop</code> é’©å­è¢«æ‰§è¡Œï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œæˆ–è€…ä¸€ä¸ªå¯¹ Pod ä¸­å®¹å™¨çš„ http è°ƒç”¨
<ol>
<li>å¦‚æœä½ çš„ç¨‹åºåœ¨æ”¶åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œæ— æ³•ä¼˜é›…é€€å‡ºï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>preStop</code></li>
<li>å¦‚æœè®©ç¨‹åºæœ¬èº«æ”¯æŒä¼˜é›…é€€å‡ºæ¯”è¾ƒéº»çƒ¦çš„è¯ï¼Œç”¨ <code>preStop</code> å®ç°ä¼˜é›…é€€å‡ºæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹å¼</li>
</ol>
</li>
<li>å°† SIGTERM å‘é€ç»™ Pod ä¸­çš„æ‰€æœ‰å®¹å™¨</li>
<li>ç»§ç»­ç­‰å¾…ï¼Œç›´åˆ°è¶…è¿‡ <code>spec.terminationGracePeriodSeconds</code> è®¾å®šå¥½çš„æ—¶é—´ï¼Œè¿™ä¸ªå€¼é»˜è®¤ä¸º 30s
<ol>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä¼˜é›…é€€å‡ºçš„ç­‰å¾…è®¡æ—¶æ˜¯ä¸ <code>preStop</code> åŒæ­¥å¼€å§‹çš„ï¼è€Œä¸”å®ƒä¹Ÿä¸ä¼šç­‰å¾… <code>preStop</code> ç»“æŸï¼</li>
</ol>
</li>
<li>å¦‚æœè¶…è¿‡äº† <code>spec.terminationGracePeriodSeconds</code> å®¹å™¨ä»ç„¶æ²¡æœ‰åœæ­¢ï¼Œk8s å°†ä¼šå‘é€ SIGKILL ä¿¡å·ç»™å®¹å™¨</li>
<li>è¿›ç¨‹å…¨éƒ¨ç»ˆæ­¢åï¼Œæ•´ä¸ª Pod å®Œå…¨è¢«æ¸…ç†æ‰</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼š1 å’Œ 2 ä¸¤ä¸ªå·¥ä½œæ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°ã€ŒPod è¿˜åœ¨ Service Endpoints ä¸­ï¼Œä½†æ˜¯ <code>preStop</code> å·²ç»æ‰§è¡Œäº†ã€çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°è¿™ç§çŠ¶å†µçš„å‘ç”Ÿã€‚</p>
<p>äº†è§£äº†ä¸Šé¢çš„æµç¨‹åï¼Œæˆ‘ä»¬å°±èƒ½åˆ†æå‡ºä¸¤ç§é”™è¯¯ç å‡ºç°çš„åŸå› ï¼š</p>
<ul>
<li>502ï¼šåº”ç”¨ç¨‹åºåœ¨æ”¶åˆ° SIGTERM ä¿¡å·åç›´æ¥ç»ˆæ­¢äº†è¿è¡Œï¼Œå¯¼è‡´éƒ¨åˆ†è¿˜æ²¡æœ‰è¢«å¤„ç†å®Œçš„è¯·æ±‚ç›´æ¥ä¸­æ–­ï¼Œä»£ç†å±‚è¿”å› 502 è¡¨ç¤ºè¿™ç§æƒ…å†µ</li>
<li>504ï¼šService Endpoints ç§»é™¤ä¸å¤ŸåŠæ—¶ï¼Œåœ¨ Pod å·²ç»è¢«ç»ˆæ­¢åï¼Œä»ç„¶æœ‰ä¸ªåˆ«è¯·æ±‚è¢«è·¯ç”±åˆ°äº†è¯¥ Podï¼Œå¾—ä¸åˆ°å“åº”å¯¼è‡´ 504</li>
</ul>
<p>é€šå¸¸çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåœ¨ Pod çš„ <code>preStop</code> æ­¥éª¤åŠ ä¸€ä¸ª 15s çš„ç­‰å¾…æ—¶é—´ã€‚
å…¶åŸç†æ˜¯ï¼šåœ¨ Pod å¤„ç† terminating çŠ¶æ€çš„æ—¶å€™ï¼Œå°±ä¼šè¢«ä» Service Endpoints ä¸­ç§»é™¤ï¼Œä¹Ÿå°±ä¸ä¼šå†æœ‰æ–°çš„è¯·æ±‚è¿‡æ¥äº†ã€‚
åœ¨ <code>preStop</code> ç­‰å¾… 15sï¼ŒåŸºæœ¬å°±èƒ½ä¿è¯æ‰€æœ‰çš„è¯·æ±‚éƒ½åœ¨å®¹å™¨æ­»æ‰ä¹‹å‰è¢«å¤„ç†å®Œæˆï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚çš„å¤„ç†æ—¶é—´éƒ½åœ¨ 300ms ä»¥å†…å§ï¼‰ã€‚</p>
<p>ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹ï¼Œå®ƒä½¿ Pod è¢«ç»ˆæ­¢æ—¶ï¼Œæ€»æ˜¯å…ˆç­‰å¾… 15sï¼Œå†å‘é€ SIGTERM ä¿¡å·ç»™å®¹å™¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="c"># æ·»åŠ ä¸‹é¢è¿™éƒ¨åˆ†</span><span class="w">
</span><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">/bin/sleep</span><span class="w">
</span><span class="w">            </span>- <span class="s2">&#34;15&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>æ›´å¥½çš„è§£å†³åŠæ³•ï¼Œæ˜¯ç›´æ¥ç­‰å¾…æ‰€æœ‰ tcp è¿æ¥éƒ½å…³é—­ï¼ˆéœ€è¦é•œåƒä¸­æœ‰ netstatï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="c"># æ·»åŠ ä¸‹é¢è¿™éƒ¨åˆ†</span><span class="w">
</span><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">/bin/sh</span><span class="w">
</span><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span><span class="w">            </span>- <span class="s2">&#34;while [ $(netstat -plunt | grep tcp | wc -l | xargs) -ne 0 ]; do sleep 1; done&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="k8s-istio-pod-prestop">å¦‚æœæˆ‘çš„æœåŠ¡è¿˜ä½¿ç”¨äº† Sidecar ä»£ç†ç½‘ç»œè¯·æ±‚ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ</h3>
<p>ä»¥æœåŠ¡ç½‘æ ¼ Istio ä¸ºä¾‹ï¼Œåœ¨ Envoy ä»£ç†äº† Pod æµé‡çš„æƒ…å†µä¸‹ï¼Œ502/504 çš„é—®é¢˜ä¼šå˜å¾—æ›´å¤æ‚ä¸€ç‚¹â€”â€”è¿˜éœ€è¦è€ƒè™‘ Sidecar ä¸ä¸»å®¹å™¨çš„å…³é—­é¡ºåºï¼š</p>
<ul>
<li>å¦‚æœåœ¨ Envoy å·²å…³é—­åï¼Œæœ‰æ–°çš„è¯·æ±‚å†è¿›æ¥ï¼Œå°†ä¼šå¯¼è‡´ 504ï¼ˆæ²¡äººå“åº”è¿™ä¸ªè¯·æ±‚äº†ï¼‰
<ul>
<li>æ‰€ä»¥ Envoy æœ€å¥½åœ¨ Terminating è‡³å°‘ 3s åæ‰èƒ½å…³ï¼Œç¡®ä¿ Istio ç½‘æ ¼é…ç½®å·²å®Œå…¨æ›´æ–°</li>
</ul>
</li>
<li>å¦‚æœåœ¨ Envoy è¿˜æ²¡åœæ­¢æ—¶ï¼Œä¸»å®¹å™¨å…ˆå…³é—­ï¼Œç„¶ååˆæœ‰æ–°çš„è¯·æ±‚å†è¿›æ¥ï¼ŒEnvoy å°†å› ä¸ºæ— æ³•è¿æ¥åˆ° upstream å¯¼è‡´ 503
<ul>
<li>æ‰€ä»¥ä¸»å®¹å™¨ä¹Ÿæœ€å¥½åœ¨ Terminating è‡³å°‘ 3s åï¼Œæ‰èƒ½å…³é—­ã€‚</li>
</ul>
</li>
<li>å¦‚æœä¸»å®¹å™¨å¤„ç†è¿˜æœªå¤„ç†å®Œé—ç•™è¯·æ±‚æ—¶ï¼ŒEnvoy æˆ–è€…ä¸»å®¹å™¨çš„å…¶ä¸­ä¸€ä¸ªåœæ­¢äº†ï¼Œä¼šå› ä¸º tcp è¿æ¥ç›´æ¥æ–­å¼€è¿æ¥å¯¼è‡´ 502
<ul>
<li>å› æ­¤ Envoy å¿…é¡»åœ¨ä¸»å®¹å™¨å¤„ç†å®Œé—ç•™è¯·æ±‚åï¼ˆå³æ²¡æœ‰ tcp è¿æ¥æ—¶ï¼‰ï¼Œæ‰èƒ½å…³é—­</li>
</ul>
</li>
</ul>
<p>æ‰€ä»¥æ€»ç»“ä¸‹ï¼šEnvoy åŠä¸»å®¹å™¨çš„ <code>preStop</code> éƒ½è‡³å°‘å¾—è®¾æˆ 3sï¼Œå¹¶ä¸”åœ¨ã€Œæ²¡æœ‰ tcp è¿æ¥ã€æ—¶ï¼Œæ‰èƒ½å…³é—­ï¼Œé¿å…å‡ºç° 502/503/504.</p>
<p>ä¸»å®¹å™¨çš„ä¿®æ”¹æ–¹æ³•åœ¨å‰æ–‡ä¸­å·²ç»å†™è¿‡äº†ï¼Œä¸‹é¢ä»‹ç»ä¸‹ Envoy çš„ä¿®æ”¹æ–¹æ³•ã€‚</p>
<p>å’Œä¸»å®¹å™¨ä¸€æ ·ï¼ŒEnvoy ä¹Ÿèƒ½ç›´æ¥åŠ  <code>preStop</code>ï¼Œä¿®æ”¹ <code>istio-sidecar-injector</code> è¿™ä¸ª <code>configmap</code>ï¼Œåœ¨ sidecar é‡Œæ·»åŠ  preStop sleep å‘½ä»¤:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-proxy</span><span class="w">
</span><span class="w">      </span><span class="c"># æ·»åŠ ä¸‹é¢è¿™éƒ¨åˆ†</span><span class="w">
</span><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">/bin/sh</span><span class="w">
</span><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span><span class="w">            </span>- <span class="s2">&#34;while [ $(netstat -plunt | grep tcp | grep -v envoy | wc -l | xargs) -ne 0 ]; do sleep 1; done&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace" target="_blank" rel="noopener noreferrer">Kubernetes best practices: terminating with grace</a></li>
<li><a href="https://medium.com/flant-com/kubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2" target="_blank" rel="noopener noreferrer">Graceful shutdown in Kubernetes is not always trivial</a></li>
</ul>
<h2 id="k8s-hpa">äºŒã€æœåŠ¡çš„ä¼¸ç¼©é…ç½® - HPA</h2>
<p>Kubernetes å®˜æ–¹ä¸»è¦æ”¯æŒåŸºäº Pod CPU çš„ä¼¸ç¼©ï¼Œè¿™æ˜¯åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¼¸ç¼©æŒ‡æ ‡ï¼Œéœ€è¦éƒ¨ç½² <a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noopener noreferrer">metrics-server</a> æ‰å¯ä½¿ç”¨ã€‚</p>
<p>å…ˆå›é¡¾ä¸‹å‰é¢ç»™å‡ºçš„ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2 </span><span class="w"> </span><span class="c"># k8s 1.23+ æ­¤ API å·²ç» GA</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Utilization</span><span class="w">
</span><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">70</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="1-å½“å‰æŒ‡æ ‡å€¼çš„è®¡ç®—æ–¹å¼">1. å½“å‰æŒ‡æ ‡å€¼çš„è®¡ç®—æ–¹å¼</h3>
<p>HPA é»˜è®¤ä½¿ç”¨ Pod çš„å½“å‰æŒ‡æ ‡è¿›è¡Œè®¡ç®—ï¼Œä»¥ CPU ä¸ºä¾‹ï¼Œå…¶è®¡ç®—å…¬å¼ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ã€ŒPod çš„ CPU åˆ©ç”¨ç‡ã€= 100% * ã€Œæ‰€æœ‰ Container çš„ CPU ç”¨é‡ä¹‹å’Œã€/ã€Œæ‰€æœ‰ Container çš„ CPU requests ä¹‹å’Œã€
</code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ†æ¯æ˜¯æ€»çš„ requests é‡ï¼Œè€Œä¸æ˜¯ limits.</p>
<h4 id="11-å­˜åœ¨çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•">1.1 å­˜åœ¨çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•</h4>
<p>åœ¨ Pod åªæœ‰ä¸€ä¸ªå®¹å™¨æ—¶è¿™æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯å½“ Pod æ³¨å…¥äº† envoy ç­‰ sidecar æ—¶ï¼Œè¿™å°±ä¼šæœ‰é—®é¢˜äº†ã€‚</p>
<p>å› ä¸º Istio çš„ Sidecar requests é»˜è®¤ä¸º <code>100m</code> ä¹Ÿå°±æ˜¯ 0.1 æ ¸ã€‚
åœ¨æœª tuning çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡è´Ÿè½½ä¸€é«˜ï¼Œsidecar çš„å®é™…ç”¨é‡å¾ˆå®¹æ˜“å°±èƒ½æ¶¨åˆ° 0.2-0.4 æ ¸ã€‚
æŠŠè¿™ä¸¤ä¸ªå€¼ä»£å…¥å‰é¢çš„å…¬å¼ï¼Œä¼šå‘ç° <strong>å¯¹äº QPS è¾ƒé«˜çš„æœåŠ¡ï¼Œæ·»åŠ  Sidecar åï¼Œã€ŒPod çš„ CPU åˆ©ç”¨ç‡ã€å¯èƒ½ä¼šé«˜äºã€Œåº”ç”¨å®¹å™¨çš„ CPU åˆ©ç”¨ç‡ã€</strong>ï¼Œé€ æˆä¸å¿…è¦çš„æ‰©å®¹ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>æ–¹æ³•ä¸€ï¼šé’ˆå¯¹æ¯ä¸ªæœåŠ¡çš„ CPU ä½¿ç”¨æƒ…å†µï¼Œä¸º sidecar è®¾ç½®ä¸åŒçš„ requests/limits</li>
<li>æ–¹æ³•äºŒï¼šä½¿ç”¨ KEDA ç­‰ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œè·å–åˆ°åº”ç”¨ç¨‹åºçš„ CPU åˆ©ç”¨ç‡ï¼ˆæ’é™¤æ‰ Sidecarï¼‰ï¼Œä½¿ç”¨å®ƒè¿›è¡Œæ‰©ç¼©å®¹</li>
<li>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ k8s 1.20 æä¾›çš„ alpha ç‰¹æ€§ï¼š<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#container-resource-metrics" target="_blank" rel="noopener noreferrer">Container Resourse Metrics</a>.</li>
</ul>
<h4 id="2-hpa-çš„æ‰©ç¼©å®¹ç®—æ³•">2. HPA çš„æ‰©ç¼©å®¹ç®—æ³•</h4>
<p>HPA ä»€ä¹ˆæ—¶å€™ä¼šæ‰©å®¹ï¼Œè¿™ä¸€ç‚¹æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ä½†æ˜¯ HPA çš„ç¼©å®¹ç­–ç•¥ï¼Œä¼šæœ‰äº›è¿·æƒ‘ï¼Œä¸‹é¢ç®€å•åˆ†æä¸‹ã€‚</p>
<ol>
<li>HPA çš„ã€Œç›®æ ‡æŒ‡æ ‡ã€å¯ä»¥ä½¿ç”¨ä¸¤ç§å½¢å¼ï¼šç»å¯¹åº¦é‡æŒ‡æ ‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚
<ul>
<li>ç»å¯¹åº¦é‡æŒ‡æ ‡ï¼šæ¯”å¦‚ CPUï¼Œå°±æ˜¯è®¾å®šç»å¯¹æ ¸æ•°ã€‚</li>
<li>èµ„æºåˆ©ç”¨ç‡ï¼ˆèµ„æºä½¿ç”¨é‡/èµ„æºè¯·æ±‚ * 100%ï¼‰ï¼šåœ¨ Pod è®¾ç½®äº†èµ„æºè¯·æ±‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨èµ„æºåˆ©ç”¨ç‡è¿›è¡Œ Pod ä¼¸ç¼©ã€‚</li>
</ul>
</li>
<li>HPA çš„ã€Œå½“å‰æŒ‡æ ‡ã€æ˜¯ä¸€æ®µæ—¶é—´å†…æ‰€æœ‰ Pods çš„å¹³å‡å€¼ï¼Œä¸æ˜¯å³°å€¼ã€‚Pod çš„æŒ‡æ ‡æ˜¯å…¶ä¸­æ‰€æœ‰å®¹å™¨æŒ‡æ ‡ä¹‹å’Œã€‚</li>
</ol>
<p>HPA çš„æ‰©ç¼©å®¹ç®—æ³•ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">æœŸæœ›å‰¯æœ¬æ•° = ceil[å½“å‰å‰¯æœ¬æ•° * ( å½“å‰æŒ‡æ ‡ / ç›®æ ‡æŒ‡æ ‡ )]
</code></pre></td></tr></table>
</div>
</div><p>ä»ä¸Šé¢çš„å‚æ•°å¯ä»¥çœ‹åˆ°ï¼š</p>
<ol>
<li>åªè¦ã€Œå½“å‰æŒ‡æ ‡ã€è¶…è¿‡äº†ç›®æ ‡æŒ‡æ ‡ï¼Œå°±ä¸€å®šä¼šå‘ç”Ÿæ‰©å®¹ã€‚</li>
<li><code>å½“å‰æŒ‡æ ‡ / ç›®æ ‡æŒ‡æ ‡</code>è¦å°åˆ°ä¸€å®šçš„ç¨‹åº¦ï¼Œæ‰ä¼šè§¦å‘ç¼©å®¹ã€‚
<ol>
<li>æ¯”å¦‚åŒå‰¯æœ¬çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°æ¯”å€¼è¦å°äºç­‰äº 1/2ï¼Œæ‰ä¼šç¼©å®¹åˆ°å•å‰¯æœ¬ã€‚</li>
<li>ä¸‰å‰¯æœ¬çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°æ¯”å€¼çš„ä¸´ç•Œç‚¹æ˜¯ 2/3ã€‚</li>
<li>äº”å‰¯æœ¬æ—¶ä¸´ç•Œå€¼æ˜¯ 4/5ï¼Œ100å‰¯æœ¬æ—¶ä¸´ç•Œå€¼æ˜¯ 99/100ï¼Œä¾æ­¤ç±»æ¨ã€‚</li>
<li>å¦‚æœ <code>å½“å‰æŒ‡æ ‡ / ç›®æ ‡æŒ‡æ ‡</code> ä» 1 é™åˆ° 0.5ï¼Œå‰¯æœ¬çš„æ•°é‡å°†ä¼šå‡åŠã€‚ï¼ˆè™½ç„¶è¯´å‰¯æœ¬æ•°è¶Šå¤šï¼Œå‘ç”Ÿè¿™ä¹ˆå¤§å˜åŒ–çš„å¯èƒ½æ€§å°±è¶Šå°ã€‚ï¼‰</li>
</ol>
</li>
<li><code>å½“å‰å‰¯æœ¬æ•° / ç›®æ ‡æŒ‡æ ‡</code>çš„å€¼è¶Šå¤§ï¼Œã€Œå½“å‰æŒ‡æ ‡ã€çš„æ³¢åŠ¨å¯¹ã€ŒæœŸæœ›å‰¯æœ¬æ•°ã€çš„å½±å“å°±è¶Šå¤§ã€‚</li>
</ol>
<p>ä¸ºäº†é˜²æ­¢æ‰©ç¼©å®¹è¿‡äºæ•æ„Ÿï¼Œå®ƒè¿˜æœ‰å‡ ä¸ªå»¶æ—¶ç›¸å…³çš„å‚æ•°ï¼š</p>
<ol>
<li>HPA Loop å»¶æ—¶ï¼šé»˜è®¤ 15 ç§’ï¼Œæ¯ 15 ç§’é’Ÿè¿›è¡Œä¸€æ¬¡ HPA æ‰«æã€‚</li>
<li><code>--horizontal-pod-autoscaler-cpu-initialization-period</code>:</li>
<li>ç¼©å®¹å†·å´æ—¶é—´ï¼šé»˜è®¤ 5 åˆ†é’Ÿã€‚</li>
</ol>
<h3 id="3-hpa-çš„æœŸæœ›å€¼è®¾æˆå¤šå°‘åˆé€‚">3. HPA çš„æœŸæœ›å€¼è®¾æˆå¤šå°‘åˆé€‚</h3>
<p>è¿™ä¸ªéœ€è¦é’ˆå¯¹æ¯ä¸ªæœåŠ¡çš„å…·ä½“æƒ…å†µï¼Œå…·ä½“åˆ†æã€‚</p>
<p>ä»¥æœ€å¸¸ç”¨çš„æŒ‰ CPU å€¼ä¼¸ç¼©ä¸ºä¾‹ï¼Œ</p>
<ul>
<li>æ ¸å¿ƒæœåŠ¡
<ul>
<li>requests/limits å€¼: å»ºè®®è®¾æˆç›¸ç­‰çš„ï¼Œä¿è¯<a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/" target="_blank" rel="noopener noreferrer">æœåŠ¡è´¨é‡ç­‰çº§</a>ä¸º Guaranteed
<ul>
<li>éœ€è¦æ³¨æ„ CPU è·Ÿ Memory çš„ limits é™åˆ¶ç­–ç•¥æ˜¯ä¸åŒçš„ï¼ŒCPU æ˜¯çœŸæ­£åœ°é™åˆ¶äº†ä¸Šé™ï¼Œè€Œ Memory æ˜¯ç”¨è¶…äº†å°±å¹²æ‰å®¹å™¨ï¼ˆOOMKilledï¼‰</li>
<li>k8s ä¸€ç›´ä½¿ç”¨ cgroups v1 (<code>cpu_shares</code>/<code>memory.limit_in_bytes</code>)æ¥é™åˆ¶ cpu/memoryï¼Œä½†æ˜¯å¯¹äº <code>Guaranteed</code> çš„ Pods è€Œè¨€ï¼Œå†…å­˜å¹¶ä¸èƒ½å®Œå…¨é¢„ç•™ï¼Œèµ„æºç«äº‰æ€»æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„ã€‚1.22 æœ‰ alpha ç‰¹æ€§æ”¹ç”¨ cgroups v2ï¼Œå¯ä»¥å…³æ³¨ä¸‹ã€‚</li>
</ul>
</li>
<li>HPA: ä¸€èˆ¬æ¥è¯´ï¼ŒæœŸæœ›å€¼è®¾ä¸º 60% åˆ° 70% å¯èƒ½æ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œæœ€å°å‰¯æœ¬æ•°å»ºè®®è®¾ä¸º 2 - 5. ï¼ˆä»…ä¾›å‚è€ƒï¼‰</li>
<li>PodDisruptionBudget: å»ºè®®æŒ‰æœåŠ¡çš„å¥å£®æ€§ä¸ HPA æœŸæœ›å€¼ï¼Œæ¥è®¾ç½® PDBï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œå°±å…ˆç•¥è¿‡äº†</li>
</ul>
</li>
<li>éæ ¸å¿ƒæœåŠ¡
<ul>
<li>requests/limits å€¼: å»ºè®® requests è®¾ä¸º limits çš„ 0.6 - 0.9 å€ï¼ˆä»…ä¾›å‚è€ƒï¼‰ï¼Œå¯¹åº”çš„æœåŠ¡è´¨é‡ç­‰çº§ä¸º Burstable
<ul>
<li>ä¹Ÿå°±æ˜¯è¶…å–äº†èµ„æºï¼Œè¿™æ ·åšä¸»è¦çš„è€ƒé‡ç‚¹æ˜¯ï¼Œå¾ˆå¤šéæ ¸å¿ƒæœåŠ¡è´Ÿè½½éƒ½å¾ˆä½ï¼Œæ ¹æœ¬è·‘ä¸åˆ° limits è¿™ä¹ˆé«˜ï¼Œé™ä½ requests å¯ä»¥æé«˜é›†ç¾¤èµ„æºåˆ©ç”¨ç‡ï¼Œä¹Ÿä¸ä¼šæŸå®³æœåŠ¡ç¨³å®šæ€§ã€‚</li>
</ul>
</li>
<li>HPA: å› ä¸º requests é™ä½äº†ï¼Œæˆ‘ä»¬å¯ä»¥æé«˜ HPA åˆ°æœŸæœ›å€¼ï¼Œæ¯”å¦‚ 80% ~ 90%ï¼Œæœ€å°å‰¯æœ¬æ•°å»ºè®®è®¾ä¸º 1 - 3. ï¼ˆä»…ä¾›å‚è€ƒï¼‰</li>
<li>PodDisruptionBudget: éæ ¸å¿ƒæœåŠ¡å˜›ï¼Œä¿è¯æœ€å°‘å‰¯æœ¬æ•°ä¸º 1 å°±è¡Œäº†ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-hpa-çš„å¸¸è§é—®é¢˜">4. HPA çš„å¸¸è§é—®é¢˜</h3>
<h4 id="41-pod-æ‰©å®¹---é¢„çƒ­é™·é˜±">4.1. Pod æ‰©å®¹ - é¢„çƒ­é™·é˜±</h4>
<blockquote>
<p>é¢„çƒ­ï¼šJava/C# è¿™ç±»è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šçš„è¯­è¨€ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ°æŸäº›åŠŸèƒ½æ—¶ï¼Œå¾€å¾€éœ€è¦åˆå§‹åŒ–ä¸€äº›èµ„æºï¼Œä¾‹å¦‚ã€ŒJIT å³æ—¶ç¼–è¯‘ã€ã€‚
å¦‚æœä»£ç é‡Œè¿˜åº”ç”¨äº†åŠ¨æ€ç±»åŠ è½½ä¹‹ç±»çš„åŠŸèƒ½ï¼Œå°±å¾ˆå¯èƒ½å¯¼è‡´å¾®æœåŠ¡æŸäº› API ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œå“åº”ç‰¹åˆ«æ…¢ï¼ˆè¦åŠ¨æ€ç¼–è¯‘ classï¼‰ã€‚
å› æ­¤ Pod åœ¨æä¾›æœåŠ¡å‰ï¼Œéœ€è¦æå‰ã€Œé¢„çƒ­ï¼ˆslow_startï¼‰ã€ä¸€æ¬¡è¿™äº›æ¥å£ï¼Œå°†éœ€è¦ç”¨åˆ°çš„èµ„æºæå‰åˆå§‹åŒ–å¥½ã€‚</p>
</blockquote>
<p>åœ¨è´Ÿè½½å¾ˆé«˜çš„æƒ…å†µä¸‹ï¼ŒHPA ä¼šè‡ªåŠ¨æ‰©å®¹ã€‚
ä½†æ˜¯å¦‚æœæ‰©å®¹çš„ Pod éœ€è¦é¢„çƒ­ï¼Œå°±å¯èƒ½ä¼šé‡åˆ°ã€Œé¢„çƒ­é™·é˜±ã€ã€‚</p>
<p>åœ¨æœ‰å¤§é‡ç”¨æˆ·è®¿é—®çš„æ—¶å€™ï¼Œä¸è®ºä½¿ç”¨ä½•ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œåªè¦è¯·æ±‚è¢«è½¬å‘åˆ°æ–°å»ºçš„ Pod ä¸Šï¼Œè¿™ä¸ªè¯·æ±‚å°±ä¼šã€Œå¡ä½ã€ã€‚
å¦‚æœè¯·æ±‚é€Ÿåº¦å¤ªå¿«ï¼ŒPod å¯åŠ¨çš„ç¬é—´ã€Œå¡ä½ã€çš„è¯·æ±‚å°±è¶Šå¤šï¼Œè¿™å°†ä¼šå¯¼è‡´æ–°å»º Pod å› ä¸ºå‹åŠ›è¿‡å¤§è€Œå®æ‰ã€‚
ç„¶å Pod ä¸€é‡å¯å°±è¢«å‹å®ï¼Œè¿›å…¥ CrashLoopBackoff å¾ªç¯ã€‚</p>
<p>å¦‚æœæ˜¯åœ¨ä½¿ç”¨å¤šçº¿ç¨‹åšè´Ÿè½½æµ‹è¯•æ—¶ï¼Œæ•ˆæœæ›´æ˜æ˜¾ï¼š50 ä¸ªçº¿ç¨‹åœ¨ä¸é—´æ–­åœ°è¯·æ±‚ï¼Œ
åˆ«çš„ Pod å“åº”æ—¶é—´æ˜¯ã€Œæ¯«ç§’çº§ã€ï¼Œè€Œæ–°å»ºçš„ Pod çš„é¦–æ¬¡å“åº”æ˜¯ã€Œç§’çº§ã€ã€‚å‡ ä¹æ˜¯ä¸€ç¬é—´ï¼Œ50 ä¸ªçº¿ç¨‹å°±ä¼šå…¨éƒ¨é™·åœ¨æ–°å»ºçš„ Pod è¿™é‡Œã€‚
è€Œæ–°å»ºçš„ Pod åœ¨å¯åŠ¨çš„ç¬é—´å¯èƒ½ç‰¹åˆ«è„†å¼±ï¼Œç¬é—´çš„ 50 ä¸ªå¹¶å‘è¯·æ±‚å°±å¯ä»¥å°†å®ƒå‹å®ã€‚
ç„¶å Pod ä¸€é‡å¯å°±è¢«å‹å®ï¼Œè¿›å…¥ CrashLoopBackoff å¾ªç¯ã€‚</p>
<p><strong>è§£å†³æ–¹æ³•</strong>ï¼š</p>
<p>å¯ä»¥åœ¨ã€Œåº”ç”¨å±‚é¢ã€è§£å†³ï¼š</p>
<ol>
<li>åœ¨å¯åŠ¨æ¢é’ˆ API çš„åç«¯æ§åˆ¶å™¨é‡Œé¢ï¼Œä¾æ¬¡è°ƒç”¨æ‰€æœ‰éœ€è¦é¢„çƒ­çš„æ¥å£æˆ–è€…å…¶ä»–æ–¹å¼ï¼Œæå‰åˆå§‹åŒ–å¥½æ‰€æœ‰èµ„æºã€‚
<ol>
<li>å¯åŠ¨æ¢é’ˆçš„æ§åˆ¶å™¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ <code>localhost</code> å›ç¯åœ°å€è°ƒç”¨å®ƒè‡ªèº«çš„æ¥å£ã€‚</li>
</ol>
</li>
<li>ä½¿ç”¨ã€ŒAOT é¢„ç¼–è¯‘ã€æŠ€æœ¯ï¼šé¢„çƒ­ï¼Œé€šå¸¸éƒ½æ˜¯å› ä¸ºã€ŒJIT å³æ—¶ç¼–è¯‘ã€å¯¼è‡´çš„é—®é¢˜ï¼Œåœ¨éœ€è¦ç”¨åˆ°æ—¶å®ƒæ‰ç¼–è¯‘ã€‚è€Œ AOT æ˜¯é¢„å…ˆç¼–è¯‘ï¼Œåœ¨ä½¿ç”¨å‰å®Œæˆç¼–è¯‘ï¼Œå› æ­¤ AOT èƒ½è§£å†³é¢„çƒ­çš„é—®é¢˜ã€‚</li>
</ol>
<p>ä¹Ÿå¯ä»¥åœ¨ã€ŒåŸºç¡€è®¾æ–½å±‚é¢ã€è§£å†³ï¼š</p>
<ol>
<li>åƒ AWS ALB TargetGroup ä»¥åŠå…¶ä»–äº‘æœåŠ¡å•†çš„ ALB æœåŠ¡ï¼Œé€šå¸¸éƒ½å¯ä»¥è®¾ç½® <code>slow_start</code> æ—¶é•¿ï¼Œå³å¯¹æ–°åŠ å…¥çš„å®ä¾‹ï¼Œä½¿ç”¨ä¸€å®šæ—¶é—´æ…¢æ…¢åœ°æŠŠæµé‡åˆ‡è¿‡å»ï¼Œæœ€ç»ˆè¾¾åˆ°é¢„æœŸçš„è´Ÿè½½å‡è¡¡çŠ¶æ€ã€‚è¿™ä¸ªå¯ä»¥è§£å†³æœåŠ¡é¢„çƒ­é—®é¢˜ã€‚</li>
<li>Envoy ä¹Ÿå·²ç»æ”¯æŒ <code>slow_start</code> æ¨¡å¼ï¼Œæ”¯æŒåœ¨ä¸€ä¸ªè®¾ç½®å¥½çš„æ—¶é—´çª—å£å†…ï¼ŒæŠŠæµé‡æ…¢æ…¢è´Ÿè½½åˆ°æ–°åŠ å…¥çš„å®ä¾‹ä¸Šï¼Œè¾¾æˆé¢„çƒ­æ•ˆæœã€‚</li>
</ol>
<h4 id="42-hpa-æ‰©ç¼©å®¹è¿‡äºæ•æ„Ÿå¯¼è‡´-pod-æ•°é‡éœ‡è¡">4.2. HPA æ‰©ç¼©å®¹è¿‡äºæ•æ„Ÿï¼Œå¯¼è‡´ Pod æ•°é‡éœ‡è¡</h4>
<p>é€šå¸¸æ¥è®²ï¼ŒEKS ä¸Šç»å¤§éƒ¨åˆ†è´Ÿè½½éƒ½åº”è¯¥é€‰æ‹©ä½¿ç”¨ CPU è¿›è¡Œæ‰©ç¼©å®¹ã€‚å› ä¸º CPU é€šå¸¸èƒ½å¾ˆå¥½çš„åæ˜ æœåŠ¡çš„è´Ÿè½½æƒ…å†µ</p>
<p>ä½†æ˜¯æœ‰äº›æœåŠ¡ä¼šå­˜åœ¨å…¶ä»–å½±å“ CPU ä½¿ç”¨ç‡çš„å› ç´ ï¼Œå¯¼è‡´ä½¿ç”¨ CPU æ‰©ç¼©å®¹å˜å¾—ä¸é‚£ä¹ˆå¯é ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æœ‰äº› Java æœåŠ¡å †å†…å­˜è®¾å¾—å¾ˆå¤§ï¼ŒGC pause ä¹Ÿè®¾å¾—æ¯”è¾ƒé•¿ï¼Œå› æ­¤å†…å­˜ GC ä¼šé€ æˆ CPU é—´æ­‡æ€§é£™å‡ï¼ŒCPU ç›‘æ§ä¼šæœ‰å¤§é‡çš„å°–å³°ã€‚</li>
<li>æœ‰äº›æœåŠ¡æœ‰å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ä¸€è¿è¡Œ CPU å°±æ¶¨ï¼Œä½†æ˜¯è¿™è·ŸæœåŠ¡çš„ QPS æ˜¯æ— å…³çš„</li>
<li>æœ‰äº›æœåŠ¡å¯èƒ½ä¸€è¿è¡Œ CPU å°±ä¼šç«‹å³å¤„äºä¸€ä¸ªé«˜ä½çŠ¶æ€ï¼Œå®ƒå¯èƒ½å¸Œæœ›ä½¿ç”¨åˆ«çš„ä¸šåŠ¡ä¾§æŒ‡æ ‡æ¥è¿›è¡Œæ‰©å®¹ï¼Œè€Œä¸æ˜¯ CPU.</li>
</ul>
<p>å› ä¸ºä¸Šè¿°é—®é¢˜å­˜åœ¨ï¼Œä½¿ç”¨ CPU æ‰©ç¼©å®¹ï¼Œå°±å¯èƒ½ä¼šé€ æˆæœåŠ¡é¢‘ç¹çš„æ‰©å®¹ç„¶åç¼©å®¹ï¼Œæˆ–è€…æ— é™æ‰©å®¹ã€‚
è€Œæœ‰äº›æœåŠ¡ï¼ˆå¦‚æˆ‘ä»¬çš„ã€Œæ¨èæœåŠ¡ã€ï¼‰ï¼Œå¯¹ã€Œæ‰©å®¹ã€å’Œã€Œç¼©å®¹ã€éƒ½æ˜¯æ¯”è¾ƒæ•æ„Ÿçš„ï¼Œæ¯æ¬¡æ‰©ç¼©éƒ½ä¼šé€ æˆæœåŠ¡å¯ç”¨ç‡æŠ–åŠ¨ã€‚</p>
<p>å¯¹è¿™ç±»æœåŠ¡è€Œè¨€ï¼ŒHPA æœ‰è¿™å‡ ç§è°ƒæ•´ç­–ç•¥ï¼š</p>
<ul>
<li>é€‰æ‹©ä½¿ç”¨ <strong>QPS</strong> ç­‰ç›¸å¯¹æ¯”è¾ƒå¹³æ»‘ï¼Œæ²¡æœ‰ GC è¿™ç±»å¹²æ‰°çš„æŒ‡æ ‡æ¥è¿›è¡Œæ‰©ç¼©å®¹ï¼Œè¿™éœ€è¦å€ŸåŠ© KEDA ç­‰ç¤¾åŒºç»„ä»¶ã€‚</li>
<li>å¯¹ kubernetes 1.18+ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ HPA çš„ <code>behavior.scaleDown</code> å’Œ <code>behavior.scaleUp</code> ä¸¤ä¸ªå‚æ•°ï¼Œæ§åˆ¶æ¯æ¬¡æ‰©ç¼©å®¹çš„æœ€å¤š pod æ•°é‡æˆ–è€…æ¯”ä¾‹ã€‚ ç¤ºä¾‹å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Utilization</span><span class="w">
</span><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">  </span><span class="c"># æœŸæœ›çš„ CPU å¹³å‡å€¼</span><span class="w">
</span><span class="w">  </span><span class="nt">behavior</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">scaleUp</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">stabilizationWindowSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c"># é»˜è®¤ä¸º 0ï¼Œåªä½¿ç”¨å½“å‰å€¼è¿›è¡Œæ‰©ç¼©å®¹</span><span class="w">
</span><span class="w">      </span><span class="nt">policies</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">180</span><span class="w">  </span><span class="c"># æ¯ 3 åˆ†é’Ÿæœ€å¤šæ‰©å®¹ 5% çš„ Pods</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Percent</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">      </span>- <span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">  </span><span class="c"># æ¯åˆ†é’Ÿæœ€å¤šæ‰©å®¹ 1 ä¸ª Podï¼Œæ‰©çš„æ…¢ä¸€ç‚¹ä¸»è¦æ˜¯ä¸ºäº†ä¸€ä¸ªä¸ªåœ°é¢„çƒ­ï¼Œé¿å…ä¸€æ¬¡æ‰©å®¹å¤ªå¤šæœªé¢„çƒ­çš„ Pods å¯¼è‡´æœåŠ¡å¯ç”¨ç‡å‰§çƒˆæŠ–åŠ¨</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Pods</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">selectPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Min </span><span class="w"> </span><span class="c"># é€‰æ‹©æœ€å°çš„ç­–ç•¥</span><span class="w">
</span><span class="w">    </span><span class="c"># ä»¥ä¸‹çš„ä¸€åˆ‡é…ç½®ï¼Œéƒ½æ˜¯ä¸ºäº†æ›´å¹³æ»‘åœ°ç¼©å®¹</span><span class="w">
</span><span class="w">    </span><span class="nt">scaleDown</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">stabilizationWindowSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">  </span><span class="c"># ä½¿ç”¨è¿‡å» 10 mins çš„æœ€å¤§ cpu å€¼è¿›è¡Œç¼©å®¹è®¡ç®—ï¼Œé¿å…è¿‡å¿«ç¼©å®¹</span><span class="w">
</span><span class="w">      </span><span class="nt">policies</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Percent </span><span class="w"> </span><span class="c"># æ¯ 3 mins æœ€å¤šç¼©å®¹ `ceil[å½“å‰å‰¯æœ¬æ•° * 5%]` ä¸ª podï¼ˆ20 ä¸ª pod ä»¥å†…ï¼Œä¸€æ¬¡åªç¼©å®¹ 1 ä¸ª podï¼‰</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">180</span><span class="w">
</span><span class="w">      </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Pods </span><span class="w"> </span><span class="c"># æ¯ 1 mins æœ€å¤šç¼©å®¹ 1 ä¸ª pod</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">      </span><span class="nt">selectPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Min </span><span class="w"> </span><span class="c"># ä¸Šé¢çš„ policies åˆ—è¡¨ï¼Œåªç”Ÿæ•ˆå…¶ä¸­æœ€å°çš„å€¼ä½œä¸ºç¼©å®¹é™åˆ¶ï¼ˆä¿è¯å¹³æ»‘ç¼©å®¹ï¼‰</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>è€Œå¯¹äºæ‰©å®¹ä¸å¤Ÿå¹³æ»‘è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘æä¾›ç±»ä¼¼ AWS ALB TargetGroup <code>slow_start</code> çš„åŠŸèƒ½ï¼Œåœ¨æ‰©å®¹æ—¶ç¼“æ…¢å°†æµé‡åˆ‡åˆ°æ–° Pod ä¸Šï¼Œä»¥å®ç°é¢„çƒ­æœåŠ¡ï¼ˆJVM é¢„çƒ­ä»¥åŠæœ¬åœ°ç¼“å­˜é¢„çƒ­ï¼‰ï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°æ¯”è¾ƒå¥½çš„å¹³æ»‘æ‰©å®¹æ•ˆæœã€‚</p>
<h3 id="5-hpa-æ³¨æ„äº‹é¡¹">5. HPA æ³¨æ„äº‹é¡¹</h3>
<p>æ³¨æ„ kubectl 1.23 ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œé»˜è®¤ä½¿ç”¨ <code>hpa.v1.autoscaling</code> æ¥æŸ¥è¯¢ HPA é…ç½®ï¼Œ<code>v2beta2</code> ç›¸å…³çš„å‚æ•°ä¼šè¢«ç¼–ç åˆ° <code>metadata.annotations</code> ä¸­ã€‚</p>
<p>æ¯”å¦‚ <code>behavior</code> å°±ä¼šè¢«ç¼–ç åˆ° <code>autoscaling.alpha.kubernetes.io/behavior</code> è¿™ä¸ª key æ‰€å¯¹åº”çš„å€¼ä¸­ã€‚</p>
<p>å› æ­¤å¦‚æœä½¿ç”¨äº† v2beta2 çš„ HPAï¼Œä¸€å®šè¦æ˜ç¡®æŒ‡å®šä½¿ç”¨ <code>v2beta2</code> ç‰ˆæœ¬çš„ HPAï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get hpa.v2beta2.autoscaling
</code></pre></td></tr></table>
</div>
</div><p>å¦åˆ™ä¸å°å¿ƒåŠ¨åˆ° <code>annotations</code> ä¸­ç¼–ç çš„æŸäº›å‚æ•°ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ„æ–™ä¹‹å¤–çš„æ•ˆæœï¼Œç”šè‡³ç›´æ¥æŠŠæ§åˆ¶é¢æå´©&hellip;
æ¯”å¦‚è¿™ä¸ª issue: <a href="https://github.com/kubernetes/kubernetes/issues/107038" target="_blank" rel="noopener noreferrer">Nil pointer dereference in KCM after v1 HPA patch request</a></p>
<h3 id="6-å‚è€ƒ">6. å‚è€ƒ</h3>
<ul>
<li><a href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener noreferrer">Pod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼© - Kubernetes Docs</a></li>
<li><a href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener noreferrer">Horizontal Pod Autoscaleræ¼”ç»ƒ - Kubernetes Docs</a></li>
</ul>
<h2 id="k8s-PodDistruptionBuget">ä¸‰ã€<a href="https://kubernetes.io/zh/docs/tasks/run-application/configure-pdb/" target="_blank" rel="noopener noreferrer">èŠ‚ç‚¹ç»´æŠ¤ä¸Podå¹²æ‰°é¢„ç®—</a></h2>
<p>åœ¨æˆ‘ä»¬é€šè¿‡ <code>kubectl drain</code> å°†æŸä¸ªèŠ‚ç‚¹ä¸Šçš„å®¹å™¨é©±é€èµ°çš„æ—¶å€™ï¼Œ
kubernetes ä¼šä¾æ® Pod çš„ã€ŒPodDistruptionBugetã€æ¥è¿›è¡Œ Pod çš„é©±é€ã€‚</p>
<p>å¦‚æœä¸è®¾ç½®ä»»ä½•æ˜ç¡®çš„ PodDistruptionBugetï¼ŒPod å°†ä¼šè¢«ç›´æ¥æ€æ­»ï¼Œç„¶ååœ¨åˆ«çš„èŠ‚ç‚¹é‡æ–°è°ƒåº¦ï¼Œ<strong>è¿™å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­ï¼</strong></p>
<p>PDB æ˜¯ä¸€ä¸ªå•ç‹¬çš„ CR è‡ªå®šä¹‰èµ„æºï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">policy/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodDisruptionBudget</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo-pdb</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># å¦‚æœä¸æ»¡è¶³ PDBï¼ŒPod é©±é€å°†ä¼šå¤±è´¥ï¼</span><span class="w">
</span><span class="w">  </span><span class="nt">minAvailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">      </span><span class="c"># æœ€å°‘ä¹Ÿè¦ç»´æŒä¸€ä¸ª Pod å¯ç”¨</span><span class="w">
</span><span class="w"></span><span class="c">#   maxUnavailable: 1  # æœ€å¤§ä¸å¯ç”¨çš„ Pod æ•°ï¼Œä¸ minAvailable ä¸èƒ½åŒæ—¶é…ç½®ï¼äºŒé€‰ä¸€</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœåœ¨è¿›è¡ŒèŠ‚ç‚¹ç»´æŠ¤æ—¶(kubectl drain)ï¼ŒPod ä¸æ»¡è¶³ PDBï¼Œdrain å°†ä¼šå¤±è´¥ï¼Œç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&gt; kubectl drain node-205 --ignore-daemonsets --delete-local-data
node/node-205 cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-nfhj7, kube-system/kube-proxy-94dz5
evicting pod default/podinfo-7c84d8c94d-h9brq
evicting pod default/podinfo-7c84d8c94d-gw6qf
error when evicting pod <span class="s2">&#34;podinfo-7c84d8c94d-h9brq&#34;</span> <span class="o">(</span>will retry after 5s<span class="o">)</span>: Cannot evict pod as it would violate the pod<span class="s1">&#39;s disruption budget.
</span><span class="s1">evicting pod default/podinfo-7c84d8c94d-h9brq
</span><span class="s1">error when evicting pod &#34;podinfo-7c84d8c94d-h9brq&#34; (will retry after 5s): Cannot evict pod as it would violate the pod&#39;</span>s disruption budget.
evicting pod default/podinfo-7c84d8c94d-h9brq
error when evicting pod <span class="s2">&#34;podinfo-7c84d8c94d-h9brq&#34;</span> <span class="o">(</span>will retry after 5s<span class="o">)</span>: Cannot evict pod as it would violate the pod<span class="err">&#39;</span>s disruption budget.
evicting pod default/podinfo-7c84d8c94d-h9brq
pod/podinfo-7c84d8c94d-gw6qf evicted
pod/podinfo-7c84d8c94d-h9brq evicted
node/node-205 evicted
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œpodinfo ä¸€å…±æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œéƒ½è¿è¡Œåœ¨ node-205 ä¸Šé¢ã€‚æˆ‘ç»™å®ƒè®¾ç½®äº†å¹²æ‰°é¢„ç®— PDB <code>minAvailable: 1</code>ã€‚</p>
<p>ç„¶åä½¿ç”¨ <code>kubectl drain</code> é©±é€ Pod æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ª Pod è¢«ç«‹å³é©±é€èµ°äº†ï¼Œè€Œå¦ä¸€ä¸ª Pod å¤§æ¦‚åœ¨ 15 ç§’å†…ä¸€ç›´é©±é€å¤±è´¥ã€‚
å› ä¸ºç¬¬ä¸€ä¸ª Pod è¿˜æ²¡æœ‰åœ¨æ–°çš„èŠ‚ç‚¹ä¸Šå¯åŠ¨å®Œæˆï¼Œå®ƒä¸æ»¡è¶³å¹²æ‰°é¢„ç®— PDB <code>minAvailable: 1</code> è¿™ä¸ªæ¡ä»¶ã€‚</p>
<p>å¤§çº¦ 15 ç§’åï¼Œæœ€å…ˆè¢«é©±é€èµ°çš„ Pod åœ¨æ–°èŠ‚ç‚¹ä¸Šå¯åŠ¨å®Œæˆäº†ï¼Œå¦ä¸€ä¸ª Pod æ»¡è¶³äº† PDB æ‰€ä»¥ç»ˆäºä¹Ÿè¢«é©±é€äº†ã€‚è¿™æ‰å®Œæˆäº†ä¸€ä¸ªèŠ‚ç‚¹çš„ drain æ“ä½œã€‚</p>
<blockquote>
<p>ClusterAutoscaler ç­‰é›†ç¾¤èŠ‚ç‚¹ä¼¸ç¼©ç»„ä»¶ï¼Œåœ¨ç¼©å®¹èŠ‚ç‚¹æ—¶ä¹Ÿä¼šè€ƒè™‘ PodDisruptionBudget. å¦‚æœä½ çš„é›†ç¾¤ä½¿ç”¨äº† ClusterAutoscaler ç­‰åŠ¨æ€æ‰©ç¼©å®¹èŠ‚ç‚¹çš„ç»„ä»¶ï¼Œå¼ºçƒˆå»ºè®®è®¾ç½®ä¸ºæ‰€æœ‰æœåŠ¡è®¾ç½® PodDisruptionBudget.</p>
</blockquote>
<h4 id="åœ¨-pdb-ä¸­ä½¿ç”¨ç™¾åˆ†æ¯”çš„æ³¨æ„äº‹é¡¹">åœ¨ PDB ä¸­ä½¿ç”¨ç™¾åˆ†æ¯”çš„æ³¨æ„äº‹é¡¹</h4>
<p>åœ¨ä½¿ç”¨ç™¾åˆ†æ¯”æ—¶ï¼Œè®¡ç®—å‡ºçš„å®ä¾‹æ•°éƒ½ä¼šè¢«å‘ä¸Šå–æ•´ï¼Œè¿™ä¼šé€ æˆä¸¤ä¸ªç°è±¡ï¼š</p>
<ul>
<li>å¦‚æœä½¿ç”¨ <code>minAvailable</code>ï¼Œå®ä¾‹æ•°è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´ ALLOWED DISRUPTIONS ä¸º 0</li>
<li>å¦‚æœä½¿ç”¨ <code>maxUnavailable</code>ï¼Œå› ä¸ºæ˜¯å‘ä¸Šå–æ•´ï¼ŒALLOWED DISRUPTIONS çš„å€¼ä¸€å®šä¸ä¼šä½äº 1</li>
</ul>
<p>å› æ­¤ä»ä¾¿äºé©±é€çš„è§’åº¦çœ‹ï¼Œå¦‚æœä½ çš„æœåŠ¡è‡³å°‘æœ‰ 2-3 ä¸ªå®ä¾‹ï¼Œå»ºè®®åœ¨ PDB ä¸­ä½¿ç”¨ç™¾åˆ†æ¯”é…ç½® <code>maxUnavailable</code>ï¼Œè€Œä¸æ˜¯ <code>minAvailable</code>.</p>
<h3 id="æœ€ä½³å®è·µ-deployment--hpa--poddisruptionbudget">æœ€ä½³å®è·µ Deployment + HPA + PodDisruptionBudget</h3>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œä¸€ä¸ªæœåŠ¡çš„æ¯ä¸ªç‰ˆæœ¬ï¼Œéƒ½åº”è¯¥åŒ…å«å¦‚ä¸‹ä¸‰ä¸ªèµ„æºï¼š</p>
<ul>
<li>Deployment: ç®¡ç†æœåŠ¡è‡ªèº«çš„ Pods å˜›</li>
<li>HPA: è´Ÿè´£ Pods çš„æ‰©ç¼©å®¹ï¼Œé€šå¸¸ä½¿ç”¨ CPU æŒ‡æ ‡è¿›è¡Œæ‰©ç¼©å®¹</li>
<li>PodDisruptionBudget(PDB): å»ºè®®æŒ‰ç…§ HPA çš„ç›®æ ‡å€¼ï¼Œæ¥è®¾ç½® PDB.
<ul>
<li>æ¯”å¦‚ HPA CPU ç›®æ ‡å€¼ä¸º 60%ï¼Œå°±å¯ä»¥è€ƒè™‘è®¾ç½® PDB <code>minAvailable=65%</code>ï¼Œä¿è¯è‡³å°‘æœ‰ 65% çš„ Pod å¯ç”¨ã€‚è¿™æ ·ç†è®ºä¸Šæé™æƒ…å†µä¸‹ QPS å‡æ‘Šåˆ°å‰©ä¸‹ 65% çš„ Pods ä¸Šä¹Ÿä¸ä¼šé€ æˆé›ªå´©ï¼ˆè¿™é‡Œå‡è®¾ QPS å’Œ CPU æ˜¯å®Œå…¨çš„çº¿æ€§å…³ç³»ï¼‰</li>
</ul>
</li>
</ul>
<h2 id="k8s-affinity">å››ã€èŠ‚ç‚¹äº²å’Œæ€§ä¸èŠ‚ç‚¹ç»„</h2>
<p>æˆ‘ä»¬ä¸€ä¸ªé›†ç¾¤ï¼Œé€šå¸¸ä¼šä½¿ç”¨ä¸åŒçš„æ ‡ç­¾ä¸ºèŠ‚ç‚¹ç»„è¿›è¡Œåˆ†ç±»ï¼Œæ¯”å¦‚ kubernetes è‡ªåŠ¨ç”Ÿæˆçš„ä¸€äº›èŠ‚ç‚¹æ ‡ç­¾ï¼š</p>
<ul>
<li><code>kubernetes.io/os</code>: é€šå¸¸éƒ½ç”¨ <code>linux</code></li>
<li><code>kubernetes.io/arch</code>: <code>amd64</code>, <code>arm64</code></li>
<li><code>topology.kubernetes.io/region</code> å’Œ <code>topology.kubernetes.io/zone</code>: äº‘æœåŠ¡çš„åŒºåŸŸåŠå¯ç”¨åŒº</li>
</ul>
<p>æˆ‘ä»¬ä½¿ç”¨å¾—æ¯”è¾ƒå¤šçš„ï¼Œæ˜¯ã€ŒèŠ‚ç‚¹äº²å’Œæ€§ã€ä»¥åŠã€ŒPod åäº²å’Œæ€§ã€ï¼Œå¦å¤–ä¸¤ä¸ªç­–ç•¥è§†æƒ…å†µä½¿ç”¨ã€‚</p>
<h3 id="1-èŠ‚ç‚¹äº²å’Œæ€§">1. èŠ‚ç‚¹äº²å’Œæ€§</h3>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ awsï¼Œé‚£ aws æœ‰ä¸€äº›è‡ªå®šä¹‰çš„èŠ‚ç‚¹æ ‡ç­¾ï¼š</p>
<ul>
<li><code>eks.amazonaws.com/nodegroup</code>: aws eks èŠ‚ç‚¹ç»„çš„åç§°ï¼ŒåŒä¸€ä¸ªèŠ‚ç‚¹ç»„ä½¿ç”¨åŒæ ·çš„ aws ec2 å®ä¾‹æ¨¡æ¿
<ul>
<li>æ¯”å¦‚ arm64 èŠ‚ç‚¹ç»„ã€amd64/x64 èŠ‚ç‚¹ç»„</li>
<li>å†…å­˜æ¯”ä¾‹é«˜çš„èŠ‚ç‚¹ç»„å¦‚ m ç³»å®ä¾‹ï¼Œè®¡ç®—æ€§èƒ½é«˜çš„èŠ‚ç‚¹ç»„å¦‚ c ç³»åˆ—</li>
<li>ç«ä»·å®ä¾‹èŠ‚ç‚¹ç»„ï¼šè¿™ä¸ªçœé’±å•Šï¼Œä½†æ˜¯åŠ¨æ€æ€§å¾ˆé«˜ï¼Œéšæ—¶å¯èƒ½è¢«å›æ”¶</li>
<li>æŒ‰é‡ä»˜è´¹èŠ‚ç‚¹ç»„ï¼šè¿™ç±»å®ä¾‹è´µï¼Œä½†æ˜¯ç¨³å®šã€‚</li>
</ul>
</li>
</ul>
<p>å‡è®¾ä½ å¸Œæœ›ä¼˜å…ˆé€‰æ‹©ç«ä»·å®ä¾‹è·‘ä½ çš„ Podï¼Œå¦‚æœç«ä»·å®ä¾‹æš‚æ—¶è·‘æ»¡äº†ï¼Œå°±é€‰æ‹©æŒ‰é‡ä»˜è´¹å®ä¾‹ã€‚
é‚£ <code>nodeSelector</code> å°±æ»¡è¶³ä¸äº†ä½ çš„éœ€æ±‚äº†ï¼Œä½ éœ€è¦ä½¿ç”¨ <code>nodeAffinity</code>ï¼Œç¤ºä¾‹å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># ä¼˜å…ˆé€‰æ‹© spot-group-c çš„èŠ‚ç‚¹</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">preference</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">eks.amazonaws.com/nodegroup</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">spot-group-c</span><span class="w">
</span><span class="w">            </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹</span><span class="w">
</span><span class="w">          </span>- <span class="nt">preference</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="c"># ä¼˜å…ˆé€‰æ‹© aws c6i çš„æœºå™¨</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node.kubernetes.io/instance-type</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.2xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.4xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.8xlarge&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">70</span><span class="w">
</span><span class="w">          </span>- <span class="nt">preference</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="c"># å…¶æ¬¡é€‰æ‹© aws c5 çš„æœºå™¨</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node.kubernetes.io/instance-type</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.2xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.4xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.9xlarge&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">         </span><span class="c"># å¦‚æœæ²¡ spot-group-c å¯ç”¨ï¼Œä¹Ÿå¯é€‰æ‹© ondemand-group-c çš„èŠ‚ç‚¹è·‘</span><span class="w">
</span><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">eks.amazonaws.com/nodegroup</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">spot-group-c</span><span class="w">
</span><span class="w">                </span>- <span class="l">ondemand-group-c</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="2-pod-åäº²å’Œæ€§">2. Pod åäº²å’Œæ€§</h3>
<p>é€šå¸¸å»ºè®®ä¸ºæ¯ä¸ª Deployment çš„ template é…ç½® Pod åäº²å’Œæ€§ï¼ŒæŠŠ Pods æ‰“æ•£åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">podAntiAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># éå¼ºåˆ¶æ€§æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹</span><span class="w">
</span><span class="w">            </span><span class="nt">podAffinityTerm</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">xxx</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">v12</span><span class="w">
</span><span class="w">              </span><span class="c"># å°† pod å°½é‡æ‰“æ•£åœ¨å¤šä¸ªå¯ç”¨åŒº</span><span class="w">
</span><span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">  </span><span class="c"># å¼ºåˆ¶æ€§è¦æ±‚</span><span class="w">
</span><span class="w">          </span><span class="c"># æ³¨æ„è¿™ä¸ªæ²¡æœ‰ weightsï¼Œå¿…é¡»æ»¡è¶³åˆ—è¡¨ä¸­çš„æ‰€æœ‰æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">xxx</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">v12</span><span class="w">
</span><span class="w">            </span><span class="c"># Pod å¿…é¡»è¿è¡Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š</span><span class="w">
</span><span class="w">            </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="k8s-container-probe">äº”ã€Pod çš„å°±ç»ªæ¢é’ˆã€å­˜æ´»æ¢é’ˆä¸å¯åŠ¨æ¢é’ˆ</h2>
<p>Pod æä¾›å¦‚ä¸‹ä¸‰ç§æ¢é’ˆï¼Œå‡æ”¯æŒä½¿ç”¨ Commandã€HTTP APIã€TCP Socket è¿™ä¸‰ç§æ‰‹æ®µæ¥è¿›è¡ŒæœåŠ¡å¯ç”¨æ€§æ¢æµ‹ã€‚</p>
<ul>
<li><code>startupProbe</code> å¯åŠ¨æ¢é’ˆï¼ˆKubernetes v1.18 [beta]ï¼‰: æ­¤æ¢é’ˆé€šè¿‡åï¼Œã€Œå°±ç»ªæ¢é’ˆã€ä¸ã€Œå­˜æ´»æ¢é’ˆã€æ‰ä¼šè¿›è¡Œå­˜æ´»æ€§ä¸å°±ç»ªæ£€æŸ¥
<ul>
<li>ç”¨äºå¯¹æ…¢å¯åŠ¨å®¹å™¨è¿›è¡Œå­˜æ´»æ€§æ£€æµ‹ï¼Œé¿å…å®ƒä»¬åœ¨å¯åŠ¨è¿è¡Œä¹‹å‰å°±è¢«æ€æ‰
<ul>
<li>startupProbe æ˜¾ç„¶æ¯” livenessProbe çš„ initialDelaySeconds å‚æ•°æ›´çµæ´»ã€‚</li>
<li>åŒæ—¶å®ƒä¹Ÿèƒ½å»¶è¿Ÿ readinessProbe çš„ç”Ÿæ•ˆæ—¶é—´ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†é¿å…æ— æ„ä¹‰çš„æ¢æµ‹ã€‚å®¹å™¨éƒ½è¿˜æ²¡ startUpï¼Œæ˜¾ç„¶æ˜¯ä¸å¯èƒ½å°±ç»ªçš„ã€‚</li>
</ul>
</li>
<li>ç¨‹åºå°†æœ€å¤šæœ‰ <code>failureThreshold * periodSeconds</code> çš„æ—¶é—´ç”¨äºå¯åŠ¨ï¼Œæ¯”å¦‚è®¾ç½® <code>failureThreshold=20</code>ã€<code>periodSeconds=5</code>ï¼Œç¨‹åºå¯åŠ¨æ—¶é—´æœ€é•¿å°±ä¸º 100sï¼Œå¦‚æœè¶…è¿‡ 100s ä»ç„¶æœªé€šè¿‡ã€Œå¯åŠ¨æ¢æµ‹ã€ï¼Œå®¹å™¨ä¼šè¢«æ€æ­»ã€‚</li>
</ul>
</li>
<li><code>readinessProbe</code> å°±ç»ªæ¢é’ˆ:
<ul>
<li>å°±ç»ªæ¢é’ˆå¤±è´¥æ¬¡æ•°è¶…è¿‡ <code>failureThreshold</code> é™åˆ¶ï¼ˆé»˜è®¤ä¸‰æ¬¡ï¼‰ï¼ŒæœåŠ¡å°†è¢«æš‚æ—¶ä» Service çš„ Endpoints ä¸­è¸¢å‡ºï¼Œç›´åˆ°æœåŠ¡å†æ¬¡æ»¡è¶³ <code>successThreshold</code>.</li>
</ul>
</li>
<li><code>livenessProbe</code> å­˜æ´»æ¢é’ˆ: æ£€æµ‹æœåŠ¡æ˜¯å¦å­˜æ´»ï¼Œå®ƒå¯ä»¥æ•æ‰åˆ°æ­»é”ç­‰æƒ…å†µï¼ŒåŠæ—¶æ€æ­»è¿™ç§å®¹å™¨ã€‚
<ul>
<li>å­˜æ´»æ¢é’ˆå¤±è´¥å¯èƒ½çš„åŸå› ï¼š
<ul>
<li>æœåŠ¡å‘ç”Ÿæ­»é”ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚å‡æ— å“åº”</li>
<li>æœåŠ¡çº¿ç¨‹å…¨éƒ¨å¡åœ¨å¯¹å¤–éƒ¨ redis/mysql ç­‰å¤–éƒ¨ä¾èµ–çš„ç­‰å¾…ä¸­ï¼Œå¯¼è‡´è¯·æ±‚æ— å“åº”</li>
</ul>
</li>
<li>å­˜æ´»æ¢é’ˆå¤±è´¥æ¬¡æ•°è¶…è¿‡ <code>failureThreshold</code> é™åˆ¶ï¼ˆé»˜è®¤ä¸‰æ¬¡ï¼‰ï¼Œå®¹å™¨å°†è¢«æ€æ­»ï¼Œéšåæ ¹æ®é‡å¯ç­–ç•¥æ‰§è¡Œé‡å¯ã€‚
<ul>
<li><code>kubectl describe pod</code> ä¼šæ˜¾ç¤ºé‡å¯åŸå› ä¸º <code>State.Last State.Reason = Error, Exit Code=137</code>ï¼ŒåŒæ—¶ Events ä¸­ä¼šæœ‰ <code>Liveness probe failed: ...</code> è¿™æ ·çš„æè¿°ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ä¸Šè¿°ä¸‰ç±»æ¢æµ‹å™¨çš„å‚æ•°éƒ½æ˜¯é€šç”¨çš„ï¼Œäº”ä¸ªæ—¶é—´ç›¸å…³çš„å‚æ•°åˆ—ä¸¾å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># ä¸‹é¢çš„å€¼å°±æ˜¯ k8s çš„é»˜è®¤å€¼</span><span class="w">
</span><span class="w"></span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c"># é»˜è®¤æ²¡æœ‰ delay æ—¶é—´</span><span class="w">
</span><span class="w"></span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w"></span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w"></span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w"></span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#  ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/app/my-app:v3</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent </span><span class="w">
</span><span class="w">        </span><span class="c"># ... çœç•¥è‹¥å¹²é…ç½®</span><span class="w">
</span><span class="w">        </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç›´æ¥ä½¿ç”¨å¥åº·æ£€æŸ¥æ¥å£å³å¯</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">  </span><span class="c"># æœ€å¤šæä¾›ç»™æœåŠ¡ 5s * 20 çš„å¯åŠ¨æ—¶é—´</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># spring çš„é€šç”¨å¥åº·æ£€æŸ¥è·¯å¾„</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="c"># Readiness probes are very important for a RollingUpdate to work properly,</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç®€å•èµ·è§å¯ç›´æ¥ä½¿ç”¨ livenessProbe ç›¸åŒçš„æ¥å£ï¼Œå½“ç„¶ä¹Ÿå¯é¢å¤–å®šä¹‰</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ Kubernetes 1.18 ä¹‹å‰ï¼Œé€šç”¨çš„æ‰‹æ®µæ˜¯ä¸ºã€Œå°±ç»ªæ¢é’ˆã€æ·»åŠ è¾ƒé•¿çš„ <code>initialDelaySeconds</code> æ¥å®ç°ç±»ä¼¼ã€Œå¯åŠ¨æ¢é’ˆã€çš„åŠŸèƒ½åŠ¨ï¼Œé¿å…å®¹å™¨å› ä¸ºå¯åŠ¨å¤ªæ…¢ï¼Œå­˜æ´»æ¢é’ˆå¤±è´¥å¯¼è‡´å®¹å™¨è¢«é‡å¯ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#  ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/app/my-app:v3</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent </span><span class="w">
</span><span class="w">        </span><span class="c"># ... çœç•¥è‹¥å¹²é…ç½®</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># spring çš„é€šç”¨å¥åº·æ£€æŸ¥è·¯å¾„</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">  </span><span class="c"># å‰ä¸¤åˆ†é’Ÿï¼Œéƒ½å‡è®¾æœåŠ¡å¥åº·ï¼Œé¿å… livenessProbe å¤±è´¥å¯¼è‡´æœåŠ¡é‡å¯</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="c"># å®¹å™¨ä¸€å¯åŠ¨ï¼ŒReadiness probes å°±ä¼šä¸æ–­è¿›è¡Œæ£€æµ‹</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">  </span><span class="c"># readiness probe ä¸éœ€è¦è®¾å¤ªé•¿æ—¶é—´ï¼Œä½¿ Pod å°½å¿«åŠ å…¥åˆ° Endpoints.</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="k8s-pod-security">å…­ã€Pod å®‰å…¨</h2>
<p>è¿™é‡Œåªä»‹ç» Pod ä¸­å®‰å…¨ç›¸å…³çš„å‚æ•°ï¼Œå…¶ä»–è¯¸å¦‚é›†ç¾¤å…¨å±€çš„å®‰å…¨ç­–ç•¥ï¼Œä¸åœ¨è¿™é‡Œè®¨è®ºã€‚</p>
<h3 id="1-pod-securitycontexthttpskubernetesiodocstasksconfigure-pod-containersecurity-context">1. <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/" target="_blank" rel="noopener noreferrer">Pod SecurityContext</a></h3>
<p>é€šè¿‡è®¾ç½® Pod çš„ SecurityContextï¼Œå¯ä»¥ä¸ºæ¯ä¸ª Pod è®¾ç½®ç‰¹å®šçš„å®‰å…¨ç­–ç•¥ã€‚</p>
<p>SecurityContext æœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ol>
<li><code>spec.securityContext</code>: è¿™æ˜¯ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#podsecuritycontext-v1-core" target="_blank" rel="noopener noreferrer">PodSecurityContext</a> å¯¹è±¡
<ul>
<li>é¡¾åæ€ä¹‰ï¼Œå®ƒå¯¹ Pod ä¸­çš„æ‰€æœ‰ contaienrs éƒ½æœ‰æ•ˆã€‚</li>
</ul>
</li>
<li><code>spec.containers[*].securityContext</code>: è¿™æ˜¯ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#securitycontext-v1-core" target="_blank" rel="noopener noreferrer">SecurityContext</a> å¯¹è±¡
<ul>
<li>container ç§æœ‰çš„ SecurityContext</li>
</ul>
</li>
</ol>
<p>è¿™ä¸¤ä¸ª SecurityContext çš„å‚æ•°åªæœ‰éƒ¨åˆ†é‡å ï¼Œé‡å çš„éƒ¨åˆ† <code>spec.containers[*].securityContext</code> ä¼˜å…ˆçº§æ›´é«˜ã€‚</p>
<p>æˆ‘ä»¬æ¯”è¾ƒå¸¸é‡åˆ°çš„ä¸€äº›<strong>æå‡æƒé™</strong>çš„å®‰å…¨ç­–ç•¥ï¼š</p>
<ol>
<li>ç‰¹æƒå®¹å™¨ï¼š<code>spec.containers[*].securityContext.privileged</code></li>
<li>æ·»åŠ ï¼ˆCapabilitiesï¼‰å¯é€‰çš„ç³»ç»Ÿçº§èƒ½åŠ›: <code>spec.containers[*].securityContext.capabilities.add</code>
<ol>
<li>åªæœ‰ ntp åŒæ­¥æœåŠ¡ç­‰å°‘æ•°å®¹å™¨ï¼Œå¯ä»¥å¼€å¯è¿™é¡¹åŠŸèƒ½ã€‚è¯·æ³¨æ„è¿™éå¸¸å±é™©ã€‚</li>
</ol>
</li>
<li>Sysctls: ç³»ç»Ÿå‚æ•°: <code>spec.securityContext.sysctls</code></li>
</ol>
<p><strong>æƒé™é™åˆ¶</strong>ç›¸å…³çš„å®‰å…¨ç­–ç•¥æœ‰ï¼ˆ<strong>å¼ºçƒˆå»ºè®®åœ¨æ‰€æœ‰ Pod ä¸ŠæŒ‰éœ€é…ç½®å¦‚ä¸‹å®‰å…¨ç­–ç•¥ï¼</strong>ï¼‰ï¼š</p>
<ol>
<li><code>spec.volumes</code>: æ‰€æœ‰çš„æ•°æ®å·éƒ½å¯ä»¥è®¾å®šè¯»å†™æƒé™</li>
<li><code>spec.securityContext.runAsNonRoot: true</code> Pod å¿…é¡»ä»¥é root ç”¨æˆ·è¿è¡Œ</li>
<li><code>spec.containers[*].securityContext.readOnlyRootFileSystem:true</code> <strong>å°†å®¹å™¨å±‚è®¾ä¸ºåªè¯»ï¼Œé˜²æ­¢å®¹å™¨æ–‡ä»¶è¢«ç¯¡æ”¹ã€‚</strong>
<ol>
<li>å¦‚æœå¾®æœåŠ¡éœ€è¦è¯»å†™æ–‡ä»¶ï¼Œå»ºè®®é¢å¤–æŒ‚è½½ <code>emptydir</code> ç±»å‹çš„æ•°æ®å·ã€‚</li>
</ol>
</li>
<li><code>spec.containers[*].securityContext.allowPrivilegeEscalation: false</code> ä¸å…è®¸ Pod åšä»»ä½•æƒé™æå‡ï¼</li>
<li><code>spec.containers[*].securityContext.capabilities.drop</code>: ç§»é™¤ï¼ˆCapabilitiesï¼‰å¯é€‰çš„ç³»ç»Ÿçº§èƒ½åŠ›</li>
</ol>
<p>è¿˜æœ‰å…¶ä»–è¯¸å¦‚æŒ‡å®šå®¹å™¨çš„è¿è¡Œç”¨æˆ·(user)/ç”¨æˆ·ç»„(group)ç­‰åŠŸèƒ½æœªåˆ—å‡ºï¼Œè¯·è‡ªè¡ŒæŸ¥é˜… Kubernetes ç›¸å…³æ–‡æ¡£ã€‚</p>
<p>ä¸€ä¸ªæ— çŠ¶æ€çš„å¾®æœåŠ¡ Pod é…ç½®ä¸¾ä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;Pod name&gt;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">â€Š </span><span class="nt">-â€Šname</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;container name&gt;</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;image&gt;</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent </span><span class="w">
</span><span class="w">    </span><span class="c"># ......æ­¤å¤„çœç•¥ 500 å­—</span><span class="w">
</span><span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># å°†å®¹å™¨å±‚è®¾ä¸ºåªè¯»ï¼Œé˜²æ­¢å®¹å™¨æ–‡ä»¶è¢«ç¯¡æ”¹ã€‚</span><span class="w">
</span><span class="w">      </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">  </span><span class="c"># ç¦æ­¢ Pod åšä»»ä½•æƒé™æå‡</span><span class="w">
</span><span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">drop</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># ç¦æ­¢å®¹å™¨ä½¿ç”¨ raw å¥—æ¥å­—ï¼Œé€šå¸¸åªæœ‰ hacker æ‰ä¼šç”¨åˆ° raw å¥—æ¥å­—ã€‚</span><span class="w">
</span><span class="w">        </span><span class="c"># raw_socket å¯è‡ªå®šä¹‰ç½‘ç»œå±‚æ•°æ®ï¼Œé¿å¼€ tcp/udp åè®®æ ˆï¼Œç›´æ¥æ“ä½œåº•å±‚çš„ ip/icmp æ•°æ®åŒ…ã€‚å¯å®ç° ip ä¼ªè£…ã€è‡ªå®šä¹‰åè®®ç­‰åŠŸèƒ½ã€‚</span><span class="w">
</span><span class="w">        </span><span class="c"># å»æ‰ net_raw ä¼šå¯¼è‡´ tcpdump æ— æ³•ä½¿ç”¨ï¼Œæ— æ³•è¿›è¡Œå®¹å™¨å†…æŠ“åŒ…ã€‚éœ€è¦æŠ“åŒ…æ—¶å¯ä¸´æ—¶å»é™¤è¿™é¡¹é…ç½®</span><span class="w">
</span><span class="w">        </span>- <span class="l">NET_RAW</span><span class="w">
</span><span class="w">        </span><span class="c"># æ›´å¥½çš„é€‰æ‹©ï¼šç›´æ¥ç¦ç”¨æ‰€æœ‰ capabilities</span><span class="w">
</span><span class="w">        </span><span class="c"># - ALL</span><span class="w">
</span><span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># runAsUser: 1000  # è®¾å®šç”¨æˆ·</span><span class="w">
</span><span class="w">    </span><span class="c"># runAsGroup: 1000  # è®¾å®šç”¨æˆ·ç»„</span><span class="w">
</span><span class="w">    </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># Pod å¿…é¡»ä»¥é root ç”¨æˆ·è¿è¡Œ</span><span class="w">
</span><span class="w">    </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">  </span><span class="c"># security compute mode</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="2-seccomp-security-compute-mode">2. seccomp: security compute mode</h3>
<p>seccomp å’Œ seccomp-bpf å…è®¸å¯¹ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥é˜²æ­¢ç”¨æˆ·çš„äºŒè¿›åˆ¶æ–‡å¯¹ä¸»æœºæ“ä½œç³»ç»Ÿä»¶æ‰§è¡Œé€šå¸¸æƒ…å†µä¸‹å¹¶ä¸éœ€è¦çš„å±é™©æ“ä½œã€‚å®ƒå’Œ Falco æœ‰äº›ç±»ä¼¼ï¼Œä¸è¿‡ Seccomp æ²¡æœ‰ä¸ºå®¹å™¨æä¾›ç‰¹åˆ«çš„æ”¯æŒã€‚</p>
<p>è§†é¢‘:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=Ro4QRx7VPsY&amp;list=PLj6h78yzYM2Pn8RxfLh2qrXBDftr6Qjut$index=22" target="_blank" rel="noopener noreferrer">Seccomp: What Can It Do For You? - Justin Cormack, Docker</a></li>
</ul>
<h2 id="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</h2>
<ul>
<li>ä¸åŒèŠ‚ç‚¹ç±»å‹çš„æ€§èƒ½æœ‰å·®è·ï¼Œå¯¼è‡´ QPS å‡è¡¡çš„æƒ…å†µä¸‹ï¼ŒCPU è´Ÿè½½ä¸å‡è¡¡
<ul>
<li>è§£å†³åŠæ³•ï¼ˆæœªéªŒè¯ï¼‰ï¼š
<ul>
<li>å°½é‡ä½¿ç”¨æ€§èƒ½ç›¸åŒçš„å®ä¾‹ç±»å‹ï¼šé€šè¿‡ <code>podAffinity</code> åŠ <code>nodeAffinity</code> æ·»åŠ èŠ‚ç‚¹ç±»å‹çš„äº²å’Œæ€§</li>
</ul>
</li>
</ul>
</li>
</ul>
]]></description></item><item><title>äº‘åŸç”Ÿæµæ°´çº¿ Argo Workflows çš„å®‰è£…ã€ä½¿ç”¨ä»¥åŠä¸ªäººä½“éªŒ</title><link>https://ryan4yin.space/posts/expirence-of-argo-workflow/</link><pubDate>Wed, 27 Jan 2021 15:37:27 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/expirence-of-argo-workflow/</guid><description><![CDATA[<blockquote>
<p>æ³¨æ„ï¼šè¿™ç¯‡æ–‡ç« å¹¶ä¸æ˜¯ä¸€ç¯‡å…¥é—¨æ•™ç¨‹ï¼Œå­¦ä¹  Argo Workflows è¯·ç§»æ­¥å®˜æ–¹æ–‡æ¡£ <a href="https://argoproj.github.io/argo-workflows/" target="_blank" rel="noopener noreferrer">Argo Documentation</a></p>
</blockquote>
<p><a href="https://github.com/argoproj/argo-workflows/" target="_blank" rel="noopener noreferrer">Argo Workflows</a> æ˜¯ä¸€ä¸ªäº‘åŸç”Ÿå·¥ä½œæµå¼•æ“ï¼Œä¸“æ³¨äº<strong>ç¼–æ’å¹¶è¡Œä»»åŠ¡</strong>ã€‚å®ƒçš„ç‰¹ç‚¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>ä½¿ç”¨ Kubernetes è‡ªå®šä¹‰èµ„æº(CR)å®šä¹‰å·¥ä½œæµï¼Œå…¶ä¸­å·¥ä½œæµä¸­çš„æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯ä¸€ä¸ªå®¹å™¨ã€‚</li>
<li>å°†å¤šæ­¥éª¤å·¥ä½œæµå»ºæ¨¡ä¸ºä¸€ç³»åˆ—ä»»åŠ¡ï¼Œæˆ–è€…ä½¿ç”¨æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰æè¿°ä»»åŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</li>
<li>å¯ä»¥åœ¨çŸ­æ—¶é—´å†…è½»æ¾è¿è¡Œç”¨äºæœºå™¨å­¦ä¹ æˆ–æ•°æ®å¤„ç†çš„è®¡ç®—å¯†é›†å‹ä½œä¸šã€‚</li>
<li>Argo Workflows å¯ä»¥çœ‹ä½œ Tekton çš„åŠ å¼ºç‰ˆï¼Œå› æ­¤æ˜¾ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ Argo Workflows è¿è¡Œ CI/CD æµæ°´çº¿(Pipielines)ã€‚</li>
</ol>
<p>é˜¿é‡Œäº‘æ˜¯ Argo Workflows çš„æ·±åº¦ä½¿ç”¨è€…å’Œè´¡çŒ®è€…ï¼Œå¦å¤– Kubeflow åº•å±‚çš„å·¥ä½œæµå¼•æ“ä¹Ÿæ˜¯ Argo Workflows.</p>
<h2 id="ä¸€argo-workflows-å¯¹æ¯”-jenkins">ä¸€ã€Argo Workflows å¯¹æ¯” Jenkins</h2>
<p>æˆ‘ä»¬åœ¨åˆ‡æ¢åˆ° Argo Workflows ä¹‹å‰ï¼Œä½¿ç”¨çš„ CI/CD å·¥å…·æ˜¯ Jenkinsï¼Œä¸‹é¢å¯¹ Argo Workflows å’Œ Jenkins åšä¸€ä¸ªæ¯”è¾ƒè¯¦ç»†çš„å¯¹æ¯”ï¼Œ
ä»¥äº†è§£ Argo Workflows çš„ä¼˜ç¼ºç‚¹ã€‚</p>
<h3 id="1-workflow-çš„å®šä¹‰">1. Workflow çš„å®šä¹‰</h3>
<p><code>Workflow</code> ä½¿ç”¨ kubernetes CR è¿›è¡Œå®šä¹‰ï¼Œå› æ­¤æ˜¾ç„¶æ˜¯ä¸€ä»½ yaml é…ç½®ã€‚</p>
<p>ä¸€ä¸ª Workflowï¼Œå°±æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ Kubernetes ä¸Šçš„æµæ°´çº¿ï¼Œå¯¹åº” Jenkins çš„ä¸€æ¬¡ Build.</p>
<p>è€Œ WorkflowTemplate åˆ™æ˜¯ä¸€ä¸ªå¯é‡ç”¨çš„ Workflow æ¨¡æ¿ï¼Œå¯¹åº” Jenkins çš„ä¸€ä¸ª Job.</p>
<p><code>WorkflowTemplate</code> çš„ yaml å®šä¹‰å’Œ <code>Workflow</code> å®Œå…¨ä¸€è‡´ï¼Œåªæœ‰ <code>Kind</code> ä¸åŒï¼</p>
<p>WorkflowTemplate å¯ä»¥è¢«å…¶ä»– Workflow å¼•ç”¨å¹¶è§¦å‘ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨ä¼ å‚ä»¥ç”Ÿæˆä¸€ä¸ª Workflow å·¥ä½œæµã€‚</p>
<h3 id="2-workflow-çš„ç¼–æ’">2. Workflow çš„ç¼–æ’</h3>
<p>Argo Workflows ç›¸æ¯”å…¶ä»–æµæ°´çº¿é¡¹ç›®(Jenkins/Tekton/Drone/Gitlab-CI)è€Œè¨€ï¼Œæœ€å¤§çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯å®ƒå¼ºå¤§çš„æµæ°´çº¿ç¼–æ’èƒ½åŠ›ã€‚</p>
<p>å…¶ä»–æµæ°´çº¿é¡¹ç›®ï¼Œå¯¹æµæ°´çº¿ä¹‹é—´çš„å…³è”æ€§è€ƒè™‘å¾—å¾ˆå°‘ï¼ŒåŸºæœ¬éƒ½å‡è®¾æµæ°´çº¿éƒ½æ˜¯äº’ç›¸ç‹¬ç«‹çš„ã€‚</p>
<p>è€Œ Argo Workflows åˆ™å‡è®¾ã€Œä»»åŠ¡ã€ä¹‹é—´æ˜¯æœ‰ä¾èµ–å…³ç³»çš„ï¼Œé’ˆå¯¹è¿™ä¸ªä¾èµ–å…³ç³»ï¼Œå®ƒæä¾›äº†ä¸¤ç§åè°ƒç¼–æ’ã€Œä»»åŠ¡ã€çš„æ–¹æ³•ï¼šSteps å’Œ DAG</p>
<p>å†å€ŸåŠ© <a href="https://argoproj.github.io/argo/workflow-templates/#referencing-other-workflowtemplates" target="_blank" rel="noopener noreferrer">templateRef</a> æˆ–è€… <a href="https://argoproj.github.io/argo/workflow-of-workflows/" target="_blank" rel="noopener noreferrer">Workflow of Workflows</a>ï¼Œå°±èƒ½å®ç° Workflows çš„ç¼–æ’äº†ã€‚</p>
<p><strong>æˆ‘ä»¬ä¹‹æ‰€ä»¥é€‰æ‹© Argo Workflows è€Œä¸æ˜¯ Tektonï¼Œä¸»è¦å°±æ˜¯å› ä¸º Argo çš„æµæ°´çº¿ç¼–æ’èƒ½åŠ›æ¯” Tekton å¼ºå¤§å¾—å¤šã€‚</strong>ï¼ˆä¹Ÿè®¸æ˜¯å› ä¸ºæˆ‘ä»¬çš„åç«¯ä¸­å°ç»“æ„æ¯”è¾ƒç‰¹æ®Šï¼Œå¯¼è‡´æˆ‘ä»¬çš„ CI æµæ°´çº¿éœ€è¦å…·å¤‡å¤æ‚çš„ç¼–æ’èƒ½åŠ›ï¼‰</p>
<p>ä¸€ä¸ªå¤æ‚å·¥ä½œæµçš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<p><figure><a class="lightgallery" href="/images/expirence-of-argo-workflow/complex-workflows.png" title="/images/expirence-of-argo-workflow/complex-workflows.png" data-thumbnail="/images/expirence-of-argo-workflow/complex-workflows.png" data-sub-html="<h2>https://github.com/argoproj/argo/issues/1088#issuecomment-445884543</h2>">
        
    </a><figcaption class="image-caption">https://github.com/argoproj/argo/issues/1088#issuecomment-445884543</figcaption>
    </figure></p>
<h3 id="3-workflow-çš„å£°æ˜å¼é…ç½®">3. Workflow çš„å£°æ˜å¼é…ç½®</h3>
<p>Argo ä½¿ç”¨ Kubernetes è‡ªå®šä¹‰èµ„æº(CR)æ¥å®šä¹‰ Workflowï¼Œç†Ÿæ‚‰ Kubernetes Yaml çš„åŒå­¦ä¸Šæ‰‹åº”è¯¥éƒ½å¾ˆå¿«ã€‚</p>
<p>ä¸‹é¢å¯¹ Workflow å®šä¹‰æ–‡ä»¶å’Œ Jenkinsfile åšä¸ªå¯¹æ¯”ï¼š</p>
<ol>
<li>argo å®Œå…¨ä½¿ç”¨ yaml æ¥å®šä¹‰æµæ°´çº¿ï¼Œå­¦ä¹ æˆæœ¬æ¯” Jenkinsfile çš„ groovy ä½ã€‚å¯¹ç†Ÿæ‚‰ Kubernetes çš„åŒå­¦å°¤å…¶å¦‚æ­¤ã€‚</li>
<li>å°† jenkinsfile ç”¨ argo é‡å†™åï¼Œä»£ç é‡å‡ºç°äº†æ˜æ˜¾çš„è†¨èƒ€ã€‚ä¸€ä¸ª 20 è¡Œçš„ Jenkinsfileï¼Œç”¨ Argo é‡å†™å¯èƒ½å°±å˜æˆäº† 60 è¡Œã€‚</li>
</ol>
<p>é…ç½®å‡ºç°äº†è†¨èƒ€æ˜¯ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è€ƒè™‘åˆ°å®ƒçš„å¯è¯»æ€§è¿˜ç®—ä¸é”™ï¼Œ
è€Œä¸” Argo çš„ Workflow ç¼–æ’åŠŸèƒ½ï¼Œèƒ½æ›¿ä»£æ‰æˆ‘ä»¬ç›®å‰ç»´æŠ¤çš„éƒ¨åˆ† Python æ„å»ºä»£ç ï¼Œä»¥åŠä¸€äº›å…¶ä»–ä¼˜ç‚¹ï¼Œé…ç½®è†¨èƒ€è¿™ä¸ªé—®é¢˜ä¹Ÿå°±å¯ä»¥æ¥å—äº†ã€‚</p>
<h3 id="4-web-ui">4. Web UI</h3>
<p>Argo Workflows çš„ Web UI æ„Ÿè§‰è¿˜å¾ˆåŸå§‹ã€‚ç¡®å®è¯¥æ”¯æŒçš„åŠŸèƒ½éƒ½æœ‰ï¼Œä½†æ˜¯å®ƒè²Œä¼¼ä¸æ˜¯é¢å‘ã€Œç”¨æˆ·ã€çš„ï¼ŒåŠŸèƒ½æ¯”è¾ƒåº•å±‚ã€‚</p>
<p>å®ƒä¸åƒ Jenkins ä¸€æ ·ï¼Œæœ‰å¾ˆå‹å¥½çš„ä½¿ç”¨ç•Œé¢(è™½ç„¶è¯´ Jenkins çš„ UI ä¹Ÿå¾ˆæ˜¾è€&hellip;)</p>
<p>å¦å¤–å®ƒæ‰€æœ‰çš„ Workflow éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ²¡åŠæ³•ç›´è§‚åœ°æ‰¾åˆ°ä¸€ä¸ª WorkflowTemplate çš„æ‰€æœ‰æ„å»ºè®°å½•ï¼Œåªèƒ½é€šè¿‡ label/namespace è¿›è¡Œåˆ†ç±»ï¼Œé€šè¿‡ä»»åŠ¡åç§°è¿›è¡Œæœç´¢ã€‚</p>
<p>è€Œ Jenkins å¯ä»¥å¾ˆæ–¹ä¾¿åœ°çœ‹åˆ°åŒä¸€ä¸ª Job çš„æ‰€æœ‰æ„å»ºå†å²ã€‚</p>
<h3 id="5-workflow-çš„åˆ†ç±»">5. Workflow çš„åˆ†ç±»</h3>
<h4 id="ä¸ºä½•éœ€è¦å¯¹-workflow-åšç»†è‡´çš„åˆ†ç±»">ä¸ºä½•éœ€è¦å¯¹ Workflow åšç»†è‡´çš„åˆ†ç±»</h4>
<p>å¸¸è§çš„å¾®æœåŠ¡é¡¹ç›®ï¼Œå¾€å¾€ä¼šæ‹†åˆ†æˆä¼—å¤š Git ä»“åº“ï¼ˆå¾®æœåŠ¡ï¼‰è¿›è¡Œå¼€å‘ï¼Œä¼—å¤šçš„ Git ä»“åº“ä¼šä½¿æˆ‘ä»¬åˆ›å»ºä¼—å¤šçš„ CI/CD æµæ°´çº¿ã€‚
å¦‚æœæ²¡æœ‰ä»»ä½•çš„åˆ†ç±»ï¼Œè¿™ä¸€å¤§å †çš„æµæ°´çº¿å¦‚ä½•ç®¡ç†ï¼Œå°±æˆäº†ä¸€ä¸ªéš¾é¢˜ã€‚</p>
<p>æœ€æ˜¾è§çš„éœ€æ±‚ï¼šå‰ç«¯å’Œåç«¯çš„æµæ°´çº¿æœ€å¥½èƒ½åŒºåˆ†ä¸€ä¸‹ï¼Œå¾€ä¸‹ç»†åˆ†ï¼Œå‰ç«¯çš„ Web ç«¯å’Œå®¢æˆ·ç«¯æœ€å¥½ä¹Ÿèƒ½åŒºåˆ†ï¼Œåç«¯çš„ä¸šåŠ¡å±‚å’Œä¸­å°æœ€å¥½ä¹ŸåŒºåˆ†å¼€æ¥ã€‚</p>
<p>å¦å¤–æˆ‘ä»¬è¿˜å¸Œæœ›å°†è¿ç»´ã€è‡ªåŠ¨åŒ–æµ‹è¯•ç›¸å…³çš„ä»»åŠ¡ä¹Ÿé›†æˆåˆ°è¿™ä¸ªç³»ç»Ÿä¸­æ¥ï¼ˆç›®å‰æˆ‘ä»¬å°±æ˜¯ä½¿ç”¨ Jenkins å®Œæˆè¿ç»´ã€è‡ªåŠ¨åŒ–æµ‹è¯•ä»»åŠ¡çš„ï¼‰ï¼Œ
å¦‚æœæ²¡æœ‰ä»»ä½•åˆ†ç±»ï¼Œè¿™ä¸€å¤§å †æµæ°´çº¿å°†æ··ä¹±æ— æ¯”ã€‚</p>
<h4 id="argo-workflows-çš„åˆ†ç±»èƒ½åŠ›">Argo Workflows çš„åˆ†ç±»èƒ½åŠ›</h4>
<p>å½“ Workflow è¶Šæ¥è¶Šå¤šçš„æ—¶å€™ï¼Œå¦‚æœä¸åšåˆ†ç±»ï¼Œä¸€å † WorkflowTemplate å †åœ¨ä¸€èµ·å°±ä¼šæ˜¾å¾—ç‰¹åˆ«æ··ä¹±ã€‚ï¼ˆæ²¡é”™ï¼Œæˆ‘è§‰å¾— Drone å°±æœ‰è¿™ä¸ªé—®é¢˜&hellip;ï¼‰</p>
<p>Argo æ˜¯å®Œå…¨åŸºäº Kubernetes çš„ï¼Œå› æ­¤ç›®å‰å®ƒä¹Ÿåªèƒ½é€šè¿‡ namespace/labels è¿›è¡Œåˆ†ç±»ã€‚</p>
<p>è¿™æ ·çš„åˆ†ç±»ç»“æ„å’Œ Jenkins çš„è§†å›¾-æ–‡ä»¶å¤¹ä½“ç³»å¤§ç›¸å¾„åº­ï¼Œç›®å‰æ„Ÿè§‰ä¸æ˜¯å¾ˆå¥½ç”¨ï¼ˆä¹Ÿå¯èƒ½çº¯ç²¹æ˜¯ Web UI çš„é”…ï¼‰ã€‚</p>
<h3 id="6-è§¦å‘æ„å»ºçš„æ–¹å¼">6. è§¦å‘æ„å»ºçš„æ–¹å¼</h3>
<p>Argo Workflows çš„æµæ°´çº¿æœ‰å¤šç§è§¦å‘æ–¹å¼ï¼š</p>
<ul>
<li>æ‰‹åŠ¨è§¦å‘ï¼šæ‰‹åŠ¨æäº¤ä¸€ä¸ª Workflowï¼Œå°±èƒ½è§¦å‘ä¸€æ¬¡æ„å»ºã€‚å¯ä»¥é€šè¿‡ <a href="https://argoproj.github.io/argo/workflow-templates/#create-workflow-from-workflowtemplate-spec" target="_blank" rel="noopener noreferrer">workflowTemplateRef</a> ç›´æ¥å¼•ç”¨ä¸€ä¸ªç°æˆçš„æµæ°´çº¿æ¨¡æ¿ã€‚</li>
<li>å®šæ—¶è§¦å‘ï¼š<a href="https://argoproj.github.io/argo/cron-workflows/" target="_blank" rel="noopener noreferrer">CronWorkflow</a></li>
<li>é€šè¿‡ Git ä»“åº“å˜æ›´è§¦å‘ï¼šå€ŸåŠ© <a href="https://github.com/argoproj/argo-events" target="_blank" rel="noopener noreferrer">argo-events</a> å¯ä»¥å®ç°æ­¤åŠŸèƒ½ï¼Œè¯¦è§å…¶æ–‡æ¡£ã€‚
<ul>
<li>å¦å¤–ç›®å‰ä¹Ÿä¸æ¸…æ¥š WebHook çš„å¯é ç¨‹åº¦å¦‚ä½•ï¼Œä¼šä¸ä¼šå› ä¸ºå®•æœºã€æ–­ç½‘ç­‰æ•…éšœï¼Œå¯¼è‡´ Git ä»“åº“å˜æ›´äº†ï¼Œè€Œ Workflow å´æ²¡è§¦å‘ï¼Œè€Œä¸”è¿˜æ²¡æœ‰ä»»ä½•æ˜¾çœ¼çš„é”™è¯¯é€šçŸ¥ï¼Ÿå¦‚æœè¿™ä¸ªé”™è¯¯å°±è¿™æ ·è—èµ·æ¥äº†ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´å¾ˆä¸¥é‡çš„é—®é¢˜ï¼</li>
</ul>
</li>
</ul>
<h3 id="7-secrets-ç®¡ç†">7. secrets ç®¡ç†</h3>
<p>Argo Workflows çš„æµæ°´çº¿ï¼Œå¯ä»¥ä» kubernetes secrets/configmap ä¸­è·å–ä¿¡æ¯ï¼Œå°†ä¿¡æ¯æ³¨å…¥åˆ°ç¯å¢ƒå˜é‡ä¸­ã€æˆ–è€…ä»¥æ–‡ä»¶å½¢å¼æŒ‚è½½åˆ° Pod ä¸­ã€‚</p>
<p>Git ç§é’¥ã€Harbor ä»“åº“å‡­æ®ã€CD éœ€è¦çš„ kubeconfigï¼Œéƒ½å¯ä»¥ç›´æ¥ä» secrets/configmap ä¸­è·å–åˆ°ã€‚</p>
<p>å¦å¤–å› ä¸º Vault å¾ˆæµè¡Œï¼Œä¹Ÿå¯ä»¥å°† secrets ä¿å­˜åœ¨ Vault ä¸­ï¼Œå†é€šè¿‡ vault agent å°†é…ç½®æ³¨å…¥è¿› Podã€‚</p>
<h3 id="8-artifacts">8. Artifacts</h3>
<p>Argo æ”¯æŒæ¥å…¥å¯¹è±¡å­˜å‚¨ï¼Œåšå…¨å±€çš„ Artifact ä»“åº“ï¼Œæœ¬åœ°å¯ä»¥ä½¿ç”¨ MinIO.</p>
<p>ä½¿ç”¨å¯¹è±¡å­˜å‚¨å­˜å‚¨ Artifactï¼Œæœ€å¤§çš„å¥½å¤„å°±æ˜¯å¯ä»¥åœ¨ Pod ä¹‹é—´éšæ„ä¼ æ•°æ®ï¼ŒPod å¯ä»¥å®Œå…¨åˆ†å¸ƒå¼åœ°è¿è¡Œåœ¨ Kubernetes é›†ç¾¤çš„ä»»ä½•èŠ‚ç‚¹ä¸Šã€‚</p>
<p>å¦å¤–ä¹Ÿå¯ä»¥è€ƒè™‘å€ŸåŠ© Artifact ä»“åº“å®ç°è·¨æµæ°´çº¿çš„ç¼“å­˜å¤ç”¨ï¼ˆæœªæµ‹è¯•ï¼‰ï¼Œæå‡æ„å»ºé€Ÿåº¦ã€‚</p>
<h3 id="9-å®¹å™¨é•œåƒçš„æ„å»º">9. å®¹å™¨é•œåƒçš„æ„å»º</h3>
<p>å€ŸåŠ© Buildkit ç­‰å®¹å™¨é•œåƒæ„å»ºå·¥å…·ï¼Œå¯ä»¥å®ç°å®¹å™¨é•œåƒçš„åˆ†å¸ƒå¼æ„å»ºã€‚</p>
<p>Buildkit å¯¹æ„å»ºç¼“å­˜çš„æ”¯æŒä¹Ÿå¾ˆå¥½ï¼Œå¯ä»¥ç›´æ¥å°†ç¼“å­˜å­˜å‚¨åœ¨å®¹å™¨é•œåƒä»“åº“ä¸­ã€‚</p>
<blockquote>
<p>ä¸å»ºè®®ä½¿ç”¨ Google çš„ Kanikoï¼Œå®ƒå¯¹ç¼“å­˜å¤ç”¨çš„æ”¯æŒä¸å’‹åœ°ï¼Œç¤¾åŒºä¹Ÿä¸æ´»è·ƒã€‚</p>
</blockquote>
<h3 id="10-å®¢æˆ·ç«¯sdk">10. å®¢æˆ·ç«¯/SDK</h3>
<p>Argo æœ‰æä¾›ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œä¹Ÿæœ‰ HTTP API å¯ä¾›ä½¿ç”¨ã€‚</p>
<p>å¦‚ä¸‹é¡¹ç›®å€¼å¾—è¯•ç”¨ï¼š</p>
<ul>
<li><a href="https://github.com/argoproj-labs/argo-client-python" target="_blank" rel="noopener noreferrer">argo-client-python</a>: Argo Workflows çš„ Python å®¢æˆ·ç«¯
<ul>
<li>è¯´å®è¯ï¼Œæ„Ÿè§‰å’Œ kubernetes-client/python ä¸€æ ·éš¾ç”¨ï¼Œæ¯•ç«Ÿéƒ½æ˜¯ openapi-generator ç”Ÿæˆå‡ºæ¥çš„&hellip;</li>
</ul>
</li>
<li><a href="https://github.com/argoproj-labs/argo-python-dsl" target="_blank" rel="noopener noreferrer">argo-python-dsl</a>: ä½¿ç”¨ Python DSL ç¼–å†™ Argo Workflows
<ul>
<li>æ„Ÿè§‰ä½¿ç”¨éš¾åº¦æ¯” yaml é«˜ï¼Œä¹Ÿä¸å¤ªå¥½ç”¨ã€‚</li>
</ul>
</li>
<li><a href="https://github.com/couler-proj/couler" target="_blank" rel="noopener noreferrer">couler</a>: ä¸º  Argo/Tekton/Airflow æä¾›ç»Ÿä¸€çš„æ„å»ºä¸ç®¡ç†æ¥å£
<ul>
<li>ç†å¿µå€’æ˜¯å¾ˆå¥½ï¼Œå¾…ç ”ç©¶</li>
</ul>
</li>
</ul>
<p>æ„Ÿè§‰ couler æŒºä¸é”™çš„ï¼Œå¯ä»¥ç›´æ¥ç”¨ Python å†™ WorkflowTemplateï¼Œè¿™æ ·å°±ä¸€æ­¥åˆ°ä½ï¼Œæ‰€æœ‰ CI/CD ä»£ç å…¨éƒ¨æ˜¯ Python äº†ã€‚</p>
<p>æ­¤å¤–ï¼Œå› ä¸º Argo Workflows æ˜¯ kubernetes è‡ªå®šä¹‰èµ„æº CRï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ helm/kustomize æ¥åš workflow çš„ç”Ÿæˆã€‚</p>
<p>ç›®å‰æˆ‘ä»¬ä¸€äº›æ­¥éª¤éå¸¸å¤šï¼Œä½†æ˜¯é‡å¤åº¦ä¹Ÿå¾ˆé«˜çš„ Argo æµæ°´çº¿é…ç½®ï¼Œå°±æ˜¯ä½¿ç”¨ helm ç”Ÿæˆçš„â€”â€”å…³é”®æ•°æ®æŠ½å–åˆ° values.yaml ä¸­ï¼Œä½¿ç”¨ helm æ¨¡æ¿ + <code>range</code> å¾ªç¯æ¥ç”Ÿæˆ workflow é…ç½®ã€‚</p>
<h2 id="äºŒå®‰è£…-argo-workflowshttpsargoprojgithubioargoinstallation">äºŒã€<a href="https://argoproj.github.io/argo/installation/" target="_blank" rel="noopener noreferrer">å®‰è£… Argo Workflows</a></h2>
<p>å®‰è£…ä¸€ä¸ªé›†ç¾¤ç‰ˆ(cluster wide)çš„ Argo Workflowsï¼Œä½¿ç”¨ MinIO åš artifacts å­˜å‚¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl apply -f https://raw.githubusercontent.com/argoproj/argo/stable/manifests/install.yaml
</code></pre></td></tr></table>
</div>
</div><p>éƒ¨ç½² MinIO:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm repo add minio https://helm.min.io/ <span class="c1"># official minio Helm charts</span>
<span class="c1"># æŸ¥çœ‹å†å²ç‰ˆæœ¬</span>
helm search repo minio/minio -l <span class="p">|</span> head
<span class="c1"># ä¸‹è½½å¹¶è§£å‹ chart</span>
helm pull minio/minio --untar --version 8.0.9

<span class="c1"># ç¼–å†™ custom-values.yamlï¼Œç„¶åéƒ¨ç½² minio</span>
kubectl create namespace minio
helm install minio ./minio -n argo -f custom-values.yaml
</code></pre></td></tr></table>
</div>
</div><p>minio éƒ¨ç½²å¥½åï¼Œå®ƒä¼šå°†é»˜è®¤çš„ <code>accesskey</code> å’Œ <code>secretkey</code> ä¿å­˜åœ¨åä¸º <code>minio</code> çš„ secret ä¸­ã€‚
æˆ‘ä»¬éœ€è¦ä¿®æ”¹ argo çš„é…ç½®ï¼Œå°† minio ä½œä¸ºå®ƒçš„é»˜è®¤ artifact ä»“åº“ã€‚</p>
<p>åœ¨ configmap <code>workflow-controller-configmap</code> çš„ data ä¸­æ·»åŠ å¦‚ä¸‹å­—æ®µï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">  artifactRepository: <span class="p">|</span>
    <span class="c1"># æ˜¯å¦å°† main å®¹å™¨çš„æ—¥å¿—ä¿å­˜ä¸º artifactï¼Œè¿™æ · pod è¢«åˆ é™¤åï¼Œä»ç„¶å¯ä»¥åœ¨ artifact ä¸­æ‰¾åˆ°æ—¥å¿—</span>
    archiveLogs: <span class="nb">true</span>
    s3:
      bucket: argo-bucket   <span class="c1"># bucket åç§°ï¼Œè¿™ä¸ª bucket éœ€è¦å…ˆæ‰‹åŠ¨åˆ›å»ºå¥½ï¼</span>
      endpoint: minio:9000  <span class="c1"># minio åœ°å€</span>
      insecure: <span class="nb">true</span>
      <span class="c1"># ä» minio è¿™ä¸ª secret ä¸­è·å– key/secret</span>
      accessKeySecret:
        name: minio
        key: accesskey
      secretKeySecret:
        name: minio
        key: secretkey
</code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨è¿˜å·®æœ€åä¸€æ­¥ï¼šæ‰‹åŠ¨è¿›å…¥ minio çš„ Web UIï¼Œåˆ›å»ºå¥½ <code>argo-bucket</code> è¿™ä¸ª bucket.
ç›´æ¥è®¿é—® minio çš„ 9000 ç«¯å£ï¼ˆéœ€è¦ä½¿ç”¨ nodeport/ingress ç­‰æ–¹å¼æš´éœ²æ­¤ç«¯å£ï¼‰å°±èƒ½è¿›å…¥ Web UIï¼Œä½¿ç”¨å‰é¢æåˆ°çš„ secret <code>minio</code> ä¸­çš„ key/secret ç™»å½•ï¼Œå°±èƒ½åˆ›å»º bucket.</p>
<h3 id="serviceaccount-é…ç½®httpsargoprojgithubioargoservice-accounts"><a href="https://argoproj.github.io/argo/service-accounts/" target="_blank" rel="noopener noreferrer">ServiceAccount é…ç½®</a></h3>
<p>Argo Workflows ä¾èµ–äº ServiceAccount è¿›è¡ŒéªŒè¯ä¸æˆæƒï¼Œè€Œä¸”é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒä½¿ç”¨æ‰€åœ¨ namespace çš„ <code>default</code> ServiceAccount è¿è¡Œ workflow.</p>
<p>å¯ <code>default</code> è¿™ä¸ª ServiceAccount é»˜è®¤æ ¹æœ¬æ²¡æœ‰ä»»ä½•æƒé™ï¼æ‰€ä»¥ Argo çš„ artifacts, outputs, access to secrets ç­‰åŠŸèƒ½å…¨éƒ½ä¼šå› ä¸ºæƒé™ä¸è¶³è€Œæ— æ³•ä½¿ç”¨ï¼</p>
<p>ä¸ºæ­¤ï¼ŒArgo çš„å®˜æ–¹æ–‡æ¡£æä¾›äº†ä¸¤ä¸ªè§£å†³æ–¹æ³•ã€‚</p>
<p>æ–¹æ³•ä¸€ï¼Œç›´æ¥ç»™ default ç»‘å®š <code>cluster-admin</code> ClusterRoleï¼Œç»™å®ƒé›†ç¾¤ç®¡ç†å‘˜çš„æƒé™ï¼Œåªè¦ä¸€è¡Œå‘½ä»¤ï¼ˆä½†æ˜¯æ˜¾ç„¶å®‰å…¨æ€§å ªå¿§ï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create rolebinding default-admin --clusterrole<span class="o">=</span>admin --serviceaccount<span class="o">=</span>&lt;namespace&gt;:default -n &lt;namespace&gt;
</code></pre></td></tr></table>
</div>
</div><p>æ–¹æ³•äºŒï¼Œå®˜æ–¹ç»™å‡ºäº†<a href="https://argoproj.github.io/argo/workflow-rbac/" target="_blank" rel="noopener noreferrer">Argo Workflows éœ€è¦çš„æœ€å°æƒé™çš„ Role å®šä¹‰</a>ï¼Œæ–¹ä¾¿èµ·è§æˆ‘å°†å®ƒæ”¹æˆä¸€ä¸ª ClusterRole:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">argo-workflow-role</span><span class="w">
</span><span class="w"></span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w"></span><span class="c"># pod get/watch is used to identify the container IDs of the current pod</span><span class="w">
</span><span class="w"></span><span class="c"># pod patch is used to annotate the step&#39;s outputs back to controller (e.g. artifact location)</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">pods</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">get</span><span class="w">
</span><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span><span class="w">  </span>- <span class="l">patch</span><span class="w">
</span><span class="w"></span><span class="c"># logs get/watch are used to get the pods logs for script outputs, and for log archival</span><span class="w">
</span><span class="w"></span>- <span class="nt">apiGroups</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">pods/log</span><span class="w">
</span><span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="l">get</span><span class="w">
</span><span class="w">  </span>- <span class="l">watch</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>åˆ›å»ºå¥½ä¸Šé¢è¿™ä¸ªæœ€å°çš„ ClusterRoleï¼Œç„¶åä¸ºæ¯ä¸ªåå­—ç©ºé—´ï¼Œè·‘ä¸€ä¸‹å¦‚ä¸‹å‘½ä»¤ï¼Œç»™ default è´¦å·ç»‘å®šè¿™ä¸ª clusterrole:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create rolebinding default-argo-workflow --clusterrole<span class="o">=</span>argo-workflow-role  --serviceaccount<span class="o">=</span>&lt;namespace&gt;:default -n &lt;namespace&gt;
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å°±èƒ½ç»™ default è´¦å·æä¾›æœ€å°çš„ workflow è¿è¡Œæƒé™ã€‚</p>
<p>æˆ–è€…å¦‚æœä½ å¸Œæœ›ä½¿ç”¨åˆ«çš„ ServiceAccount æ¥è¿è¡Œ workflowï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œåˆ›å»º ServiceAccountï¼Œç„¶åå†èµ°ä¸Šé¢æ–¹æ³•äºŒçš„æµç¨‹ï¼Œä½†æ˜¯æœ€åï¼Œè¦è®°å¾—åœ¨ workflow çš„ <code>spec.serviceAccountName</code> ä¸­è®¾å®šå¥½ ServiceAccount åç§°ã€‚</p>
<h3 id="workflow-executorshttpsargoprojgithubioargoworkflow-executors"><a href="https://argoproj.github.io/argo/workflow-executors/" target="_blank" rel="noopener noreferrer">Workflow Executors</a></h3>
<p>Workflow Executor æ˜¯ç¬¦åˆç‰¹å®šæ¥å£çš„ä¸€ä¸ªè¿›ç¨‹(Process)ï¼ŒArgo å¯ä»¥é€šè¿‡å®ƒæ‰§è¡Œä¸€äº›åŠ¨ä½œï¼Œå¦‚ç›‘æ§ Pod æ—¥å¿—ã€æ”¶é›† Artifactsã€ç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸç­‰ç­‰&hellip;</p>
<p>Workflow Executor æœ‰å¤šç§å®ç°ï¼Œå¯ä»¥é€šè¿‡å‰é¢æåˆ°çš„ configmap <code>workflow-controller-configmap</code> æ¥é€‰æ‹©ã€‚</p>
<p>å¯é€‰é¡¹å¦‚ä¸‹ï¼š</p>
<ol>
<li>docker(é»˜è®¤): ç›®å‰ä½¿ç”¨èŒƒå›´æœ€å¹¿ï¼Œä½†æ˜¯å®‰å…¨æ€§æœ€å·®ã€‚å®ƒè¦æ±‚ä¸€å®šè¦æŒ‚è½½è®¿é—® <code>docker.sock</code>ï¼Œå› æ­¤ä¸€å®šè¦ root æƒé™ï¼</li>
<li>kubelet: åº”ç”¨éå¸¸å°‘ï¼Œç›®å‰åŠŸèƒ½ä¹Ÿæœ‰äº›æ¬ ç¼ºï¼Œç›®å‰ä¹Ÿå¿…é¡»æä¾› root æƒé™</li>
<li>Kubernetes API (k8sapi): ç›´æ¥é€šè¿‡è°ƒç”¨ k8sapi å®ç°æ—¥å¿—ç›‘æ§ã€Artifacts æ‰‹æœºç­‰åŠŸèƒ½ï¼Œéå¸¸å®‰å…¨ï¼Œä½†æ˜¯æ€§èƒ½æ¬ ä½³ã€‚</li>
<li>Process Namespace Sharing (pns): å®‰å…¨æ€§æ¯” k8sapi å·®ä¸€ç‚¹ï¼Œå› ä¸º Process å¯¹å…¶ä»–æ‰€æœ‰å®¹å™¨éƒ½å¯è§äº†ã€‚ä½†æ˜¯ç›¸å¯¹çš„æ€§èƒ½å¥½å¾ˆå¤šã€‚</li>
</ol>
<p>åœ¨ docker è¢« kubernetes æŠ›å¼ƒçš„å½“ä¸‹ï¼Œå¦‚æœä½ å·²ç»æ”¹ç”¨ containerd åšä¸º kubernetes è¿è¡Œæ—¶ï¼Œé‚£ argo å°†ä¼šæ— æ³•å·¥ä½œï¼Œå› ä¸ºå®ƒé»˜è®¤ä½¿ç”¨ docker ä½œä¸ºè¿è¡Œæ—¶ï¼</p>
<p>æˆ‘ä»¬å»ºè®®å°† workflow executore æ”¹ä¸º <code>pns</code>ï¼Œå…¼é¡¾å®‰å…¨æ€§ä¸æ€§èƒ½ï¼Œ<code>workflow-controller-configmap</code> æŒ‰ç…§å¦‚ä¸‹æ–¹å¼ä¿®æ”¹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">workflow-controller-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    # ...çœç•¥è‹¥å¹²é…ç½®...
</span><span class="sd">
</span><span class="sd">    # Specifies the container runtime interface to use (default: docker)
</span><span class="sd">    # must be one of: docker, kubelet, k8sapi, pns
</span><span class="sd">    containerRuntimeExecutor: pns
</span><span class="sd">    # ...</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¸‰ä½¿ç”¨-argo-workflows-åš-ci-å·¥å…·">ä¸‰ã€ä½¿ç”¨ Argo Workflows åš CI å·¥å…·</h2>
<p>å®˜æ–¹çš„ Reference è¿˜ç®—è¯¦ç»†ï¼Œä¹Ÿæœ‰æä¾›éå¸¸å¤šçš„ examples ä¾›æˆ‘ä»¬å‚è€ƒï¼Œè¿™é‡Œæä¾›æˆ‘ä»¬å‡ ä¸ªå¸¸ç”¨çš„ workflow å®šä¹‰ã€‚</p>
<ol>
<li>ä½¿ç”¨ buildkit æ„å»ºé•œåƒï¼šhttps://github.com/argoproj/argo-workflows/blob/master/examples/buildkit-template.yaml
<ol>
<li>buildkit æ”¯æŒç¼“å­˜ï¼Œå¯ä»¥åœ¨è¿™ä¸ª example çš„åŸºç¡€ä¸Šè‡ªå®šä¹‰å‚æ•°</li>
<li>æ³¨æ„ä½¿ç”¨ PVC æ¥è·¨ step å…±äº«å­˜å‚¨ç©ºé—´è¿™ç§æ‰‹æ®µï¼Œé€Ÿåº¦ä¼šæ¯”é€šè¿‡ artifacts é«˜å¾ˆå¤šã€‚</li>
</ol>
</li>
</ol>
<h2 id="å››å¸¸è§é—®é¢˜">å››ã€å¸¸è§é—®é¢˜</h2>
<h3 id="1-workflow-é»˜è®¤ä½¿ç”¨-root-è´¦å·">1. workflow é»˜è®¤ä½¿ç”¨ root è´¦å·ï¼Ÿ</h3>
<p>workflow çš„æµç¨‹é»˜è®¤ä½¿ç”¨ root è´¦å·ï¼Œå¦‚æœä½ çš„é•œåƒé»˜è®¤ä½¿ç”¨é root è´¦å·ï¼Œè€Œä¸”è¦ä¿®æ”¹æ–‡ä»¶ï¼Œå°±å¾ˆå¯èƒ½é‡åˆ° Permission Denined çš„é—®é¢˜ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼šé€šè¿‡ Pod Security Context æ‰‹åŠ¨è®¾å®šå®¹å™¨çš„ user/group:</p>
<ul>
<li><a href="https://argoproj.github.io/argo/workflow-pod-security-context/" target="_blank" rel="noopener noreferrer">Workflow Pod Security Context</a></li>
</ul>
<p>å®‰å…¨èµ·è§ï¼Œæˆ‘å»ºè®®æ‰€æœ‰çš„ workflow éƒ½æ‰‹åŠ¨è®¾å®š <code>securityContext</code>ï¼Œç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">argoproj.io/v1alpha1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">WorkflowTemplate</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="m">1000</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>æˆ–è€…ä¹Ÿå¯ä»¥é€šè¿‡ <code>workflow-controller-configmap</code> çš„ <code>workflowDefaults</code> è®¾å®šé»˜è®¤çš„ workflow é…ç½®ã€‚</p>
<h3 id="2-å¦‚ä½•ä»-hashicorp-vault-ä¸­è¯»å–-secrets">2. å¦‚ä½•ä» hashicorp vault ä¸­è¯»å– secrets?</h3>
<blockquote>
<p>å‚è€ƒ <a href="https://github.com/argoproj/argo/issues/3267#issuecomment-650119636" target="_blank" rel="noopener noreferrer">Support to get secrets from Vault</a></p>
</blockquote>
<p>hashicorp vault ç›®å‰å¯ä»¥è¯´æ˜¯äº‘åŸç”Ÿé¢†åŸŸæœ€å—æ¬¢è¿çš„ secrets ç®¡ç†å·¥å…·ã€‚
æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒç”¨å®ƒåšä¸ºåˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼ŒåŒæ—¶åœ¨æœ¬åœ° CI/CD ä¸­ï¼Œä¹Ÿä½¿ç”¨å®ƒå­˜å‚¨ç›¸å…³çš„æ•æ„Ÿä¿¡æ¯ã€‚</p>
<p>ç°åœ¨è¿ç§»åˆ° argoï¼Œæˆ‘ä»¬å½“ç„¶å¸Œæœ›èƒ½å¤Ÿæœ‰ä¸€ä¸ªå¥½çš„æ–¹æ³•ä» vault ä¸­è¯»å–é…ç½®ã€‚</p>
<p>ç›®å‰æœ€æ¨èçš„æ–¹æ³•ï¼Œæ˜¯ä½¿ç”¨ vault çš„ vault-agentï¼Œå°† secrets ä»¥æ–‡ä»¶çš„å½¢å¼æ³¨å…¥åˆ° pod ä¸­ã€‚</p>
<p>é€šè¿‡ valut-policy - vault-role - k8s-serviceaccount ä¸€ç³»åˆ—è®¤è¯æˆæƒé…ç½®ï¼Œå¯ä»¥åˆ¶å®šéå¸¸ç»†ç²’åº¦çš„ secrets æƒé™è§„åˆ™ï¼Œè€Œä¸”é…ç½®ä¿¡æ¯é˜…åå³ç„šï¼Œå®‰å…¨æ€§å¾ˆé«˜ã€‚</p>
<h3 id="3-å¦‚ä½•åœ¨å¤šä¸ªåå­—ç©ºé—´ä¸­ä½¿ç”¨åŒä¸€ä¸ª-secrets">3. å¦‚ä½•åœ¨å¤šä¸ªåå­—ç©ºé—´ä¸­ä½¿ç”¨åŒä¸€ä¸ª secrets?</h3>
<p>ä½¿ç”¨ Namespace å¯¹ workflow è¿›è¡Œåˆ†ç±»æ—¶ï¼Œé‡åˆ°çš„ä¸€ä¸ªå¸¸è§é—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•åœ¨å¤šä¸ªåå­—ç©ºé—´ä½¿ç”¨ <code>private-git-creds</code>/<code>docker-config</code>/<code>minio</code>/<code>vault</code> ç­‰ workflow å¿…è¦çš„ secrets.</p>
<p>å¸¸è§çš„æ–¹æ³•æ˜¯æŠŠ secrets åœ¨æ‰€æœ‰åå­—ç©ºé—´ create ä¸€æ¬¡ã€‚</p>
<p>ä½†æ˜¯ä¹Ÿæœ‰æ›´æ–¹ä¾¿çš„ secrets åŒæ­¥å·¥å…·ï¼š</p>
<p>æ¯”å¦‚ï¼Œä½¿ç”¨ <a href="https://github.com/kyverno/kyverno" target="_blank" rel="noopener noreferrer">kyverno</a> è¿›è¡Œ secrets åŒæ­¥çš„é…ç½®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">kyverno.io/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterPolicy</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sync-secrets</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">background</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># å°† secret vault ä» argo Namespace åŒæ­¥åˆ°å…¶ä»–æ‰€æœ‰ Namespace</span><span class="w">
</span><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">sync-vault-secret</span><span class="w">
</span><span class="w">    </span><span class="nt">match</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">resources</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">kinds</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="l">Namespace</span><span class="w">
</span><span class="w">    </span><span class="nt">generate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">regcred</span><span class="w">
</span><span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;{{request.object.metadata.name}}&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">synchronize</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">      </span><span class="nt">clone</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">argo</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span><span class="w">  </span><span class="c"># å¯ä»¥é…ç½®å¤šä¸ª rulesï¼Œæ¯ä¸ª rules åŒæ­¥ä¸€ä¸ª secret</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢æä¾›çš„ kyverno é…ç½®ï¼Œä¼šå®æ—¶åœ°ç›‘æ§æ‰€æœ‰ Namespace å˜æ›´ï¼Œä¸€ä½†æœ‰æ–° Namespace è¢«åˆ›å»ºï¼Œå®ƒå°±ä¼šç«‹å³å°† <code>vault</code> secret åŒæ­¥åˆ°è¯¥ Namespace.</p>
<p>æˆ–è€…ï¼Œä½¿ç”¨ä¸“é—¨çš„ secrets/configmap å¤åˆ¶å·¥å…·ï¼š<a href="https://github.com/mittwald/kubernetes-replicator" target="_blank" rel="noopener noreferrer">kubernetes-replicator</a></p>
<h3 id="4-argo-å¯¹-cr-èµ„æºçš„éªŒè¯ä¸å¤Ÿä¸¥è°¨å†™é”™äº†-key-éƒ½ä¸æŠ¥é”™">4. Argo å¯¹ CR èµ„æºçš„éªŒè¯ä¸å¤Ÿä¸¥è°¨ï¼Œå†™é”™äº† key éƒ½ä¸æŠ¥é”™</h3>
<p>å¾…ç ”ç©¶</p>
<h3 id="5-å¦‚ä½•å½’æ¡£å†å²æ•°æ®">5. å¦‚ä½•å½’æ¡£å†å²æ•°æ®ï¼Ÿ</h3>
<p>Argo ç”¨çš„æ—¶é—´é•¿äº†ï¼Œè·‘è¿‡çš„ Workflows/Pods å…¨éƒ½ä¿å­˜åœ¨ Kubernetes/Argo Server ä¸­ï¼Œå¯¼è‡´ Argo è¶Šç”¨è¶Šæ…¢ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒArgo æä¾›äº†ä¸€äº›é…ç½®æ¥é™åˆ¶ Workflows å’Œ Pods çš„æ•°é‡ï¼Œè¯¦è§ï¼š<a href="https://argoproj.github.io/argo/cost-optimisation/#limit-the-total-number-of-workflows-and-pods" target="_blank" rel="noopener noreferrer">Limit The Total Number Of Workflows And Pods</a></p>
<p>è¿™äº›é™åˆ¶éƒ½æ˜¯ Workflow çš„å‚æ•°ï¼Œå¦‚æœå¸Œæœ›è®¾ç½®ä¸€ä¸ªå…¨å±€é»˜è®¤çš„é™åˆ¶ï¼Œå¯ä»¥æŒ‰ç…§å¦‚ä¸‹ç¤ºä¾‹ä¿®æ”¹ argo çš„ <code>workflow-controller-configmap</code> è¿™ä¸ª configmap:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ConfigMap</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">workflow-controller-configmap</span><span class="w">
</span><span class="w"></span><span class="nt">data</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    # Default values that will apply to all Workflows from this controller, unless overridden on the Workflow-level
</span><span class="sd">    # See more: docs/default-workflow-specs.md
</span><span class="sd">    workflowDefaults:
</span><span class="sd">      spec:
</span><span class="sd">        # must complete in 8h (28,800 seconds)
</span><span class="sd">        activeDeadlineSeconds: 28800
</span><span class="sd">        # keep workflows for 1d (86,400 seconds)
</span><span class="sd">        ttlStrategy:
</span><span class="sd">          secondsAfterCompletion: 86400
</span><span class="sd">          # secondsAfterSuccess: 5
</span><span class="sd">          # secondsAfterFailure: 500
</span><span class="sd">        # delete all pods as soon as they complete
</span><span class="sd">        podGC:
</span><span class="sd">          # å¯é€‰é¡¹ï¼š&#34;OnPodCompletion&#34;, &#34;OnPodSuccess&#34;, &#34;OnWorkflowCompletion&#34;, &#34;OnWorkflowSuccess&#34;
</span><span class="sd">          strategy: OnPodCompletion</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><h3 id="6-argo-çš„å…¶ä»–è¿›é˜¶é…ç½®">6. Argo çš„å…¶ä»–è¿›é˜¶é…ç½®</h3>
<p>Argo Workflows çš„é…ç½®ï¼Œéƒ½ä¿å­˜åœ¨ <code>workflow-controller-configmap</code> è¿™ä¸ª configmap ä¸­ï¼Œæˆ‘ä»¬å‰é¢å·²ç»æ¥è§¦åˆ°äº†å®ƒçš„éƒ¨åˆ†å†…å®¹ã€‚</p>
<p>è¿™é‡Œç»™å‡ºæ­¤é…ç½®æ–‡ä»¶çš„å®Œæ•´ examples: <a href="https://github.com/argoproj/argo/blob/master/docs/workflow-controller-configmap.yaml">https://github.com/argoproj/argo/blob/master/docs/workflow-controller-configmap.yaml</a></p>
<p>å…¶ä¸­ä¸€äº›å¯èƒ½éœ€è¦è‡ªå®šä¹‰çš„å‚æ•°å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>parallelism</code>: workflow çš„æœ€å¤§å¹¶è¡Œæ•°é‡</li>
<li><code>persistence</code>: å°†å®Œæˆçš„ workflows ä¿å­˜åˆ° postgresql/mysql ä¸­ï¼Œè¿™æ ·å³ä½¿ k8s ä¸­çš„ workflow è¢«åˆ é™¤äº†ï¼Œè¿˜èƒ½æŸ¥çœ‹ workflow è®°å½•
<ul>
<li>ä¹Ÿæ”¯æŒé…ç½®è¿‡æœŸæ—¶é—´</li>
</ul>
</li>
<li><code>sso</code>: å¯ç”¨å•ç‚¹ç™»å½•</li>
</ul>
<h3 id="7-æ˜¯å¦åº”è¯¥å°½é‡ä½¿ç”¨-cicd-å·¥å…·æä¾›çš„åŠŸèƒ½">7. æ˜¯å¦åº”è¯¥å°½é‡ä½¿ç”¨ CI/CD å·¥å…·æä¾›çš„åŠŸèƒ½ï¼Ÿ</h3>
<p>æˆ‘ä»åŒäº‹ä»¥åŠç½‘ç»œä¸Šï¼Œäº†è§£åˆ°éƒ¨åˆ† DevOps äººå‘˜ä¸»å¼ å°½é‡è‡ªå·±ä½¿ç”¨ Python/Go æ¥å®ç° CI/CD æµæ°´çº¿ï¼ŒCI/CD å·¥å…·æä¾›çš„åŠŸèƒ½èƒ½ä¸ä½¿ç”¨å°±ä¸è¦ä½¿ç”¨ã€‚</p>
<p>å› æ­¤æœ‰æ­¤ä¸€é—®ã€‚ä¸‹é¢åšä¸‹è¯¦ç»†çš„åˆ†æï¼š</p>
<p>å°½é‡ä½¿ç”¨ CI/CD å·¥å…·æä¾›çš„æ’ä»¶/åŠŸèƒ½ï¼Œå¥½å¤„æ˜¯ä¸éœ€è¦è‡ªå·±å»å®ç°ï¼Œå¯ä»¥é™ä½ç»´æŠ¤æˆæœ¬ã€‚
ä½†æ˜¯ç›¸å¯¹çš„è¿ç»´äººå‘˜å°±éœ€è¦æ·±å…¥å­¦ä¹ è¿™ä¸ª CI/CD å·¥å…·çš„ä½¿ç”¨ï¼Œå¦å¤–è¿˜ä¼šå’Œ CI/CD å·¥å…·ç»‘å®šï¼Œä¼šå¢åŠ è¿ç§»éš¾åº¦ã€‚</p>
<p>è€Œå°½é‡è‡ªå·±ç”¨ Python ç­‰ä»£ç å»å®ç°æµæ°´çº¿ï¼Œè®© CI/CD å·¥å…·åªè´Ÿè´£è°ƒåº¦ä¸è¿è¡Œè¿™äº› Python ä»£ç ï¼Œ
é‚£ CI/CD å°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°éšä¾¿æ¢ï¼Œè¿ç»´äººå‘˜ä¹Ÿä¸éœ€è¦å»æ·±å…¥å­¦ä¹  CI/CD å·¥å…·çš„ä½¿ç”¨ã€‚
ç¼ºç‚¹æ˜¯å¯èƒ½ä¼šå¢åŠ  CI/CD ä»£ç çš„å¤æ‚æ€§ã€‚</p>
<p>æˆ‘è§‚å¯Ÿåˆ° argo/drone çš„ä¸€äº› examplesï¼Œå‘ç°å®ƒä»¬çš„ç‰¹å¾æ˜¯ï¼š</p>
<ol>
<li>æ‰€æœ‰ CI/CD ç›¸å…³çš„é€»è¾‘ï¼Œå…¨éƒ½å®ç°åœ¨æµæ°´çº¿ä¸­ï¼Œä¸éœ€è¦å…¶ä»–æ„å»ºä»£ç </li>
<li>æ¯ä¸€ä¸ª step éƒ½ä½¿ç”¨ä¸“ç”¨é•œåƒï¼šgolang/nodejs/python
<ol>
<li>æ¯”å¦‚å…ˆä½¿ç”¨ golang é•œåƒè¿›è¡Œæµ‹è¯•ã€æ„å»ºï¼Œå†ä½¿ç”¨ kaniko å°†æ‰“åŒ…æˆå®¹å™¨é•œåƒ</li>
</ol>
</li>
</ol>
<p>é‚£æ˜¯å¦åº”è¯¥å°½é‡ä½¿ç”¨ CI/CD å·¥å…·æä¾›çš„åŠŸèƒ½å‘¢ï¼Ÿ
<strong>å…¶å®è¿™å°±æ˜¯æœ‰å¤šç§æ–¹æ³•å®ç°åŒä¸€ä»¶äº‹ï¼Œè¯¥ç”¨å“ªç§æ–¹æ³•çš„é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜åœ¨å„ä¸ªé¢†åŸŸéƒ½å¾ˆå¸¸è§ã€‚</strong></p>
<p>ä»¥æˆ‘ç›®å‰çš„ç»éªŒæ¥çœ‹ï¼Œéœ€è¦å…·ä½“é—®é¢˜å…·ä½“åˆ†æï¼Œä»¥ Argo Workflows ä¸ºä¾‹ï¼š</p>
<ol>
<li>æµæ°´çº¿æœ¬èº«éå¸¸ç®€å•ï¼Œé‚£å®Œå…¨å¯ä»¥ç›´æ¥ä½¿ç”¨ argo æ¥å®ç°ï¼Œæ²¡å¿…è¦è‡ªå·±å†æä¸ª python è„šæœ¬
<ol>
<li>ç®€å•çš„æµæ°´çº¿ï¼Œè¿ç§»èµ·æ¥å¾€å¾€ä¹Ÿéå¸¸ç®€å•ã€‚æ²¡å¿…è¦ä¸ºäº†å¯è¿ç§»æ€§ï¼Œéè¦ç”¨ argo å»è°ƒç”¨ python è„šæœ¬ã€‚</li>
</ol>
</li>
<li>æµæ°´çº¿çš„æ­¥éª¤ä¹‹é—´åŒ…å«å¾ˆå¤šé€»è¾‘åˆ¤æ–­/æ•°æ®ä¼ é€’ï¼Œé‚£å¾ˆå¯èƒ½æ˜¯ä½ çš„æµæ°´çº¿è®¾è®¡æœ‰é—®é¢˜ï¼
<ol>
<li><strong>æµæ°´çº¿çš„æ­¥éª¤ä¹‹é—´ä¼ é€’çš„æ•°æ®åº”è¯¥å°½å¯èƒ½å°‘ï¼å¤æ‚çš„é€»è¾‘åˆ¤æ–­åº”è¯¥å°½é‡å°è£…åœ¨å…¶ä¸­ä¸€ä¸ªæ­¥éª¤ä¸­ï¼</strong></li>
<li>è¿™ç§æƒ…å†µä¸‹ï¼Œå°±åº”è¯¥ä½¿ç”¨ python è„šæœ¬æ¥å°è£…å¤æ‚çš„é€»è¾‘ï¼Œè€Œä¸åº”è¯¥å°†è¿™äº›é€»è¾‘æš´éœ²åˆ° Argo Workflows ä¸­ï¼</li>
</ol>
</li>
<li>æˆ‘éœ€è¦æ‰¹é‡è¿è¡Œå¾ˆå¤šçš„æµæ°´çº¿ï¼Œè€Œä¸”å®ƒä»¬ä¹‹é—´è¿˜æœ‰å¤æ‚çš„ä¾èµ–å…³ç³»ï¼šé‚£æ˜¾ç„¶åº”è¯¥åˆ©ç”¨ä¸Š argo wrokflow çš„é«˜çº§ç‰¹æ€§ã€‚
<ol>
<li>argo çš„ dag/steps å’Œ workflow of workflows è¿™ä¸¤ä¸ªåŠŸèƒ½ç»“åˆï¼Œå¯ä»¥ç®€å•åœ°å®ç°ä¸Šè¿°åŠŸèƒ½ã€‚</li>
</ol>
</li>
</ol>
<h2 id="8-å¦‚ä½•æå‡-argo-workflows-çš„åˆ›å»ºå’Œé”€æ¯é€Ÿåº¦">8. å¦‚ä½•æå‡ Argo Workflows çš„åˆ›å»ºå’Œé”€æ¯é€Ÿåº¦ï¼Ÿ</h2>
<p>æˆ‘ä»¬å‘ç° workflow çš„ podï¼Œåˆ›å»ºå’Œé”€æ¯æ¶ˆè€—äº†å¤§é‡æ—¶é—´ï¼Œå°¤å…¶æ˜¯é”€æ¯ã€‚
è¿™å¯¼è‡´æˆ‘ä»¬å•ä¸ªæµæ°´çº¿åœ¨ argo ä¸Šè·‘ï¼Œè¿˜æ²¡åœ¨ jenkins ä¸Šè·‘æ›´å¿«ã€‚</p>
<h2 id="ä½¿ç”¨ä½“éªŒ">ä½¿ç”¨ä½“éªŒ</h2>
<p>ç›®å‰å·²ç»ä½¿ç”¨ Argo Workflows ä¸€ä¸ªæœˆå¤šäº†ï¼Œæ€»çš„æ¥è¯´ï¼Œæœ€éš¾ç”¨çš„å°±æ˜¯ Web UIã€‚</p>
<p>å…¶ä»–çš„éƒ½æ˜¯å°é—®é¢˜ï¼Œåªæœ‰ Web UI æ˜¯çœŸçš„è¶…éš¾ç”¨ï¼Œæ„Ÿè§‰æ ¹æœ¬å°±æ²¡æœ‰å¥½å¥½åšè¿‡è®¾è®¡&hellip;</p>
<p>æ€¥éœ€ä¸€ä¸ªç¬¬ä¸‰æ–¹ Web UI&hellip;</p>
<h2 id="ç”»å¤–---å¦‚ä½•å¤„ç†å…¶ä»–-kubernetes-èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»">ç”»å¤– - å¦‚ä½•å¤„ç†å…¶ä»– Kubernetes èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»</h2>
<p>Argo ç›¸æ¯”å…¶ä»– CI å·¥å…·ï¼Œæœ€å¤§çš„ç‰¹ç‚¹ï¼Œæ˜¯å®ƒå‡è®¾ã€Œä»»åŠ¡ã€ä¹‹é—´æ˜¯æœ‰ä¾èµ–å…³ç³»çš„ï¼Œå› æ­¤å®ƒæä¾›äº†å¤šç§åè°ƒç¼–æ’ã€Œä»»åŠ¡ã€çš„æ–¹æ³•ã€‚</p>
<p>ä½†æ˜¯è²Œä¼¼ Argo CD å¹¶æ²¡æœ‰ç»§æ‰¿è¿™ä¸ªç†å¿µï¼ŒArgo CD éƒ¨ç½²æ—¶ï¼Œå¹¶ä¸èƒ½åœ¨ kubernetes èµ„æºä¹‹é—´ï¼Œé€šè¿‡ DAG ç­‰æ–¹æ³•å®šä¹‰ä¾èµ–å…³ç³»ã€‚</p>
<p>å¾®æœåŠ¡ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œå¸Œæœ›èƒ½æŒ‰ä¾èµ–å…³ç³»è¿›è¡Œéƒ¨ç½²ï¼Œè€Œ ArgoCD/FluxCD éƒ¨ç½² kubernetes yaml æ—¶éƒ½æ˜¯ä¸è€ƒè™‘ä»»ä½•ä¾èµ–å…³ç³»çš„ã€‚è¿™é‡Œå°±å­˜åœ¨ä¸€äº›çŸ›ç›¾ã€‚</p>
<p>è§£å†³è¿™ä¸ªçŸ›ç›¾çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œæˆ‘æŸ¥é˜…äº†å¾ˆå¤šèµ„æ–™ï¼Œä¹Ÿè‡ªå·±åšäº†ä¸€äº›æ€è€ƒï¼Œå¾—åˆ°çš„æœ€ä½³å®è·µæ¥è‡ª<a href="https://developer.aliyun.com/article/573791" target="_blank" rel="noopener noreferrer">è§£å†³æœåŠ¡ä¾èµ– - é˜¿é‡Œäº‘ ACK å®¹å™¨æœåŠ¡</a>ï¼Œå®ƒç»™å‡ºäº†ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<ol>
<li><strong>åº”ç”¨ç«¯æœåŠ¡ä¾èµ–æ£€æŸ¥</strong>: å³åœ¨å¾®æœåŠ¡çš„å…¥å£æ·»åŠ ä¾èµ–æ£€æŸ¥é€»è¾‘ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–çš„å¾®æœåŠ¡/æ•°æ®åº“éƒ½å¯è®¿é—®äº†ï¼Œå°±ç»­æ¢é’ˆæ‰èƒ½è¿”å› 200. å¦‚æœè¶…æ—¶å°±ç›´æ¥ Crash</li>
<li><strong>ç‹¬ç«‹çš„æœåŠ¡ä¾èµ–æ£€æŸ¥é€»è¾‘</strong>: éƒ¨åˆ†é—ç•™ä»£ç ä½¿ç”¨æ–¹æ³•ä¸€æ”¹é€ èµ·æ¥æˆ–è®¸ä¼šå¾ˆå›°éš¾ï¼Œè¿™æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨ <strong>pod initContainer</strong> æˆ–è€…å®¹å™¨çš„å¯åŠ¨è„šæœ¬ä¸­ï¼ŒåŠ å…¥ä¾èµ–æ£€æŸ¥é€»è¾‘ã€‚</li>
</ol>
<p>ä½†æ˜¯è¿™ä¸¤ä¸ªæ–¹æ¡ˆä¹Ÿè¿˜æ˜¯å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œåœ¨è¯´æ˜é—®é¢˜å‰ï¼Œæˆ‘å…ˆè¯´æ˜ä¸€ä¸‹æˆ‘ä»¬ã€Œ<strong>æŒ‰åºéƒ¨ç½²</strong>ã€çš„åº”ç”¨åœºæ™¯ã€‚</p>
<p>æˆ‘ä»¬æ˜¯ä¸€ä¸ªå¾ˆå°çš„å›¢é˜Ÿï¼Œåç«¯åš RPC æ¥å£å‡çº§æ—¶ï¼Œé€šå¸¸æ˜¯ç›´æ¥åœ¨å¼€å‘ç¯å¢ƒåšå…¨é‡å‡çº§+æµ‹è¯•ã€‚
å› æ­¤è¿ç»´è¿™è¾¹ä¹Ÿæ˜¯ï¼Œæ¯æ¬¡éƒ½æ˜¯åšå…¨é‡å‡çº§ã€‚</p>
<p>å› ä¸ºæ²¡æœ‰åè®®åå•†æœºåˆ¶ï¼Œæ–°çš„å¾®æœåŠ¡çš„ã€ŒRPC æœåŠ¡ç«¯ã€å°†å…¼å®¹ v1 v2 æ–°æ—§ä¸¤ç§åè®®ï¼Œè€Œæ–°çš„ã€ŒRPC å®¢æˆ·ç«¯ã€å°†ç›´æ¥ä½¿ç”¨ v2 åè®®å»è¯·æ±‚å…¶ä»–å¾®æœåŠ¡ã€‚
è¿™å°±å¯¼è‡´æˆ‘ä»¬<strong>å¿…é¡»å…ˆå‡çº§ã€ŒRPC æœåŠ¡ç«¯ã€ï¼Œç„¶åæ‰èƒ½å‡çº§ã€ŒRPC å®¢æˆ·ç«¯ã€</strong>ã€‚</p>
<p>ä¸ºæ­¤ï¼Œåœ¨è¿›è¡Œå¾®æœåŠ¡çš„å…¨é‡å‡çº§æ—¶ï¼Œå°±éœ€è¦æ²¿ç€ RPC è°ƒç”¨é“¾è·¯æŒ‰åºå‡çº§ï¼Œè¿™é‡Œå°±æ¶‰åŠåˆ°äº† Kubernetes èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
<blockquote>
<p>æˆ‘ç›®å‰è·çŸ¥çš„å…³é”®é—®é¢˜åœ¨äºï¼šæˆ‘ä»¬ä½¿ç”¨çš„å¹¶ä¸æ˜¯çœŸæ­£çš„å¾®æœåŠ¡å¼€å‘æ¨¡å¼ï¼Œè€Œæ˜¯åœ¨æŠŠæ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿå½“æˆä¸€ä¸ªã€Œå•ä½“æœåŠ¡ã€åœ¨çœ‹å¾…ï¼Œæ‰€ä»¥å¼•ç”³å‡ºäº†è¿™æ ·çš„ä¾èµ–å…³é”®çš„é—®é¢˜ã€‚
æˆ‘è¿›å…¥çš„æ–°å…¬å¸å®Œå…¨æ²¡æœ‰è¿™æ ·çš„é—®é¢˜ï¼Œæ‰€æœ‰çš„æœåŠ¡ä¹‹é—´åœ¨ CI/CD è¿™ä¸ªé˜¶æ®µéƒ½æ˜¯è§£è€¦çš„ï¼ŒCI/CD ä¸éœ€è¦è€ƒè™‘æœåŠ¡ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œä¹Ÿæ²¡æœ‰è‡ªåŠ¨æŒ‰ç…§ä¾èµ–å…³ç³»è¿›è¡Œå¾®æœåŠ¡æ‰¹é‡å‘å¸ƒçš„åŠŸèƒ½ï¼Œè¿™äº›éƒ½ç”±å¼€å‘äººå‘˜è‡ªè¡Œç»´æŠ¤ã€‚
æˆ–è®¸è¿™æ‰æ˜¯æ­£ç¡®çš„ä½¿ç”¨å§¿åŠ¿ï¼Œå¦‚æœåŠ¨ä¸åŠ¨å°±è¦æ‰¹é‡æ›´æ–°ä¸€å¤§æ‰¹æœåŠ¡ï¼Œé‚£å¾®æœåŠ¡ä½“ç³»çš„è®¾è®¡ã€æ‹†åˆ†è‚¯å®šæ˜¯æœ‰é—®é¢˜äº†ï¼Œç”Ÿäº§ç¯å¢ƒä¹Ÿä¸ä¼šå…è®¸è¿™ä¹ˆè½»ç‡çš„æ›´æ–°ã€‚</p>
</blockquote>
<p>å‰é¢è®²äº†ï¼Œé˜¿é‡Œäº‘æä¾›çš„ã€Œåº”ç”¨ç«¯æœåŠ¡ä¾èµ–æ£€æŸ¥ã€å’Œã€Œç‹¬ç«‹çš„æœåŠ¡ä¾èµ–æ£€æŸ¥é€»è¾‘ã€æ˜¯æœ€ä½³å®è·µã€‚å®ƒä»¬çš„ä¼˜ç‚¹æœ‰ï¼š</p>
<ol>
<li>ç®€åŒ–éƒ¨ç½²é€»è¾‘ï¼Œæ¯æ¬¡ç›´æ¥åšå…¨é‡éƒ¨ç½²å°± OKã€‚</li>
<li>æå‡éƒ¨ç½²é€Ÿåº¦ï¼Œå…·ä½“ä½“ç°åœ¨ï¼šGitOps éƒ¨ç½²æµç¨‹åªéœ€è¦èµ°ä¸€æ¬¡ï¼ˆæŒ‰åºéƒ¨ç½²è¦å¾ˆå¤šæ¬¡ï¼‰ã€æ‰€æœ‰é•œåƒéƒ½æå‰æ‹‰å–å¥½äº†ã€æ‰€æœ‰ Pod ä¹Ÿéƒ½æå‰å¯åŠ¨äº†ã€‚</li>
</ol>
<p>ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜æ˜¯ã€Œç°åº¦å‘å¸ƒã€æˆ–è€…ã€Œæ»šåŠ¨æ›´æ–°ã€ï¼Œè¿™ä¸¤ç§æƒ…å†µä¸‹éƒ½å­˜åœ¨<strong>æ–°æ—§ç‰ˆæœ¬å…±å­˜</strong>çš„é—®é¢˜ã€‚</p>
<p>å¦‚æœå‡ºç°äº† RPC æ¥å£å‡çº§ï¼Œé‚£å°±å¿…é¡»å…ˆå®Œæˆã€ŒRPC æœåŠ¡ç«¯ã€çš„ã€Œç°åº¦å‘å¸ƒã€æˆ–è€…ã€Œæ»šåŠ¨æ›´æ–°ã€ï¼Œå†å»æ›´æ–°ã€ŒRPC å®¢æˆ·ç«¯ã€ã€‚</p>
<p>å¦åˆ™å¦‚æœç›´æ¥å¯¹æ‰€æœ‰å¾®æœåŠ¡åšç°åº¦æ›´æ–°ï¼Œåªä¾é ã€ŒæœåŠ¡ä¾èµ–æ£€æŸ¥ã€ï¼Œå°±ä¼šå‡ºç°è¿™æ ·çš„é—®é¢˜â€”â€”ã€ŒRPC æœåŠ¡ç«¯ã€å¤„äºã€Œè–›å®šè°”ã€çŠ¶æ€ï¼Œä½ è°ƒç”¨åˆ°çš„æœåŠ¡ç«¯ç‰ˆæœ¬æ˜¯æ–°è¿˜æ˜¯æ—§ï¼Œå–å†³äºè´Ÿè½½å‡è¡¡çš„ç­–ç•¥å’Œæ¦‚ç‡ã€‚</p>
<p>**å› æ­¤åœ¨åš RPC æ¥å£çš„å…¨é‡å‡çº§æ—¶ï¼Œåªä¾é ã€ŒæœåŠ¡ä¾èµ–æ£€æŸ¥ã€æ˜¯è¡Œä¸é€šçš„ã€‚**æˆ‘ç›®å‰æƒ³åˆ°çš„æ–¹æ¡ˆï¼Œæœ‰å¦‚ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>æˆ‘ä»¬å½“å‰çš„ä½¿ç”¨æ–¹æ¡ˆï¼š<strong>ç›´æ¥åœ¨ yaml éƒ¨ç½²è¿™ä¸€æ­¥å®ç°æŒ‰åºéƒ¨ç½²</strong>ï¼Œæ¯æ¬¡éƒ¨ç½²åå°±è½®è¯¢ kube-apiserverï¼Œç¡®è®¤å…¨éƒ¨ç°åº¦å®Œæˆï¼Œå†è¿›è¡Œä¸‹ä¸€é˜¶æ®µçš„ yaml éƒ¨ç½²ã€‚</li>
<li><strong>è®©åç«¯åŠ ä¸ªå‚æ•°æ¥æ§åˆ¶å®¢æˆ·ç«¯ä½¿ç”¨çš„ RPC åè®®ç‰ˆæœ¬ï¼Œæˆ–è€…æä¸€ä¸ªåè®®åå•†</strong>ã€‚è¿™æ ·å°±ä¸éœ€è¦æ§åˆ¶å¾®æœåŠ¡å‘å¸ƒé¡ºåºäº†ã€‚</li>
<li>ç¤¾åŒºå¾ˆå¤šæœ‰çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²éƒ½æ¶‰åŠåˆ°éƒ¨ç½²é¡ºåºç­‰å¤æ‚æ“ä½œï¼Œç›®å‰æµè¡Œçš„è§£å†³æ–¹æ¡ˆæ˜¯<strong>ä½¿ç”¨ Operator+CRD æ¥å®ç°è¿™ç±»åº”ç”¨çš„éƒ¨ç½²</strong>ã€‚Operator ä¼šè‡ªè¡Œå¤„ç†å¥½å„ä¸ªç»„ä»¶çš„éƒ¨ç½²é¡ºåºã€‚</li>
</ul>
<h2 id="å‚è€ƒæ–‡æ¡£">å‚è€ƒæ–‡æ¡£</h2>
<ul>
<li><a href="https://www.infoq.cn/article/fFZPvrKtbykg53x03IaH" target="_blank" rel="noopener noreferrer">ArgoåŠ å…¥CNCFå­µåŒ–å™¨ï¼Œä¸€æ–‡è§£æKubernetesåŸç”Ÿå·¥ä½œæµ</a></li>
</ul>
<p>è§†é¢‘:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=fKiU7txd4RI&amp;list=PLj6h78yzYM2Pn8RxfLh2qrXBDftr6Qjut&amp;index=149" target="_blank" rel="noopener noreferrer">How to Multiply the Power of Argo Projects By Using Them Together - Hong Wang</a></li>
</ul>]]></description></item><item><title>secrets ç®¡ç†å·¥å…· Vault çš„ä»‹ç»ã€å®‰è£…åŠä½¿ç”¨</title><link>https://ryan4yin.space/posts/expirence-of-vault/</link><pubDate>Sun, 24 Jan 2021 09:31:41 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/expirence-of-vault/</guid><description><![CDATA[<p><a href="https://github.com/hashicorp/vault" target="_blank" rel="noopener noreferrer">Vault</a> æ˜¯ hashicorp æ¨å‡ºçš„ secrets ç®¡ç†ã€åŠ å¯†å³æœåŠ¡ä¸æƒé™ç®¡ç†å·¥å…·ã€‚å®ƒçš„åŠŸèƒ½ç®€ä»‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>secrets ç®¡ç†ï¼šæ”¯æŒä¿å­˜å„ç§è‡ªå®šä¹‰ä¿¡æ¯ã€è‡ªåŠ¨ç”Ÿæˆå„ç±»å¯†é’¥ï¼Œvault è‡ªåŠ¨ç”Ÿæˆçš„å¯†é’¥è¿˜èƒ½è‡ªåŠ¨è½®è½¬(rotate)</li>
<li>è®¤è¯æ–¹å¼ï¼šæ”¯æŒæ¥å…¥å„å¤§äº‘å‚å•†çš„è´¦å·ä½“ç³»ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘RAMå­è´¦å·ä½“ç³»ï¼‰æˆ–è€… LDAP ç­‰è¿›è¡Œèº«ä»½éªŒè¯ï¼Œä¸éœ€è¦åˆ›å»ºé¢å¤–çš„è´¦å·ä½“ç³»ã€‚</li>
<li>æƒé™ç®¡ç†ï¼šé€šè¿‡ policyï¼Œå¯ä»¥è®¾å®šéå¸¸ç»†è‡´çš„ ACL æƒé™ã€‚</li>
<li>å¯†é’¥å¼•æ“ï¼šä¹Ÿæ”¯æŒæ¥ç®¡å„å¤§äº‘å‚å•†çš„è´¦å·ä½“ç³»ï¼ˆæ¯”å¦‚é˜¿é‡Œäº‘RAMå­è´¦å·ä½“ç³»ï¼‰ï¼Œå®ç° API Key çš„è‡ªåŠ¨è½®è½¬ã€‚</li>
<li>æ”¯æŒæ¥å…¥ kubernetes rbac æƒé™ä½“ç³»ï¼Œé€šè¿‡ serviceaccount+role ä¸ºæ¯ä¸ª Pod å•ç‹¬é…ç½®æƒé™ã€‚</li>
</ol>
<ul>
<li>æ”¯æŒé€šè¿‡ sidecar/init-container å°† secrets æ³¨å…¥åˆ° pod ä¸­ï¼Œæˆ–è€…é€šè¿‡ k8s operator å°† vault æ•°æ®åŒæ­¥åˆ° k8s secrets ä¸­</li>
</ul>
<p>åœ¨ä½¿ç”¨ Vault ä¹‹å‰ï¼Œæˆ‘ä»¬æ˜¯ä»¥æºç¨‹å¼€æºçš„ <a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener noreferrer">Apollo</a> ä½œä¸ºå¾®æœåŠ¡çš„åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒã€‚</p>
<p>Apollo åœ¨å›½å†…éå¸¸æµè¡Œã€‚å®ƒåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒé…ç½®çš„ç»§æ‰¿ï¼Œä¹Ÿæœ‰æä¾› HTTP API æ–¹ä¾¿è‡ªåŠ¨åŒ–ã€‚
ç¼ºç‚¹æ˜¯æƒé™ç®¡ç†å’Œ secrets ç®¡ç†æ¯”è¾ƒå¼±ï¼Œä¹Ÿä¸æ”¯æŒä¿¡æ¯åŠ å¯†ï¼Œä¸é€‚åˆç›´æ¥å­˜å‚¨æ•æ„Ÿä¿¡æ¯ã€‚å› æ­¤æˆ‘ä»¬ç°åœ¨åˆ‡æ¢åˆ°äº† Vault.</p>
<p>ç›®å‰æˆ‘ä»¬æœ¬åœ°çš„ CI/CD æµæ°´çº¿å’Œäº‘ä¸Šçš„å¾®æœåŠ¡ä½“ç³»ï¼Œéƒ½æ˜¯ä½¿ç”¨çš„ Vault åš secrets ç®¡ç†.</p>
<h2 id="ä¸€vault-åŸºç¡€æ¦‚å¿µ">ä¸€ã€Vault åŸºç¡€æ¦‚å¿µ</h2>
<blockquote>
<p>ã€ŒåŸºæœ¬æ¦‚å¿µã€è¿™ä¸€èŠ‚ï¼ŒåŸºæœ¬éƒ½ç¿»è¯‘è‡ªå®˜æ–¹æ–‡æ¡£: <a href="https://www.vaultproject.io/docs/internals/architecture">https://www.vaultproject.io/docs/internals/architecture</a></p>
</blockquote>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹ Vault çš„æ¶æ„å›¾ï¼š</p>
<p><figure><a class="lightgallery" href="/images/expirence-of-vault/vault-layers.png" title="/images/expirence-of-vault/vault-layers.png" data-thumbnail="/images/expirence-of-vault/vault-layers.png" data-sub-html="<h2>vault layers</h2>">
        
    </a><figcaption class="image-caption">vault layers</figcaption>
    </figure></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå‡ ä¹æ‰€æœ‰çš„ Vault ç»„ä»¶éƒ½è¢«ç»Ÿç§°ä¸ºã€Œå±éšœ(Barrier)ã€ï¼Œ
Vault å¯ä»¥ç®€å•åœ°è¢«åˆ’åˆ†ä¸º Storage Backendã€Barrier å’Œ HTTP/S API ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>
<p>ç±»æ¯”é“¶è¡Œé‡‘åº“ï¼Œã€Œå±éšœã€å°±æ˜¯ Vault(é‡‘åº“) å‘¨å›´çš„ã€Œé’¢é“ã€å’Œã€Œæ··å‡åœŸã€ï¼ŒStorage Backend å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„æ‰€æœ‰æ•°æ®æµåŠ¨éƒ½éœ€è¦ç»è¿‡å®ƒã€‚</p>
<p>ã€Œå±éšœã€ç¡®ä¿åªæœ‰åŠ å¯†æ•°æ®ä¼šè¢«å†™å…¥ Storage Backendï¼ŒåŠ å¯†æ•°æ®åœ¨ç»è¿‡ã€Œå±éšœã€è¢«è¯»å‡ºçš„è¿‡ç¨‹ä¸­è¢«éªŒè¯ä¸è§£å¯†ã€‚</p>
<p>å’Œé“¶è¡Œé‡‘åº“çš„å¤§é—¨éå¸¸ç±»ä¼¼ï¼ŒBarrier ä¹Ÿå¿…é¡»å…ˆè§£å°ï¼Œæ‰èƒ½è§£å¯† Storage Backend ä¸­çš„æ•°æ®ã€‚</p>
<h3 id="1-æ•°æ®å­˜å‚¨åŠåŠ å¯†è§£å¯†">1. æ•°æ®å­˜å‚¨åŠåŠ å¯†è§£å¯†</h3>
<p>Storage Backend(åç«¯å­˜å‚¨): Vault è‡ªèº«ä¸å­˜å‚¨æ•°æ®ï¼Œå› æ­¤éœ€è¦ä¸ºå®ƒé…ç½®ä¸€ä¸ªã€ŒStorage Backendã€ã€‚
ã€ŒStorage Backendã€æ˜¯ä¸å—ä¿¡ä»»çš„ï¼Œåªç”¨äºå­˜å‚¨åŠ å¯†æ•°æ®ã€‚</p>
<p>Initialization(åˆå§‹åŒ–): Vault åœ¨é¦–æ¬¡å¯åŠ¨æ—¶éœ€è¦åˆå§‹åŒ–ï¼Œè¿™ä¸€æ­¥ç”Ÿæˆä¸€ä¸ªã€ŒåŠ å¯†å¯†é’¥(Encryption Key)ã€ç”¨äºåŠ å¯†æ•°æ®ï¼ŒåŠ å¯†å®Œæˆçš„æ•°æ®æ‰èƒ½è¢«ä¿å­˜åˆ° Storage Backend.</p>
<p>Unseal(è§£å°): Vault å¯åŠ¨åï¼Œå› ä¸ºä¸çŸ¥é“ã€ŒåŠ å¯†å¯†é’¥ã€ï¼Œå®ƒä¼šè¿›å…¥ã€Œå°å°(Sealed)ã€çŠ¶æ€ï¼Œåœ¨ã€Œè§£å°(Unseal)ã€å‰æ— æ³•è¿›è¡Œä»»ä½•æ“ä½œã€‚</p>
<p>ã€ŒåŠ å¯†å¯†é’¥ã€è¢«ã€Œmaster keyã€ä¿æŠ¤ï¼Œæˆ‘ä»¬å¿…é¡»æä¾›ã€Œmaster keyã€æ‰èƒ½å®Œæˆ Unseal æ“ä½œã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒVault ä½¿ç”¨<a href="https://medium.com/taipei-ethereum-meetup/%E7%A7%81%E9%91%B0%E5%88%86%E5%89%B2-shamirs-secret-sharing-7a70c8abf664" target="_blank" rel="noopener noreferrer">æ²™ç±³å°”å¯†é’¥å…±äº«ç®—æ³•</a>
å°†ã€Œmaster keyã€åˆ†å‰²æˆäº”ä¸ªã€ŒKey Shares(åˆ†äº«å¯†é’¥)ã€ï¼Œå¿…é¡»è¦æä¾›å…¶ä¸­ä»»æ„ä¸‰ä¸ªã€ŒKey Sharesã€æ‰èƒ½é‡å»ºå‡ºã€Œmaster keyã€ä»è€Œå®Œæˆ Unseal.</p>
<p><figure><a class="lightgallery" href="/images/expirence-of-vault/vault-shamir-secret-sharing.svg" title="/images/expirence-of-vault/vault-shamir-secret-sharing.svg" data-thumbnail="/images/expirence-of-vault/vault-shamir-secret-sharing.svg" data-sub-html="<h2>vault-shamir-secret-sharing</h2>">
        
    </a><figcaption class="image-caption">vault-shamir-secret-sharing</figcaption>
    </figure></p>
<blockquote>
<p>ã€ŒKey Sharesã€çš„æ•°é‡ï¼Œä»¥åŠé‡å»ºã€Œmaster keyã€æœ€å°‘éœ€è¦çš„ key shares æ•°é‡ï¼Œéƒ½æ˜¯å¯ä»¥è°ƒæ•´çš„ã€‚
æ²™ç±³å°”å¯†é’¥å…±äº«ç®—æ³•ä¹Ÿå¯ä»¥å…³é—­ï¼Œè¿™æ · master key å°†è¢«ç›´æ¥ç”¨äº Unseal.</p>
</blockquote>
<h3 id="2-è®¤è¯ç³»ç»ŸåŠæƒé™ç³»ç»Ÿ">2. è®¤è¯ç³»ç»ŸåŠæƒé™ç³»ç»Ÿ</h3>
<p>åœ¨è§£å°å®Œæˆåï¼ŒVault å°±å¯ä»¥å¼€å§‹å¤„ç†è¯·æ±‚äº†ã€‚</p>
<p>HTTP è¯·æ±‚è¿›å…¥åçš„æ•´ä¸ªå¤„ç†æµç¨‹éƒ½ç”± vault core ç®¡ç†ï¼Œcore ä¼šå¼ºåˆ¶è¿›è¡Œ ACL æ£€æŸ¥ï¼Œå¹¶ç¡®ä¿å®¡è®¡æ—¥å¿—(audit logging)å®Œæˆè®°å½•ã€‚</p>
<p>å®¢æˆ·ç«¯é¦–æ¬¡è¿æ¥ vault æ—¶ï¼Œéœ€è¦å…ˆå®Œæˆèº«ä»½è®¤è¯ï¼Œvault çš„ã€Œauth methodsã€æ¨¡å—æœ‰å¾ˆå¤šèº«ä»½è®¤è¯æ–¹æ³•å¯é€‰ï¼š</p>
<ol>
<li>ç”¨æˆ·å‹å¥½çš„è®¤è¯æ–¹æ³•ï¼Œé€‚åˆç®¡ç†å‘˜ä½¿ç”¨ï¼šusername/passwordã€äº‘æœåŠ¡å•†ã€ldap
<ol>
<li>åœ¨åˆ›å»º user çš„æ—¶å€™ï¼Œéœ€è¦ä¸º user ç»‘å®š policyï¼Œç»™äºˆåˆé€‚çš„æƒé™ã€‚</li>
</ol>
</li>
<li>åº”ç”¨å‹å¥½çš„æ–¹æ³•ï¼Œé€‚åˆåº”ç”¨ç¨‹åºä½¿ç”¨ï¼špublic/private keysã€tokensã€kubernetesã€jwt</li>
</ol>
<p>èº«ä»½éªŒè¯è¯·æ±‚æµç» Core å¹¶è¿›å…¥ auth methodsï¼Œauth methods ç¡®å®šè¯·æ±‚æ˜¯å¦æœ‰æ•ˆå¹¶è¿”å›ã€Œå…³è”ç­–ç•¥(policies)ã€çš„åˆ—è¡¨ã€‚</p>
<p>ACL Policies ç”± policy store è´Ÿè´£ç®¡ç†ä¸å­˜å‚¨ï¼Œç”± core è¿›è¡Œ ACL æ£€æŸ¥ã€‚
ACL çš„é»˜è®¤è¡Œä¸ºæ˜¯æ‹’ç»ï¼Œè¿™æ„å‘³ç€é™¤éæ˜ç¡®é…ç½® Policy å…è®¸æŸé¡¹æ“ä½œï¼Œå¦åˆ™è¯¥æ“ä½œå°†è¢«æ‹’ç»ã€‚</p>
<p>åœ¨é€šè¿‡ auth methods å®Œæˆäº†èº«ä»½è®¤è¯ï¼Œå¹¶ä¸”è¿”å›çš„ã€Œå…³è”ç­–ç•¥ã€ä¹Ÿæ²¡æ¯›ç—…ä¹‹åï¼Œã€Œtoken storeã€å°†ä¼šç”Ÿæˆå¹¶ç®¡ç†ä¸€ä¸ªæ–°çš„ tokenï¼Œ
è¿™ä¸ª token ä¼šè¢«è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œç”¨äºè¿›è¡Œåç»­è¯·æ±‚ã€‚</p>
<p>ç±»ä¼¼ web ç½‘ç«™çš„ cookieï¼Œtoken ä¹Ÿéƒ½å­˜åœ¨ä¸€ä¸ª lease ç§ŸæœŸæˆ–è€…è¯´æœ‰æ•ˆæœŸï¼Œè¿™åŠ å¼ºäº†å®‰å…¨æ€§ã€‚</p>
<p>token å…³è”äº†ç›¸å…³çš„ç­–ç•¥ policiesï¼Œè¿™äº›ç­–ç•¥å°†è¢«ç”¨äºéªŒè¯è¯·æ±‚çš„æƒé™ã€‚</p>
<p>è¯·æ±‚ç»è¿‡éªŒè¯åï¼Œå°†è¢«è·¯ç”±åˆ° secret engineã€‚å¦‚æœ secret engine è¿”å›äº†ä¸€ä¸ª secretï¼ˆç”± vault è‡ªåŠ¨ç”Ÿæˆçš„ secretï¼‰ï¼Œ
Core ä¼šå°†å…¶æ³¨å†Œåˆ° expiration managerï¼Œå¹¶ç»™å®ƒé™„åŠ ä¸€ä¸ª lease IDã€‚lease ID è¢«å®¢æˆ·ç«¯ç”¨äºæ›´æ–°(renew)æˆ–åŠé”€(revoke)å®ƒå¾—åˆ°çš„ secret.</p>
<p>å¦‚æœå®¢æˆ·ç«¯å…è®¸ç§Ÿçº¦(lease)åˆ°æœŸï¼Œexpiration manager å°†è‡ªåŠ¨åŠé”€è¿™ä¸ª secret.</p>
<p>Core è´Ÿè´£å¤„ç†å®¡æ ¸ä»£ç†(audit broker)çš„è¯·æ±‚åŠå“åº”æ—¥å¿—ï¼Œå°†è¯·æ±‚å‘é€åˆ°æ‰€æœ‰å·²é…ç½®çš„å®¡æ ¸è®¾å¤‡(audit devices)ã€‚</p>
<h3 id="3-secret-engine">3. Secret Engine</h3>
<p>Secret Engine æ˜¯ä¿å­˜ã€ç”Ÿæˆæˆ–è€…åŠ å¯†æ•°æ®çš„ç»„ä»¶ï¼Œå®ƒéå¸¸çµæ´»ã€‚</p>
<p>æœ‰çš„ Secret Engines åªæ˜¯å•çº¯åœ°å­˜å‚¨ä¸è¯»å–æ•°æ®ï¼Œæ¯”å¦‚ kv å°±å¯ä»¥çœ‹ä½œä¸€ä¸ªåŠ å¯†çš„ Redisã€‚
è€Œå…¶ä»–çš„ Secret Engines åˆ™è¿æ¥åˆ°å…¶ä»–çš„æœåŠ¡å¹¶æŒ‰éœ€ç”ŸæˆåŠ¨æ€å‡­è¯ã€‚</p>
<p>è¿˜æœ‰äº› Secret Engines æä¾›ã€ŒåŠ å¯†å³æœåŠ¡(encryption as a service)ã€çš„èƒ½åŠ›ï¼Œå¦‚ transitã€è¯ä¹¦ç®¡ç†ç­‰ã€‚</p>
<p>å¸¸ç”¨çš„ engine ä¸¾ä¾‹ï¼š</p>
<ol>
<li>AliCloud Secrets Engine: åŸºäº RAM ç­–ç•¥åŠ¨æ€ç”Ÿæˆ AliCloud Access Tokenï¼Œæˆ–åŸºäº RAM è§’è‰²åŠ¨æ€ç”Ÿæˆ AliCloud STS å‡­æ®
<ul>
<li>Access Token ä¼šè‡ªåŠ¨æ›´æ–°(Renew)ï¼Œè€Œ STS å‡­æ®æ˜¯ä¸´æ—¶ä½¿ç”¨çš„ï¼Œè¿‡æœŸåå°±å¤±æ•ˆäº†ã€‚</li>
</ul>
</li>
<li>kv: é”®å€¼å­˜å‚¨ï¼Œå¯ç”¨äºå­˜å‚¨ä¸€äº›é™æ€çš„é…ç½®ã€‚å®ƒä¸€å®šç¨‹åº¦ä¸Šèƒ½æ›¿ä»£æ‰æºç¨‹çš„ Apollo é…ç½®ä¸­å¿ƒã€‚</li>
<li>Transit Secrets Engine: æä¾›åŠ å¯†å³æœåŠ¡çš„åŠŸèƒ½ï¼Œå®ƒåªè´Ÿè´£åŠ å¯†å’Œè§£å¯†ï¼Œä¸è´Ÿè´£å­˜å‚¨ã€‚ä¸»è¦åº”ç”¨åœºæ™¯æ˜¯å¸® app åŠ è§£å¯†æ•°æ®ï¼Œä½†æ˜¯æ•°æ®ä»æ—§å­˜å‚¨åœ¨ MySQL ç­‰æ•°æ®åº“ä¸­ã€‚</li>
</ol>
<h2 id="äºŒéƒ¨ç½²-vault">äºŒã€éƒ¨ç½² Vault</h2>
<p>å®˜æ–¹å»ºè®®<a href="https://www.vaultproject.io/docs/platform/k8s/helm/run" target="_blank" rel="noopener noreferrer">é€šè¿‡ Helm éƒ¨ç½² vault</a>ï¼Œå¤§æ¦‚æµç¨‹ï¼š</p>
<ol>
<li>ä½¿ç”¨ helm/docker éƒ¨ç½²è¿è¡Œ vault.</li>
<li>åˆå§‹åŒ–/è§£å° vault: vault å®‰å…¨æªæ–½ï¼Œæ¯æ¬¡é‡å¯å¿…é¡»è§£å°(å¯è®¾ç½®è‡ªåŠ¨è§£å°).</li>
</ol>
<h3 id="0-å¦‚ä½•é€‰æ‹©å­˜å‚¨åç«¯">0. å¦‚ä½•é€‰æ‹©å­˜å‚¨åç«¯ï¼Ÿ</h3>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦ HAï¼Œè‡³å°‘è¦ä¿ç•™èƒ½å‡çº§åˆ° HA çš„èƒ½åŠ›ï¼Œæ‰€ä»¥ä¸å»ºè®®é€‰æ‹©ä¸æ”¯æŒ HA çš„åç«¯ã€‚</p>
<p>è€Œå…·ä½“çš„é€‰æ‹©ï¼Œå°±å› å›¢é˜Ÿç»éªŒè€Œå¼‚äº†ï¼Œäººä»¬å¾€å¾€å€¾å‘äºä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„ã€çŸ¥æ ¹çŸ¥åº•çš„åç«¯ï¼Œæˆ–è€…é€‰ç”¨äº‘æœåŠ¡ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬å¯¹ MySQL/PostgreSQL æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè€Œä¸”ä½¿ç”¨äº‘æœåŠ¡æä¾›çš„æ•°æ®åº“ä¸éœ€è¦è€ƒè™‘å¤ªå¤šçš„ç»´æŠ¤é—®é¢˜ï¼ŒMySQL ä½œä¸ºä¸€ä¸ªé€šç”¨åè®®ä¹Ÿä¸ä¼šè¢«äº‘å‚å•†ç»‘æ¶ï¼Œé‚£æˆ‘ä»¬å°±å€¾å‘äºä½¿ç”¨ MySQL/PostgreSQL.</p>
<p>è€Œå¦‚æœä½ ä»¬æ˜¯æœ¬åœ°è‡ªå»ºï¼Œé‚£ä½ å¯èƒ½æ›´å€¾å‘äºä½¿ç”¨ Etcd/Consul/Raft åšåç«¯å­˜å‚¨ã€‚</p>
<h3 id="1-docker-compose-éƒ¨ç½²é-ha">1. docker-compose éƒ¨ç½²ï¼ˆé HAï¼‰</h3>
<blockquote>
<p>æ¨èç”¨äºæœ¬åœ°å¼€å‘æµ‹è¯•ç¯å¢ƒï¼Œæˆ–è€…å…¶ä»–ä¸éœ€è¦é«˜å¯ç”¨çš„ç¯å¢ƒã€‚</p>
</blockquote>
<p><code>docker-compose.yml</code> ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;3.3&#39;</span><span class="w">
</span><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">vault</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># æ–‡æ¡£ï¼šhttps://hub.docker.com/_/vault</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">vault:1.6.0</span><span class="w">
</span><span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># rootless å®¹å™¨ï¼Œå†…éƒ¨ä¸èƒ½ä½¿ç”¨æ ‡å‡†ç«¯å£ 443</span><span class="w">
</span><span class="w">      </span>- <span class="s2">&#34;443:8200&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l">always</span><span class="w">
</span><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># å®¡è®¡æ—¥å¿—å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤ä¸å†™å®¡è®¡æ—¥å¿—ï¼Œå¯ç”¨ `file` audit backend æ—¶å¿…é¡»æä¾›ä¸€ä¸ªæ­¤æ–‡ä»¶å¤¹ä¸‹çš„è·¯å¾„</span><span class="w">
</span><span class="w">      </span>- <span class="l">./logs:/vault/logs</span><span class="w">
</span><span class="w">      </span><span class="c"># å½“ä½¿ç”¨ file data storage æ’ä»¶æ—¶ï¼Œæ•°æ®è¢«å­˜å‚¨åœ¨è¿™é‡Œã€‚é»˜è®¤ä¸å¾€è¿™å†™ä»»ä½•æ•°æ®ã€‚</span><span class="w">
</span><span class="w">      </span>- <span class="l">./file:/vault/file</span><span class="w">
</span><span class="w">      </span><span class="c"># é…ç½®ç›®å½•ï¼Œvault é»˜è®¤ `/valut/config/` ä¸­æ‰€æœ‰ä»¥ .hcl/.json ç»“å°¾çš„æ–‡ä»¶</span><span class="w">
</span><span class="w">      </span><span class="c"># config.hcl æ–‡ä»¶å†…å®¹ï¼Œå‚è€ƒ cutom-vaules.yaml</span><span class="w">
</span><span class="w">      </span>- <span class="l">./config.hcl:/vault/config/config.hcl</span><span class="w">
</span><span class="w">      </span><span class="c"># TLS è¯ä¹¦</span><span class="w">
</span><span class="w">      </span>- <span class="l">./certs:/certs</span><span class="w">
</span><span class="w">    </span><span class="c"># vault éœ€è¦é”å®šå†…å­˜ä»¥é˜²æ­¢æ•æ„Ÿå€¼ä¿¡æ¯è¢«äº¤æ¢(swapped)åˆ°ç£ç›˜ä¸­</span><span class="w">
</span><span class="w">    </span><span class="c"># ä¸ºæ­¤éœ€è¦æ·»åŠ å¦‚ä¸‹èƒ½åŠ›</span><span class="w">
</span><span class="w">    </span><span class="nt">cap_add</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="l">IPC_LOCK</span><span class="w">
</span><span class="w">    </span><span class="c"># å¿…é¡»æ‰‹åŠ¨è®¾ç½® entrypointï¼Œå¦åˆ™ vault å°†ä»¥ development æ¨¡å¼è¿è¡Œ</span><span class="w">
</span><span class="w">    </span><span class="nt">entrypoint</span><span class="p">:</span><span class="w"> </span><span class="l">vault server -config /vault/config/config.hcl</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p><code>config.hcl</code> å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="n">ui</span> <span class="o">=</span> <span class="kt">true</span>

<span class="err">//</span> <span class="k">ä½¿ç”¨æ–‡ä»¶åšæ•°æ®å­˜å‚¨</span><span class="err">ï¼ˆ</span><span class="k">å•èŠ‚ç‚¹</span><span class="err">ï¼‰</span>
<span class="k">storage</span> <span class="s2">&#34;file&#34;</span> {
<span class="n">  path</span>    <span class="o">=</span> <span class="s2">&#34;/vault/file&#34;</span>
}

<span class="k">listener</span> <span class="s2">&#34;tcp&#34;</span> {
<span class="n">  address</span> <span class="o">=</span> <span class="s2">&#34;[::]:8200&#34;</span>

<span class="n">  tls_disable</span> <span class="o">=</span> <span class="kt">false</span>
<span class="n">  tls_cert_file</span> <span class="o">=</span> <span class="s2">&#34;/certs/server.crt&#34;</span>
<span class="n">  tls_key_file</span>  <span class="o">=</span> <span class="s2">&#34;/certs/server.key&#34;</span>
}
</code></pre></td></tr></table>
</div>
</div><p>å°†å¦‚ä¸Šä¸¤ä»½é…ç½®ä¿å­˜åœ¨åŒä¸€éæ–‡ä»¶å¤¹å†…ï¼ŒåŒæ—¶åœ¨ <code>./certs</code> ä¸­æä¾› TLS è¯ä¹¦ <code>server.crt</code> å’Œç§é’¥ <code>server.key</code>ã€‚</p>
<p>ç„¶å <code>docker-compose up -d</code> å°±èƒ½å¯åŠ¨è¿è¡Œä¸€ä¸ª vault å®ä¾‹ã€‚</p>
<h3 id="install-by-helm">2. é€šè¿‡ helm éƒ¨ç½²é«˜å¯ç”¨çš„ vault</h3>
<blockquote>
<p>æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ</p>
</blockquote>
<p>é€šè¿‡ helm éƒ¨ç½²ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># æ·»åŠ  valut ä»“åº“</span>
helm repo add hashicorp https://helm.releases.hashicorp.com
<span class="c1"># æŸ¥çœ‹ vault ç‰ˆæœ¬å·</span>
helm search repo hashicorp/vault -l <span class="p">|</span> head
<span class="c1"># ä¸‹è½½æŸä¸ªç‰ˆæœ¬å·çš„ vault</span>
helm pull hashicorp/vault --version  0.11.0 --untar
</code></pre></td></tr></table>
</div>
</div><p>å‚ç…§ä¸‹è½½ä¸‹æ¥çš„ <code>./vault/values.yaml</code> ç¼–å†™ <code>custom-values.yaml</code>ï¼Œ
éƒ¨ç½²ä¸€ä¸ªä»¥ <code>mysql</code> ä¸ºåç«¯å­˜å‚¨çš„ HA vaultï¼Œé…ç½®ç¤ºä¾‹å¦‚ä¸‹:</p>
<blockquote>
<p>é…ç½®å†…å®¹è™½ç„¶å¤šï¼Œä½†æ˜¯å¤§éƒ½æ˜¯ç›´æ¥æ‹·è´è‡ª <code>./vault/values.yaml</code>ï¼Œæ”¹åŠ¨å¾ˆå°‘ã€‚
æµ‹è¯• Vault æ—¶å¯ä»¥å¿½ç•¥æ‰å…¶ä¸­å¤§å¤šæ•°çš„é…ç½®é¡¹ã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># enabled is the master enabled switch. Setting this to true or false</span><span class="w">
</span><span class="w">  </span><span class="c"># will enable or disable all the components within this chart by default.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="c"># TLS for end-to-end encrypted transport</span><span class="w">
</span><span class="w">  </span><span class="nt">tlsDisable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">injector</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># True if you want to enable vault agent injection.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># If true, will enable a node exporter metrics endpoint at /metrics.</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Mount Path of the Vault Kubernetes Auth Method.</span><span class="w">
</span><span class="w">  </span><span class="nt">authPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;auth/kubernetes&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">certs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># secretName is the name of the secret that has the TLS certificate and</span><span class="w">
</span><span class="w">    </span><span class="c"># private key to serve the injector webhook. If this is null, then the</span><span class="w">
</span><span class="w">    </span><span class="c"># injector will default to its automatic management mode that will assign</span><span class="w">
</span><span class="w">    </span><span class="c"># a service account to the injector to generate its own certificates.</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># caBundle is a base64-encoded PEM-encoded certificate bundle for the</span><span class="w">
</span><span class="w">    </span><span class="c"># CA that signed the TLS certificate that the webhook serves. This must</span><span class="w">
</span><span class="w">    </span><span class="c"># be set if secretName is non-null.</span><span class="w">
</span><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># certName and keyName are the names of the files within the secret for</span><span class="w">
</span><span class="w">    </span><span class="c"># the TLS cert and private key, respectively. These have reasonable</span><span class="w">
</span><span class="w">    </span><span class="c"># defaults but can be customized if necessary.</span><span class="w">
</span><span class="w">    </span><span class="nt">certName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.crt</span><span class="w">
</span><span class="w">    </span><span class="nt">keyName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.key</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">server</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># Resource requests, limits, etc. for the server cluster placement. This</span><span class="w">
</span><span class="w">  </span><span class="c"># should map directly to the value of the resources field for a PodSpec.</span><span class="w">
</span><span class="w">  </span><span class="c"># By default no direct resource request is made.</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Enables a headless service to be used by the Vault Statefulset</span><span class="w">
</span><span class="w">  </span><span class="nt">service</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="c"># Port on which Vault server is listening</span><span class="w">
</span><span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8200</span><span class="w">
</span><span class="w">    </span><span class="c"># Target port to which the service should be mapped to</span><span class="w">
</span><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8200</span><span class="w">
</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># This configures the Vault Statefulset to create a PVC for audit</span><span class="w">
</span><span class="w">  </span><span class="c"># logs.  Once Vault is deployed, initialized and unseal, Vault must</span><span class="w">
</span><span class="w">  </span><span class="c"># be configured to use this for audit logs.  This will be mounted to</span><span class="w">
</span><span class="w">  </span><span class="c"># /vault/audit</span><span class="w">
</span><span class="w">  </span><span class="c"># See https://www.vaultproject.io/docs/audit/index.html to know more</span><span class="w">
</span><span class="w">  </span><span class="nt">auditStorage</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Run Vault in &#34;HA&#34; mode. There are no storage requirements unless audit log</span><span class="w">
</span><span class="w">  </span><span class="c"># persistence is required.  In HA mode Vault will configure itself to use Consul</span><span class="w">
</span><span class="w">  </span><span class="c"># for its storage backend.  The default configuration provided will work the Consul</span><span class="w">
</span><span class="w">  </span><span class="c"># Helm project by default.  It is possible to manually configure Vault to use a</span><span class="w">
</span><span class="w">  </span><span class="c"># different HA backend.</span><span class="w">
</span><span class="w">  </span><span class="nt">ha</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># Set the api_addr configuration for Vault HA</span><span class="w">
</span><span class="w">    </span><span class="c"># See https://www.vaultproject.io/docs/configuration#api_addr</span><span class="w">
</span><span class="w">    </span><span class="c"># If set to null, this will be set to the Pod IP Address</span><span class="w">
</span><span class="w">    </span><span class="nt">apiAddr</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># config is a raw string of default configuration when using a Stateful</span><span class="w">
</span><span class="w">    </span><span class="c"># deployment. Default is to use a Consul for its HA storage backend.</span><span class="w">
</span><span class="w">    </span><span class="c"># This should be HCL.</span><span class="w">
</span><span class="w">    
</span><span class="w">    </span><span class="c"># Note: Configuration files are stored in ConfigMaps so sensitive data </span><span class="w">
</span><span class="w">    </span><span class="c"># such as passwords should be either mounted through extraSecretEnvironmentVars</span><span class="w">
</span><span class="w">    </span><span class="c"># or through a Kube secret.  For more information see: </span><span class="w">
</span><span class="w">    </span><span class="c"># https://www.vaultproject.io/docs/platform/k8s/helm/run#protecting-sensitive-vault-configurations</span><span class="w">
</span><span class="w">    </span><span class="nt">config</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">      ui = true
</span><span class="sd">
</span><span class="sd">      listener &#34;tcp&#34; {
</span><span class="sd">        address = &#34;[::]:8200&#34;
</span><span class="sd">        cluster_address = &#34;[::]:8201&#34;
</span><span class="sd">
</span><span class="sd">        # æ³¨æ„ï¼Œè¿™ä¸ªå€¼è¦å’Œ helm çš„å‚æ•° global.tlsDisable ä¸€è‡´
</span><span class="sd">        tls_disable = false
</span><span class="sd">        tls_cert_file = &#34;/etc/certs/vault.crt&#34;
</span><span class="sd">        tls_key_file  = &#34;/etc/certs/vault.key&#34;
</span><span class="sd">      }
</span><span class="sd">
</span><span class="sd">      # storage &#34;postgresql&#34; {
</span><span class="sd">      #   connection_url = &#34;postgres://username:password@&lt;host&gt;:5432/vault?sslmode=disable&#34;
</span><span class="sd">      #   ha_enabled = true
</span><span class="sd">      # }
</span><span class="sd">
</span><span class="sd">      service_registration &#34;kubernetes&#34; {}
</span><span class="sd">
</span><span class="sd">      # Example configuration for using auto-unseal, using AWS KMS. 
</span><span class="sd">      # the cluster must have a service account that is authorized to access AWS KMS, throught an IAM Role.
</span><span class="sd">      # seal &#34;awskms&#34; {
</span><span class="sd">      #   region     = &#34;us-east-1&#34;
</span><span class="sd">      #   kms_key_id = &#34;&lt;some-key-id&gt;&#34;
</span><span class="sd">      #   é»˜è®¤æƒ…å†µä¸‹æ’ä»¶ä¼šä½¿ç”¨ awskms çš„å…¬ç½‘ enpointï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‚æ•°ï¼Œæ”¹ç”¨è‡ªè¡Œåˆ›å»ºçš„ vpc å†…ç½‘ endpoint
</span><span class="sd">      #   endpoint   = &#34;https://&lt;vpc-endpoint-id&gt;.kms.us-east-1.vpce.amazonaws.com&#34;
</span><span class="sd">      # }</span><span class="w">      
</span><span class="w">
</span><span class="w">  </span><span class="c"># Definition of the serviceAccount used to run Vault.</span><span class="w">
</span><span class="w">  </span><span class="c"># These options are also used when using an external Vault server to validate</span><span class="w">
</span><span class="w">  </span><span class="c"># Kubernetes tokens.</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceAccount</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">create</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;vault&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="c"># å¦‚æœè¦ä½¿ç”¨ auto unseal çš„è¯ï¼Œè¿™ä¸ªå¡«å†™æ‹¥æœ‰ awskms æƒé™çš„ AWS IAM Role</span><span class="w">
</span><span class="w">      </span><span class="nt">eks.amazonaws.com/role-arn</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;role-arn&gt;</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="c"># Vault UI</span><span class="w">
</span><span class="w"></span><span class="nt">ui</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">publishNotReadyAddresses</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">serviceType</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterIP</span><span class="w">
</span><span class="w">  </span><span class="nt">activeVaultPodOnly</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="nt">externalPort</span><span class="p">:</span><span class="w"> </span><span class="m">8200</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ä½¿ç”¨è‡ªå®šä¹‰çš„ <code>custom-values.yaml</code> éƒ¨ç½² vautl:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl create namespace vault
<span class="c1"># å®‰è£…/å‡çº§ valut</span>
helm upgrade --install vault ./vault --namespace vault -f custom-values.yaml
</code></pre></td></tr></table>
</div>
</div><h3 id="3-åˆå§‹åŒ–å¹¶è§£å°-vault">3. åˆå§‹åŒ–å¹¶è§£å° vault</h3>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://learn.hashicorp.com/tutorials/vault/kubernetes-raft-deployment-guide?in=vault/kubernetes#install-vault" target="_blank" rel="noopener noreferrer">Initialize and unseal Vault - Vault on Kubernetes Deployment Guide</a></p>
</blockquote>
<p>é€šè¿‡ helm éƒ¨ç½² vaultï¼Œé»˜è®¤ä¼šéƒ¨ç½²ä¸€ä¸ªä¸‰å‰¯æœ¬çš„ StatefulSetï¼Œä½†æ˜¯è¿™ä¸‰ä¸ªå‰¯æœ¬éƒ½ä¼šå¤„äº NotReady çŠ¶æ€ï¼ˆdocker æ–¹å¼éƒ¨ç½²çš„ä¹Ÿä¸€æ ·ï¼‰ã€‚
æ¥ä¸‹æ¥è¿˜éœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–å¹¶è§£å° vaultï¼Œæ‰èƒ½ <code>Ready</code>:</p>
<ol>
<li>ç¬¬ä¸€æ­¥ï¼šä»ä¸‰ä¸ªå‰¯æœ¬ä¸­éšä¾¿é€‰æ‹©ä¸€ä¸ªï¼Œè¿è¡Œ vault çš„åˆå§‹åŒ–å‘½ä»¤ï¼š<code>kubectl exec -ti vault-0 -- vault operator init</code>
<ol>
<li>åˆå§‹åŒ–æ“ä½œä¼šè¿”å› 5 ä¸ª unseal keysï¼Œä»¥åŠä¸€ä¸ª Initial Root Tokenï¼Œè¿™äº›æ•°æ®éå¸¸æ•æ„Ÿéå¸¸é‡è¦ï¼Œä¸€å®šè¦ä¿å­˜åˆ°å®‰å…¨çš„åœ°æ–¹ï¼</li>
</ol>
</li>
<li>ç¬¬äºŒæ­¥ï¼šåœ¨æ¯ä¸ªå‰¯æœ¬ä¸Šï¼Œä½¿ç”¨ä»»æ„ä¸‰ä¸ª unseal keys è¿›è¡Œè§£å°æ“ä½œã€‚
<ol>
<li>ä¸€å…±æœ‰ä¸‰ä¸ªå‰¯æœ¬ï¼Œä¹Ÿå°±æ˜¯è¯´è¦è§£å° 3*3 æ¬¡ï¼Œæ‰èƒ½å®Œæˆ vault çš„å®Œæ•´è§£å°ï¼</li>
</ol>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># æ¯ä¸ªå®ä¾‹éƒ½éœ€è¦è§£å°ä¸‰æ¬¡ï¼</span>
<span class="c1">## Unseal the first vault server until it reaches the key threshold</span>
$ kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator unseal <span class="c1"># ... Unseal Key 1</span>
$ kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator unseal <span class="c1"># ... Unseal Key 2</span>
$ kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator unseal <span class="c1"># ... Unseal Key 3</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·å°±å®Œæˆäº†éƒ¨ç½²ï¼Œä½†æ˜¯è¦æ³¨æ„ï¼Œ<strong>vault å®ä¾‹æ¯æ¬¡é‡å¯åï¼Œéƒ½éœ€è¦é‡æ–°è§£å°ï¼ä¹Ÿå°±æ˜¯é‡æ–°è¿›è¡Œç¬¬äºŒæ­¥æ“ä½œï¼</strong></p>
<h3 id="4-åˆå§‹åŒ–å¹¶è®¾ç½®è‡ªåŠ¨è§£å°">4. åˆå§‹åŒ–å¹¶è®¾ç½®è‡ªåŠ¨è§£å°</h3>
<p>åœ¨æœªè®¾ç½® auto unseal çš„æƒ…å†µä¸‹ï¼Œvault æ¯æ¬¡é‡å¯éƒ½è¦æ‰‹åŠ¨è§£å°æ‰€æœ‰ vault å®ä¾‹ï¼Œå®åœ¨æ˜¯å¾ˆéº»çƒ¦ï¼Œåœ¨äº‘ä¸Šè‡ªåŠ¨æ‰©ç¼©å®¹çš„æƒ…å†µä¸‹ï¼Œvault å®ä¾‹ä¼šè¢«è‡ªåŠ¨è°ƒåº¦ï¼Œè¿™ç§æƒ…å†µå°±æ›´éº»çƒ¦äº†ã€‚</p>
<p>ä¸ºäº†ç®€åŒ–è¿™ä¸ªæµç¨‹ï¼Œå¯ä»¥è€ƒè™‘é…ç½® auto unseal è®© vault è‡ªåŠ¨è§£å°ã€‚</p>
<p>è‡ªåŠ¨è§£å°ç›®å‰æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ol>
<li>ä½¿ç”¨é˜¿é‡Œäº‘/AWS/Azure ç­‰äº‘æœåŠ¡æä¾›çš„å¯†é’¥åº“æ¥ç®¡ç† encryption key
<ol>
<li>AWS: <a href="https://www.vaultproject.io/docs/configuration/seal/awskms" target="_blank" rel="noopener noreferrer">awskms Seal</a>
<ol>
<li>å¦‚æœæ˜¯ k8s é›†ç¾¤ï¼Œvault ä½¿ç”¨çš„ ServiceAccount éœ€è¦æœ‰æƒé™ä½¿ç”¨ AWS KMSï¼Œå®ƒå¯æ›¿ä»£æ‰ config.hcl ä¸­çš„ access_key/secret_key ä¸¤ä¸ªå±æ€§</li>
</ol>
</li>
<li>é˜¿é‡Œäº‘ï¼š<a href="https://www.vaultproject.io/docs/configuration/seal/alicloudkms" target="_blank" rel="noopener noreferrer">alicloudkms Seal</a></li>
</ol>
</li>
<li>å¦‚æœä½ ä¸æƒ³ç”¨äº‘æœåŠ¡ï¼Œé‚£å¯ä»¥è€ƒè™‘ <a href="https://learn.hashicorp.com/tutorials/vault/autounseal-transit" target="_blank" rel="noopener noreferrer">autounseal-transit</a>ï¼Œè¿™ç§æ–¹æ³•ä½¿ç”¨å¦ä¸€ä¸ª vault å®ä¾‹æä¾›çš„ transit å¼•æ“æ¥å®ç° auto-unseal.</li>
<li>ç®€å•ç²—æš´ï¼šç›´æ¥å†™ä¸ª crontab æˆ–è€…åœ¨ CI å¹³å°ä¸ŠåŠ ä¸ªå®šæ—¶ä»»åŠ¡å»æ‰§è¡Œè§£å°å‘½ä»¤ï¼Œä»¥å®ç°è‡ªåŠ¨è§£å°ã€‚ä¸è¿‡è¿™æ ·å®‰å…¨æ€§å°±ä¸å¥½è¯´äº†ã€‚</li>
</ol>
<p>ä»¥ä½¿ç”¨ awskms ä¸ºä¾‹ï¼Œé¦–å…ˆåˆ›å»º aws IAM çš„ policy å†…å®¹å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;Version&#34;</span><span class="p">:</span> <span class="s2">&#34;2012-10-17&#34;</span><span class="p">,</span>
    <span class="nt">&#34;Statement&#34;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&#34;Sid&#34;</span><span class="p">:</span> <span class="s2">&#34;VaultKMSUnseal&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Effect&#34;</span><span class="p">:</span> <span class="s2">&#34;Allow&#34;</span><span class="p">,</span>
            <span class="nt">&#34;Action&#34;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&#34;kms:Decrypt&#34;</span><span class="p">,</span>
                <span class="s2">&#34;kms:Encrypt&#34;</span><span class="p">,</span>
                <span class="s2">&#34;kms:DescribeKey&#34;</span>
            <span class="p">],</span>
            <span class="nt">&#34;Resource&#34;</span><span class="p">:</span> <span class="s2">&#34;*&#34;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶ååˆ›å»º IAM Role ç»‘å®šä¸Šé¢çš„ policyï¼Œå¹¶ä¸º vault çš„ k8s serviceaccount åˆ›å»ºä¸€ä¸ª IAM Roleï¼Œç»‘å®šä¸Šè¿™ä¸ª policy.</p>
<p>è¿™æ · vault ä½¿ç”¨çš„ serviceaccount è‡ªèº«å°±æ‹¥æœ‰äº†è®¿é—® awskms çš„æƒé™ï¼Œä¹Ÿå°±ä¸éœ€è¦é¢å¤–é€šè¿‡ access_key/secret_key æ¥è®¿é—® awskms.</p>
<p>å…³äº IAM Role å’Œ k8s serviceaccount å¦‚ä½•ç»‘å®šï¼Œå‚è§å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="noopener noreferrer">IAM roles for EKS service accounts</a></p>
<p>å®Œäº‹åå†ä¿®æ”¹å¥½å‰é¢æä¾›çš„ helm é…ç½®ï¼Œéƒ¨ç½²å®ƒï¼Œæœ€åä½¿ç”¨å¦‚ä¸‹å‘½ä»¤åˆå§‹åŒ–ä¸€ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># åˆå§‹åŒ–å‘½ä»¤å’Œæ™®é€šæ¨¡å¼å¹¶æ— ä¸åŒ</span>
kubectl <span class="nb">exec</span> -ti vault-0 -- vault operator init
<span class="c1"># ä¼šæ‰“å°å‡ºä¸€ä¸ª root tokenï¼Œä»¥åŠäº”ä¸ª Recovery Keyï¼ˆè€Œä¸æ˜¯ Unseal Keyï¼‰</span>
<span class="c1"># Recover Key ä¸å†ç”¨äºè§£å°ï¼Œä½†æ˜¯é‡æ–°ç”Ÿæˆ root token ç­‰æ“ä½œä»ç„¶ä¼šéœ€è¦ç”¨åˆ°å®ƒ.</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±å¤§åŠŸå‘Šæˆäº†ï¼Œå¯ä»¥å°è¯•ä¸‹åˆ é™¤ vault çš„ podï¼Œæ–°å»ºçš„ Pod åº”è¯¥ä¼šè‡ªåŠ¨è§£å°ã€‚</p>
<h2 id="ä¸‰vault-è‡ªèº«çš„é…ç½®ç®¡ç†">ä¸‰ã€Vault è‡ªèº«çš„é…ç½®ç®¡ç†</h2>
<p>Vault æœ¬èº«æ˜¯ä¸€ä¸ªå¤æ‚çš„ secrets å·¥å…·ï¼Œå®ƒæä¾›äº† <strong>Web UI</strong> å’Œ <strong>CLI</strong> ç”¨äºæ‰‹åŠ¨ç®¡ç†ä¸æŸ¥çœ‹ Vault çš„å†…å®¹ã€‚</p>
<p>ä½†æ˜¯ä½œä¸ºä¸€å DevOpsï¼Œæˆ‘ä»¬å½“ç„¶æ›´å–œæ¬¢è‡ªåŠ¨åŒ–çš„æ–¹æ³•ï¼Œè¿™æœ‰ä¸¤ç§é€‰æ‹©:</p>
<ul>
<li>ä½¿ç”¨ vault çš„ sdk: python-<a href="https://github.com/hvac/hvac" target="_blank" rel="noopener noreferrer">hvac</a></li>
<li>ä½¿ç”¨ <a href="https://github.com/hashicorp/terraform-provider-vault" target="_blank" rel="noopener noreferrer">terraform-provider-vault</a> æˆ–è€… <a href="https://github.com/pulumi/pulumi-vault" target="_blank" rel="noopener noreferrer">pulumi-vault</a> å®ç° vault é…ç½®çš„è‡ªåŠ¨åŒ–ç®¡ç†ã€‚</li>
</ul>
<p>Web UI é€‚åˆæ‰‹å·¥æ“ä½œï¼Œè€Œ sdk/<code>terraform-provider-vault</code> åˆ™é€‚åˆç”¨äºè‡ªåŠ¨åŒ–ç®¡ç† vault.</p>
<p>æˆ‘ä»¬çš„æµ‹è¯•ç¯å¢ƒå°±æ˜¯ä½¿ç”¨ <code>pulumi-vault</code> å®Œæˆçš„è‡ªåŠ¨åŒ–é…ç½® vault policy å’Œ kubernetes roleï¼Œç„¶åè‡ªåŠ¨åŒ–æ³¨å…¥æ‰€æœ‰æµ‹è¯•ç”¨çš„ secrets.</p>
<h3 id="1-ä½¿ç”¨-pulumi-è‡ªåŠ¨åŒ–é…ç½®-vault">1. ä½¿ç”¨ pulumi è‡ªåŠ¨åŒ–é…ç½® vault</h3>
<p>ä½¿ç”¨ pulumi ç®¡ç† vault é…ç½®çš„ä¼˜åŠ¿æ˜¯å¾ˆå¤§çš„ï¼Œå› ä¸ºäº‘ä¸Šèµ„æºçš„æ•æ„Ÿä¿¡æ¯ï¼ˆæ•°æ®åº“è´¦å·å¯†ç ã€èµ„æº IDã€RAMå­è´¦å·ï¼‰éƒ½æ˜¯ pulumi åˆ›å»ºçš„ã€‚</p>
<p>å†ç»“åˆä½¿ç”¨ pulumi_valutï¼Œå°±èƒ½å®ç°æ•æ„Ÿä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆåï¼Œç«‹å³ä¿å­˜åˆ° vault ä¸­ï¼Œå®ç°å®Œå…¨è‡ªåŠ¨åŒ–ã€‚</p>
<p>åç»­å¾®æœåŠ¡å°±å¯ä»¥é€šè¿‡ kubernetes è®¤è¯ï¼Œç›´æ¥ä» vault è¯»å–æ•æ„Ÿä¿¡æ¯ã€‚</p>
<p>æˆ–è€…æ˜¯å†™å…¥åˆ°æœ¬åœ°çš„ vault ä¸­ç•™åšå¤‡ä»½ï¼Œåœ¨éœ€è¦çš„æ—¶å€™ï¼Œç®¡ç†å‘˜èƒ½ç™»å…¥è¿›å»æŸ¥çœ‹ç›¸å…³æ•æ„Ÿä¿¡æ¯ã€‚</p>
<h4 id="11-token-çš„ç”Ÿæˆ">1.1 Token çš„ç”Ÿæˆ</h4>
<p>pulumi_vault æœ¬èº«æŒºç®€å•çš„ï¼Œå£°æ˜å¼çš„é…ç½®å˜›ï¼Œç›´æ¥ç”¨å°±æ˜¯äº†ã€‚</p>
<p>ä½†æ˜¯å®ƒä¸€å®šè¦æ±‚æä¾› <code>VAULT_TOKEN</code> ä½œä¸ºèº«ä»½è®¤è¯çš„å‡­è¯ï¼ˆå®æµ‹ userpass/approle éƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨ï¼Œä¼šæŠ¥é”™ <code>no vault token found</code>ï¼‰ï¼Œè€Œä¸” pulumi è¿˜ä¼šå…ˆç”Ÿæˆä¸´æ—¶ç”¨çš„ child tokenï¼Œç„¶åç”¨è¿™ä¸ª child token
è¿›è¡Œåç»­çš„æ“ä½œã€‚</p>
<p>é¦–å…ˆå®‰å…¨èµ·è§ï¼Œè‚¯å®šä¸åº”è¯¥ç›´æ¥æä¾› root tokenï¼root token åº”è¯¥å°å­˜ï¼Œé™¤äº†ç´§æ€¥æƒ…å†µä¸åº”è¯¥å¯ç”¨ã€‚</p>
<p>é‚£ä¹ˆåº”è¯¥å¦‚ä½•ç”Ÿæˆä¸€ä¸ªæƒé™æœ‰é™çš„ token ç»™ vault ä½¿ç”¨å‘¢ï¼Ÿ
æˆ‘çš„æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ª userpass è´¦å·ï¼Œé€šè¿‡ policy ç»™äºˆå®ƒæœ‰é™çš„æƒé™ã€‚
ç„¶åå…ˆæ‰‹åŠ¨(æˆ–è€…è‡ªåŠ¨)ç™»å½•è·å–åˆ° tokenï¼Œå†å°† token æä¾›ç»™ pulumi_vault ä½¿ç”¨ã€‚</p>
<p>è¿™é‡Œé¢æœ‰ä¸ªå‘ï¼Œå°±æ˜¯å¿…é¡»ç»™ userpass è´¦å·åˆ›å»º child token çš„æƒé™ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">path</span> <span class="s2">&#34;local/*&#34;</span> {
<span class="n">  capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;read&#34;, &#34;list&#34;</span><span class="p">]</span>
}

<span class="err">//</span> <span class="k">å…è®¸åˆ›å»º</span> <span class="k">child</span> <span class="k">token</span>
<span class="k">path</span> <span class="s2">&#34;auth/token/create&#34;</span> {
<span class="n">  capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;</span><span class="p">]</span>
}
</code></pre></td></tr></table>
</div>
</div><p>ä¸ç»™è¿™ä¸ªæƒé™ï¼Œpulumi_vault å°±ä¼šä¸€ç›´æŠ¥é”™ã€‚ã€‚</p>
<p>ç„¶åè¿˜å¾—ç»™å®ƒã€Œè‡ªåŠ¨åŒ–é…ç½®ã€éœ€è¦çš„æƒé™ï¼Œæ¯”å¦‚è‡ªåŠ¨åˆ›å»º/æ›´æ–° policy/secrets/kubernetes ç­‰ç­‰ï¼Œç¤ºä¾‹å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># To list policies - Step 3
</span><span class="c1"></span><span class="k">path</span> <span class="s2">&#34;sys/policy&#34;</span>
{
<span class="n">  capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;read&#34;</span><span class="p">]</span>
}<span class="c1">
</span><span class="c1">
</span><span class="c1"># Create and manage ACL policies broadly across Vault
</span><span class="c1"></span><span class="k">path</span> <span class="s2">&#34;sys/policy/*&#34;</span>
{
<span class="n">  capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;, &#34;sudo&#34;</span><span class="p">]</span>
}<span class="c1">
</span><span class="c1">
</span><span class="c1"># List, create, update, and delete key/value secrets
</span><span class="c1"></span><span class="k">path</span> <span class="s2">&#34;secret/*&#34;</span>
{
<span class="n">  capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;delete&#34;, &#34;list&#34;, &#34;sudo&#34;</span><span class="p">]</span>
}

<span class="k">path</span> <span class="s2">&#34;auth/kubernetes/role/*&#34;</span>
{
<span class="n">  capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;create&#34;, &#34;read&#34;, &#34;update&#34;, &#34;list&#34;</span><span class="p">]</span>
}
</code></pre></td></tr></table>
</div>
</div><h2 id="å››åœ¨-kubernetes-ä¸­ä½¿ç”¨-vault-æ³¨å…¥-secrets">å››ã€åœ¨ Kubernetes ä¸­ä½¿ç”¨ vault æ³¨å…¥ secrets</h2>
<p><figure><a class="lightgallery" href="/images/expirence-of-vault/vault-k8s-auth-workflow.png" title="/images/expirence-of-vault/vault-k8s-auth-workflow.png" data-thumbnail="/images/expirence-of-vault/vault-k8s-auth-workflow.png" data-sub-html="<h2>vault-k8s-auth-workflow</h2>">
        
    </a><figcaption class="image-caption">vault-k8s-auth-workflow</figcaption>
    </figure></p>
<p>å‰é¢æåˆ°è¿‡ vault æ”¯æŒé€šè¿‡ Kubernetes çš„ ServiceAccount ä¸ºæ¯ä¸ª Pod å•ç‹¬åˆ†é…æƒé™ã€‚</p>
<p>åº”ç”¨ç¨‹åºæœ‰ä¸¤ç§æ–¹å¼å»è¯»å– vault ä¸­çš„é…ç½®ï¼š</p>
<ol>
<li>å€ŸåŠ© Vault Sidecarï¼Œå°† secrets ä»¥æ–‡ä»¶çš„å½¢å¼è‡ªåŠ¨æ³¨å…¥åˆ° Pod ä¸­ï¼Œæ¯”å¦‚ <code>/vault/secrets/config.json</code>
<ul>
<li>vault sidecar åœ¨å¸¸é©»æ¨¡å¼ä¸‹æ¯ 15 ç§’æ›´æ–°ä¸€æ¬¡é…ç½®ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ <code>watchdog</code> å®æ—¶ç›‘æ§ secrets æ–‡ä»¶çš„å˜æ›´ã€‚</li>
</ul>
</li>
<li>åº”ç”¨ç¨‹åºè‡ªå·±ä½¿ç”¨ SDK ç›´æ¥è®¿é—® vault api è·å– secrets</li>
</ol>
<p>ä¸Šè¿°ä¸¤ç§æ–¹å¼ï¼Œéƒ½å¯ä»¥å€ŸåŠ© Kubernetes ServiceAccount è¿›è¡Œèº«ä»½éªŒè¯å’Œæƒé™åˆ†é…ã€‚</p>
<p>ä¸‹é¢ä»¥ Sidecar æ¨¡å¼ä¸ºä¾‹ï¼Œä»‹ç»å¦‚ä½•å°† secrets ä»¥æ–‡ä»¶å½¢å¼æ³¨å…¥åˆ° Pod ä¸­ã€‚</p>
<h3 id="1-éƒ¨ç½²å¹¶é…ç½®-vault-agent">1. éƒ¨ç½²å¹¶é…ç½® vault agent</h3>
<p>é¦–å…ˆå¯ç”¨ Vault çš„ Kubernetes èº«ä»½éªŒè¯:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># é…ç½®èº«ä»½è®¤è¯éœ€è¦åœ¨ vault pod ä¸­æ‰§è¡Œï¼Œå¯åŠ¨ vault-0 çš„äº¤äº’å¼ä¼šè¯</span>
kubectl <span class="nb">exec</span> -n vault -it vault-0 -- /bin/sh
<span class="nb">export</span> <span class="nv">VAULT_TOKEN</span><span class="o">=</span><span class="s1">&#39;&lt;your-root-token&gt;&#39;</span>
<span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span><span class="s1">&#39;http://localhost:8200&#39;</span>
 
<span class="c1"># å¯ç”¨ Kubernetes èº«ä»½éªŒè¯</span>
vault auth <span class="nb">enable</span> kubernetes

<span class="c1"># kube-apiserver API é…ç½®ï¼Œvault éœ€è¦é€šè¿‡ kube-apiserver å®Œæˆå¯¹ serviceAccount çš„èº«ä»½éªŒè¯</span>
vault write auth/kubernetes/config <span class="se">\
</span><span class="se"></span>    <span class="nv">token_reviewer_jwt</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>cat /var/run/secrets/kubernetes.io/serviceaccount/token<span class="k">)</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="nv">kubernetes_host</span><span class="o">=</span><span class="s2">&#34;https://</span><span class="nv">$KUBERNETES_PORT_443_TCP_ADDR</span><span class="s2">:443&#34;</span> <span class="se">\
</span><span class="se"></span>    <span class="nv">kubernetes_ca_cert</span><span class="o">=</span>@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
</code></pre></td></tr></table>
</div>
</div><h4 id="11-ä½¿ç”¨é›†ç¾¤å¤–éƒ¨çš„-valut-å®ä¾‹">1.1 ä½¿ç”¨é›†ç¾¤å¤–éƒ¨çš„ valut å®ä¾‹</h4>
<blockquote>
<p>å¦‚æœä½ æ²¡è¿™ä¸ªéœ€æ±‚ï¼Œè¯·è·³è¿‡è¿™ä¸€èŠ‚ã€‚</p>
</blockquote>
<blockquote>
<p>è¯¦è§ <a href="https://learn.hashicorp.com/tutorials/vault/kubernetes-external-vault?in=vault/kubernetes#install-the-vault-helm-chart-configured-to-address-an-external-vault" target="_blank" rel="noopener noreferrer">Install the Vault Helm chart configured to address an external Vault</a></p>
</blockquote>
<p>kubernetes ä¹Ÿå¯ä»¥å’Œå¤–éƒ¨çš„ vault å®ä¾‹é›†æˆï¼Œé›†ç¾¤ä¸­åªéƒ¨ç½² vault-agent.</p>
<p>è¿™é€‚ç”¨äºå¤šä¸ª kubernetes é›†ç¾¤ä»¥åŠå…¶ä»– APP å…±ç”¨ä¸€ä¸ª vault å®ä¾‹çš„æƒ…å†µï¼Œæ¯”å¦‚æˆ‘ä»¬æœ¬åœ°çš„å¤šä¸ªå¼€å‘æµ‹è¯•é›†ç¾¤ï¼Œå°±éƒ½å…±ç”¨ç€åŒä¸€ä¸ª vault å®ä¾‹ï¼Œæ–¹ä¾¿ç»Ÿä¸€ç®¡ç†åº”ç”¨çš„ secrets.</p>
<p>é¦–å…ˆï¼Œä½¿ç”¨ helm chart éƒ¨ç½² vault-agentï¼Œæ¥å…¥å¤–éƒ¨çš„ vault å®ä¾‹ã€‚ä½¿ç”¨çš„ <code>custom-values.yaml</code> ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">global</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># enabled is the master enabled switch. Setting this to true or false</span><span class="w">
</span><span class="w">  </span><span class="c"># will enable or disable all the components within this chart by default.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">  </span><span class="c"># TLS for end-to-end encrypted transport</span><span class="w">
</span><span class="w">  </span><span class="nt">tlsDisable</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">injector</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># True if you want to enable vault agent injection.</span><span class="w">
</span><span class="w">  </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># If multiple replicas are specified, by default a leader-elector side-car</span><span class="w">
</span><span class="w">  </span><span class="c"># will be created so that only one injector attempts to create TLS certificates.</span><span class="w">
</span><span class="w">  </span><span class="nt">leaderElector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">repository</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;gcr.io/google_containers/leader-elector&#34;</span><span class="w">
</span><span class="w">      </span><span class="nt">tag</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0.4&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">ttl</span><span class="p">:</span><span class="w"> </span><span class="l">60s</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># If true, will enable a node exporter metrics endpoint at /metrics.</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># External vault server address for the injector to use. Setting this will</span><span class="w">
</span><span class="w">  </span><span class="c"># disable deployment of a  vault server along with the injector.</span><span class="w">
</span><span class="w">  </span><span class="c"># TODO è¿™é‡Œçš„ https ca.crt è¦æ€ä¹ˆè®¾ç½®ï¼ŸmTLS åˆè¯¥å¦‚ä½•é…ç½®ï¼Ÿ</span><span class="w">
</span><span class="w">  </span><span class="nt">externalVaultAddr</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;https://&lt;external-vault-url&gt;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="c"># Mount Path of the Vault Kubernetes Auth Method.</span><span class="w">
</span><span class="w">  </span><span class="nt">authPath</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;auth/kubernetes&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">  </span><span class="nt">certs</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># secretName is the name of the secret that has the TLS certificate and</span><span class="w">
</span><span class="w">    </span><span class="c"># private key to serve the injector webhook. If this is null, then the</span><span class="w">
</span><span class="w">    </span><span class="c"># injector will default to its automatic management mode that will assign</span><span class="w">
</span><span class="w">    </span><span class="c"># a service account to the injector to generate its own certificates.</span><span class="w">
</span><span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># caBundle is a base64-encoded PEM-encoded certificate bundle for the</span><span class="w">
</span><span class="w">    </span><span class="c"># CA that signed the TLS certificate that the webhook serves. This must</span><span class="w">
</span><span class="w">    </span><span class="c"># be set if secretName is non-null.</span><span class="w">
</span><span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;&#34;</span><span class="w">
</span><span class="w">
</span><span class="w">    </span><span class="c"># certName and keyName are the names of the files within the secret for</span><span class="w">
</span><span class="w">    </span><span class="c"># the TLS cert and private key, respectively. These have reasonable</span><span class="w">
</span><span class="w">    </span><span class="c"># defaults but can be customized if necessary.</span><span class="w">
</span><span class="w">    </span><span class="nt">certName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.crt</span><span class="w">
</span><span class="w">    </span><span class="nt">keyName</span><span class="p">:</span><span class="w"> </span><span class="l">tls.key</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>éƒ¨ç½²å‘½ä»¤å’Œ <a href="#install-by-helm" rel="">é€šè¿‡ helm éƒ¨ç½² vault</a> ä¸€è‡´ï¼Œåªè¦æ›´æ¢ <code>custom-values.yaml</code> å°±è¡Œã€‚</p>
<p>vault-agent éƒ¨ç½²å®Œæˆåï¼Œç¬¬äºŒæ­¥æ˜¯ä¸º vault åˆ›å»º serviceAccountã€secret å’Œ ClusterRoleBindingï¼Œä»¥å…è®¸ vault å®¡æŸ¥ kubernetes çš„ token, å®Œæˆå¯¹ pod çš„èº«ä»½éªŒè¯. yaml é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-auth</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Secret</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-auth</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span><span class="w">  </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">kubernetes.io/service-account.name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-auth</span><span class="w">
</span><span class="w"></span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/service-account-token</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRoleBinding</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">role-tokenreview-binding</span><span class="w">
</span><span class="w"></span><span class="nt">roleRef</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l">rbac.authorization.k8s.io</span><span class="w">
</span><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ClusterRole</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">system:auth-delegator</span><span class="w">
</span><span class="w"></span><span class="nt">subjects</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ServiceAccount</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">vault-auth</span><span class="w">
</span><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨åœ¨ vault å®ä¾‹è¿™è¾¹ï¼Œå¯ç”¨ kubernetes èº«ä»½éªŒè¯ï¼Œåœ¨ vault å®ä¾‹å†…ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p>
<blockquote>
<p>vault å®ä¾‹å†…æ˜¾ç„¶æ²¡æœ‰ kubectl å’Œ kubeconfigï¼Œç®€ä¾¿èµ·è§ï¼Œä¸‹åˆ—çš„ vault å‘½ä»¤ä¹Ÿå¯ä»¥é€šè¿‡ Web UI å®Œæˆã€‚</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">VAULT_TOKEN</span><span class="o">=</span><span class="s1">&#39;&lt;your-root-token&gt;&#39;</span>
<span class="nb">export</span> <span class="nv">VAULT_ADDR</span><span class="o">=</span><span class="s1">&#39;http://localhost:8200&#39;</span>
 
<span class="c1"># å¯ç”¨ Kubernetes èº«ä»½éªŒè¯</span>
vault auth <span class="nb">enable</span> kubernetes
 
<span class="c1"># kube-apiserver API é…ç½®ï¼Œvault éœ€è¦é€šè¿‡ kube-apiserver å®Œæˆå¯¹ serviceAccount çš„èº«ä»½éªŒè¯</span>
<span class="c1"># TOKEN_REVIEW_JWT: å°±æ˜¯æˆ‘ä»¬å‰é¢åˆ›å»ºçš„ secret `vault-auth`</span>
<span class="nv">TOKEN_REVIEW_JWT</span><span class="o">=</span><span class="k">$(</span>kubectl -n vault get secret vault-auth -o go-template<span class="o">=</span><span class="s1">&#39;{{ .data.token }}&#39;</span> <span class="p">|</span> base64 --decode<span class="k">)</span>
<span class="c1"># kube-apiserver çš„ ca è¯ä¹¦</span>
<span class="nv">KUBE_CA_CERT</span><span class="o">=</span><span class="k">$(</span>kubectl -n vault config view --raw --minify --flatten -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[].cluster.certificate-authority-data}&#39;</span> <span class="p">|</span> base64 --decode<span class="k">)</span>
<span class="c1"># kube-apiserver çš„ url</span>
<span class="nv">KUBE_HOST</span><span class="o">=</span><span class="k">$(</span>kubectl config view --raw --minify --flatten -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[].cluster.server}&#39;</span><span class="k">)</span>

vault write auth/kubernetes/config <span class="se">\
</span><span class="se"></span>        <span class="nv">token_reviewer_jwt</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$TOKEN_REVIEW_JWT</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>        <span class="nv">kubernetes_host</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$KUBE_HOST</span><span class="s2">&#34;</span> <span class="se">\
</span><span class="se"></span>        <span class="nv">kubernetes_ca_cert</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$KUBE_CA_CERT</span><span class="s2">&#34;</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ ·ï¼Œå°±å®Œæˆäº† kubernetes ä¸å¤–éƒ¨ vault çš„é›†æˆï¼</p>
<h3 id="2-å…³è”-k8s-rbac-æƒé™ç³»ç»Ÿå’Œ-vault">2. å…³è” k8s rbac æƒé™ç³»ç»Ÿå’Œ vault</h3>
<p>æ¥ä¸‹æ¥éœ€è¦åšçš„äº‹ï¼š</p>
<ol start="2">
<li>é€šè¿‡ vault policy å®šä¹‰å¥½æ¯ä¸ª roleï¼ˆå¾®æœåŠ¡ï¼‰èƒ½è®¿é—®å“ªäº›èµ„æºã€‚</li>
<li>ä¸ºæ¯ä¸ªå¾®æœåŠ¡ç”Ÿæˆä¸€ä¸ª roleï¼Œè¿™ä¸ª role éœ€è¦ç»‘å®šå¯¹åº”çš„ vault policy åŠ kubernetes serviceaccount
<ol>
<li>è¿™ä¸ª role æ˜¯ vault çš„ kubernetes æ’ä»¶è‡ªèº«çš„å±æ€§ï¼Œå®ƒå’Œ kubernetes role æ²¡æœ‰åŠæ¯›é’±å…³ç³»ã€‚</li>
</ol>
</li>
<li>åˆ›å»ºä¸€ä¸ª ServiceAccountï¼Œå¹¶ä½¿ç”¨è¿™ä¸ª ä½¿ç”¨è¿™ä¸ª ServiceAccount éƒ¨ç½²å¾®æœåŠ¡</li>
</ol>
<p>å…¶ä¸­ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥éƒ½å¯ä»¥é€šè¿‡ vault api è‡ªåŠ¨åŒ–å®Œæˆ.
ç¬¬ä¸‰æ­¥å¯ä»¥é€šè¿‡ kubectl éƒ¨ç½²æ—¶å®Œæˆã€‚</p>
<p>æ–¹ä¾¿èµ·è§ï¼Œvault policy / role / k8s serviceaccount è¿™ä¸‰ä¸ªé…ç½®ï¼Œéƒ½å»ºè®®å’Œå¾®æœåŠ¡ä½¿ç”¨ç›¸åŒçš„åç§°ã€‚</p>
<blockquote>
<p>ä¸Šè¿°é…ç½®ä¸­ï¼Œrole èµ·åˆ°ä¸€ä¸ªæ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼Œå®ƒå…³è”äº† k8s serviceaccount å’Œ vault policy ä¸¤ä¸ªé…ç½®ã€‚</p>
</blockquote>
<p>æ¯”å¦‚åˆ›å»ºä¸€ä¸ªåä¸º <code>my-app-policy</code> çš„ vault policyï¼Œå†…å®¹ä¸º:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># å…è®¸è¯»å–æ•°æ®
</span><span class="c1"></span><span class="k">path</span> <span class="s2">&#34;my-app/data/*&#34;</span> {
<span class="n">   capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;read&#34;, &#34;list&#34;</span><span class="p">]</span>
}
<span class="err">//</span> <span class="k">å…è®¸åˆ—å‡º</span> <span class="k">myapp</span> <span class="k">ä¸­çš„æ‰€æœ‰æ•°æ®</span><span class="p">(</span><span class="k">kv</span> <span class="k">v2</span><span class="p">)</span>
<span class="k">path</span> <span class="s2">&#34;myapp/metadata/*&#34;</span> {
<span class="n">    capabilities</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;read&#34;, &#34;list&#34;</span><span class="p">]</span>
}
</code></pre></td></tr></table>
</div>
</div><p>ç„¶ååœ¨ vault çš„ kuberntes æ’ä»¶é…ç½®ä¸­ï¼Œåˆ›å»º role <code>my-app-role</code>ï¼Œé…ç½®å¦‚ä¸‹:</p>
<ol>
<li>å…³è” k8s default åå­—ç©ºé—´ä¸­çš„ serviceaccount <code>my-app-account</code>ï¼Œå¹¶åˆ›å»ºå¥½è¿™ä¸ª serviceaccount.</li>
<li>å…³è” vault token policyï¼Œè¿™å°±æ˜¯å‰é¢åˆ›å»ºçš„ <code>my-app-policy</code></li>
<li>è®¾ç½® token periodï¼ˆæœ‰æ•ˆæœŸï¼‰</li>
</ol>
<p>è¿™ä¹‹åï¼Œæ¯ä¸ªå¾®æœåŠ¡å°±èƒ½é€šè¿‡ serviceaccount ä» vault ä¸­è¯»å– <code>my-app</code> ä¸­çš„æ‰€æœ‰ä¿¡æ¯äº†ã€‚</p>
<h3 id="3-éƒ¨ç½²-pod">3. éƒ¨ç½² Pod</h3>
<blockquote>
<p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://www.vaultproject.io/docs/platform/k8s/injector">https://www.vaultproject.io/docs/platform/k8s/injector</a></p>
</blockquote>
<p>ä¸‹ä¸€æ­¥å°±æ˜¯å°†é…ç½®æ³¨å…¥åˆ°å¾®æœåŠ¡å®¹å™¨ä¸­ï¼Œè¿™éœ€è¦ä½¿ç”¨åˆ° Agent Sidecar Injectorã€‚
vault é€šè¿‡ sidecar å®ç°é…ç½®çš„è‡ªåŠ¨æ³¨å…¥ä¸åŠ¨æ€æ›´æ–°ã€‚</p>
<p>å…·ä½“è€Œè¨€å°±æ˜¯åœ¨ Pod ä¸ŠåŠ ä¸Šä¸€å † Agent Sidecar Injector çš„æ³¨è§£ï¼Œå¦‚æœé…ç½®æ¯”è¾ƒå¤šï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ configmap ä¿å­˜ï¼Œåœ¨æ³¨è§£ä¸­å¼•ç”¨ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ vault-inject-agent æœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š</p>
<ol>
<li>init æ¨¡å¼: ä»…åœ¨ Pod å¯åŠ¨å‰åˆå§‹åŒ–ä¸€æ¬¡ï¼Œè·‘å®Œå°±é€€å‡ºï¼ˆCompletedï¼‰</li>
<li>å¸¸é©»æ¨¡å¼: å®¹å™¨ä¸é€€å‡ºï¼ŒæŒç»­ç›‘æ§ vault çš„é…ç½®æ›´æ–°ï¼Œç»´æŒ Pod é…ç½®å’Œ vualt é…ç½®çš„åŒæ­¥ã€‚</li>
</ol>
<p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">annotations</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-init-first</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">  </span><span class="c"># æ˜¯å¦ä½¿ç”¨ initContainer æå‰åˆå§‹åŒ–é…ç½®æ–‡ä»¶</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-inject</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;true&#39;</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/secret-volume-path</span><span class="p">:</span><span class="w"> </span><span class="l">vault</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/role</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my-app-role&#34;</span><span class="w">  </span><span class="c"># vault kubernetes æ’ä»¶çš„ role åç§°</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-inject-template-config.json</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">          </span><span class="w">          </span><span class="c"># æ¸²æŸ“æ¨¡æ¿çš„è¯­æ³•åœ¨åé¢ä»‹ç»</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-limits-cpu</span><span class="p">:</span><span class="w"> </span><span class="l">250m</span><span class="w">
</span><span class="w">        </span><span class="nt">vault.hashicorp.com/agent-requests-cpu</span><span class="p">:</span><span class="w"> </span><span class="l">100m</span><span class="w">
</span><span class="w">        </span><span class="c"># åŒ…å« vault é…ç½®çš„ configmapï¼Œå¯ä»¥åšæ›´ç²¾ç»†çš„æ§åˆ¶</span><span class="w">
</span><span class="w">        </span><span class="c"># vault.hashicorp.com/agent-configmap: my-app-vault-config</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.svc.local/xx/my-app:latest</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">        </span><span class="c"># æ­¤å¤„çœç•¥è‹¥å¹²é…ç½®...</span><span class="w">
</span><span class="w">      </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-account</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>å¸¸è§é”™è¯¯ï¼š</p>
<ul>
<li>vault-agent(sidecar) æŠ¥é”™: <code>namespace not authorized</code>
<ul>
<li><code>auth/kubernetes/config</code> ä¸­çš„ role æ²¡æœ‰ç»‘å®š Pod çš„ namespace</li>
</ul>
</li>
<li>vault-agent(sidecar) æŠ¥é”™: <code>permission denied</code>
<ul>
<li>æ£€æŸ¥ <code>vault</code> å®ä¾‹çš„æ—¥å¿—ï¼Œåº”è¯¥æœ‰å¯¹åº”çš„é”™è¯¯æ—¥å¿—ï¼Œå¾ˆå¯èƒ½æ˜¯ <code>auth/kubernetes/config</code> æ²¡é…å¯¹ï¼Œvault æ— æ³•éªŒè¯ kube-apiserver çš„ tls è¯ä¹¦ï¼Œæˆ–è€…ä½¿ç”¨çš„ kubernetes token æ²¡æœ‰æƒé™ã€‚</li>
</ul>
</li>
<li>vault-agent(sidecar) æŠ¥é”™: <code>service account not authorized</code>
<ul>
<li><code>auth/kubernetes/config</code> ä¸­çš„ role æ²¡æœ‰ç»‘å®š Pod ä½¿ç”¨çš„ serviceAccount</li>
</ul>
</li>
</ul>
<h3 id="4-vault-agent-é…ç½®">4. vault agent é…ç½®</h3>
<p>vault-agent çš„é…ç½®ï¼Œéœ€è¦æ³¨æ„çš„æœ‰ï¼š</p>
<ol>
<li>å¦‚æœä½¿ç”¨ configmap æä¾›å®Œæ•´çš„ <code>config.hcl</code> é…ç½®ï¼Œæ³¨æ„ <code>agent-init</code></li>
</ol>
<p>vautl-agent çš„ template è¯´æ˜ï¼š</p>
<p>ç›®å‰æ¥è¯´æœ€æµè¡Œçš„é…ç½®æ–‡ä»¶æ ¼å¼åº”è¯¥æ˜¯ json/yamlï¼Œä»¥ json ä¸ºä¾‹ï¼Œ
å¯¹æ¯ä¸ªå¾®æœåŠ¡çš„ kv æ•°æ®ï¼Œå¯ä»¥è€ƒè™‘å°†å®ƒæ‰€æœ‰çš„ä¸ªæ€§åŒ–é…ç½®éƒ½ä¿å­˜åœ¨ <code>&lt;engine-name&gt;/&lt;service-name&gt;/</code> ä¸‹é¢ï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹ template æ³¨å…¥é…ç½®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{
    {{ range secrets &#34;&lt;engine-name&gt;/metadata/&lt;service-name&gt;/&#34; }}
        &#34;{{ printf &#34;%s&#34; . }}&#34;: 
        {{ with secret (printf &#34;&lt;engine-name&gt;/&lt;service-name&gt;/%s&#34; .) }}
        {{ .Data.data | toJSONPretty }},
        {{ end }}
    {{ end }}
}
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>template çš„è¯¦ç»†è¯­æ³•å‚è§: <a href="https://github.com/hashicorp/consul-template#secret">https://github.com/hashicorp/consul-template#secret</a></p>
</blockquote>
<blockquote>
<p>æ³¨æ„ï¼šv2 ç‰ˆæœ¬çš„ kv secretsï¼Œå®ƒçš„ list æ¥å£æœ‰å˜æ›´ï¼Œå› æ­¤åœ¨éå† v2 kv secrets æ—¶ï¼Œ
å¿…é¡»è¦å†™æˆ <code>range secrets &quot;&lt;engine-name&gt;/metadata/&lt;service-name&gt;/&quot;</code>ï¼Œä¹Ÿå°±æ˜¯ä¸­é—´è¦æ’å…¥ <code>metadata</code>ï¼Œè€Œä¸” policy ä¸­å¿…é¡»å¼€æ”¾ <code>&lt;engine-name&gt;/metadata/&lt;service-name&gt;/</code> çš„ read/list æƒé™ï¼
å®˜æ–¹æ–‡æ¡£å®Œå…¨æ²¡æåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘é€šè¿‡ wireshark æŠ“åŒ…è°ƒè¯•ï¼Œå¯¹ç…§å®˜æ–¹çš„ <a href="https://www.vaultproject.io/api-docs/secret/kv/kv-v2" target="_blank" rel="noopener noreferrer">KV Secrets Engine - Version 2 (API)</a> æ‰ææ˜ç™½è¿™ä¸ªã€‚</p>
</blockquote>
<p>è¿™æ ·ç”Ÿæˆå‡ºæ¥çš„å†…å®¹å°†æ˜¯ json æ ¼å¼ï¼Œä¸è¿‡æœ‰ä¸ªä¸å…¼å®¹çš„åœ°æ–¹ï¼šæœ€åä¸€ä¸ª secrets çš„æœ«å°¾æœ‰é€—å· <code>,</code>
æ¸²æŸ“å‡ºçš„æ•ˆæœç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;secret-a&#34;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&#34;a&#34;</span><span class="p">:</span> <span class="s2">&#34;b&#34;</span><span class="p">,</span>
  <span class="nt">&#34;c&#34;</span><span class="p">:</span> <span class="s2">&#34;d&#34;</span>
<span class="p">},</span>
    <span class="nt">&#34;secret-b&#34;</span><span class="p">:</span> <span class="p">{</span>
  <span class="nt">&#34;v&#34;</span><span class="p">:</span> <span class="s2">&#34;g&#34;</span><span class="p">,</span>
  <span class="nt">&#34;r&#34;</span><span class="p">:</span> <span class="s2">&#34;c&#34;</span>
<span class="p">},</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>å› ä¸ºå­˜åœ¨å°¾éƒ¨é€—å·(trailing comma)ï¼Œç›´æ¥ä½¿ç”¨ json æ ‡å‡†åº“è§£æå®ƒä¼šæŠ¥é”™ã€‚
é‚£è¯¥å¦‚ä½•å»è§£æå®ƒå‘¢ï¼Ÿæˆ‘åœ¨ä¸‡èƒ½çš„ stackoverflow ä¸Šæ‰¾åˆ°äº†è§£å†³æ–¹æ¡ˆï¼š<strong>yaml å®Œå…¨å…¼å®¹ json è¯­æ³•ï¼Œå¹¶ä¸”æ”¯æŒå°¾éƒ¨é€—å·ï¼</strong></p>
<p>ä»¥ python ä¸ºä¾‹ï¼Œç›´æ¥ <code>yaml.safe_load()</code> å°±èƒ½å®Œç¾è§£æ vault ç”Ÿæˆå‡ºçš„ json å†…å®¹ã€‚</p>
<h3 id="5-æ‹“å±•åœ¨-kubernetes-ä¸­ä½¿ç”¨-vault-çš„å…¶ä»–å§¿åŠ¿">5. æ‹“å±•ï¼šåœ¨ kubernetes ä¸­ä½¿ç”¨ vault çš„å…¶ä»–å§¿åŠ¿</h3>
<p>é™¤äº†ä½¿ç”¨å®˜æ–¹æä¾›çš„ sidecar æ¨¡å¼è¿›è¡Œ secrets æ³¨å…¥ï¼Œç¤¾åŒºä¹Ÿæä¾›äº†ä¸€äº›åˆ«çš„æ–¹æ¡ˆï¼Œå¯ä»¥å‚è€ƒï¼š</p>
<ul>
<li><a href="https://github.com/hashicorp/vault-csi-provider" target="_blank" rel="noopener noreferrer">hashicorp/vault-csi-provider</a>: å®˜æ–¹çš„ Beta é¡¹ç›®ï¼Œé€šè¿‡ Secrets Store CSI é©±åŠ¨å°† vault secrets ä»¥æ•°æ®å·çš„å½¢å¼æŒ‚è½½åˆ° pod ä¸­</li>
<li><a href="https://github.com/external-secrets/kubernetes-external-secrets" target="_blank" rel="noopener noreferrer">kubernetes-external-secrets</a>: æä¾› CRD å®šä¹‰ï¼Œæ ¹æ®å®šä¹‰å°† secret ä» vault ä¸­åŒæ­¥åˆ° kubernetes secrets</li>
</ul>
<p>å®˜æ–¹çš„ sidecar/init-container æ¨¡å¼ä»ç„¶æ˜¯æœ€æ¨èä½¿ç”¨çš„ã€‚</p>
<h2 id="äº”ä½¿ç”¨-vault-å®ç°-aws-iam-credentials-çš„è‡ªåŠ¨è½®è½¬">äº”ã€ä½¿ç”¨ vault å®ç° AWS IAM Credentials çš„è‡ªåŠ¨è½®è½¬</h2>
<p>å¾…ç»­ã€‚ã€‚ã€‚</p>
]]></description></item><item><title>Pulumi ä½¿ç”¨ä½“éªŒ - åŸºç¡€è®¾æ–½ä»£ç åŒ–</title><link>https://ryan4yin.space/posts/expirence-of-pulumi/</link><pubDate>Fri, 08 Jan 2021 18:51:30 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/expirence-of-pulumi/</guid><description><![CDATA[<p><a href="https://github.com/pulumi/pulumi" target="_blank" rel="noopener noreferrer">Pulumi</a> æ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½çš„è‡ªåŠ¨ç®¡ç†å·¥å…·ï¼Œä½¿ç”¨ Python/TypeScript/Go/Dotnet ç¼–å†™å¥½å£°æ˜å¼çš„èµ„æºé…ç½®ï¼Œå°±èƒ½å®ç°ä¸€é”®åˆ›å»º/ä¿®æ”¹/é”€æ¯å„ç±»èµ„æºï¼Œè¿™é‡Œçš„èµ„æºå¯ä»¥æ˜¯ï¼š</p>
<ul>
<li>AWS/é˜¿é‡Œäº‘ç­‰äº‘ä¸Šçš„è´Ÿè½½å‡è¡¡ã€äº‘æœåŠ¡å™¨ã€TLS è¯ä¹¦ã€DNSã€CDNã€OSSã€æ•°æ®åº“&hellip;å‡ ä¹æ‰€æœ‰çš„äº‘ä¸Šèµ„æº</li>
<li>æœ¬åœ°è‡ªå»ºçš„ vSphere/Kubernetes/ProxmoxVE/libvirt ç¯å¢ƒä¸­çš„è™šæ‹Ÿæœºã€å®¹å™¨ç­‰èµ„æº</li>
</ul>
<p>ç›¸æ¯”ç›´æ¥è°ƒç”¨ AWS/é˜¿é‡Œäº‘/Kubernetes çš„ APIï¼Œä½¿ç”¨ pulumi çš„å¥½å¤„æœ‰ï¼š</p>
<ul>
<li>å£°æ˜å¼é…ç½®ï¼šä½ åªéœ€è¦å£°æ˜ä½ çš„èµ„æºå±æ€§å°± OKï¼Œæ‰€æœ‰çš„çŠ¶æ€ç®¡ç†ã€å¼‚å¸¸å¤„ç†éƒ½ç”± pulumi å®Œæˆã€‚</li>
<li>ç»Ÿä¸€çš„é…ç½®æ–¹å¼ï¼šæä¾›ç»Ÿä¸€çš„é…ç½®æ–¹æ³•ï¼Œæ¥å£°æ˜å¼çš„é…ç½®æ‰€æœ‰ AWS/é˜¿é‡Œäº‘/Kubernetes èµ„æºã€‚</li>
<li>å£°æ˜å¼é…ç½®çš„å¯è¯»æ€§æ›´å¥½ï¼Œæ›´ä¾¿äºç»´æŠ¤</li>
</ul>
<p>è¯•æƒ³ä¸€ä¸‹ï¼Œé€šè¿‡ä¼ ç»Ÿçš„æ‰‹æ®µå»ä»é›¶æ­å»ºä¸€ä¸ªäº‘ä¸Šæµ‹è¯•ç¯å¢ƒã€æˆ–è€…æœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œéœ€è¦æ‰‹å·¥åšå¤šå°‘ç¹ççš„å·¥ä½œã€‚</p>
<p>è€Œä¾é  Pulumi è¿™ç±»ã€ŒåŸºç¡€è®¾æ–½å³ä»£ç ã€çš„å·¥å…·ï¼Œåªéœ€è¦ä¸€è¡Œå‘½ä»¤å°±èƒ½æ­å»ºå¥½ä¸€ä¸ªå¯å¤ç°çš„äº‘ä¸Šæµ‹è¯•ç¯å¢ƒæˆ–æœ¬åœ°å¼€å‘ç¯å¢ƒã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬çš„é˜¿é‡Œäº‘æµ‹è¯•ç¯å¢ƒï¼ŒåŒ…æ‹¬ä¸¤ä¸ª kubernetes é›†ç¾¤ã€è´Ÿè½½å‡è¡¡ã€VPC ç½‘ç»œã€æ•°æ®åº“ã€äº‘ç›‘æ§å‘Šè­¦/æ—¥å¿—å‘Šè­¦ã€RAMè´¦å·æƒé™ä½“ç³»ç­‰ç­‰ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ä½“ç³»ã€‚</p>
<p>äººå·¥å»é…ç½®è¿™ä¹ˆå¤šä¸œè¥¿ï¼Œæƒ³è¦å¤ç°æ˜¯å¾ˆå›°éš¾çš„ï¼Œéå¸¸ç¹çè€Œä¸”å®¹æ˜“å‡ºé”™ã€‚</p>
<p>ä½†æ˜¯ä½¿ç”¨ pulumiï¼Œåªéœ€è¦ä¸€è¡Œå‘½ä»¤ï¼Œå°±èƒ½åˆ›å»ºå¹¶é…ç½®å¥½è¿™äº”èŠ±å…«é—¨ä¸€å¤§å †çš„ç©æ„å„¿ã€‚
é”€æ¯æ•´ä¸ªæµ‹è¯•ç¯å¢ƒä¹Ÿåªéœ€è¦ä¸€è¡Œå‘½ä»¤ã€‚</p>
<p><strong>å®é™…ä½¿ç”¨ä½“éªŒ</strong>ï¼šæˆ‘ä»¬ä½¿ç”¨ Pulumi è‡ªåŠ¨åŒ–äº†é˜¿é‡Œäº‘æµ‹è¯•ç¯å¢ƒæ­å»º 95%+ çš„æ“ä½œï¼Œè¿™ä¸ªæ¯”ä¾‹éšç€é˜¿é‡Œäº‘çš„ pulumi provider çš„å®Œå–„ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥æé«˜ï¼</p>
<h2 id="pulumi-vs-terraform">Pulumi vs Terraform</h2>
<p>æœ‰ä¸€ä¸ªã€ŒåŸºç¡€è®¾æ–½å³ä»£ç ã€çš„å·¥å…·æ¯” Pulumi æ›´æµè¡Œï¼Œå®ƒå°±æ˜¯ <a href="https://www.terraform.io/" target="_blank" rel="noopener noreferrer">Terraform</a>.</p>
<p>å®é™…ä¸Šæˆ‘ä»¬ä¸€å¼€å§‹ä½¿ç”¨çš„ä¹Ÿæ˜¯ Terraformï¼Œä½†æ˜¯åæ¥ä½¿ç”¨ Pulumi å®Œå…¨é‡å†™äº†ä¸€éã€‚</p>
<p>ä¸»è¦åŸå› æ˜¯ï¼ŒPulumi è§£å†³äº† Terraform é…ç½®çš„ä¸€ä¸ªç—›ç‚¹ï¼šé…ç½®è¯­æ³•å¤ªè¿‡ç®€å•ï¼Œå¯¼è‡´é…ç½®ç¹çã€‚è€Œä¸”è¿˜è¦é¢å¤–å­¦ä¹ ä¸€é—¨ DSL - HCL</p>
<p>Terraform è™½ç„¶åº”ç”¨å¹¿æ³›ï¼Œä½†æ˜¯å®ƒé»˜è®¤ä½¿ç”¨çš„ HCL è¯­è¨€å¤ªç®€å•ï¼Œè¡¨ç°åŠ›ä¸å¤Ÿå¼ºã€‚
è¿™å°±å¯¼è‡´åœ¨ä¸€äº›åœºæ™¯ä¸‹ä½¿ç”¨ Terraformï¼Œä¼šå‡ºç°å¤§é‡çš„é‡å¤é…ç½®ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„åœºæ™¯æ˜¯ã€Œæ‰¹é‡åˆ›å»ºèµ„æºï¼ŒåŠ¨æ€ç”Ÿæˆèµ„æºå‚æ•°ã€ã€‚æ¯”å¦‚æ‰¹é‡åˆ›å»ºä¸€æ‰¹åç§°ç±»ä¼¼çš„ ECS æœåŠ¡å™¨/VPCäº¤æ¢æœºã€‚å¦‚æœä½¿ç”¨ terraformï¼Œå°±ä¼šå‡ºç°å¤§é‡çš„é‡å¤é…ç½®ã€‚</p>
<p>æ”¹ç”¨ terraform æä¾›çš„ module èƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šå®ç°é…ç½®çš„å¤ç”¨ï¼Œä½†æ˜¯å®ƒè¿˜æ˜¯è§£å†³ä¸äº†é—®é¢˜ã€‚
è¦ä½¿ç”¨ moduleï¼Œä½ éœ€è¦ä»˜å‡ºæ—¶é—´å»å­¦ä¹  module çš„æ¦‚å¿µï¼Œä¸ºäº†æ‹¼æ¥å‚æ•°ï¼Œä½ è¿˜éœ€è¦å­¦ä¹  HCL çš„ä¸€äº›é«˜çº§ç”¨æ³•ã€‚</p>
<p>ä½†æ˜¯ä»˜å‡ºäº†è¿™ä¹ˆå¤šï¼Œæœ€åå†™å‡ºçš„ module è¿˜æ˜¯ä¸å¤Ÿçµæ´»â€”â€”å®ƒè¢« HCL å±€é™ä½äº†ã€‚</p>
<p>ä¸ºäº†å®ç°å¦‚æ­¤çš„å‚æ•°åŒ–åŠ¨æ€åŒ–ï¼Œæˆ‘ä»¬ä¸å¾—ä¸å¼•å…¥ Python ç­‰å…¶ä»–ç¼–ç¨‹è¯­è¨€ã€‚äºæ˜¯æ„å»ºæµç¨‹å°±å˜æˆäº†ï¼š</p>
<ol>
<li>å€ŸåŠ© Python ç­‰å…¶ä»–è¯­è¨€å…ˆç”Ÿæˆå‡º HCL é…ç½®</li>
<li>é€šè¿‡ <code>terraform</code> å‘½ä»¤è¡Œè¿›è¡Œ plan ä¸ apply</li>
<li>é€šè¿‡ Python ä»£ç è§£æ <code>terraform.tfstat</code>ï¼Œè·å– apply ç»“æœï¼Œå†è¿›è¡Œè¿›ä¸€æ­¥æ“ä½œã€‚</li>
</ol>
<p>è¿™æ˜¾ç„¶éå¸¸ç¹çï¼Œä¸»è¦å›°éš¾å°±åœ¨äº Python å’Œ Terraform ä¹‹é—´çš„äº¤äº’ã€‚</p>
<p>è¿›ä¸€æ­¥æ€è€ƒï¼Œ<strong>æ—¢ç„¶å…¶ä»–ç¼–ç¨‹è¯­è¨€å¦‚ Python/Go çš„å¼•å…¥ä¸å¯é¿å…ï¼Œé‚£æ˜¯ä¸æ˜¯èƒ½ä½¿ç”¨å®ƒä»¬å½»åº•æ›¿ä»£æ‰ HCL å‘¢ï¼Ÿèƒ½ä¸èƒ½ç›´æ¥ä½¿ç”¨ Python/Go ç¼–å†™é…ç½®</strong>ï¼Ÿå¦‚æœ Terraform åŸç”Ÿå°±æ”¯æŒ Python/Go æ¥ç¼–å†™é…ç½®ï¼Œé‚£å°±ä¸å­˜åœ¨äº¤äº’é—®é¢˜äº†ã€‚</p>
<p>ç›¸æ¯”äºä½¿ç”¨é¢†åŸŸç‰¹å®šè¯­è¨€ HCLï¼Œä½¿ç”¨é€šç”¨ç¼–ç¨‹è¯­è¨€ç¼–å†™é…ç½®ï¼Œå¥½å¤„æœ‰ï¼š</p>
<ol>
<li>Python/Go/TypeScript ç­‰é€šç”¨çš„ç¼–ç¨‹è¯­è¨€ï¼Œèƒ½æ»¡è¶³ä½ çš„ä¸€åˆ‡éœ€æ±‚ã€‚</li>
<li>ä½œä¸ºä¸€ä¸ªå¼€å‘äººå‘˜/DevOpsï¼Œä½ åº”è¯¥å¯¹ Python/Go ç­‰è¯­è¨€ç›¸å½“ç†Ÿæ‚‰ï¼Œå¯ä»¥ç›´æ¥åˆ©ç”¨ä¸Šå·²æœ‰çš„ç»éªŒã€‚</li>
<li>æ›´æ–¹ä¾¿æµ‹è¯•ï¼šå¯ä»¥ä½¿ç”¨å„ç¼–ç¨‹è¯­è¨€ä¸­æµè¡Œçš„æµ‹è¯•æ¡†æ¶æ¥æµ‹è¯• pulumi é…ç½®ï¼</li>
</ol>
<p>äºæ˜¯ Pulumi æ¨ªç©ºå‡ºä¸–ã€‚</p>
<blockquote>
<p>å¦ä¸€ä¸ªå’Œ Pulumi åŠŸèƒ½ç±»ä¼¼çš„å·¥å…·ï¼Œæ˜¯åˆšå‡ºç‚‰æ²¡å¤šä¹…çš„ terraform-cdkï¼Œä½†æ˜¯ç›®å‰å®ƒè¿˜å¾ˆä¸æˆç†Ÿã€‚</p>
</blockquote>
<h2 id="pulumi-ç‰¹ç‚¹ä»‹ç»">Pulumi ç‰¹ç‚¹ä»‹ç»</h2>
<ol start="4">
<li>åŸç”Ÿæ”¯æŒé€šè¿‡ Python/Go/TypeScript/Dotnet ç­‰è¯­è¨€ç¼–å†™é…ç½®ï¼Œä¹Ÿå°±å®Œå…¨è§£å†³äº†ä¸Šè¿°çš„ terraform å’Œ python çš„äº¤äº’é—®é¢˜ã€‚</li>
<li>pulumi æ˜¯ç›®å‰æœ€æµè¡Œçš„ çœŸ-IaaS å·¥å…·ï¼Œå¯¹å„è¯­è¨€çš„æ”¯æŒéƒ½å¾ˆæˆç†Ÿã€‚</li>
<li>å…¼å®¹ terraform çš„æ‰€æœ‰ providerï¼Œåªæ˜¯éœ€è¦è‡ªè¡Œä½¿ç”¨ <a href="https://github.com/pulumi/pulumi-tf-provider-boilerplate" target="_blank" rel="noopener noreferrer">pulumi-tf-provider-boilerplate</a> é‡æ–°æ‰“åŒ…ï¼Œæœ‰äº›éº»çƒ¦ã€‚
<ol>
<li>pulumi å®˜æ–¹çš„ provider å‡ ä¹å…¨éƒ½æ˜¯å°è£…çš„ terraform providerï¼ŒåŒ…æ‹¬ aws/azure/alicloudï¼Œç›®å‰åªå‘ç° kubernetes æ˜¯åŸç”Ÿçš„ï¼ˆç‹¬è‹—å•Šï¼‰ã€‚</li>
</ol>
</li>
<li>çŠ¶æ€ç®¡ç†å’Œ secrets ç®¡ç†æœ‰å¦‚ä¸‹å‡ ç§é€‰æ‹©ï¼š
<ol>
<li>ä½¿ç”¨ app.pulumi.comï¼ˆé»˜è®¤ï¼‰:å…è´¹ç‰ˆæä¾› stack å†å²ç®¡ç†ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„å†å²è®°å½•ã€‚å¦å¤–è¿˜æä¾›ä¸€ä¸ªèµ„æºå…³ç³»çš„å¯è§†åŒ–é¢æ¿ã€‚æ€»ä¹‹å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯å¤šäººåˆä½œå°±éœ€è¦æ”¶è´¹ã€‚</li>
<li>æœ¬åœ°æ–‡ä»¶å­˜å‚¨ï¼š<code>pulumi login file:///app/data</code></li>
<li><a href="https://www.pulumi.com/docs/intro/concepts/state/#logging-into-the-aws-s3-backend" target="_blank" rel="noopener noreferrer">äº‘ç«¯å¯¹è±¡å­˜å‚¨</a>ï¼Œæ”¯æŒ s3 ç­‰å¯¹è±¡å­˜å‚¨åè®®ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨ AWS æˆ–è€…æœ¬åœ°çš„ MinIO æ¥åš Backend.
<ul>
<li><code>pulumi login 's3://&lt;bucket-path&gt;?endpoint=my.minio.local:8080&amp;disableSSL=true&amp;s3ForcePathStyle=true'</code></li>
<li>minio/aws çš„ creadential å¯ä»¥é€šè¿‡ <code>AWS_ACCESS_KEY_ID</code> å’Œ <code>AWS_SECRET_ACCESS_KEY</code> ä¸¤ä¸ªç¯å¢ƒå˜é‡è®¾ç½®ã€‚å¦å¤–å³ä½¿æ˜¯ä½¿ç”¨ MinIOï¼Œ<code>AWS_REGION</code> è¿™ä¸ªæ²¡å•¥ç”¨çš„ç¯å¢ƒå˜é‡ä¹Ÿå¿…é¡»è®¾ç½®ï¼å¦åˆ™ä¼šæŠ¥é”™ã€‚</li>
</ul>
</li>
<li><a href="https://github.com/pulumi/pulumi/issues/4727" target="_blank" rel="noopener noreferrer">gitlab 13 æ”¯æŒ Terraform HTTP State åè®®</a>ï¼Œç­‰è¿™ä¸ª pr åˆå¹¶ï¼Œpulumi ä¹Ÿèƒ½ä»¥ gitlab ä¸º backend äº†ã€‚</li>
<li>ä½¿ç”¨ pulumi ä¼ä¸šç‰ˆï¼ˆè‡ªå»ºæœåŠ¡ï¼‰ï¼šæ¯” app.pulumi.com æä¾›æ›´å¤šçš„ç‰¹æ€§ï¼Œä½†æ˜¯æ˜¾ç„¶æ˜¯æ”¶è´¹çš„ã€‚ã€‚</li>
</ol>
</li>
</ol>
<p>æ€»ä¹‹ï¼Œéå¸¸é¦™ï¼Œå¼ºçƒˆæ¨èå„ä½ DevOps è¯•ç”¨ã€‚</p>
<hr>
<blockquote>
<p>ä»¥ä¸‹å†…å®¹æ˜¯æˆ‘å¯¹ pulumi çš„ä¸€äº›æ€è€ƒï¼Œä»¥åŠä½¿ç”¨ pulumi é‡åˆ°çš„å„ç§é—®é¢˜+è§£å†³æ–¹æ³•ï¼Œé€‚åˆå¯¹ pulumi æœ‰ä¸€å®šäº†è§£çš„åŒå­¦é˜…è¯»ã€‚</p>
</blockquote>
<blockquote>
<p>å¦‚æœä½ åˆšæ¥è§¦ Pulumi è€Œä¸”æœ‰å…´è¶£å­¦ä¹ ï¼Œå»ºè®®å…ˆç§»æ­¥ <a href="https://www.pulumi.com/docs/get-started/install/" target="_blank" rel="noopener noreferrer">pulumi get started</a> å…¥ä¸ªé—¨ï¼Œå†æ¥ç€çœ‹ä¸‹é¢çš„å†…å®¹ã€‚</p>
</blockquote>
<h2 id="ä½¿ç”¨å»ºè®®">ä½¿ç”¨å»ºè®®</h2>
<ol>
<li><strong>å»ºè®®æŸ¥çœ‹å¯¹åº”çš„ terraform provider æ–‡æ¡£ï¼špulumi çš„ provider åŸºæœ¬éƒ½æ˜¯å°è£…çš„ terraform ç‰ˆæœ¬ï¼Œè€Œä¸”æ–‡æ¡£æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ¯”ï¼ˆç®€ï¼‰è¾ƒï¼ˆç›´ï¼‰éš¾ï¼ˆä¸€ï¼‰çœ‹ï¼ˆå¨ï¼‰æ‡‚ï¼ˆshiï¼‰ï¼Œexamples ä¹Ÿå°‘ã€‚</strong></li>
<li>stack: pulumi å®˜æ–¹æä¾›äº†ä¸¤ç§ stack ç”¨æ³•ï¼š<a href="https://www.pulumi.com/docs/intro/concepts/organizing-stacks-projects/" target="_blank" rel="noopener noreferrer">ã€Œå•ä½“ã€å’Œã€Œå¾®-stackã€</a>
<ol>
<li>å•ä½“: one stack rule them allï¼Œé€šè¿‡ stack å‚æ•°æ¥æ§åˆ¶æ­¥éª¤ã€‚stack ç”¨æ¥åŒºåˆ†ç¯å¢ƒ dev/pro ç­‰ã€‚</li>
<li>å¾®-stack: æ¯ä¸€ä¸ª stack æ˜¯ä¸€ä¸ªæ­¥éª¤ï¼Œæ‰€æœ‰ stack ç»„æˆä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ã€‚</li>
<li>å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘å‘ç°ã€Œå¾®-stackã€æ¨¡å¼éœ€è¦ä½¿ç”¨åˆ° pulumi çš„ inter-stack dependenciesï¼ŒæŠ¥ä¸€å †çš„é”™ï¼Œè€Œä¸”ä¸å¤Ÿçµæ´»ã€‚å› æ­¤ç›®å‰æ›´æ¨èã€Œå•ä½“ã€æ¨¡å¼ã€‚</li>
</ol>
</li>
</ol>
<p>æˆ‘ä»¬æœ€è¿‘ä½¿ç”¨ pulumi å®Œå…¨é‡å†™äº†ä»¥å‰ç”¨ terraform ç¼–å†™çš„äº‘ä¸Šé…ç½®ï¼Œç®€åŒ–äº†å¾ˆå¤šç¹ççš„é…ç½®ï¼Œä¹Ÿé™ä½äº†æˆ‘ä»¬ Python è¿ç»´ä»£ç å’Œ terraform ä¹‹é—´çš„äº¤äº’éš¾åº¦ã€‚
å¦å¤–æˆ‘ä»¬è¿˜å……åˆ†åˆ©ç”¨ä¸Šäº† Python çš„ç±»å‹æ£€æŸ¥å’Œè¯­æ³•æ£€æŸ¥ï¼Œå¾ˆå¤šé”™è¯¯ IDE éƒ½èƒ½ç›´æ¥ç»™å‡ºæç¤ºï¼Œå¼ºåŒ–äº†é…ç½®çš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<p>ä¸è¿‡ç”±äºé˜¿é‡Œäº‘ provider æš‚æ—¶è¿˜ï¼š</p>
<ol>
<li>ä¸æ”¯æŒç®¡ç† ASM æœåŠ¡ç½‘æ ¼ã€DTS æ•°æ®ä¼ è¾“ç­‰èµ„æº</li>
<li>OSS ç­‰äº§å“çš„éƒ¨åˆ†å‚æ•°ä¹Ÿæš‚æ—¶ä¸æ”¯æŒé…ç½®ï¼ˆæ¯”å¦‚ OSS ä¸æ”¯æŒé…ç½®å›¾ç‰‡æ ·å¼ã€ElasticSearch æš‚æ—¶ä¸æ”¯æŒè‡ªåŠ¨åˆ›å»º 7.x ç‰ˆæœ¬ï¼‰</li>
<li>ä¸æ”¯æŒåˆ›å»º ElasticSearch 7.x</li>
</ol>
<p>è¿™äº›é—®é¢˜ï¼Œå¯¼è‡´æˆ‘ä»¬ä»ç„¶æœ‰éƒ¨åˆ†é…ç½®éœ€è¦æ‰‹åŠ¨å¤„ç†ï¼Œå¦å¤–ä¸€äº›è€—æ—¶é•¿çš„èµ„æºï¼Œéœ€è¦å•ç‹¬å»åˆ›å»ºã€‚
å› æ­¤è¿˜ä¸èƒ½å®ç°å®Œå…¨çš„ã€Œä¸€é”®ã€ã€‚</p>
<h2 id="å¸¸è§é—®é¢˜">å¸¸è§é—®é¢˜</h2>
<h3 id="1-output-çš„ç”¨æ³•">1. <code>Output</code> çš„ç”¨æ³•</h3>
<ol>
<li>pulumi é€šè¿‡èµ„æºä¹‹é—´çš„å±æ€§å¼•ç”¨ï¼ˆ<code>Output[str]</code>ï¼‰æ¥ç¡®å®šä¾èµ–å…³ç³»ï¼Œå¦‚æœä½ é€šè¿‡è‡ªå®šä¹‰çš„å±æ€§(<code>str</code>)è§£è€¦äº†èµ„æºä¾èµ–ï¼Œä¼šå¯¼è‡´èµ„æºåˆ›å»ºé¡ºåºé”™è¯¯è€Œåˆ›å»ºå¤±è´¥ã€‚</li>
<li><code>Output[str]</code> æ˜¯ä¸€ä¸ªå¼‚æ­¥å±æ€§ï¼Œç±»ä¼¼ Futureï¼Œä¸èƒ½è¢«ç”¨åœ¨ pulumi å‚æ•°ä¹‹å¤–çš„åœ°æ–¹ï¼</li>
<li><code>Output[str]</code> æä¾›ä¸¤ç§æ–¹æ³•èƒ½ç›´æ¥å¯¹ <code>Output[str]</code> è¿›è¡Œä¸€äº›æ“ä½œï¼š
<ol>
<li><code>Output.concat(&quot;http://&quot;, domain, &quot;/&quot;, path)</code>: æ­¤æ–¹æ³•å°† str ä¸ <code>Output[str]</code> æ‹¼æ¥èµ·æ¥ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„ <code>Output[str]</code> å¯¹è±¡ï¼Œå¯ç”¨åš pulumi å±æ€§ã€‚</li>
<li><code>domain.apply(lambda it: print(it))</code>: <code>Output[str]</code> çš„ <code>apply</code> æ–¹æ³•æ¥æ”¶ä¸€ä¸ªå‡½æ•°ã€‚åœ¨å¼‚æ­¥è·å–åˆ°æ•°æ®åï¼Œpulumi ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼ŒæŠŠå…·ä½“çš„æ•°æ®ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚
<ul>
<li>å¦å¤– <code>apply</code> ä¹Ÿä¼šå°†ä¼ å…¥å‡½æ•°çš„è¿”å›å€¼åŒ…è£…æˆ <code>Output</code> ç±»å‹è¿”å›å‡ºæ¥ã€‚</li>
<li>å¯ç”¨äºï¼šåœ¨è·å–åˆ°æ•°æ®åï¼Œå°†æ•°æ®æ‰“å°å‡ºæ¥/å‘é€åˆ°é‚®ç®±/è°ƒç”¨æŸä¸ª API ä¸Šä¼ æ•°æ®ç­‰ç­‰ã€‚</li>
</ul>
</li>
<li><code>Output.all(output1, output2, ...).apply(lambda it: print(it))</code> å¯ç”¨äºå°†å¤šä¸ª <code>output</code> å€¼ï¼Œæ‹¼æ¥æˆä¸€ä¸ª <code>Output</code> ç±»å‹ï¼Œå…¶å†…éƒ¨çš„ raw å€¼ä¸ºä¸€ä¸ª tuple å¯¹è±¡ <code>(str1, str2, ...)</code>.
<ol>
<li>å®˜æ–¹ä¸¾ä¾‹ï¼š<code>connection_string = Output.all(sql_server.name, database.name).apply(lambda args: f&quot;Server=tcp:{args[0]}.database.windows.net;initial catalog={args[1]}...&quot;)</code></li>
</ol>
</li>
</ol>
</li>
</ol>
<h3 id="2-å¦‚ä½•ä½¿ç”¨å¤šä¸ªäº‘è´¦å·å¤šä¸ª-k8s-é›†ç¾¤">2. å¦‚ä½•ä½¿ç”¨å¤šä¸ªäº‘è´¦å·/å¤šä¸ª k8s é›†ç¾¤ï¼Ÿ</h3>
<p>é»˜è®¤æƒ…å†µä¸‹ pulumi ä½¿ç”¨é»˜è®¤çš„ providerï¼Œä½†æ˜¯ pulumi æ‰€æœ‰çš„èµ„æºéƒ½æœ‰ä¸€ä¸ªé¢å¤–çš„ <code>opts</code> å‚æ•°ï¼Œå¯ç”¨äºè®¾å®šå…¶ä»– providerã€‚</p>
<p>é€šè¿‡è¿™ä¸ª <code>opts</code>ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°åœ¨ä¸€ä¸ª pulumi é¡¹ç›®ä¸­ï¼Œä½¿ç”¨å¤šä¸ªäº‘è´¦å·ï¼Œæˆ–è€…ç®¡ç†å¤šä¸ª k8s é›†ç¾¤ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pulumi</span> <span class="kn">import</span> <span class="n">get_stack</span><span class="p">,</span> <span class="n">ResourceOptions</span><span class="p">,</span> <span class="n">StackReference</span>
<span class="kn">from</span> <span class="nn">pulumi_alicloud</span> <span class="kn">import</span> <span class="n">Provider</span><span class="p">,</span> <span class="n">oss</span>

<span class="c1"># è‡ªå®šä¹‰ providerï¼Œkey/secret é€šè¿‡å‚æ•°è®¾å®šï¼Œè€Œä¸æ˜¯ä»é»˜è®¤çš„ç¯å¢ƒå˜é‡è¯»å–ã€‚</span>
<span class="c1"># å¯ä»¥è‡ªå®šä¹‰å¾ˆå¤šä¸ª providers</span>
<span class="n">provider</span> <span class="o">=</span> <span class="n">pulumi_alicloud</span><span class="o">.</span><span class="n">Provider</span><span class="p">(</span>
   <span class="s2">&#34;custom-alicloud-provider&#34;</span><span class="p">,</span>
   <span class="n">region</span><span class="o">=</span><span class="s2">&#34;cn-hangzhou&#34;</span><span class="p">,</span>
   <span class="n">access_key</span><span class="o">=</span><span class="s2">&#34;xxx&#34;</span><span class="p">,</span>
   <span class="n">secret_key</span><span class="o">=</span><span class="s2">&#34;jjj&#34;</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># é€šè¿‡ optsï¼Œè®© pulumi ä½¿ç”¨è‡ªå®šä¹‰çš„ providerï¼ˆæ›¿æ¢æ‰é»˜è®¤çš„ï¼‰</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">oss</span><span class="o">.</span><span class="n">Bucket</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">ResourceOptions</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="3-inter-stack-å±æ€§ä¼ é€’">3. inter-stack å±æ€§ä¼ é€’</h3>
<blockquote>
<p>è¿™ä¸œè¥¿è¿˜æ²¡æé€ï¼Œå¾…ç ”ç©¶ã€‚</p>
</blockquote>
<p>å¤šä¸ª stack ä¹‹é—´è¦äº’ç›¸ä¼ é€’å‚æ•°ï¼Œéœ€è¦é€šè¿‡ <code>pulumi.export</code> å¯¼å‡ºå±æ€§ï¼Œé€šè¿‡ <code>stack.require_xxx</code> è·å–å±æ€§ã€‚</p>
<p>ä»å¦ä¸€ä¸ª stack è¯»å–å±æ€§çš„ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pulumi</span> <span class="kn">import</span> <span class="n">StackReference</span>

<span class="n">cfg</span> <span class="o">=</span> <span class="n">pulumi</span><span class="o">.</span><span class="n">Config</span><span class="p">()</span>
<span class="n">stack_name</span> <span class="o">=</span> <span class="n">pulumi</span><span class="o">.</span><span class="n">get_stack</span><span class="p">()</span>  <span class="c1"># stack åç§°</span>
<span class="n">project</span> <span class="o">=</span> <span class="n">pulumi</span><span class="o">.</span><span class="n">get_project</span><span class="p">()</span>
<span class="n">infra</span> <span class="o">=</span> <span class="n">StackReference</span><span class="p">(</span><span class="n">f</span><span class="s2">&#34;ryan4yin/{project}/{stack_name}&#34;</span><span class="p">)</span>

<span class="c1"># è¿™ä¸ªå±æ€§åœ¨ä¸Šä¸€ä¸ª stack ä¸­è¢« export å‡ºæ¥</span>
<span class="n">vpc_id</span> <span class="o">=</span> <span class="n">infra</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="s2">&#34;resources.vpc.id&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="4-pulumi-up-è¢«ä¸­æ–­æˆ–è€…å¯¹èµ„æºåšäº†æ‰‹åŠ¨ä¿®æ”¹ä¼šå‘ç”Ÿä»€ä¹ˆ">4. <code>pulumi up</code> è¢«ä¸­æ–­ï¼Œæˆ–è€…å¯¹èµ„æºåšäº†æ‰‹åŠ¨ä¿®æ”¹ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h3>
<ol>
<li>å¼ºè¡Œä¸­æ–­ <code>pulumi up</code>ï¼Œä¼šå¯¼è‡´èµ„æºè¿›å…¥ <code>pending</code> çŠ¶æ€ï¼Œå¿…é¡»æ‰‹åŠ¨ä¿®å¤ã€‚
<ol>
<li>ä¿®å¤æ–¹æ³•ï¼š<code>pulumi stack export</code>ï¼Œåˆ é™¤ pending èµ„æºï¼Œå† <code>pulumi stack import</code></li>
</ol>
</li>
<li>æ‰‹åŠ¨åˆ é™¤äº†äº‘ä¸Šèµ„æºï¼Œæˆ–è€…ä¿®æ”¹äº†ä¸€äº›å¯¹èµ„æºç®¡ç†æ— å½±å“çš„å‚æ•°ï¼Œå¯¹ <code>pulumi</code> æ²¡æœ‰å½±å“ï¼Œå®ƒèƒ½æ­£ç¡®æ£€æµ‹åˆ°è¿™ç§æƒ…å†µã€‚
<ol>
<li>å¯ä»¥é€šè¿‡ <code>pulumi refresh</code> æ‰‹åŠ¨ä»äº‘ä¸Šæ‹‰å–æœ€æ–°çš„èµ„æºçŠ¶æ€ã€‚</li>
</ol>
</li>
<li>æ‰‹åŠ¨æ›´æ”¹äº†èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ˆæ¯”å¦‚ç»‘å®š EIP ä¹‹ç±»çš„ï¼‰ï¼Œå¾ˆå¯èƒ½å¯¼è‡´ pulumi æ— æ³•æ­£ç¡®ç®¡ç†èµ„æºä¹‹é—´çš„ä¾èµ–ã€‚
<ul>
<li>è¿™ç§æƒ…å†µå¿…é¡»å…ˆæ‰‹åŠ¨è¿˜åŸä¾èµ–å…³ç³»ï¼ˆæˆ–è€…æŠŠç›¸å…³èµ„æºå…¨éƒ¨æ‰‹åŠ¨åˆ é™¤æ‰ï¼‰ï¼Œç„¶åæ‰èƒ½ç»§ç»­ä½¿ç”¨ pulumiã€‚</li>
</ul>
</li>
</ol>
<h3 id="5-å¦‚ä½•æ‰‹åŠ¨å£°æ˜èµ„æºé—´çš„ä¾èµ–å…³ç³»">5. å¦‚ä½•æ‰‹åŠ¨å£°æ˜èµ„æºé—´çš„ä¾èµ–å…³ç³»ï¼Ÿ</h3>
<p>æœ‰æ—¶å€™å› ä¸ºä¸€äº›é—®é¢˜ï¼ˆæ¯”å¦‚ pulumi provider åŠŸèƒ½ç¼ºå¤±ï¼Œä½¿ç”¨äº† restful api å®ç°éƒ¨åˆ†åŠŸèƒ½ï¼‰ï¼Œpulumi å¯èƒ½æ— æ³•è¯†åˆ«åˆ°æŸäº›èµ„æºä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p>
<p>è¿™æ—¶å¯ä»¥ä¸ºèµ„æºæ·»åŠ  <code>dependsOn</code> å±æ€§ï¼Œè¿™ä¸ªå±æ€§èƒ½æ˜¾å¼åœ°å£°æ˜ä¾èµ–å…³ç³»ã€‚</p>
<h3 id="6-å¦‚ä½•å¯¼å…¥å·²ç»å­˜åœ¨çš„èµ„æº">6. å¦‚ä½•å¯¼å…¥å·²ç»å­˜åœ¨çš„èµ„æºï¼Ÿ</h3>
<p>ç”±äºå†å²åŸå› ï¼Œæˆ‘ä»¬å¯èƒ½æœ‰éƒ¨åˆ†èµ„æºæ˜¯æ‰‹åŠ¨åˆ›å»ºæˆ–è€…ç”±å…¶ä»– IaC å·¥å…·ç®¡ç†çš„ï¼Œè¯¥å¦‚ä½•å°†å®ƒä»¬çº³å…¥ pulumi ç®¡è¾–å‘¢ï¼Ÿ</p>
<p>å®˜æ–¹æœ‰æä¾›ä¸€ç¯‡ç›¸å…³æ–‡æ¡£ <a href="https://www.pulumi.com/docs/guides/adopting/import/" target="_blank" rel="noopener noreferrer">Importing Infrastructure</a>.</p>
<p>æ–‡æ¡£æœ‰æåˆ°ä¸‰ç§èµ„æºå¯¼å…¥çš„æ–¹æ³•ï¼š</p>
<ol>
<li>ä½¿ç”¨ <code>pulumi import</code> å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤èƒ½å¯¼å…¥èµ„æºåŒæ—¶è‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„ä»£ç ã€‚
<ul>
<li>æ„Ÿè§‰è¿™ä¸ªå‘½ä»¤ä¹Ÿå¾ˆé€‚åˆç”¨æ¥åš<strong>èµ„æºçš„é…ç½®å¤‡ä»½</strong>ï¼Œä¸éœ€è¦å¯¹ç…§èµ„æºæ‰‹å†™ pulumi ä»£ç äº†ï¼Œå¥½è¯„ã€‚</li>
</ul>
</li>
<li>æ‰¹é‡å¯¼å…¥èµ„æºï¼šæ–‡æ¡£çš„ <code>Bulk Import Operations</code> è¿™ä¸€èŠ‚ä»‹ç»äº†å¦‚ä½•é€šè¿‡ json åˆ—å‡ºèµ„æºæ¸…å•ï¼Œç„¶åä½¿ç”¨ <code>pulumi import -f resources.json</code> è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰å¯¼å…¥èµ„æºçš„ pulumi ä»£ç ã€‚</li>
</ol>
<h3 id="5-pulumi-kubernetes">5. pulumi-kubernetesï¼Ÿ</h3>
<p>pulumi-kubernetes æ˜¯ä¸€æ¡é¾™æœåŠ¡ï¼š</p>
<ol>
<li>åœ¨ yaml é…ç½®ç”Ÿæˆè¿™ä¸€æ­¥ï¼Œå®ƒèƒ½ç»“åˆ/æ›¿ä»£æ‰ helm/kustomizeï¼Œæˆ–è€…ä½ é«˜åº¦è‡ªå®šä¹‰çš„ Python è„šæœ¬ã€‚</li>
<li>åœ¨ yaml éƒ¨ç½²è¿™ä¸€æ­¥ï¼Œå®ƒèƒ½æ›¿ä»£æ‰ argo-cd è¿™ç±» gitops å·¥å…·ã€‚</li>
<li>å¼ºå¤§çš„çŠ¶æ€ç®¡ç†ï¼Œargo-cd ä¹Ÿæœ‰çŠ¶æ€ç®¡ç†ï¼Œå¯ä»¥å¯¹æ¯”çœ‹çœ‹ã€‚</li>
</ol>
<p>ä¹Ÿå¯ä»¥ä»…é€šè¿‡ kubernetes_pulumi ç”Ÿæˆ yamlï¼Œå†é€šè¿‡ argo-cd éƒ¨ç½²ï¼Œè¿™æ · pulumi_kubernetes å°±ä»…ç”¨æ¥ç®€åŒ– yaml çš„ç¼–å†™ï¼Œä»ç„¶é€šè¿‡ gitops å·¥å…·/kubectl æ¥éƒ¨ç½²ã€‚</p>
<p>ä½¿ç”¨ pulumi-kubernetes å†™é…ç½®ï¼Œè¦è­¦æƒ•é€»è¾‘å’Œæ•°æ®çš„æ··åˆç¨‹åº¦ã€‚
å› ä¸º kubernetes çš„é…ç½®å¤æ‚åº¦æ¯”è¾ƒé«˜ï¼Œå¦‚æœåŠ¨æ€é…ç½®æ¯”è¾ƒå¤šï¼Œå¾ˆå®¹æ˜“å°±ä¼šå†™å‡ºéš¾ä»¥ç»´æŠ¤çš„ python ä»£ç æ¥ã€‚</p>
<p>æ¸²æŸ“ yaml çš„ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">pulumi</span> <span class="kn">import</span> <span class="n">get_stack</span><span class="p">,</span> <span class="n">ResourceOptions</span><span class="p">,</span> <span class="n">StackReference</span>
<span class="kn">from</span> <span class="nn">pulumi_kubernetes</span> <span class="kn">import</span> <span class="n">Provider</span>
<span class="kn">from</span> <span class="nn">pulumi_kubernetes.apps.v1</span> <span class="kn">import</span> <span class="n">Deployment</span><span class="p">,</span> <span class="n">DeploymentSpecArgs</span>
<span class="kn">from</span> <span class="nn">pulumi_kubernetes.core.v1</span> <span class="kn">import</span> <span class="p">(</span>
	<span class="n">ContainerArgs</span><span class="p">,</span>
	<span class="n">ContainerPortArgs</span><span class="p">,</span>
	<span class="n">EnvVarArgs</span><span class="p">,</span>
	<span class="n">PodSpecArgs</span><span class="p">,</span>
	<span class="n">PodTemplateSpecArgs</span><span class="p">,</span>
	<span class="n">ResourceRequirementsArgs</span><span class="p">,</span>
	<span class="n">Service</span><span class="p">,</span>
	<span class="n">ServicePortArgs</span><span class="p">,</span>
	<span class="n">ServiceSpecArgs</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pulumi_kubernetes.meta.v1</span> <span class="kn">import</span> <span class="n">LabelSelectorArgs</span><span class="p">,</span> <span class="n">ObjectMetaArgs</span>

<span class="n">provider</span> <span class="o">=</span> <span class="n">Provider</span><span class="p">(</span>
   <span class="s2">&#34;render-yaml&#34;</span><span class="p">,</span>
   <span class="n">render_yaml_to_directory</span><span class="o">=</span><span class="s2">&#34;rendered&#34;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">deployment</span> <span class="o">=</span> <span class="n">Deployment</span><span class="p">(</span>
	<span class="s2">&#34;redis&#34;</span><span class="p">,</span>
	<span class="n">spec</span><span class="o">=</span><span class="n">DeploymentSpecArgs</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
   <span class="n">opts</span><span class="o">=</span><span class="n">ResourceOptions</span><span class="p">(</span><span class="n">provider</span><span class="o">=</span><span class="n">provider</span><span class="p">),</span>
<span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚ç¤ºä¾‹æ‰€ç¤ºï¼Œpulumi-kubernetes çš„é…ç½®æ˜¯å®Œå…¨ç»“æ„åŒ–çš„ï¼Œæ¯” yaml/helm/kustomize è¦çµæ´»éå¸¸å¤šã€‚</p>
<p>æ€»ä¹‹å®ƒéå¸¸çµæ´»ï¼Œæ—¢å¯ä»¥å’Œ helm/kustomize ç»“åˆä½¿ç”¨ï¼Œæ›¿ä»£æ‰ argocd/kubectlã€‚
ä¹Ÿå¯ä»¥å’Œ argocd/kubectl ä½¿ç”¨ï¼Œæ›¿ä»£æ‰ helm/kustomizeã€‚</p>
<p>å…·ä½“æ€ä¹ˆä½¿ç”¨å¥½ï¼Ÿæˆ‘ä¹Ÿè¿˜åœ¨ç ”ç©¶ã€‚</p>
<h3 id="6-é˜¿é‡Œäº‘èµ„æº-replace-æŠ¥é”™">6. é˜¿é‡Œäº‘èµ„æº replace æŠ¥é”™ï¼Ÿ</h3>
<p>é˜¿é‡Œäº‘æœ‰éƒ¨åˆ†èµ„æºï¼Œåªèƒ½åˆ›å»ºåˆ é™¤ï¼Œä¸å…è®¸ä¿®æ”¹ï¼Œæ¯”å¦‚ã€Œèµ„æºç»„ã€ã€‚
å¯¹è¿™ç±»èµ„æºåšå˜æ›´æ—¶ï¼Œpulumi ä¼šç›´æ¥æŠ¥é”™ï¼šã€ŒResources aleardy existsã€ï¼Œ
è¿™ç±»èµ„æºï¼Œé€šå¸¸éƒ½æœ‰ä¸€ä¸ªã€Œforceã€å‚æ•°ï¼ŒæŒ‡ç¤ºæ˜¯å¦å¼ºåˆ¶ä¿®æ”¹â€”â€”å³å…ˆåˆ é™¤å†é‡å»ºã€‚</p>
<h3 id="7-æœ‰äº›èµ„æºå±æ€§æ— æ³•ä½¿ç”¨-pulumi-é…ç½®">7. æœ‰äº›èµ„æºå±æ€§æ— æ³•ä½¿ç”¨ pulumi é…ç½®ï¼Ÿ</h3>
<p>è¿™å¾—çœ‹å„äº‘æœåŠ¡æä¾›å•†çš„æ”¯æŒæƒ…å†µã€‚</p>
<p>æ¯”å¦‚é˜¿é‡Œäº‘å¾ˆå¤šèµ„æºçš„å±æ€§ï¼Œpulumi éƒ½æ— æ³•å®Œå…¨é…ç½®ï¼Œå› ä¸º alicloud provider çš„åŠŸèƒ½è¿˜ä¸å¤Ÿå…¨é¢ã€‚</p>
<p>ç›®å‰æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒï¼Œå¤§æ¦‚ 95%+ çš„ä¸œè¥¿ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ pulumi å®ç°è‡ªåŠ¨åŒ–é…ç½®ã€‚
è€Œå…¶ä»– OSS çš„é«˜çº§å‚æ•°ã€æ–°å‡ºçš„ ASM æœåŠ¡ç½‘æ ¼ã€kubernetes çš„æˆæƒç®¡ç†ã€ElasticSearch7 ç­‰èµ„æºï¼Œè¿˜æ˜¯éœ€è¦æ‰‹åŠ¨é…ç½®ã€‚</p>
<p>è¿™ä¸ªæ²¡åŠæ³•ï¼Œåªèƒ½ç­‰é˜¿é‡Œäº‘æä¾›æ”¯æŒã€‚</p>
<h3 id="8-cicd-ä¸­å¦‚ä½•ä½¿-pulumi-å°†çŠ¶æ€ä¿å­˜åˆ°æ–‡ä»¶">8. CI/CD ä¸­å¦‚ä½•ä½¿ pulumi å°†çŠ¶æ€ä¿å­˜åˆ°æ–‡ä»¶ï¼Ÿ</h3>
<p>CI/CD ä¸­æˆ‘ä»¬å¯èƒ½ä¼šå¸Œæœ› pulumi å°†çŠ¶æ€ä¿å­˜åˆ°æœ¬åœ°ï¼Œé¿å…è¿æ¥ pulumi ä¸­å¿ƒæœåŠ¡å™¨ã€‚
è¿™ä¸€æ–¹é¢èƒ½åŠ å¿«é€Ÿåº¦ï¼Œå¦ä¸€æ–¹é¢ä¸€äº›ä¸´æ—¶çŠ¶æ€æˆ‘ä»¬å¯èƒ½æ ¹æœ¬ä¸æƒ³å­˜å‚¨ï¼Œå¯ä»¥ç›´æ¥ä¸¢å¼ƒã€‚</p>
<p>æ–¹æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># æŒ‡å®šçŠ¶æ€æ–‡ä»¶è·¯å¾„</span>
pulumi login file://&lt;file-path&gt;
<span class="c1"># ä¿å­˜åˆ°é»˜è®¤ä½ç½®: ~/.pulumi/credentials.json</span>
pulumi login --local

<span class="c1"># ä¿å­˜åˆ°è¿œç¨‹ S3 å­˜å‚¨ï¼ˆminio/ceph æˆ–è€…å„ç±»äº‘å¯¹è±¡å­˜å‚¨æœåŠ¡ï¼Œéƒ½å…¼å®¹ aws çš„ s3 åè®®ï¼‰</span>
pulumi login s3://&lt;bucket-path&gt;
</code></pre></td></tr></table>
</div>
</div><p>ç™»å½•å®Œæˆåï¼Œå†è¿›è¡Œ <code>pulumi up</code> æ“ä½œï¼Œæ•°æ®å°±ä¼šç›´æ¥ä¿å­˜åˆ°ä½ è®¾å®šçš„è·¯å¾„ä¸‹ã€‚</p>
<h2 id="ç¼ºç‚¹">ç¼ºç‚¹</h2>
<h3 id="1-æŠ¥é”™ä¿¡æ¯ä¸ç›´è§‚">1. æŠ¥é”™ä¿¡æ¯ä¸ç›´è§‚</h3>
<p>pulumi å’Œ terraform éƒ½æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯å°è£…å±‚æ¬¡å¤ªé«˜äº†ã€‚</p>
<p>å°è£…çš„å±‚æ¬¡å¾ˆé«˜ï¼Œä¼˜ç‚¹æ˜¯æ–¹ä¾¿äº†æˆ‘ä»¬ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨å¾ˆç»Ÿä¸€å¾ˆç®€æ´çš„å£°æ˜å¼è¯­æ³•ç¼–å†™é…ç½®ã€‚
è€Œç¼ºç‚¹ï¼Œåˆ™æ˜¯å‡ºäº† bugï¼ŒæŠ¥é”™ä¿¡æ¯å¾€å¾€ä¸å¤Ÿç›´è§‚ï¼Œå¯¼è‡´é—®é¢˜ä¸å¥½æ’æŸ¥ã€‚</p>
<h3 id="2-èµ„æºçŠ¶æ€è¢«ç ´åæ—¶ä¿®å¤èµ·æ¥éå¸¸éº»çƒ¦">2. èµ„æºçŠ¶æ€è¢«ç ´åæ—¶ï¼Œä¿®å¤èµ·æ¥éå¸¸éº»çƒ¦</h3>
<p>åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œéƒ½å¯èƒ½å‘ç”Ÿèµ„æºçŠ¶æ€è¢«ç ´åçš„é—®é¢˜ï¼š</p>
<ol>
<li>åœ¨åˆ›å»ºèµ„æº Aï¼Œå› ä¸ºå‚æ•°æ˜¯å·²çŸ¥çš„ï¼Œä½ ç›´æ¥ä½¿ç”¨äº†å¸¸é‡è€Œä¸æ˜¯ <code>Output</code>ã€‚è¿™ä¼šå¯¼è‡´ pulumi æ— æ³•è¯†åˆ«åˆ°ä¾èµ–å…³ç³»ï¼ä»è€Œåˆ›å»ºå¤±è´¥ï¼Œæˆ–è€…åˆ é™¤æ—¶èµ„æºçŠ¶æ€è¢«ç ´åï¼</li>
<li>æœ‰ä¸€ä¸ª pulumi stack ä¸€æ¬¡åœ¨ä¸‰å°ç‰©ç†æœºä¸Šåˆ›å»ºèµ„æºã€‚ä½ ç™½å¤©åˆ›å»ºèµ„æºæ™šä¸Šåˆ é™¤èµ„æºï¼Œä½†æ˜¯æŸä¸€å°ç‰©ç†æœºæ™šä¸Šä¼šå…³æœºã€‚è¿™å°†å¯¼è‡´ pulumi æ— æ³•æŸ¥è¯¢åˆ°è¿™å°ç‰©ç†æœºä¸Šçš„èµ„æºçŠ¶æ€ï¼Œè¿™ä¸ª pulumi stack åœ¨æ™šä¸Šå°±æ— æ³•ä½¿ç”¨ï¼Œå®ƒä¼šä¸€ç›´æŠ¥é”™ï¼</li>
</ol>
<h2 id="å¸¸ç”¨-provider">å¸¸ç”¨ Provider</h2>
<ul>
<li><a href="https://github.com/pulumi/pulumi-alicloud" target="_blank" rel="noopener noreferrer">pulumi-alicloud</a>: ç®¡ç†é˜¿é‡Œäº‘èµ„æº</li>
<li><a href="https://github.com/pulumi/pulumi-vault" target="_blank" rel="noopener noreferrer">pulumi-vault</a>: æˆ‘è¿™è¾¹ç”¨å®ƒæ¥å¿«é€Ÿåˆå§‹åŒ– vaultï¼Œåˆ›å»ºä¸ç®¡ç† vault çš„æ‰€æœ‰é…ç½®ã€‚</li>
</ul>
<h2 id="æˆ‘åˆ›å»ºç»´æŠ¤çš„-provider">æˆ‘åˆ›å»ºç»´æŠ¤çš„ Provider</h2>
<p>ç”±äº Pulumi ç”Ÿæ€è¿˜æ¯”è¾ƒå°ï¼Œæœ‰äº› provider åªæœ‰ terraform æ‰æœ‰ã€‚</p>
<p>æˆ‘ä¸ºäº†é€ (æ–¹)ç¦(ä¾¿)å¤§(è‡ª)ä¼—(å·±)ï¼Œåˆ›å»ºå¹¶ç»´æŠ¤äº†ä¸¤ä¸ªæœ¬åœ°è™šæ‹Ÿæœºç›¸å…³çš„ Providers:</p>
<ul>
<li><a href="https://github.com/ryan4yin/pulumi-proxmox" target="_blank" rel="noopener noreferrer">ryan4yin/pulumi-proxmox</a>: ç›®å‰åªç”¨æ¥è‡ªåŠ¨åˆ›å»º PVE è™šæ‹Ÿæœº
<ul>
<li>å¯ä»¥è€ƒè™‘ç»“åˆ kubespray/kubeadm å¿«é€Ÿåˆ›å»º k8s é›†ç¾¤</li>
</ul>
</li>
<li><a href="https://github.com/ryan4yin/pulumi-libvirt" target="_blank" rel="noopener noreferrer">ryan4yin/pulumi-libvirt</a>: å¿«é€Ÿåˆ›å»º kvm è™šæ‹Ÿæœº
<ul>
<li>å¯ä»¥è€ƒè™‘ç»“åˆ kubespray/kubeadm å¿«é€Ÿåˆ›å»º k8s é›†ç¾¤</li>
</ul>
</li>
</ul>]]></description></item></channel></rss>