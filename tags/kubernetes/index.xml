<rss xmlns:atom="http://www.w3.org/2005/Atom" xmlns:dc="http://purl.org/dc/elements/1.1/" version="2.0"><channel><title>Kubernetes - æ ‡ç­¾ - Ryan4Yin's Space</title><link>https://ryan4yin.space/tags/kubernetes/</link><description>Kubernetes - æ ‡ç­¾ - Ryan4Yin's Space</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><managingEditor>xiaoyin_c@qq.com (ryan4yin)</managingEditor><webMaster>xiaoyin_c@qq.com (ryan4yin)</webMaster><lastBuildDate>Tue, 25 Jan 2022 01:37:00 +0800</lastBuildDate><atom:link href="https://ryan4yin.space/tags/kubernetes/" rel="self" type="application/rss+xml"/><item><title>éƒ¨ç½²ä¸€ä¸ª Kubernetes é›†ç¾¤</title><link>https://ryan4yin.space/posts/kubernetes-deployemnt-using-kubeadm/</link><pubDate>Tue, 25 Jan 2022 01:37:00 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/kubernetes-deployemnt-using-kubeadm/</guid><description><![CDATA[<blockquote>
<p>æœ¬æ–‡ç”±ä¸ªäººç¬”è®° <a href="https://github.com/ryan4yin/knowledge/tree/master/kubernetes" target="_blank" rel="noopener noreferrer">ryan4yin/knowledge</a> æ•´ç†è€Œæ¥ï¼Œä¸ä¿è¯æ­£ç¡®</p>
</blockquote>
<h2 id="æœ¬åœ°-kubernetes-é›†ç¾¤å®‰è£…å·¥å…·">æœ¬åœ° Kubernetes é›†ç¾¤å®‰è£…å·¥å…·</h2>
<blockquote>
<p>äº‘ä¸Šçš„ Kubernetes é›†ç¾¤ï¼ŒåŸºæœ¬ä¸Šå„äº‘å‚å•†éƒ½æ”¯æŒä¸€é”®éƒ¨ç½²ã€‚è¿™é‡Œä¸»è¦å…³æ³¨æœ¬åœ°éƒ¨ç½²ï¼Œæˆ–è€…å«åšè£¸æœº(baremetal)éƒ¨ç½²</p>
</blockquote>
<blockquote>
<p>æœ¬æ–‡ä»‹ç»çš„æ–¹æ³•é€‚åˆå¼€å‘æµ‹è¯•ä½¿ç”¨ï¼Œå®‰å…¨æ€§ã€ç¨³å®šæ€§ã€é•¿æœŸå¯ç”¨æ€§ç­‰æ–¹æ¡ˆéƒ½å¯èƒ½è¿˜æœ‰é—®é¢˜ã€‚</p>
</blockquote>
<blockquote>
<p>æœ¬æ–‡æœªè€ƒè™‘å›½å†…ç½‘ç»œç¯å¢ƒï¼Œå»ºè®®åœ¨è·¯ç”±å™¨ä¸Šæ•´ä¸ªç§‘å­¦ä»£ç†ï¼Œæˆ–è€…è‡ªè¡Œè°ƒæ•´æ–‡ä¸­çš„éƒ¨åˆ†å‘½ä»¤ã€‚</p>
</blockquote>
<p>kubernetes æ˜¯ä¸€ä¸ªç»„ä»¶åŒ–çš„ç³»ç»Ÿï¼Œå®‰è£…è¿‡ç¨‹æœ‰å¾ˆå¤§çš„çµæ´»æ€§ï¼Œå¾ˆå¤šç»„ä»¶éƒ½æœ‰å¤šç§å®ç°ï¼Œè¿™äº›å®ç°å„æœ‰ç‰¹ç‚¹ï¼Œè®©åˆå­¦è€…çœ¼èŠ±ç¼­ä¹±ã€‚</p>
<p>è€Œä¸”è¦æŠŠè¿™äº›ç»„ä»¶ä¸€ä¸ªä¸ªå®‰è£…é…ç½®å¥½å¹¶ä¸”èƒ½ååŒå·¥ä½œï¼Œä¹Ÿæ˜¯å¾ˆä¸å®¹æ˜“çš„ã€‚</p>
<p>å› æ­¤ç¤¾åŒºå‡ºç°äº†å„ç§å„æ ·çš„å®‰è£…æ–¹æ¡ˆï¼Œä¸‹é¢ä»‹ç»ä¸‹å‡ ç§æ”¯æŒè£¸æœºï¼ˆBaremetalï¼‰éƒ¨ç½²çš„å·¥å…·ï¼š</p>
<ol>
<li><a href="https://kuboard.cn/install/install-k8s.html" target="_blank" rel="noopener noreferrer">kubeadm</a>: ç¤¾åŒºçš„é›†ç¾¤å®‰è£…å·¥å…·ï¼Œç›®å‰å·²ç»å¾ˆæˆç†Ÿäº†ã€‚
<ol>
<li>ä½¿ç”¨éš¾åº¦ï¼šç®€å•</li>
</ol>
</li>
<li><a href="https://github.com/k3s-io/k3s" target="_blank" rel="noopener noreferrer">k3s</a>: è½»é‡çº§ kubernetesï¼Œèµ„æºéœ€æ±‚å°ï¼Œéƒ¨ç½²éå¸¸ç®€å•ï¼Œé€‚åˆå¼€å‘æµ‹è¯•ç”¨æˆ–è€…è¾¹ç¼˜ç¯å¢ƒ
<ol>
<li>æ”¯æŒ airgap ç¦»çº¿éƒ¨ç½²</li>
<li>ä½¿ç”¨éš¾åº¦ï¼šè¶…çº§ç®€å•</li>
</ol>
</li>
<li><a href="https://github.com/alibaba/sealer" target="_blank" rel="noopener noreferrer">alibaba/sealer</a>: æ”¯æŒå°†æ•´ä¸ª kubernetes æ‰“åŒ…æˆä¸€ä¸ªé•œåƒè¿›è¡Œäº¤ä»˜ï¼Œè€Œä¸”éƒ¨ç½²ä¹Ÿéå¸¸ç®€å•ã€‚
<ol>
<li>ä½¿ç”¨éš¾åº¦ï¼šè¶…çº§ç®€å•</li>
<li>è¿™ä¸ªé¡¹ç›®ç›®å‰è¿˜åœ¨å‘å±•ä¸­ï¼Œä¸è¿‡è²Œä¼¼å·²ç»æœ‰å¾ˆå¤š toB çš„å…¬å¸åœ¨ä½¿ç”¨å®ƒè¿›è¡Œ k8s åº”ç”¨çš„äº¤ä»˜äº†ã€‚</li>
</ol>
</li>
<li><a href="https://github.com/kubernetes-sigs/kubespray" target="_blank" rel="noopener noreferrer">kubespray</a>: é€‚åˆè‡ªå»ºç”Ÿäº§çº§åˆ«çš„é›†ç¾¤ï¼Œæ˜¯ä¸€ä¸ªå¤§è€Œå…¨çš„ kubernetes å®‰è£…æ–¹æ¡ˆï¼Œè‡ªåŠ¨å®‰è£…å®¹å™¨è¿è¡Œæ—¶ã€k8sã€ç½‘ç»œæ’ä»¶ç­‰ç»„ä»¶ï¼Œè€Œä¸”å„ç»„ä»¶éƒ½æœ‰å¾ˆå¤šæ–¹æ¡ˆå¯é€‰ï¼Œä½†æ˜¯æ„Ÿè§‰æœ‰ç‚¹å¤æ‚ã€‚
<ol>
<li>ä½¿ç”¨éš¾åº¦ï¼šä¸­ç­‰</li>
<li>æ”¯æŒ airgap ç¦»çº¿éƒ¨ç½²ï¼Œä½†æ˜¯ä»¥å‰æˆ‘è¯•ç”¨è¿‡æ˜¯æœ‰å‘ï¼Œç°åœ¨ä¸çŸ¥é“å’‹æ ·äº†</li>
<li>åº•å±‚ä½¿ç”¨äº† kubeadm éƒ¨ç½²é›†ç¾¤</li>
</ol>
</li>
</ol>
<p>ç¬”è€…ä¸ºäº†å­¦ä¹  Kuberntesï¼Œä¸‹é¢é‡‡ç”¨å®˜æ–¹çš„ kubeadm è¿›è¡Œéƒ¨ç½²ï¼ˆä¸è¦é—®ä¸ºå•¥ä¸äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œé—®å°±æ˜¯æ‡’ï¼‰ï¼Œå®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ containerdï¼Œç½‘ç»œæ’ä»¶åˆ™ä½¿ç”¨ç›®å‰æœ€æ½®çš„åŸºäº eBPF çš„ Cilium.</p>
<p>kubernetes å®˜æ–¹ä»‹ç»äº†ä¸¤ç§é«˜å¯ç”¨é›†ç¾¤çš„æ‹“æ‰‘ç»“æ„ï¼šã€ŒStacked etcd topologyã€å’Œã€ŒExternal etcd topologyã€ï¼Œç®€å•èµ·è§ï¼Œæœ¬æ–‡ä½¿ç”¨ç¬¬ä¸€ç§ã€Œå †å  Etcd æ‹“æ‰‘ã€ç»“æ„ï¼Œåˆ›å»ºä¸€ä¸ªä¸‰ master çš„é«˜å¯ç”¨é›†ç¾¤ã€‚</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noopener noreferrer">Kubernetes Docs - Installing kubeadm</a></li>
<li><a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/high-availability/" target="_blank" rel="noopener noreferrer">Kubernetes Docs - Creating Highly Available clusters with kubeadm</a></li>
</ul>
<h2 id="1-èŠ‚ç‚¹çš„ç¯å¢ƒå‡†å¤‡">1. èŠ‚ç‚¹çš„ç¯å¢ƒå‡†å¤‡</h2>
<p>é¦–å…ˆå‡†å¤‡ä¸‰å° Linux è™šæ‹Ÿæœºï¼Œç³»ç»ŸæŒ‰éœ€é€‰æ‹©ï¼Œç„¶åè°ƒæ•´è¿™ä¸‰å°æœºå™¨çš„è®¾ç½®ï¼š</p>
<ul>
<li>èŠ‚ç‚¹é…ç½®ï¼š
<ul>
<li>masterï¼šä¸ä½äº 2c/3gï¼Œç¡¬ç›˜ 20G
<ul>
<li>ä¸»èŠ‚ç‚¹æ€§èƒ½ä¹Ÿå—é›†ç¾¤ Pods ä¸ªæ•°çš„å½±å“ï¼Œä¸Šè¿°é…ç½®åº”è¯¥å¯ä»¥æ”¯æ’‘åˆ°æ¯ä¸ª Worker èŠ‚ç‚¹è·‘ 100 ä¸ª Pod.</li>
</ul>
</li>
<li>workerï¼šçœ‹éœ€æ±‚ï¼Œå»ºè®®ä¸ä½äº 2c/4gï¼Œç¡¬ç›˜ä¸å°äº 20Gï¼Œèµ„æºå……åˆ†çš„è¯å»ºè®® 40G.</li>
</ul>
</li>
<li>å¤„äºåŒä¸€ç½‘ç»œå†…å¹¶å¯äº’é€šï¼ˆé€šå¸¸æ˜¯åŒä¸€å±€åŸŸç½‘ï¼‰</li>
<li>å„ä¸»æœºçš„ hostname å’Œ mac/ip åœ°å€ä»¥åŠ <code>/sys/class/dmi/id/product_uuid</code>ï¼Œéƒ½å¿…é¡»å”¯ä¸€
<ul>
<li>è¿™é‡Œæœ€å®¹æ˜“å‡ºé—®é¢˜çš„ï¼Œé€šå¸¸æ˜¯ hostname å†²çªï¼</li>
</ul>
</li>
<li><strong>å¿…é¡»</strong>å…³é—­ swapï¼Œkubelet æ‰èƒ½æ­£å¸¸å·¥ä½œï¼</li>
</ul>
<p>æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ç›´æ¥ä½¿ç”¨ <a href="https://github.com/ryan4yin/pulumi-libvirt#examples" target="_blank" rel="noopener noreferrer">ryan4yin/pulumi-libvirt</a> è‡ªåŠ¨åˆ›å»ºäº†äº”ä¸ªè™šæ‹Ÿæœºï¼Œå¹¶è®¾ç½®å¥½äº† ip/hostname.</p>
<p>æœ¬æ–‡ä½¿ç”¨äº† opensuse leap 15.3 çš„ KVM cloud image è¿›è¡Œå®‰è£…æµ‹è¯•ã€‚</p>
<h3 id="11-iptables-è®¾ç½®">1.1 iptables è®¾ç½®</h3>
<p>ç›®å‰ kubernetes çš„å®¹å™¨ç½‘ç»œï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ bridge æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼ä¸‹ï¼Œéœ€è¦ä½¿ <code>iptables</code> èƒ½å¤Ÿæ¥ç®¡ bridge ä¸Šçš„æµé‡ã€‚</p>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo modprobe br_netfilter
cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf
</span><span class="s">br_netfilter
</span><span class="s">EOF</span>

cat <span class="s">&lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf
</span><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span><span class="s">net.bridge.bridge-nf-call-iptables = 1
</span><span class="s">EOF</span>
sudo sysctl --system
</code></pre></td></tr></table>
</div>
</div><h3 id="12-å¼€æ”¾èŠ‚ç‚¹ç«¯å£">1.2 å¼€æ”¾èŠ‚ç‚¹ç«¯å£</h3>
<blockquote>
<p>å±€åŸŸç½‘ç¯å¢ƒçš„è¯ï¼Œå»ºè®®ç›´æ¥å…³é—­é˜²ç«å¢™ã€‚è¿™æ ·æ‰€æœ‰ç«¯å£éƒ½å¯ç”¨ï¼Œæ–¹ä¾¿å¿«æ·ã€‚</p>
</blockquote>
<blockquote>
<p>é€šå¸¸æˆ‘ä»¬çš„äº‘ä¸Šé›†ç¾¤ï¼Œä¹Ÿæ˜¯å…³é—­é˜²ç«å¢™çš„ï¼Œåªæ˜¯ä¼šé€šè¿‡äº‘æœåŠ¡æä¾›çš„ã€Œå®‰å…¨ç»„ã€æ¥é™åˆ¶å®¢æˆ·ç«¯ ip</p>
</blockquote>
<p>Control-plane èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ masterï¼Œéœ€è¦å¼€æ”¾å¦‚ä¸‹ç«¯å£ï¼š</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>6443*</td>
<td>Kubernetes API server</td>
<td>All</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>2379-2380</td>
<td>etcd server client API</td>
<td>kube-apiserver, etcd</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10251</td>
<td>kube-scheduler</td>
<td>Self</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10252</td>
<td>kube-controller-manager</td>
<td>Self</td>
</tr>
</tbody>
</table>
<p>Worker èŠ‚ç‚¹éœ€è¦å¼€å‘å¦‚ä¸‹ç«¯å£ï¼š</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Direction</th>
<th>Port Range</th>
<th>Purpose</th>
<th>Used By</th>
</tr>
</thead>
<tbody>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>10250</td>
<td>kubelet API</td>
<td>Self, Control plane</td>
</tr>
<tr>
<td>TCP</td>
<td>Inbound</td>
<td>30000-32767</td>
<td>NodePort Servicesâ€ </td>
<td>All</td>
</tr>
</tbody>
</table>
<p>å¦å¤–é€šå¸¸æˆ‘ä»¬æœ¬åœ°æµ‹è¯•çš„æ—¶å€™ï¼Œå¯èƒ½æ›´æƒ³ç›´æ¥åœ¨ <code>80</code> <code>443</code> <code>8080</code> ç­‰ç«¯å£ä¸Šä½¿ç”¨ <code>NodePort</code>ï¼Œ
å°±éœ€è¦ä¿®æ”¹ kube-apiserver çš„ <code>--service-node-port-range</code> å‚æ•°æ¥è‡ªå®šä¹‰ NodePort çš„ç«¯å£èŒƒå›´ï¼Œç›¸åº”çš„ Worker èŠ‚ç‚¹ä¹Ÿå¾—å¼€æ”¾è¿™äº›ç«¯å£ã€‚</p>
<h2 id="2-å®‰è£…-containerd">2. å®‰è£… containerd</h2>
<p>é¦–å…ˆæ˜¯ç¯å¢ƒé…ç½®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf
</span><span class="s">overlay
</span><span class="s">br_netfilter
</span><span class="s">nf_conntrack
</span><span class="s">EOF</span>

sudo modprobe overlay
sudo modprobe br_netfilter
sudo modprobe nf_conntrack

<span class="c1"># Setup required sysctl params, these persist across reboots.</span>
cat <span class="s">&lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
</span><span class="s">net.bridge.bridge-nf-call-iptables  = 1
</span><span class="s">net.ipv4.ip_forward                 = 1
</span><span class="s">net.bridge.bridge-nf-call-ip6tables = 1
</span><span class="s">EOF</span>

<span class="c1"># Apply sysctl params without reboot</span>
sudo sysctl --system
</code></pre></td></tr></table>
</div>
</div><p>å®‰è£… containerd+nerdctl:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">wget https://github.com/containerd/nerdctl/releases/download/v0.11.1/nerdctl-full-0.11.1-linux-amd64.tar.gz
tar -axvf nerdctl-full-0.11.1-linux-amd64.tar.gz
<span class="c1"># è¿™é‡Œç®€å•èµ·è§ï¼Œrootless ç›¸å…³çš„ä¸œè¥¿ä¹Ÿä¸€èµ·è£…è¿›å»äº†ï¼Œæµ‹è¯•å˜›å°±æ— æ‰€è°“äº†...</span>
mv bin/* /usr/local/bin/
mv lib/systemd/system/containerd.service /usr/lib/systemd/system/

systemctl <span class="nb">enable</span> containerd
systemctl start containerd
</code></pre></td></tr></table>
</div>
</div><p><code>nerdctl</code> æ˜¯ä¸€ä¸ª containerd çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œä½†æ˜¯å®ƒçš„å®¹å™¨ã€é•œåƒä¸ Kubernetes çš„å®¹å™¨ã€é•œåƒæ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œä¸èƒ½äº’é€šï¼</p>
<p>ç›®å‰åªèƒ½é€šè¿‡ <code>crictl</code> æ¥æŸ¥çœ‹ã€æ‹‰å– Kubernetes çš„å®¹å™¨ã€é•œåƒï¼Œä¸‹ä¸€èŠ‚ä¼šä»‹ç» crictl çš„å®‰è£…ã€‚</p>
<h2 id="3-å®‰è£…-kubeletkubeadmkubectl">3. å®‰è£… kubelet/kubeadm/kubectl</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ä¸€äº›å…¨å±€éƒ½éœ€è¦ç”¨çš„å˜é‡</span>
<span class="nv">CNI_VERSION</span><span class="o">=</span><span class="s2">&#34;v0.8.2&#34;</span>
<span class="nv">CRICTL_VERSION</span><span class="o">=</span><span class="s2">&#34;v1.17.0&#34;</span>
<span class="c1"># kubernetes çš„ç‰ˆæœ¬å·</span>
<span class="c1"># RELEASE=&#34;$(curl -sSL https://dl.k8s.io/release/stable.txt)&#34;</span>
<span class="nv">RELEASE</span><span class="o">=</span><span class="s2">&#34;1.22.1&#34;</span>
<span class="c1"># kubelet é…ç½®æ–‡ä»¶çš„ç‰ˆæœ¬å·</span>
<span class="nv">RELEASE_VERSION</span><span class="o">=</span><span class="s2">&#34;v0.4.0&#34;</span>
<span class="c1"># æ¶æ„</span>
<span class="nv">ARCH</span><span class="o">=</span><span class="s2">&#34;amd64&#34;</span>
<span class="c1">#ã€€å®‰è£…ç›®å½•</span>
<span class="nv">DOWNLOAD_DIR</span><span class="o">=</span>/usr/local/bin


<span class="c1"># CNI æ’ä»¶</span>
sudo mkdir -p /opt/cni/bin
curl -L <span class="s2">&#34;https://github.com/containernetworking/plugins/releases/download/</span><span class="si">${</span><span class="nv">CNI_VERSION</span><span class="si">}</span><span class="s2">/cni-plugins-linux-</span><span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span><span class="s2">-</span><span class="si">${</span><span class="nv">CNI_VERSION</span><span class="si">}</span><span class="s2">.tgz&#34;</span> <span class="p">|</span> sudo tar -C /opt/cni/bin -xz

<span class="c1"># crictl ç›¸å…³å·¥å…·</span>
curl -L <span class="s2">&#34;https://github.com/kubernetes-sigs/cri-tools/releases/download/</span><span class="si">${</span><span class="nv">CRICTL_VERSION</span><span class="si">}</span><span class="s2">/crictl-</span><span class="si">${</span><span class="nv">CRICTL_VERSION</span><span class="si">}</span><span class="s2">-linux-</span><span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span><span class="s2">.tar.gz&#34;</span> <span class="p">|</span> sudo tar -C <span class="nv">$DOWNLOAD_DIR</span> -xz

<span class="c1"># kubelet/kubeadm/kubectl</span>
<span class="nb">cd</span> <span class="nv">$DOWNLOAD_DIR</span>
sudo curl -L --remote-name-all https://storage.googleapis.com/kubernetes-release/release/<span class="si">${</span><span class="nv">RELEASE</span><span class="si">}</span>/bin/linux/<span class="si">${</span><span class="nv">ARCH</span><span class="si">}</span>/<span class="o">{</span>kubeadm,kubelet,kubectl<span class="o">}</span>
sudo chmod +x <span class="o">{</span>kubeadm,kubelet,kubectl<span class="o">}</span>

<span class="c1"># kubelet/kubeadm é…ç½®</span>
curl -sSL <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes/release/</span><span class="si">${</span><span class="nv">RELEASE_VERSION</span><span class="si">}</span><span class="s2">/cmd/kubepkg/templates/latest/deb/kubelet/lib/systemd/system/kubelet.service&#34;</span> <span class="p">|</span> sed <span class="s2">&#34;s:/usr/bin:</span><span class="si">${</span><span class="nv">DOWNLOAD_DIR</span><span class="si">}</span><span class="s2">:g&#34;</span> <span class="p">|</span> sudo tee /etc/systemd/system/kubelet.service
sudo mkdir -p /etc/systemd/system/kubelet.service.d
curl -sSL <span class="s2">&#34;https://raw.githubusercontent.com/kubernetes/release/</span><span class="si">${</span><span class="nv">RELEASE_VERSION</span><span class="si">}</span><span class="s2">/cmd/kubepkg/templates/latest/deb/kubeadm/10-kubeadm.conf&#34;</span> <span class="p">|</span> sed <span class="s2">&#34;s:/usr/bin:</span><span class="si">${</span><span class="nv">DOWNLOAD_DIR</span><span class="si">}</span><span class="s2">:g&#34;</span> <span class="p">|</span> sudo tee /etc/systemd/system/kubelet.service.d/10-kubeadm.conf

systemctl <span class="nb">enable</span> --now kubelet
<span class="c1"># éªŒè¯ kubelet å¯åŠ¨èµ·æ¥äº†ï¼Œä½†æ˜¯ç›®å‰è¿˜æ²¡æœ‰åˆå§‹åŒ–é…ç½®ï¼Œè¿‡ä¸€é˜µå°±ä¼šé‡å¯ä¸€æ¬¡</span>
systemctl status kubelet
</code></pre></td></tr></table>
</div>
</div><p>è¯•ç”¨ crictl:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="nb">export</span> <span class="nv">CONTAINER_RUNTIME_ENDPOINT</span><span class="o">=</span><span class="s1">&#39;unix:///var/run/containerd/containerd.sock&#39;</span>
<span class="c1"># åˆ—å‡ºæ‰€æœ‰ podsï¼Œç°åœ¨åº”è¯¥å•¥ä¹Ÿæ²¡</span>
crictl  pods

<span class="c1"># åˆ—å‡ºæ‰€æœ‰é•œåƒ</span>
crictl images
</code></pre></td></tr></table>
</div>
</div><h2 id="4-ä¸º-master-çš„-kube-apiserver-åˆ›å»ºè´Ÿè½½å‡è¡¡å®ç°é«˜å¯ç”¨">4. ä¸º master çš„ kube-apiserver åˆ›å»ºè´Ÿè½½å‡è¡¡å®ç°é«˜å¯ç”¨</h2>
<p>æ ¹æ® kubeadm å®˜æ–¹æ–‡æ¡£ <a href="https://github.com/kubernetes/kubeadm/blob/master/docs/ha-considerations.md#kube-vip" target="_blank" rel="noopener noreferrer">Kubeadm Docs - High Availability Considerations</a> ä»‹ç»ï¼Œè¦å®ç° kube-apiserver çš„é«˜å¯ç”¨ï¼Œç›®å‰æœ€çŸ¥åçš„è´Ÿè½½å‡è¡¡æ–¹å¼æ˜¯ keepalived+haproxyï¼Œå¦å¤–ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ kube-vip ç­‰æ›´ç®€å•çš„å·¥å…·ã€‚</p>
<p>ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨ kube-vip å§ï¼Œå‚è€ƒäº† kube-vip çš„å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://kube-vip.io/install_static/" target="_blank" rel="noopener noreferrer">Kube-vip as a Static Pod with Kubelet</a>.</p>
<blockquote>
<p>P.S. æˆ‘ä¹Ÿè§è¿‡æœ‰çš„å®‰è£…å·¥å…·ä¼šç›´æ¥æŠ›å¼ƒ keepalivedï¼Œç›´æ¥åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè·‘ä¸€ä¸ª nginx åšè´Ÿè½½å‡è¡¡ï¼Œé…ç½®é‡Œå†™æ­»äº†æ‰€æœ‰ master çš„åœ°å€&hellip;</p>
</blockquote>
<p>é¦–å…ˆä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ç”Ÿæˆ kube-vip çš„é…ç½®æ–‡ä»¶ï¼Œä»¥ ARP ä¸ºä¾‹ï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®æ¢æˆ BGPï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">cat <span class="s">&lt;&lt;EOF | sudo tee add-kube-vip.sh
</span><span class="s"># ä½ çš„è™šæ‹Ÿæœºç½‘å¡ï¼Œopensuse/centos ç­‰éƒ½æ˜¯ eth0ï¼Œä½†æ˜¯ ubuntu å¯èƒ½æ˜¯ ens3
</span><span class="s">export INTERFACE=eth0
</span><span class="s">
</span><span class="s"># ç”¨äºå®ç°é«˜å¯ç”¨çš„ vipï¼Œéœ€è¦å’Œå‰é¢çš„ç½‘ç»œæ¥å£åœ¨åŒä¸€ç½‘æ®µå†…ï¼Œå¦åˆ™å°±æ— æ³•è·¯ç”±äº†ã€‚
</span><span class="s">export VIP=192.168.122.200
</span><span class="s">
</span><span class="s"># ç”Ÿæˆ static-pod çš„é…ç½®æ–‡ä»¶
</span><span class="s">mkdir -p /etc/kubernetes/manifests
</span><span class="s">nerdctl run --rm --network=host --entrypoint=/kube-vip ghcr.io/kube-vip/kube-vip:v0.3.8 \
</span><span class="s">  manifest pod \
</span><span class="s">  --interface $INTERFACE \
</span><span class="s">  --vip $VIP \
</span><span class="s">  --controlplane \
</span><span class="s">  --services \
</span><span class="s">  --arp \
</span><span class="s">  --leaderElection | tee  /etc/kubernetes/manifests/kube-vip.yaml
</span><span class="s">EOF</span>

bash add-kube-vip.sh
</code></pre></td></tr></table>
</div>
</div><p>ä¸‰ä¸ª master èŠ‚ç‚¹éƒ½éœ€è¦è·‘ä¸‹ä¸Šé¢çš„å‘½ä»¤ï¼ˆworker ä¸éœ€è¦ï¼‰ï¼Œåˆ›å»ºå¥½ kube-vip çš„ static-pod é…ç½®æ–‡ä»¶ã€‚
åœ¨å®Œæˆ kubeadm åˆå§‹åŒ–åï¼Œkubelet ä¼šè‡ªåŠ¨æŠŠå®ƒä»¬æ‹‰èµ·ä¸º static pod.</p>
<h2 id="5-ä½¿ç”¨-kubeadm-åˆ›å»ºé›†ç¾¤">5. ä½¿ç”¨ kubeadm åˆ›å»ºé›†ç¾¤</h2>
<p>å…¶å®éœ€è¦è¿è¡Œçš„å°±æ˜¯è¿™æ¡å‘½ä»¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># æç®€é…ç½®ï¼š</span>
cat <span class="s">&lt;&lt;EOF | sudo tee kubeadm-config.yaml
</span><span class="s">apiVersion: kubeadm.k8s.io/v1beta3
</span><span class="s">kind: InitConfiguration
</span><span class="s">nodeRegistration:
</span><span class="s">  criSocket: &#34;/var/run/containerd/containerd.sock&#34;
</span><span class="s">  imagePullPolicy: IfNotPresent
</span><span class="s">---
</span><span class="s">kind: ClusterConfiguration
</span><span class="s">apiVersion: kubeadm.k8s.io/v1beta3
</span><span class="s">kubernetesVersion: v1.22.1
</span><span class="s">clusterName: kubernetes
</span><span class="s">certificatesDir: /etc/kubernetes/pki
</span><span class="s">imageRepository: k8s.gcr.io
</span><span class="s">controlPlaneEndpoint: &#34;192.168.122.200:6443&#34;  # å¡« apiserver çš„ vip åœ°å€ï¼Œæˆ–è€…æ•´ä¸ªåŸŸåä¹Ÿè¡Œï¼Œä½†æ˜¯å°±å¾—åŠ  /etc/hosts æˆ–è€…å†…ç½‘ DNS è§£æ
</span><span class="s">networking:
</span><span class="s">  serviceSubnet: &#34;10.96.0.0/16&#34;
</span><span class="s">  podSubnet: &#34;10.244.0.0/16&#34;
</span><span class="s">etcd:
</span><span class="s">  local:
</span><span class="s">    dataDir: /var/lib/etcd
</span><span class="s">---
</span><span class="s">apiVersion: kubelet.config.k8s.io/v1beta1
</span><span class="s">kind: KubeletConfiguration
</span><span class="s">cgroupDriver: systemd
</span><span class="s"># è®© kubelet ä» certificates.k8s.io ç”³è¯·ç”±é›†ç¾¤ CA Root ç­¾åçš„ tls è¯ä¹¦ï¼Œè€Œéç›´æ¥ä½¿ç”¨è‡ªç­¾åè¯ä¹¦
</span><span class="s"># å¦‚æœä¸å¯ç”¨è¿™ä¸ªï¼Œ å®‰è£… metrics-server æ—¶å°±ä¼šé‡åˆ°è¯ä¹¦æŠ¥é”™ï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ã€‚
</span><span class="s">serverTLSBootstrap: true
</span><span class="s">EOF</span>

<span class="c1"># æŸ¥çœ‹ kubeadm é»˜è®¤çš„å®Œæ•´é…ç½®ï¼Œä¾›å‚è€ƒ</span>
kubeadm config print init-defaults &gt; init.default.yaml

<span class="c1"># æ‰§è¡Œé›†ç¾¤çš„åˆå§‹åŒ–ï¼Œè¿™ä¼šç›´æ¥å°†å½“å‰èŠ‚ç‚¹åˆ›å»ºä¸º master</span>
<span class="c1"># æˆåŠŸè¿è¡Œçš„å‰æï¼šå‰é¢è¯¥è£…çš„ä¸œè¥¿éƒ½è£…å¥½äº†ï¼Œè€Œä¸” kubelet å·²ç»åœ¨åå°è¿è¡Œäº†</span>
<span class="c1"># `--upload-certs` ä¼šå°†ç”Ÿæˆçš„é›†ç¾¤è¯ä¹¦ä¸Šä¼ åˆ° kubeadm æœåŠ¡å™¨ï¼Œåœ¨ä¸¤å°æ—¶å†…åŠ å…¥é›†ç¾¤çš„ master èŠ‚ç‚¹ä¼šè‡ªåŠ¨æ‹‰è¯ä¹¦ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿é›†ç¾¤åˆ›å»ºã€‚</span>
kubeadm init --config kubeadm-config.yaml --upload-certs
</code></pre></td></tr></table>
</div>
</div><p>kubeadm åº”è¯¥ä¼šæŠ¥é”™ï¼Œæç¤ºä½ æœ‰äº›ä¾èµ–ä¸å­˜åœ¨ï¼Œä¸‹é¢å…ˆå®‰è£…å¥½ä¾èµ–é¡¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo zypper in -y socat ebtables conntrack-tools
</code></pre></td></tr></table>
</div>
</div><p>å†é‡æ–°è¿è¡Œå‰é¢çš„ kubeadm å‘½ä»¤ï¼Œåº”è¯¥å°±èƒ½æ­£å¸¸æ‰§è¡Œäº†ï¼Œå®ƒåšçš„æ“ä½œæœ‰ï¼š</p>
<ul>
<li>æ‹‰å–æ§åˆ¶é¢çš„å®¹å™¨é•œåƒ</li>
<li>ç”Ÿæˆ ca æ ¹è¯ä¹¦</li>
<li>ä½¿ç”¨æ ¹è¯ä¹¦ä¸º etcd/apiserver ç­‰ä¸€ç¥¨å·¥å…·ç”Ÿæˆ tls è¯ä¹¦</li>
<li>ä¸ºæ§åˆ¶é¢çš„å„ä¸ªç»„ä»¶ç”Ÿæˆ kubeconfig é…ç½®</li>
<li>ç”Ÿæˆ static pod é…ç½®ï¼Œkubelet ä¼šæ ¹æ®è¿™äº›é…ç½®è‡ªåŠ¨æ‹‰èµ· kube-proxy ä»¥åŠå…¶ä»–æ‰€æœ‰çš„ k8s master ç»„ä»¶</li>
</ul>
<p>è¿è¡Œå®Œä¼šç»™å‡ºä¸‰éƒ¨åˆ†å‘½ä»¤ï¼š</p>
<ul>
<li>å°† <code>kubeconfig</code> æ”¾åˆ° <code>$HOME/.kube/config</code> ä¸‹ï¼Œ<code>kubectl</code> éœ€è¦ä½¿ç”¨è¯¥é…ç½®æ–‡ä»¶è¿æ¥ kube-apiserver</li>
<li>control-plane èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤:
<ul>
<li>è¿™é‡Œç”±äºæˆ‘ä»¬æå‰æ·»åŠ äº† kube-vip çš„ static-pod é…ç½®ï¼Œè¿™é‡Œçš„ preflight-check ä¼šæŠ¥é”™ï¼Œéœ€è¦æ·»åŠ æ­¤å‚æ•°å¿½ç•¥è¯¥æŠ¥é”™ - <code>--ignore-preflight-errors=DirAvailable--etc-kubernetes-manifests</code></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubeadm join 192.168.122.200:6443 --token &lt;token&gt; <span class="se">\
</span><span class="se"></span>  --discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span class="se">\
</span><span class="se"></span>  --control-plane --certificate-key &lt;key&gt; <span class="se">\
</span><span class="se"></span>  --ignore-preflight-errors<span class="o">=</span>DirAvailable--etc-kubernetes-manifests
</code></pre></td></tr></table>
</div>
</div></li>
<li>worker èŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤:
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubeadm join 192.168.122.200:6443 --token &lt;token&gt; <span class="se">\
</span><span class="se"></span>      --discovery-token-ca-cert-hash sha256:&lt;hash&gt; 
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<p>è·‘å®Œç¬¬ä¸€éƒ¨åˆ† <code>kubeconfig</code> çš„å¤„ç†å‘½ä»¤åï¼Œå°±å¯ä»¥ä½¿ç”¨ kubectl æŸ¥çœ‹é›†ç¾¤çŠ¶å†µäº†ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">k8s-master-0:~/kubeadm <span class="c1"># kubectl get no</span>
NAME           STATUS     ROLES                  AGE   VERSION
k8s-master-0   NotReady   control-plane,master   79s   v1.22.1
k8s-master-0:~/kubeadm <span class="c1"># kubectl get po --all-namespaces</span>
NAMESPACE     NAME                                   READY   STATUS    RESTARTS   AGE
kube-system   coredns-78fcd69978-6tlnw               0/1     Pending   <span class="m">0</span>          83s
kube-system   coredns-78fcd69978-hxtvs               0/1     Pending   <span class="m">0</span>          83s
kube-system   etcd-k8s-master-0                      1/1     Running   <span class="m">6</span>          90s
kube-system   kube-apiserver-k8s-master-0            1/1     Running   <span class="m">4</span>          90s
kube-system   kube-controller-manager-k8s-master-0   1/1     Running   <span class="m">4</span>          90s
kube-system   kube-proxy-6w2bx                       1/1     Running   <span class="m">0</span>          83s
kube-system   kube-scheduler-k8s-master-0            1/1     Running   <span class="m">7</span>          97s
</code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨åœ¨å…¶ä»–èŠ‚ç‚¹è¿è¡Œå‰é¢æ‰“å°å‡ºçš„åŠ å…¥é›†ç¾¤çš„å‘½ä»¤ï¼Œå°±å¯ä»¥æ­å»ºå¥½ä¸€ä¸ªé«˜å¯ç”¨çš„é›†ç¾¤äº†ã€‚</p>
<p>æ‰€æœ‰èŠ‚ç‚¹éƒ½åŠ å…¥é›†ç¾¤åï¼Œé€šè¿‡ kubectl æŸ¥çœ‹ï¼Œåº”è¯¥æ˜¯ä¸‰ä¸ªæ§åˆ¶é¢ masterï¼Œä¸¤ä¸ª workerï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">k8s-master-0:~/kubeadm <span class="c1"># kubectl get node</span>
NAME           STATUS     ROLES                  AGE     VERSION
k8s-master-0   NotReady   control-plane,master   26m     v1.22.1
k8s-master-1   NotReady   control-plane,master   7m2s    v1.22.1
k8s-master-2   NotReady   control-plane,master   2m10s   v1.22.1
k8s-worker-0   NotReady   &lt;none&gt;                 97s     v1.22.1
k8s-worker-1   NotReady   &lt;none&gt;                 86s     v1.22.1
</code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨å®ƒä»¬éƒ½è¿˜å¤„äº NotReady çŠ¶æ€ï¼Œéœ€è¦ç­‰åˆ°æˆ‘ä»¬æŠŠç½‘ç»œæ’ä»¶å®‰è£…å¥½ï¼Œæ‰ä¼š Ready.</p>
<p>ç°åœ¨å†çœ‹ä¸‹é›†ç¾¤çš„è¯ä¹¦ç­¾å‘çŠ¶æ€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubectl get csr --sort-by<span class="o">=</span><span class="s1">&#39;{.spec.username}&#39;</span>
NAME        AGE     SIGNERNAME                                    REQUESTOR                  REQUESTEDDURATION   CONDITION
csr-95hll   6m58s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-tklnr   7m5s    kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-w92jv   9m15s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-rv7sj   8m11s   kubernetes.io/kube-apiserver-client-kubelet   system:bootstrap:q8ivnz    &lt;none&gt;              Approved,Issued
csr-nxkgx   10m     kubernetes.io/kube-apiserver-client-kubelet   system:node:k8s-master-0   &lt;none&gt;              Approved,Issued
csr-cd22c   10m     kubernetes.io/kubelet-serving                 system:node:k8s-master-0   &lt;none&gt;              Pending
csr-wjrnr   9m53s   kubernetes.io/kubelet-serving                 system:node:k8s-master-0   &lt;none&gt;              Pending
csr-sjq42   9m8s    kubernetes.io/kubelet-serving                 system:node:k8s-master-1   &lt;none&gt;              Pending
csr-xtv8f   8m56s   kubernetes.io/kubelet-serving                 system:node:k8s-master-1   &lt;none&gt;              Pending
csr-f2dsf   8m3s    kubernetes.io/kubelet-serving                 system:node:k8s-master-2   &lt;none&gt;              Pending
csr-xl8dg   6m58s   kubernetes.io/kubelet-serving                 system:node:k8s-worker-0   &lt;none&gt;              Pending
csr-p9g24   6m52s   kubernetes.io/kubelet-serving                 system:node:k8s-worker-1   &lt;none&gt;              Pending
</code></pre></td></tr></table>
</div>
</div><p>èƒ½çœ‹åˆ°æœ‰å¥½å‡ ä¸ª <code>kubernetes.io/kubelet-serving</code> çš„è¯ä¹¦è¿˜å¤„äº pending çŠ¶æ€ï¼Œ
è¿™æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨ kubeadm é…ç½®æ–‡ä»¶ä¸­ï¼Œè®¾ç½®äº† <code>serverTLSBootstrap: true</code>ï¼Œè®© Kubelet ä»é›†ç¾¤ä¸­ç”³è¯· CA ç­¾åè¯ä¹¦ï¼Œè€Œä¸æ˜¯è‡ªç­¾åå¯¼è‡´çš„ã€‚</p>
<p>è®¾ç½®è¿™ä¸ªå‚æ•°çš„ä¸»è¦ç›®çš„ï¼Œæ˜¯ä¸ºäº†è®© metrics-server ç­‰ç»„ä»¶èƒ½ä½¿ç”¨ https åè®®ä¸ kubelet é€šä¿¡ï¼Œé¿å…ä¸º metrics-server æ·»åŠ å‚æ•° <code>--kubelet-insecure-tls</code>.</p>
<p>ç›®å‰ kubeadm ä¸æ”¯æŒè‡ªåŠ¨æ‰¹å‡† kubelet ç”³è¯·çš„è¯ä¹¦ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ‰¹å‡†ä¸€ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># æ‰¹å‡† Kubelet ç”³è¯·çš„æ‰€æœ‰è¯ä¹¦</span>
kubectl certificate approve csr-cd22c csr-wjrnr csr-sjq42 csr-xtv8f csr-f2dsf csr-xl8dg csr-p9g24
</code></pre></td></tr></table>
</div>
</div><p>åœ¨æœªæ‰¹å‡†è¿™äº›è¯ä¹¦ä¹‹å‰ï¼Œæ‰€æœ‰éœ€è¦è°ƒç”¨ kubelet api çš„åŠŸèƒ½éƒ½å°†æ— æ³•ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æŸ¥çœ‹ pod æ—¥å¿—</li>
<li>è·å–èŠ‚ç‚¹ metrics</li>
<li>ç­‰ç­‰</li>
</ul>
<h3 id="51-å¸¸è§é—®é¢˜">5.1 å¸¸è§é—®é¢˜</h3>
<h4 id="511-ä½¿ç”¨å›½å†…é•œåƒæº">5.1.1 ä½¿ç”¨å›½å†…é•œåƒæº</h4>
<p>å¦‚æœä½ æ²¡æœ‰ç§‘å­¦ç¯å¢ƒï¼Œkubeadm é»˜è®¤çš„é•œåƒä»“åº“åœ¨å›½å†…æ˜¯æ‹‰ä¸äº†çš„ã€‚
å¦‚æœå¯¹å¯é æ€§è¦æ±‚é«˜ï¼Œæœ€å¥½æ˜¯è‡ªå»ºç§æœ‰é•œåƒä»“åº“ï¼ŒæŠŠé•œåƒæ¨é€åˆ°ç§æœ‰ä»“åº“ã€‚</p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤åˆ—å‡ºæ‰€æœ‰éœ€è¦ç”¨åˆ°çš„é•œåƒåœ°å€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubeadm config images list --kubernetes-version v1.22.1
k8s.gcr.io/kube-apiserver:v1.22.1
k8s.gcr.io/kube-controller-manager:v1.22.1
k8s.gcr.io/kube-scheduler:v1.22.1
k8s.gcr.io/kube-proxy:v1.22.1
k8s.gcr.io/pause:3.5
k8s.gcr.io/etcd:3.5.0-0
k8s.gcr.io/coredns/coredns:v1.8.4
</code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ <code>skopeo</code> ç­‰å·¥å…·æˆ–è„šæœ¬å°†ä¸Šè¿°é•œåƒæ‹·è´åˆ°ä½ çš„ç§æœ‰ä»“åº“ï¼Œæˆ–è€…å›¾æ–¹ä¾¿ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰ä¹Ÿå¯ä»¥è€ƒè™‘ç½‘ä¸Šæ‰¾æ‰¾åˆ«äººåŒæ­¥å¥½çš„é•œåƒåœ°å€ã€‚å°†é•œåƒåœ°å€æ·»åŠ åˆ° <code>kubeadm-config.yaml</code> ä¸­å†éƒ¨ç½²ã€‚</p>
<h4 id="512-é‡ç½®é›†ç¾¤é…ç½®">5.1.2 é‡ç½®é›†ç¾¤é…ç½®</h4>
<p>åˆ›å»ºé›†ç¾¤çš„è¿‡ç¨‹ä¸­å‡ºç°ä»»ä½•é—®é¢˜ï¼Œéƒ½å¯ä»¥é€šè¿‡åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šè¿è¡Œ <code>kubeadm reset</code> æ¥è¿˜åŸé…ç½®ï¼Œç„¶åé‡æ–°èµ° kubeadm çš„é›†ç¾¤åˆ›å»ºæµç¨‹ã€‚</p>
<p>ä½†æ˜¯è¦æ³¨æ„å‡ ç‚¹ï¼š</p>
<ul>
<li><code>kubeadm reset</code> ä¼šæ¸…é™¤åŒ…å« kube-vip é…ç½®åœ¨å†…çš„æ‰€æœ‰ static-pod é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥ master èŠ‚ç‚¹éœ€è¦é‡æ–°è·‘ä¸‹å‰é¢ç»™çš„ kube-vip å‘½ä»¤ï¼Œç”Ÿæˆä¸‹ kube-vip é…ç½®ã€‚</li>
<li><code>kubeadm reset</code> ä¸ä¼šé‡ç½®ç½‘ç»œæ¥å£çš„é…ç½®ï¼Œmaster èŠ‚ç‚¹éœ€è¦æ‰‹åŠ¨æ¸…ç†ä¸‹ kube-vip æ·»åŠ çš„ vip: <code>ip addr del 192.168.122.200/32 dev eth0</code>.</li>
<li>å¦‚æœä½ åœ¨å®‰è£…äº†ç½‘ç»œæ’ä»¶ä¹‹åå¸Œæœ›é‡è£…é›†ç¾¤ï¼Œé¡ºåºå¦‚ä¸‹ï¼š
<ul>
<li>é€šè¿‡ <code>kubectl delete -f xxx.yaml</code>/<code>helm uninstall</code> åˆ é™¤æ‰€æœ‰é™¤ç½‘ç»œä¹‹å¤–çš„å…¶ä»–åº”ç”¨é…ç½®</li>
<li>åˆ é™¤ç½‘ç»œæ’ä»¶</li>
<li>å…ˆé‡å¯ä¸€éæ‰€æœ‰èŠ‚ç‚¹ï¼Œæˆ–è€…æ‰‹åŠ¨é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çš„ç½‘ç»œé…ç½®
<ul>
<li>å»ºè®®é‡å¯ï¼Œå› ä¸ºæˆ‘ä¸çŸ¥é“è¯¥æ€ä¹ˆæ‰‹åŠ¨é‡ç½®&hellip; è¯•äº† <code>systemctl restart network</code> å¹¶ä¸ä¼šæ¸…ç†æ‰€æœ‰è™šæ‹Ÿç½‘ç»œæ¥å£ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>å¦‚æ­¤æ“ä½œåï¼Œå†é‡æ–°æ‰§è¡Œé›†ç¾¤å®‰è£…ï¼Œåº”è¯¥å°±æ²¡å•¥æ¯›ç—…äº†ã€‚</p>
<h2 id="6-éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§">6. éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§</h2>
<p>è™½ç„¶ç½‘ç»œæ’ä»¶è¿˜æ²¡è£…å¯¼è‡´é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹éƒ½è¿˜æ²¡ readyï¼Œä½†æ˜¯æˆ‘ä»¬å·²ç»å¯ä»¥é€šè¿‡ kubectl å‘½ä»¤æ¥ç®€å•éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§äº†ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬å°†å‰é¢æ”¾ç½®åœ¨ k8s-master-0 çš„è®¤è¯æ–‡ä»¶ <code>$HOME/.kube/config</code> ä»¥åŠ kunbectl å®‰è£…åœ¨å¦ä¸€å°æœºå™¨ä¸Šï¼Œæ¯”å¦‚æˆ‘ç›´æ¥æ”¾æˆ‘çš„å®¿ä¸»æœºã€‚</p>
<p>ç„¶ååœ¨å®¿ä¸»æœºä¸Šè·‘ <code>kubectl get node</code> å‘½ä»¤éªŒè¯é›†ç¾¤çš„é«˜å¯ç”¨æ€§ï¼š</p>
<ul>
<li>ä¸‰ä¸ªä¸»èŠ‚ç‚¹éƒ½æ­£å¸¸è¿è¡Œæ—¶ï¼Œkubectl å‘½ä»¤ä¹Ÿæ­£å¸¸</li>
<li>pause æˆ–è€… stop å…¶ä¸­ä¸€ä¸ª masterï¼Œkubectl å‘½ä»¤ä»ç„¶èƒ½æ­£å¸¸è¿è¡Œ</li>
<li>å† pause ç¬¬äºŒä¸ª masterï¼Œkubectl å‘½ä»¤åº”è¯¥å°±ä¼šå¡ä½ï¼Œå¹¶ä¸”è¶…æ—¶ï¼Œæ— æ³•ä½¿ç”¨äº†</li>
<li>resume æ¢å¤åœæ‰çš„ä¸¤ä¸ª master ä¹‹ä¸€ï¼Œä¼šå‘ç° kubectl å‘½ä»¤åˆèƒ½æ­£å¸¸è¿è¡Œäº†</li>
</ul>
<p>åˆ°è¿™é‡Œ kubeadm çš„å·¥ä½œå°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å†å®‰è£…ç½‘ç»œæ’ä»¶ï¼Œé›†ç¾¤å°±å¯ç”¨äº†ã€‚</p>
<h2 id="7-å®‰è£…ç½‘ç»œæ’ä»¶">7. å®‰è£…ç½‘ç»œæ’ä»¶</h2>
<p>ç¤¾åŒºæœ‰å¾ˆå¤šç§ç½‘ç»œæ’ä»¶å¯é€‰ï¼Œæ¯”è¾ƒçŸ¥åä¸”æ€§èƒ½ä¹Ÿä¸é”™çš„ï¼Œåº”è¯¥æ˜¯ Calico å’Œ Ciliumï¼Œå…¶ä¸­ Cilium ä¸»æ‰“åŸºäº eBPF çš„é«˜æ€§èƒ½ä¸é«˜å¯è§‚æµ‹æ€§ã€‚</p>
<p>ä¸‹é¢åˆ†åˆ«ä»‹ç»è¿™ä¸¤ä¸ªæ’ä»¶çš„å®‰è£…æ–¹æ³•ã€‚ï¼ˆæ³¨æ„åªèƒ½å®‰è£…å…¶ä¸­ä¸€ä¸ªç½‘ç»œæ’ä»¶ï¼Œä¸èƒ½é‡å¤å®‰è£…ã€‚ï¼‰</p>
<p>éœ€è¦æå‰åœ¨æœ¬æœºå®‰è£…å¥½ helmï¼Œæˆ‘è¿™é‡Œä½¿ç”¨å®¿ä¸»æœºï¼Œå› æ­¤åªéœ€è¦åœ¨å®¿ä¸»æœºå®‰è£…:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ä¸€è¡Œå‘½ä»¤å®‰è£…ï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨ä¸‹è½½å®‰è£…åŒ…ï¼Œéƒ½è¡Œ</span>
curl https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 <span class="p">|</span> bash

<span class="c1"># æˆ–è€… opensuse ç›´æ¥ç”¨åŒ…ç®¡ç†å™¨å®‰è£…</span>
sudo zypper in helm
</code></pre></td></tr></table>
</div>
</div><h3 id="71-å®‰è£…-cilium">7.1 å®‰è£… Cilium</h3>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.cilium.io/en/v1.10/gettingstarted/k8s-install-kubeadm/</p>
</blockquote>
<p>cilium é€šè¿‡ eBPF æä¾›äº†é«˜æ€§èƒ½ä¸é«˜å¯è§‚æµ‹çš„ k8s é›†ç¾¤ç½‘ç»œï¼Œ
å¦å¤– cilium è¿˜æä¾›äº†æ¯” kube-proxy æ›´é«˜æ•ˆçš„å®ç°ï¼Œå¯ä»¥å®Œå…¨æ›¿ä»£ kube-proxy.</p>
<p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯å…ˆä½¿ç”¨ kube-proxy æ¨¡å¼ï¼Œå…ˆç†Ÿæ‚‰ä¸‹ cilium çš„ä½¿ç”¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm repo add cilium https://helm.cilium.io/
helm search repo cilium/cilium -l <span class="p">|</span> head

helm install cilium cilium/cilium --version 1.10.4 --namespace kube-system
</code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥é€šè¿‡ <code>kubectl get pod -A</code> æŸ¥çœ‹ cilium çš„å®‰è£…è¿›åº¦ï¼Œå½“æ‰€æœ‰ pod éƒ½ ready åï¼Œé›†ç¾¤å°± ready äº†~</p>
<p>cilium ä¹Ÿæä¾›äº†ä¸“ç”¨çš„å®¢æˆ·ç«¯ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">curl -L --remote-name-all https://github.com/cilium/cilium-cli/releases/latest/download/cilium-linux-amd64.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
sha256sum --check cilium-linux-amd64.tar.gz.sha256sum
sudo tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin
rm cilium-linux-amd64.tar.gz<span class="o">{</span>,.sha256sum<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åä½¿ç”¨ cilium å®¢æˆ·ç«¯æ£€æŸ¥ç½‘ç»œæ’ä»¶çš„çŠ¶æ€ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"> $ cilium status --wait
    /Â¯Â¯<span class="se">\
</span><span class="se"></span> /Â¯Â¯<span class="se">\_</span>_/Â¯Â¯<span class="se">\ </span>   Cilium:         OK
 <span class="se">\_</span>_/Â¯Â¯<span class="se">\_</span>_/    Operator:       OK
 /Â¯Â¯<span class="se">\_</span>_/Â¯Â¯<span class="se">\ </span>   Hubble:         disabled
 <span class="se">\_</span>_/Â¯Â¯<span class="se">\_</span>_/    ClusterMesh:    disabled
    <span class="se">\_</span>_/

DaemonSet         cilium             Desired: 5, Ready: 5/5, Available: 5/5
Deployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
Containers:       cilium             Running: <span class="m">5</span>
                  cilium-operator    Running: <span class="m">2</span>
Cluster Pods:     2/2 managed by Cilium
Image versions    cilium             quay.io/cilium/cilium:v1.10.4@sha256:7d354052ccf2a7445101d78cebd14444c7c40129ce7889f2f04b89374dbf8a1d: <span class="m">5</span>
                  cilium-operator    quay.io/cilium/operator-generic:v1.10.4@sha256:c49a14e34634ff1a494c84b718641f27267fb3a0291ce3d74352b44f8a8d2f93: <span class="m">2</span>
</code></pre></td></tr></table>
</div>
</div><p>cilium è¿˜æä¾›äº†å‘½ä»¤ï¼Œè‡ªåŠ¨åˆ›å»º pod è¿›è¡Œé›†ç¾¤ç½‘ç»œçš„è¿æ¥æ€§æµ‹è¯•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ cilium connectivity <span class="nb">test</span>
â„¹ï¸  Monitor aggregation detected, will skip some flow validation steps
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Creating namespace <span class="k">for</span> connectivity check...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying echo-same-node service...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying same-node deployment...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying client deployment...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying client2 deployment...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying echo-other-node service...
âœ¨ <span class="o">[</span>kubernetes<span class="o">]</span> Deploying other-node deployment...
...
â„¹ï¸  Expose Relay locally with:
   cilium hubble <span class="nb">enable</span>
   cilium status --wait
   cilium hubble port-forward<span class="p">&amp;</span>
ğŸƒ Running tests...
...
---------------------------------------------------------------------------------------------------------------------
âœ… All <span class="m">11</span> tests <span class="o">(</span><span class="m">134</span> actions<span class="o">)</span> successful, <span class="m">0</span> tests skipped, <span class="m">0</span> scenarios skipped.
</code></pre></td></tr></table>
</div>
</div><p>é€šè¿‡ <code>kubectl get po -A</code> èƒ½è§‚å¯Ÿåˆ°ï¼Œè¿™ä¸ªæµ‹è¯•å‘½ä»¤ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ª <code>cilium-test</code> åå­—ç©ºé—´ï¼Œå¹¶åœ¨å¯åŠ¨åˆ›å»ºè‹¥å¹² pod è¿›è¡Œè¯¦ç»†çš„æµ‹è¯•ã€‚</p>
<p>æ•´ä¸ªæµ‹è¯•æµç¨‹å¤§æ¦‚ä¼šæŒç»­ 5 åˆ†å¤šé’Ÿï¼Œæµ‹è¯•å®Œæˆåï¼Œç›¸å…³ Pod ä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ‰‹åŠ¨åˆ é™¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl delete namespace cilium-test
</code></pre></td></tr></table>
</div>
</div><h3 id="72-å®‰è£…-calico">7.2 å®‰è£… Calico</h3>
<blockquote>
<p>å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.projectcalico.org/getting-started/kubernetes/self-managed-onprem/onpremises</p>
</blockquote>
<p>ä¹Ÿå°±ä¸¤ä¸‰è¡Œå‘½ä»¤ã€‚å®‰è£…ç¡®å®ç‰¹åˆ«ç®€å•ï¼Œæ‡’å¾—ä»‹ç»äº†ï¼Œçœ‹å®˜æ–¹æ–‡æ¡£å§ã€‚</p>
<p>ä½†æ˜¯å®é™…ä¸Š calico çš„ç»†èŠ‚è¿˜è›®å¤šçš„ï¼Œå»ºè®®é€šè¯»ä¸‹å®ƒçš„å®˜æ–¹æ–‡æ¡£ï¼Œäº†è§£ä¸‹ calico çš„æ¶æ„ã€‚</p>
<h2 id="8-æŸ¥çœ‹é›†ç¾¤çŠ¶æ€">8. æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</h2>
<p>å®˜æ–¹çš„ dashboard ä¸ªäººæ„Ÿè§‰ä¸å¤ªå¥½ç”¨ï¼Œå»ºè®®ç›´æ¥åœ¨æœ¬åœ°è£…ä¸ª k9s ç”¨ï¼Œç‰¹åˆ«çˆ½ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">sudo zypper in k9s
</code></pre></td></tr></table>
</div>
</div><p>ç„¶åå°±å¯ä»¥æ„‰å¿«åœ°ç©è€äº†ã€‚</p>
<h2 id="9-å®‰è£…-metrics-server">9. å®‰è£… metrics-server</h2>
<blockquote>
<p>è¿™ä¸€æ­¥å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š<a href="https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-certs/#kubelet-serving-certs" target="_blank" rel="noopener noreferrer">Enabling signed kubelet serving certificates</a></p>
</blockquote>
<p>å¦‚æœéœ€è¦ä½¿ç”¨ HPA ä»¥åŠç®€å•çš„é›†ç¾¤ç›‘æ§ï¼Œé‚£ä¹ˆ metrics-server æ˜¯å¿…é¡»å®‰è£…çš„ï¼Œç°åœ¨æˆ‘ä»¬å®‰è£…ä¸€ä¸‹å®ƒã€‚</p>
<p>é¦–å…ˆï¼Œè·‘ kubectl çš„ç›‘æ§å‘½ä»¤åº”è¯¥ä¼šæŠ¥é”™ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubectl top node
error: Metrics API not available
</code></pre></td></tr></table>
</div>
</div><p>k9s é‡Œé¢åº”è¯¥ä¹Ÿçœ‹ä¸åˆ°ä»»ä½•ç›‘æ§æŒ‡æ ‡ã€‚</p>
<p>ç°åœ¨é€šè¿‡ helm å®‰è£…å®ƒï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/
helm search repo metrics-server/metrics-server -l <span class="p">|</span> head

helm upgrade --install metrics-server metrics-server/metrics-server --version 3.5.0 --namespace kube-system
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>metrics-server é»˜è®¤åªä¼šéƒ¨ç½²ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚æœå¸Œæœ›é«˜å¯ç”¨ï¼Œè¯·å‚è€ƒå®˜æ–¹é…ç½®ï¼š<a href="https://github.com/kubernetes-sigs/metrics-server/tree/master/manifests/high-availability" target="_blank" rel="noopener noreferrer">metrics-server - high-availability manifests</a></p>
</blockquote>
<p>ç­‰ metrics-server å¯åŠ¨å¥½åï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>kubectl top</code> å‘½ä»¤å•¦ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">â¯ kubectl top node
NAME           CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%   
k8s-master-0   327m         16%    1465Mi          50%       
k8s-master-1   263m         13%    1279Mi          44%       
k8s-master-2   289m         14%    1282Mi          44%       
k8s-worker-0   62m          3%     518Mi           13%       
k8s-worker-1   115m         2%     659Mi           8%        

â¯ kubectl top pod
No resources found in default namespace.

â¯ kubectl top pod -A
NAMESPACE     NAME                                   CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   
kube-system   cilium-45nw4                           9m           135Mi           
kube-system   cilium-5x7jf                           6m           154Mi           
kube-system   cilium-84sr2                           7m           160Mi           
kube-system   cilium-operator-78f45675-dp4b6         2m           30Mi            
kube-system   cilium-operator-78f45675-fpm5g         1m           30Mi            
kube-system   cilium-tkhl4                           6m           141Mi           
kube-system   cilium-zxbvm                           5m           138Mi           
kube-system   coredns-78fcd69978-dpxxk               3m           16Mi            
kube-system   coredns-78fcd69978-ptd9p               1m           18Mi            
kube-system   etcd-k8s-master-0                      61m          88Mi            
kube-system   etcd-k8s-master-1                      50m          85Mi            
kube-system   etcd-k8s-master-2                      55m          83Mi            
kube-system   kube-apiserver-k8s-master-0            98m          462Mi           
kube-system   kube-apiserver-k8s-master-1            85m          468Mi           
kube-system   kube-apiserver-k8s-master-2            85m          423Mi           
kube-system   kube-controller-manager-k8s-master-0   22m          57Mi            
kube-system   kube-controller-manager-k8s-master-1   2m           23Mi            
kube-system   kube-controller-manager-k8s-master-2   2m           23Mi            
kube-system   kube-proxy-j2s76                       1m           24Mi            
kube-system   kube-proxy-k6d6z                       1m           18Mi            
kube-system   kube-proxy-k85rx                       1m           23Mi            
kube-system   kube-proxy-pknsc                       1m           20Mi            
kube-system   kube-proxy-xsq4m                       1m           15Mi            
kube-system   kube-scheduler-k8s-master-0            3m           25Mi            
kube-system   kube-scheduler-k8s-master-1            4m           21Mi            
kube-system   kube-scheduler-k8s-master-2            5m           21Mi            
kube-system   kube-vip-k8s-master-0                  4m           17Mi            
kube-system   kube-vip-k8s-master-1                  2m           16Mi            
kube-system   kube-vip-k8s-master-2                  2m           17Mi            
kube-system   metrics-server-559f85484-5b6xf         7m           27Mi    
</code></pre></td></tr></table>
</div>
</div><h2 id="10-ä¸º-etcd-æ·»åŠ å®šæœŸå¤‡ä»½èƒ½åŠ›">10. ä¸º etcd æ·»åŠ å®šæœŸå¤‡ä»½èƒ½åŠ›</h2>
<p>è¯·ç§»æ­¥ <a href="https://github.com/ryan4yin/knowledge/blob/master/datastore/etcd/etcd%20%E7%9A%84%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D.md" target="_blank" rel="noopener noreferrer">etcd çš„å¤‡ä»½ä¸æ¢å¤</a></p>
<h2 id="11-å®‰è£…-volume-provisioner">11. å®‰è£… Volume Provisioner</h2>
<p>åœ¨æˆ‘ä»¬å­¦ä¹ ä½¿ç”¨ Prometheus/MinIO/Tekton ç­‰æœ‰çŠ¶æ€åº”ç”¨æ—¶ï¼Œå®ƒä»¬é»˜è®¤æƒ…å†µä¸‹ä¼šé€šè¿‡ PVC å£°æ˜éœ€è¦çš„æ•°æ®å·ã€‚</p>
<p>ä¸ºäº†æ”¯æŒè¿™ä¸ªèƒ½åŠ›ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ª Volume Provisioner.</p>
<p>å¯¹äºäº‘ä¸Šç¯å¢ƒï¼Œç›´æ¥æ¥å…¥äº‘æœåŠ¡å•†æä¾›çš„ Volume Provisioner å°± OK äº†ï¼Œæ–¹ä¾¿çœäº‹è€Œä¸”è¶³å¤Ÿå¯é ã€‚</p>
<p>è€Œå¯¹äº bare-metal ç¯å¢ƒï¼Œæ¯”è¾ƒæœ‰åçš„åº”è¯¥æ˜¯ rook-cephï¼Œä½†æ˜¯è¿™ä¸ªç©æ„éƒ¨ç½²å¤æ‚ï¼Œç»´æŠ¤éš¾åº¦åˆé«˜ï¼Œä¸é€‚åˆç”¨æ¥æµ‹è¯•å­¦ä¹ ï¼Œä¹Ÿä¸é€‚åˆç”Ÿäº§ç¯å¢ƒã€‚</p>
<p>å¯¹äºå¼€å‘ã€æµ‹è¯•ç¯å¢ƒï¼Œæˆ–è€…ä¸ªäººé›†ç¾¤ï¼Œå»ºè®®ä½¿ç”¨ï¼š</p>
<ul>
<li>local æ•°æ®å·ï¼Œé€‚åˆæ•°æ®å¯ä¸¢å¤±ï¼Œä¸”ä¸è¦æ±‚åˆ†å¸ƒå¼çš„åœºæ™¯ï¼Œå¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒ
<ul>
<li><a href="https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner">https://github.com/kubernetes-sigs/sig-storage-local-static-provisioner</a></li>
<li><a href="https://github.com/rancher/local-path-provisioner">https://github.com/rancher/local-path-provisioner</a></li>
</ul>
</li>
<li>NFS æ•°æ®å·ï¼Œé€‚åˆæ•°æ®å¯ä¸¢å¤±ï¼Œå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜ï¼Œå¹¶ä¸”è¦æ±‚åˆ†å¸ƒå¼çš„åœºæ™¯ã€‚æ¯”å¦‚å¼€å‘æµ‹è¯•ç¯å¢ƒã€æˆ–è€…çº¿ä¸Šæ²¡å•¥å‹åŠ›çš„åº”ç”¨
<ul>
<li><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner</a></li>
<li><a href="https://github.com/kubernetes-csi/csi-driver-nfs">https://github.com/kubernetes-csi/csi-driver-nfs</a></li>
<li>NFS æ•°æ®çš„å¯é æ€§ä¾èµ–äºå¤–éƒ¨ NFS æœåŠ¡å™¨ï¼Œä¼ä¸šé€šå¸¸ä½¿ç”¨ç¾¤æ™–ç­‰ NAS æ¥åš NFS æœåŠ¡å™¨</li>
<li>å¦‚æœå¤–éƒ¨ NFS æœåŠ¡å™¨å‡ºé—®é¢˜ï¼Œåº”ç”¨å°±ä¼šå´©ã€‚</li>
</ul>
</li>
<li>ç›´æ¥ä½¿ç”¨äº‘ä¸Šçš„å¯¹è±¡å­˜å‚¨ï¼Œé€‚åˆå¸Œæœ›æ•°æ®ä¸ä¸¢å¤±ã€å¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚
<ul>
<li>ç›´æ¥ä½¿ç”¨ <a href="https://github.com/rclone/rclone">https://github.com/rclone/rclone</a> mount æ¨¡å¼æ¥ä¿å­˜æ•°æ®ï¼Œæˆ–è€…ç›´æ¥åŒæ­¥æ–‡ä»¶å¤¹æ•°æ®åˆ°äº‘ç«¯ï¼ˆå¯èƒ½ä¼šæœ‰ä¸€å®šæ•°æ®ä¸¢å¤±ï¼‰ã€‚</li>
</ul>
</li>
</ul>
]]></description></item><item><title>Kubernetes å¾®æœåŠ¡æœ€ä½³å®è·µ</title><link>https://ryan4yin.space/posts/kubernetes-best-practices/</link><pubDate>Tue, 25 Jan 2022 00:13:00 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/kubernetes-best-practices/</guid><description><![CDATA[<blockquote>
<p>æœ¬æ–‡ç”±ä¸ªäººç¬”è®° <a href="https://github.com/ryan4yin/knowledge/tree/master/kubernetes" target="_blank" rel="noopener noreferrer">ryan4yin/knowledge</a> æ•´ç†è€Œæ¥</p>
</blockquote>
<p>æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸‹æˆ‘ä¸ªäººåœ¨ä½¿ç”¨ Kubernetes çš„è¿‡ç¨‹ä¸­ï¼Œæ€»ç»“å‡ºçš„ä¸€å¥—ã€ŒKubernetes é…ç½®ã€ï¼Œæ˜¯æˆ‘ä¸ªäººçš„ã€Œæœ€ä½³å®è·µã€ã€‚
å…¶ä¸­å¤§éƒ¨åˆ†å†…å®¹éƒ½ç»å†è¿‡çº¿ä¸Šç¯å¢ƒçš„è€ƒéªŒï¼Œä½†æ˜¯ä¹Ÿæœ‰å°‘éƒ¨åˆ†è¿˜åªåœ¨æˆ‘è„‘å­é‡Œæ¨¡æ‹Ÿè¿‡ï¼Œè¯·è°¨æ…å‚è€ƒã€‚</p>
<p>é˜…è¯»å‰çš„å‡ ä¸ªæ³¨æ„äº‹é¡¹ï¼š</p>
<ul>
<li>è¿™ä»½æ–‡æ¡£æ¯”è¾ƒé•¿ï¼Œå›Šæ‹¬äº†å¾ˆå¤šå†…å®¹ï¼Œå»ºè®®å½“æˆå‚è€ƒæ‰‹å†Œä½¿ç”¨ï¼Œå…ˆå‚ç…§ç›®å½•ç®€å•è¯»ä¸€è¯»ï¼Œæœ‰éœ€è¦å†ç»†è¯»ç›¸å…³å†…å®¹ã€‚</li>
<li>è¿™ä»½æ–‡æ¡£éœ€è¦ä¸€å®šçš„ Kubernetes åŸºç¡€æ‰èƒ½ç†è§£ï¼Œè€Œä¸”å¦‚æœæ²¡æœ‰è¿‡å®è·µç»éªŒçš„è¯ï¼Œçœ‹ä¸Šå»å¯èƒ½ä¼šæ¯”è¾ƒæ¯ç‡¥ã€‚
<ul>
<li>è€Œæœ‰è¿‡å®è·µç»éªŒçš„å¤§ä½¬ï¼Œå¯èƒ½ä¼šè·Ÿæˆ‘æœ‰ä¸åŒçš„è§è§£ï¼Œæ¬¢è¿å„è·¯å¤§ä½¬è¯„è®º~</li>
</ul>
</li>
</ul>
<p>æˆ‘ä¼šè§†æƒ…å†µä¸å®šæœŸæ›´æ–°è¿™ä»½æ–‡æ¡£ã€‚</p>
<h2 id="é›¶ç¤ºä¾‹">é›¶ã€ç¤ºä¾‹</h2>
<p>é¦–å…ˆï¼Œè¿™é‡Œç»™å‡ºä¸€äº›æœ¬æ–‡éµå®ˆçš„å‰æï¼Œè¿™äº›å‰æåªæ˜¯å¥‘åˆæˆ‘é‡åˆ°çš„åœºæ™¯ï¼Œå¯çµæ´»å˜é€šï¼š</p>
<ul>
<li>è¿™é‡Œåªè®¨è®ºæ— çŠ¶æ€æœåŠ¡ï¼Œæœ‰çŠ¶æ€æœåŠ¡ä¸åœ¨è®¨è®ºèŒƒå›´å†…</li>
<li>æˆ‘ä»¬ä¸ä½¿ç”¨ Deployment çš„æ»šåŠ¨æ›´æ–°èƒ½åŠ›ï¼Œè€Œæ˜¯ä¸ºæ¯ä¸ªæœåŠ¡çš„æ¯ä¸ªç‰ˆæœ¬ï¼Œéƒ½åˆ›å»ºä¸åŒçš„ Deployment + HPA + PodDisruptionBudgetï¼Œè¿™æ˜¯ä¸ºäº†æ–¹ä¾¿åšé‡‘ä¸é›€/ç°åº¦å‘å¸ƒ</li>
<li>æˆ‘ä»¬çš„æœåŠ¡å¯èƒ½ä¼šä½¿ç”¨ IngressController / Service Mesh æ¥è¿›è¡ŒæœåŠ¡çš„è´Ÿè½½å‡è¡¡ã€æµé‡åˆ‡åˆ†</li>
</ul>
<p>ä¸‹é¢å…ˆç»™å‡ºä¸€ä¸ª Deployment + HPA + PodDisruptionBudget çš„ demoï¼Œåé¢å†æ‹†å¼€è¯¦ç»†è¯´ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span><span class="w">    </span><span class="c"># å› ä¸ºæœåŠ¡çš„æ¯ä¸ªç‰ˆæœ¬éƒ½ä½¿ç”¨å„è‡ªçš„ Deploymentï¼ŒæœåŠ¡æ›´æ–°æ—¶å…¶å®æ˜¯ç”¨ä¸ä¸Šè¿™é‡Œçš„æ»šåŠ¨æ›´æ–°ç­–ç•¥çš„</span><span class="w">
</span><span class="w">    </span><span class="c"># è¿™ä¸ªé…ç½®åº”è¯¥åªåœ¨ SRE æ‰‹åŠ¨ä¿®æ”¹ Deployment é…ç½®æ—¶æ‰ä¼šç”Ÿæ•ˆï¼ˆé€šå¸¸ä¸åº”è¯¥å‘ç”Ÿè¿™ç§äº‹ï¼‰</span><span class="w">
</span><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="l">% </span><span class="w"> </span><span class="c"># æ»šåŠ¨æ›´æ–°æ—¶ï¼Œæ¯æ¬¡æœ€å¤šæ›´æ–° 10% çš„ Pods</span><span class="w">
</span><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c"># æ»šåŠ¨æ›´æ–°æ—¶ï¼Œä¸å…è®¸å‡ºç°ä¸å¯ç”¨çš„ Podsï¼Œä¹Ÿå°±æ˜¯è¯´å§‹ç»ˆè¦ç»´æŒ 3 ä¸ªå¯ç”¨å‰¯æœ¬</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v3</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">        </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v3</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">podAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># éå¼ºåˆ¶æ€§æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹ï¼ˆåªæœ‰ä¸€æ¡è§„åˆ™çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼æ²¡å•¥æ„ä¹‰ï¼‰</span><span class="w">
</span><span class="w">            </span><span class="nt">podAffinityTerm</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">my-app</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">v3</span><span class="w">
</span><span class="w">              </span><span class="c"># pod å°½é‡ä½¿ç”¨åŒä¸€ç§èŠ‚ç‚¹ç±»å‹ï¼Œä¹Ÿå°±æ˜¯å°½é‡ä¿è¯èŠ‚ç‚¹çš„æ€§èƒ½ä¸€è‡´</span><span class="w">
</span><span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">node.kubernetes.io/instance-type</span><span class="w">
</span><span class="w">        </span><span class="nt">podAntiAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># éå¼ºåˆ¶æ€§æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹ï¼ˆåªæœ‰ä¸€æ¡è§„åˆ™çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼æ²¡å•¥æ„ä¹‰ï¼‰</span><span class="w">
</span><span class="w">            </span><span class="nt">podAffinityTerm</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">my-app</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">v3</span><span class="w">
</span><span class="w">              </span><span class="c"># å°† pod å°½é‡æ‰“æ•£åœ¨å¤šä¸ªå¯ç”¨åŒº</span><span class="w">
</span><span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">  </span><span class="c"># å¼ºåˆ¶æ€§è¦æ±‚ï¼ˆè¿™ä¸ªå»ºè®®æŒ‰éœ€æ·»åŠ ï¼‰</span><span class="w">
</span><span class="w">          </span><span class="c"># æ³¨æ„è¿™ä¸ªæ²¡æœ‰ weightsï¼Œå¿…é¡»æ»¡è¶³åˆ—è¡¨ä¸­çš„æ‰€æœ‰æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">my-app</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">v3</span><span class="w">
</span><span class="w">            </span><span class="c"># Pod å¿…é¡»è¿è¡Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š</span><span class="w">
</span><span class="w">            </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span><span class="w">      </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># runAsUser: 1000  # è®¾å®šç”¨æˆ·</span><span class="w">
</span><span class="w">        </span><span class="c"># runAsGroup: 1000  # è®¾å®šç”¨æˆ·ç»„</span><span class="w">
</span><span class="w">        </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># Pod å¿…é¡»ä»¥é root ç”¨æˆ·è¿è¡Œ</span><span class="w">
</span><span class="w">        </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">  </span><span class="c"># security compute mode</span><span class="w">
</span><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span><span class="w">      </span><span class="nt">nodeSelector</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">eks.amazonaws.com/nodegroup</span><span class="p">:</span><span class="w"> </span><span class="l">common </span><span class="w"> </span><span class="c"># ä½¿ç”¨ä¸“ç”¨èŠ‚ç‚¹ç»„ï¼Œå¦‚æœå¸Œæœ›ä½¿ç”¨å¤šä¸ªèŠ‚ç‚¹ç»„ï¼Œå¯æ”¹ç”¨èŠ‚ç‚¹äº²å’Œæ€§</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir</span><span class="w">
</span><span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span>{}<span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">my-app:v3 </span><span class="w"> </span><span class="c"># å»ºè®®ä½¿ç”¨ç§æœ‰é•œåƒä»“åº“ï¼Œè§„é¿ docker.io çš„é•œåƒæ‹‰å–é™åˆ¶</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/tmp</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">tmp-dir</span><span class="w">
</span><span class="w">        </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="l">/bin/sh</span><span class="w">
</span><span class="w">              </span>- -<span class="l">c</span><span class="w">
</span><span class="w">              </span>- <span class="s2">&#34;while [ $(netstat -plunt | grep tcp | wc -l | xargs) -ne 0 ]; do sleep 1; done&#34;</span><span class="w">
</span><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w">  </span><span class="c"># èµ„æºè¯·æ±‚ä¸é™åˆ¶</span><span class="w">
</span><span class="w">          </span><span class="c"># å¯¹äºæ ¸å¿ƒæœåŠ¡ï¼Œå»ºè®®è®¾ç½® requests = limitsï¼Œé¿å…èµ„æºç«äº‰</span><span class="w">
</span><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># HPA ä¼šä½¿ç”¨ requests è®¡ç®—èµ„æºåˆ©ç”¨ç‡</span><span class="w">
</span><span class="w">            </span><span class="c"># å»ºè®®å°† requests è®¾ä¸ºæœåŠ¡æ­£å¸¸çŠ¶æ€ä¸‹çš„ CPU ä½¿ç”¨ç‡ï¼ŒHPA çš„ç›®å‰æŒ‡æ ‡è®¾ä¸º 80%</span><span class="w">
</span><span class="w">            </span><span class="c"># æ‰€æœ‰å®¹å™¨çš„ requests æ€»é‡ä¸å»ºè®®ä¸º 2c/4G 4c/8G ç­‰å¸¸è§å€¼ï¼Œå› ä¸ºèŠ‚ç‚¹é€šå¸¸ä¹Ÿæ˜¯è¿™ä¸ªé…ç½®ï¼Œè¿™ä¼šå¯¼è‡´ Pod åªèƒ½è°ƒåº¦åˆ°æ›´å¤§çš„èŠ‚ç‚¹ä¸Šï¼Œé€‚å½“è°ƒå° requests ç­‰æ‰©å……å¯ç”¨çš„èŠ‚ç‚¹ç±»å‹ï¼Œä»è€Œæ‰©å……èŠ‚ç‚¹æ± ã€‚ </span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># limits - requests ä¸ºå…è®¸è¶…å–çš„èµ„æºé‡ï¼Œå»ºè®®ä¸º requests çš„ 1 åˆ° 2 å€ï¼Œé…Œæƒ…é…ç½®ã€‚</span><span class="w">
</span><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l">1000m</span><span class="w">
</span><span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="l">1Gi</span><span class="w">
</span><span class="w">        </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># å°†å®¹å™¨å±‚è®¾ä¸ºåªè¯»ï¼Œé˜²æ­¢å®¹å™¨æ–‡ä»¶è¢«ç¯¡æ”¹</span><span class="w">
</span><span class="w">          </span><span class="c">## å¦‚æœéœ€è¦å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå»ºè®®é¢å¤–æŒ‚è½½ emptyDir æ¥æä¾›å¯è¯»å†™çš„æ•°æ®å·</span><span class="w">
</span><span class="w">          </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span><span class="w">          </span><span class="c"># ç¦æ­¢ Pod åšä»»ä½•æƒé™æå‡</span><span class="w">
</span><span class="w">          </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">          </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="c"># drop ALL çš„æƒé™æ¯”è¾ƒä¸¥æ ¼ï¼Œå¯æŒ‰éœ€ä¿®æ”¹</span><span class="w">
</span><span class="w">            </span><span class="nt">drop</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">ALL</span><span class="w">
</span><span class="w">        </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w">  </span><span class="c"># è¦æ±‚ kubernetes 1.18+</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç›´æ¥ä½¿ç”¨å¥åº·æ£€æŸ¥æ¥å£å³å¯</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">  </span><span class="c"># æœ€å¤šæä¾›ç»™æœåŠ¡ 5s * 20 çš„å¯åŠ¨æ—¶é—´</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># spring çš„é€šç”¨å¥åº·æ£€æŸ¥è·¯å¾„</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="c"># Readiness probes are very important for a RollingUpdate to work properly,</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç®€å•èµ·è§å¯ç›´æ¥ä½¿ç”¨ livenessProbe ç›¸åŒçš„æ¥å£ï¼Œå½“ç„¶ä¹Ÿå¯é¢å¤–å®šä¹‰</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Utilization</span><span class="w">
</span><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">70</span><span class="w">
</span><span class="w"></span><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">policy/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodDisruptionBudget</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">minAvailable</span><span class="p">:</span><span class="w"> </span><span class="m">75</span><span class="l">%</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l">v3</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="ä¸€ä¼˜é›…åœæ­¢gracful-shutdownä¸-502504-æŠ¥é”™">ä¸€ã€ä¼˜é›…åœæ­¢ï¼ˆGracful Shutdownï¼‰ä¸ 502/504 æŠ¥é”™</h2>
<p>å¦‚æœ Pod æ­£åœ¨å¤„ç†å¤§é‡è¯·æ±‚ï¼ˆæ¯”å¦‚ 1000 QPS+ï¼‰æ—¶ï¼Œå› ä¸ºèŠ‚ç‚¹æ•…éšœæˆ–ã€Œç«ä»·èŠ‚ç‚¹ã€è¢«å›æ”¶ç­‰åŸå› è¢«é‡æ–°è°ƒåº¦ï¼Œ
ä½ å¯èƒ½ä¼šè§‚å¯Ÿåˆ°åœ¨å®¹å™¨è¢« terminate çš„ä¸€æ®µæ—¶é—´å†…å‡ºç°å°‘é‡ 502/504ã€‚</p>
<p>ä¸ºäº†ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦å…ˆç†è§£æ¸…æ¥š terminate ä¸€ä¸ª Pod çš„æµç¨‹ï¼š</p>
<ol>
<li>Pod çš„çŠ¶æ€è¢«è®¾ä¸ºã€ŒTerminatingã€ï¼Œï¼ˆå‡ ä¹ï¼‰åŒæ—¶è¯¥ Pod è¢«ä»æ‰€æœ‰å…³è”çš„ Service Endpoints ä¸­ç§»é™¤</li>
<li><code>preStop</code> é’©å­è¢«æ‰§è¡Œï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œæˆ–è€…ä¸€ä¸ªå¯¹ Pod ä¸­å®¹å™¨çš„ http è°ƒç”¨
<ol>
<li>å¦‚æœä½ çš„ç¨‹åºåœ¨æ”¶åˆ° SIGTERM ä¿¡å·æ—¶ï¼Œæ— æ³•ä¼˜é›…é€€å‡ºï¼Œå°±å¯ä»¥è€ƒè™‘ä½¿ç”¨ <code>preStop</code></li>
<li>å¦‚æœè®©ç¨‹åºæœ¬èº«æ”¯æŒä¼˜é›…é€€å‡ºæ¯”è¾ƒéº»çƒ¦çš„è¯ï¼Œç”¨ <code>preStop</code> å®ç°ä¼˜é›…é€€å‡ºæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹å¼</li>
</ol>
</li>
<li>å°† SIGTERM å‘é€ç»™ Pod ä¸­çš„æ‰€æœ‰å®¹å™¨</li>
<li>ç»§ç»­ç­‰å¾…ï¼Œç›´åˆ°è¶…è¿‡ <code>spec.terminationGracePeriodSeconds</code> è®¾å®šå¥½çš„æ—¶é—´ï¼Œè¿™ä¸ªå€¼é»˜è®¤ä¸º 30s
<ol>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªä¼˜é›…é€€å‡ºçš„ç­‰å¾…è®¡æ—¶æ˜¯ä¸ <code>preStop</code> åŒæ­¥å¼€å§‹çš„ï¼è€Œä¸”å®ƒä¹Ÿä¸ä¼šç­‰å¾… <code>preStop</code> ç»“æŸï¼</li>
</ol>
</li>
<li>å¦‚æœè¶…è¿‡äº† <code>spec.terminationGracePeriodSeconds</code> å®¹å™¨ä»ç„¶æ²¡æœ‰åœæ­¢ï¼Œk8s å°†ä¼šå‘é€ SIGKILL ä¿¡å·ç»™å®¹å™¨</li>
<li>è¿›ç¨‹å…¨éƒ¨ç»ˆæ­¢åï¼Œæ•´ä¸ª Pod å®Œå…¨è¢«æ¸…ç†æ‰</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼š1 å’Œ 2 ä¸¤ä¸ªå·¥ä½œæ˜¯å¼‚æ­¥å‘ç”Ÿçš„ï¼Œæ‰€ä»¥å¯èƒ½ä¼šå‡ºç°ã€ŒPod è¿˜åœ¨ Service Endpoints ä¸­ï¼Œä½†æ˜¯ <code>preStop</code> å·²ç»æ‰§è¡Œäº†ã€çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°è¿™ç§çŠ¶å†µçš„å‘ç”Ÿã€‚</p>
<p>äº†è§£äº†ä¸Šé¢çš„æµç¨‹åï¼Œæˆ‘ä»¬å°±èƒ½åˆ†æå‡ºä¸¤ç§é”™è¯¯ç å‡ºç°çš„åŸå› ï¼š</p>
<ul>
<li>502ï¼šåº”ç”¨ç¨‹åºåœ¨æ”¶åˆ° SIGTERM ä¿¡å·åç›´æ¥ç»ˆæ­¢äº†è¿è¡Œï¼Œå¯¼è‡´éƒ¨åˆ†è¿˜æ²¡æœ‰è¢«å¤„ç†å®Œçš„è¯·æ±‚ç›´æ¥ä¸­æ–­ï¼Œä»£ç†å±‚è¿”å› 502 è¡¨ç¤ºè¿™ç§æƒ…å†µ</li>
<li>504ï¼šService Endpoints ç§»é™¤ä¸å¤ŸåŠæ—¶ï¼Œåœ¨ Pod å·²ç»è¢«ç»ˆæ­¢åï¼Œä»ç„¶æœ‰ä¸ªåˆ«è¯·æ±‚è¢«è·¯ç”±åˆ°äº†è¯¥ Podï¼Œå¾—ä¸åˆ°å“åº”å¯¼è‡´ 504</li>
</ul>
<p>é€šå¸¸çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œåœ¨ Pod çš„ <code>preStop</code> æ­¥éª¤åŠ ä¸€ä¸ª 15s çš„ç­‰å¾…æ—¶é—´ã€‚
å…¶åŸç†æ˜¯ï¼šåœ¨ Pod å¤„ç† terminating çŠ¶æ€çš„æ—¶å€™ï¼Œå°±ä¼šè¢«ä» Service Endpoints ä¸­ç§»é™¤ï¼Œä¹Ÿå°±ä¸ä¼šå†æœ‰æ–°çš„è¯·æ±‚è¿‡æ¥äº†ã€‚
åœ¨ <code>preStop</code> ç­‰å¾… 15sï¼ŒåŸºæœ¬å°±èƒ½ä¿è¯æ‰€æœ‰çš„è¯·æ±‚éƒ½åœ¨å®¹å™¨æ­»æ‰ä¹‹å‰è¢«å¤„ç†å®Œæˆï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œç»å¤§éƒ¨åˆ†è¯·æ±‚çš„å¤„ç†æ—¶é—´éƒ½åœ¨ 300ms ä»¥å†…å§ï¼‰ã€‚</p>
<p>ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹ï¼Œå®ƒä½¿ Pod è¢«ç»ˆæ­¢æ—¶ï¼Œæ€»æ˜¯å…ˆç­‰å¾… 15sï¼Œå†å‘é€ SIGTERM ä¿¡å·ç»™å®¹å™¨ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="c"># æ·»åŠ ä¸‹é¢è¿™éƒ¨åˆ†</span><span class="w">
</span><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">/bin/sleep</span><span class="w">
</span><span class="w">            </span>- <span class="s2">&#34;15&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>æ›´å¥½çš„è§£å†³åŠæ³•ï¼Œæ˜¯ç›´æ¥ç­‰å¾…æ‰€æœ‰ tcp è¿æ¥éƒ½å…³é—­ï¼ˆéœ€è¦é•œåƒä¸­æœ‰ netstatï¼‰ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">      </span><span class="c"># æ·»åŠ ä¸‹é¢è¿™éƒ¨åˆ†</span><span class="w">
</span><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">/bin/sh</span><span class="w">
</span><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span><span class="w">            </span>- <span class="s2">&#34;while [ $(netstat -plunt | grep tcp | wc -l | xargs) -ne 0 ]; do sleep 1; done&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="k8s-istio-pod-prestop">å¦‚æœæˆ‘çš„æœåŠ¡è¿˜ä½¿ç”¨äº† Sidecar ä»£ç†ç½‘ç»œè¯·æ±‚ï¼Œè¯¥æ€ä¹ˆå¤„ç†ï¼Ÿ</h3>
<p>ä»¥æœåŠ¡ç½‘æ ¼ Istio ä¸ºä¾‹ï¼Œåœ¨ Envoy ä»£ç†äº† Pod æµé‡çš„æƒ…å†µä¸‹ï¼Œ502/504 çš„é—®é¢˜ä¼šå˜å¾—æ›´å¤æ‚ä¸€ç‚¹â€”â€”è¿˜éœ€è¦è€ƒè™‘ Sidecar ä¸ä¸»å®¹å™¨çš„å…³é—­é¡ºåºï¼š</p>
<ul>
<li>å¦‚æœåœ¨ Envoy å·²å…³é—­åï¼Œæœ‰æ–°çš„è¯·æ±‚å†è¿›æ¥ï¼Œå°†ä¼šå¯¼è‡´ 504ï¼ˆæ²¡äººå“åº”è¿™ä¸ªè¯·æ±‚äº†ï¼‰
<ul>
<li>æ‰€ä»¥ Envoy æœ€å¥½åœ¨ Terminating è‡³å°‘ 3s åæ‰èƒ½å…³ï¼Œç¡®ä¿ Istio ç½‘æ ¼é…ç½®å·²å®Œå…¨æ›´æ–°</li>
</ul>
</li>
<li>å¦‚æœåœ¨ Envoy è¿˜æ²¡åœæ­¢æ—¶ï¼Œä¸»å®¹å™¨å…ˆå…³é—­ï¼Œç„¶ååˆæœ‰æ–°çš„è¯·æ±‚å†è¿›æ¥ï¼ŒEnvoy å°†å› ä¸ºæ— æ³•è¿æ¥åˆ° upstream å¯¼è‡´ 503
<ul>
<li>æ‰€ä»¥ä¸»å®¹å™¨ä¹Ÿæœ€å¥½åœ¨ Terminating è‡³å°‘ 3s åï¼Œæ‰èƒ½å…³é—­ã€‚</li>
</ul>
</li>
<li>å¦‚æœä¸»å®¹å™¨å¤„ç†è¿˜æœªå¤„ç†å®Œé—ç•™è¯·æ±‚æ—¶ï¼ŒEnvoy æˆ–è€…ä¸»å®¹å™¨çš„å…¶ä¸­ä¸€ä¸ªåœæ­¢äº†ï¼Œä¼šå› ä¸º tcp è¿æ¥ç›´æ¥æ–­å¼€è¿æ¥å¯¼è‡´ 502
<ul>
<li>å› æ­¤ Envoy å¿…é¡»åœ¨ä¸»å®¹å™¨å¤„ç†å®Œé—ç•™è¯·æ±‚åï¼ˆå³æ²¡æœ‰ tcp è¿æ¥æ—¶ï¼‰ï¼Œæ‰èƒ½å…³é—­</li>
</ul>
</li>
</ul>
<p>æ‰€ä»¥æ€»ç»“ä¸‹ï¼šEnvoy åŠä¸»å®¹å™¨çš„ <code>preStop</code> éƒ½è‡³å°‘å¾—è®¾æˆ 3sï¼Œå¹¶ä¸”åœ¨ã€Œæ²¡æœ‰ tcp è¿æ¥ã€æ—¶ï¼Œæ‰èƒ½å…³é—­ï¼Œé¿å…å‡ºç° 502/503/504.</p>
<p>ä¸»å®¹å™¨çš„ä¿®æ”¹æ–¹æ³•åœ¨å‰æ–‡ä¸­å·²ç»å†™è¿‡äº†ï¼Œä¸‹é¢ä»‹ç»ä¸‹ Envoy çš„ä¿®æ”¹æ–¹æ³•ã€‚</p>
<p>å’Œä¸»å®¹å™¨ä¸€æ ·ï¼ŒEnvoy ä¹Ÿèƒ½ç›´æ¥åŠ  <code>preStop</code>ï¼Œä¿®æ”¹ <code>istio-sidecar-injector</code> è¿™ä¸ª <code>configmap</code>ï¼Œåœ¨ sidecar é‡Œæ·»åŠ  preStop sleep å‘½ä»¤:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="w">    </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">istio-proxy</span><span class="w">
</span><span class="w">      </span><span class="c"># æ·»åŠ ä¸‹é¢è¿™éƒ¨åˆ†</span><span class="w">
</span><span class="w">      </span><span class="nt">lifecycle</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">preStop</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">exec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="l">/bin/sh</span><span class="w">
</span><span class="w">            </span>- -<span class="l">c</span><span class="w">
</span><span class="w">            </span>- <span class="s2">&#34;while [ $(netstat -plunt | grep tcp | grep -v envoy | wc -l | xargs) -ne 0 ]; do sleep 1; done&#34;</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="å‚è€ƒ">å‚è€ƒ</h3>
<ul>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace" target="_blank" rel="noopener noreferrer">Kubernetes best practices: terminating with grace</a></li>
<li><a href="https://medium.com/flant-com/kubernetes-graceful-shutdown-nginx-php-fpm-d5ab266963c2" target="_blank" rel="noopener noreferrer">Graceful shutdown in Kubernetes is not always trivial</a></li>
</ul>
<h2 id="k8s-hpa">äºŒã€æœåŠ¡çš„ä¼¸ç¼©é…ç½® - HPA</h2>
<p>Kubernetes å®˜æ–¹ä¸»è¦æ”¯æŒåŸºäº Pod CPU çš„ä¼¸ç¼©ï¼Œè¿™æ˜¯åº”ç”¨æœ€ä¸ºå¹¿æ³›çš„ä¼¸ç¼©æŒ‡æ ‡ï¼Œéœ€è¦éƒ¨ç½² <a href="https://github.com/kubernetes-sigs/metrics-server" target="_blank" rel="noopener noreferrer">metrics-server</a> æ‰å¯ä½¿ç”¨ã€‚</p>
<p>å…ˆå›é¡¾ä¸‹å‰é¢ç»™å‡ºçš„ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2 </span><span class="w"> </span><span class="c"># k8s 1.23+ æ­¤ API å·²ç» GA</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">my-app</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">prod</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Utilization</span><span class="w">
</span><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">70</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="1-å½“å‰æŒ‡æ ‡å€¼çš„è®¡ç®—æ–¹å¼">1. å½“å‰æŒ‡æ ‡å€¼çš„è®¡ç®—æ–¹å¼</h3>
<p>HPA é»˜è®¤ä½¿ç”¨ Pod çš„å½“å‰æŒ‡æ ‡è¿›è¡Œè®¡ç®—ï¼Œä»¥ CPU ä¸ºä¾‹ï¼Œå…¶è®¡ç®—å…¬å¼ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ã€ŒPod çš„ CPU åˆ©ç”¨ç‡ã€= 100% * ã€Œæ‰€æœ‰ Container çš„ CPU ç”¨é‡ä¹‹å’Œã€/ã€Œæ‰€æœ‰ Container çš„ CPU requests ä¹‹å’Œã€
</code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„åˆ†æ¯æ˜¯æ€»çš„ requests é‡ï¼Œè€Œä¸æ˜¯ limits.</p>
<h4 id="11-å­˜åœ¨çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•">1.1 å­˜åœ¨çš„é—®é¢˜ä¸è§£å†³æ–¹æ³•</h4>
<p>åœ¨ Pod åªæœ‰ä¸€ä¸ªå®¹å™¨æ—¶è¿™æ²¡å•¥é—®é¢˜ï¼Œä½†æ˜¯å½“ Pod æ³¨å…¥äº† envoy ç­‰ sidecar æ—¶ï¼Œè¿™å°±ä¼šæœ‰é—®é¢˜äº†ã€‚</p>
<p>å› ä¸º Istio çš„ Sidecar requests é»˜è®¤ä¸º <code>100m</code> ä¹Ÿå°±æ˜¯ 0.1 æ ¸ã€‚
åœ¨æœª tuning çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡è´Ÿè½½ä¸€é«˜ï¼Œsidecar çš„å®é™…ç”¨é‡å¾ˆå®¹æ˜“å°±èƒ½æ¶¨åˆ° 0.2-0.4 æ ¸ã€‚
æŠŠè¿™ä¸¤ä¸ªå€¼ä»£å…¥å‰é¢çš„å…¬å¼ï¼Œä¼šå‘ç° <strong>å¯¹äº QPS è¾ƒé«˜çš„æœåŠ¡ï¼Œæ·»åŠ  Sidecar åï¼Œã€ŒPod çš„ CPU åˆ©ç”¨ç‡ã€å¯èƒ½ä¼šé«˜äºã€Œåº”ç”¨å®¹å™¨çš„ CPU åˆ©ç”¨ç‡ã€</strong>ï¼Œé€ æˆä¸å¿…è¦çš„æ‰©å®¹ã€‚</p>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>æ–¹æ³•ä¸€ï¼šé’ˆå¯¹æ¯ä¸ªæœåŠ¡çš„ CPU ä½¿ç”¨æƒ…å†µï¼Œä¸º sidecar è®¾ç½®ä¸åŒçš„ requests/limits</li>
<li>æ–¹æ³•äºŒï¼šä½¿ç”¨ KEDA ç­‰ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œè·å–åˆ°åº”ç”¨ç¨‹åºçš„ CPU åˆ©ç”¨ç‡ï¼ˆæ’é™¤æ‰ Sidecarï¼‰ï¼Œä½¿ç”¨å®ƒè¿›è¡Œæ‰©ç¼©å®¹</li>
<li>æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ k8s 1.20 æä¾›çš„ alpha ç‰¹æ€§ï¼š<a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#container-resource-metrics" target="_blank" rel="noopener noreferrer">Container Resourse Metrics</a>.</li>
</ul>
<h4 id="2-hpa-çš„æ‰©ç¼©å®¹ç®—æ³•">2. HPA çš„æ‰©ç¼©å®¹ç®—æ³•</h4>
<p>HPA ä»€ä¹ˆæ—¶å€™ä¼šæ‰©å®¹ï¼Œè¿™ä¸€ç‚¹æ˜¯å¾ˆå¥½ç†è§£çš„ã€‚ä½†æ˜¯ HPA çš„ç¼©å®¹ç­–ç•¥ï¼Œä¼šæœ‰äº›è¿·æƒ‘ï¼Œä¸‹é¢ç®€å•åˆ†æä¸‹ã€‚</p>
<ol>
<li>HPA çš„ã€Œç›®æ ‡æŒ‡æ ‡ã€å¯ä»¥ä½¿ç”¨ä¸¤ç§å½¢å¼ï¼šç»å¯¹åº¦é‡æŒ‡æ ‡å’Œèµ„æºåˆ©ç”¨ç‡ã€‚
<ul>
<li>ç»å¯¹åº¦é‡æŒ‡æ ‡ï¼šæ¯”å¦‚ CPUï¼Œå°±æ˜¯è®¾å®šç»å¯¹æ ¸æ•°ã€‚</li>
<li>èµ„æºåˆ©ç”¨ç‡ï¼ˆèµ„æºä½¿ç”¨é‡/èµ„æºè¯·æ±‚ * 100%ï¼‰ï¼šåœ¨ Pod è®¾ç½®äº†èµ„æºè¯·æ±‚æ—¶ï¼Œå¯ä»¥ä½¿ç”¨èµ„æºåˆ©ç”¨ç‡è¿›è¡Œ Pod ä¼¸ç¼©ã€‚</li>
</ul>
</li>
<li>HPA çš„ã€Œå½“å‰æŒ‡æ ‡ã€æ˜¯ä¸€æ®µæ—¶é—´å†…æ‰€æœ‰ Pods çš„å¹³å‡å€¼ï¼Œä¸æ˜¯å³°å€¼ã€‚Pod çš„æŒ‡æ ‡æ˜¯å…¶ä¸­æ‰€æœ‰å®¹å™¨æŒ‡æ ‡ä¹‹å’Œã€‚</li>
</ol>
<p>HPA çš„æ‰©ç¼©å®¹ç®—æ³•ä¸ºï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">æœŸæœ›å‰¯æœ¬æ•° = ceil[å½“å‰å‰¯æœ¬æ•° * ( å½“å‰æŒ‡æ ‡ / ç›®æ ‡æŒ‡æ ‡ )]
</code></pre></td></tr></table>
</div>
</div><p>ä»ä¸Šé¢çš„å‚æ•°å¯ä»¥çœ‹åˆ°ï¼š</p>
<ol>
<li>åªè¦ã€Œå½“å‰æŒ‡æ ‡ã€è¶…è¿‡äº†ç›®æ ‡æŒ‡æ ‡ï¼Œå°±ä¸€å®šä¼šå‘ç”Ÿæ‰©å®¹ã€‚</li>
<li><code>å½“å‰æŒ‡æ ‡ / ç›®æ ‡æŒ‡æ ‡</code>è¦å°åˆ°ä¸€å®šçš„ç¨‹åº¦ï¼Œæ‰ä¼šè§¦å‘ç¼©å®¹ã€‚
<ol>
<li>æ¯”å¦‚åŒå‰¯æœ¬çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°æ¯”å€¼è¦å°äºç­‰äº 1/2ï¼Œæ‰ä¼šç¼©å®¹åˆ°å•å‰¯æœ¬ã€‚</li>
<li>ä¸‰å‰¯æœ¬çš„æƒ…å†µä¸‹ï¼Œä¸Šè¿°æ¯”å€¼çš„ä¸´ç•Œç‚¹æ˜¯ 2/3ã€‚</li>
<li>äº”å‰¯æœ¬æ—¶ä¸´ç•Œå€¼æ˜¯ 4/5ï¼Œ100å‰¯æœ¬æ—¶ä¸´ç•Œå€¼æ˜¯ 99/100ï¼Œä¾æ­¤ç±»æ¨ã€‚</li>
<li>å¦‚æœ <code>å½“å‰æŒ‡æ ‡ / ç›®æ ‡æŒ‡æ ‡</code> ä» 1 é™åˆ° 0.5ï¼Œå‰¯æœ¬çš„æ•°é‡å°†ä¼šå‡åŠã€‚ï¼ˆè™½ç„¶è¯´å‰¯æœ¬æ•°è¶Šå¤šï¼Œå‘ç”Ÿè¿™ä¹ˆå¤§å˜åŒ–çš„å¯èƒ½æ€§å°±è¶Šå°ã€‚ï¼‰</li>
</ol>
</li>
<li><code>å½“å‰å‰¯æœ¬æ•° / ç›®æ ‡æŒ‡æ ‡</code>çš„å€¼è¶Šå¤§ï¼Œã€Œå½“å‰æŒ‡æ ‡ã€çš„æ³¢åŠ¨å¯¹ã€ŒæœŸæœ›å‰¯æœ¬æ•°ã€çš„å½±å“å°±è¶Šå¤§ã€‚</li>
</ol>
<p>ä¸ºäº†é˜²æ­¢æ‰©ç¼©å®¹è¿‡äºæ•æ„Ÿï¼Œå®ƒè¿˜æœ‰å‡ ä¸ªå»¶æ—¶ç›¸å…³çš„å‚æ•°ï¼š</p>
<ol>
<li>HPA Loop å»¶æ—¶ï¼šé»˜è®¤ 15 ç§’ï¼Œæ¯ 15 ç§’é’Ÿè¿›è¡Œä¸€æ¬¡ HPA æ‰«æã€‚</li>
<li><code>--horizontal-pod-autoscaler-cpu-initialization-period</code>:</li>
<li>ç¼©å®¹å†·å´æ—¶é—´ï¼šé»˜è®¤ 5 åˆ†é’Ÿã€‚</li>
</ol>
<h3 id="3-hpa-çš„æœŸæœ›å€¼è®¾æˆå¤šå°‘åˆé€‚">3. HPA çš„æœŸæœ›å€¼è®¾æˆå¤šå°‘åˆé€‚</h3>
<p>è¿™ä¸ªéœ€è¦é’ˆå¯¹æ¯ä¸ªæœåŠ¡çš„å…·ä½“æƒ…å†µï¼Œå…·ä½“åˆ†æã€‚</p>
<p>ä»¥æœ€å¸¸ç”¨çš„æŒ‰ CPU å€¼ä¼¸ç¼©ä¸ºä¾‹ï¼Œ</p>
<ul>
<li>æ ¸å¿ƒæœåŠ¡
<ul>
<li>requests/limits å€¼: å»ºè®®è®¾æˆç›¸ç­‰çš„ï¼Œä¿è¯<a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/" target="_blank" rel="noopener noreferrer">æœåŠ¡è´¨é‡ç­‰çº§</a>ä¸º Guaranteed
<ul>
<li>éœ€è¦æ³¨æ„ CPU è·Ÿ Memory çš„ limits é™åˆ¶ç­–ç•¥æ˜¯ä¸åŒçš„ï¼ŒCPU æ˜¯çœŸæ­£åœ°é™åˆ¶äº†ä¸Šé™ï¼Œè€Œ Memory æ˜¯ç”¨è¶…äº†å°±å¹²æ‰å®¹å™¨ï¼ˆOOMKilledï¼‰</li>
<li>k8s ä¸€ç›´ä½¿ç”¨ cgroups v1 (<code>cpu_shares</code>/<code>memory.limit_in_bytes</code>)æ¥é™åˆ¶ cpu/memoryï¼Œä½†æ˜¯å¯¹äº <code>Guaranteed</code> çš„ Pods è€Œè¨€ï¼Œå†…å­˜å¹¶ä¸èƒ½å®Œå…¨é¢„ç•™ï¼Œèµ„æºç«äº‰æ€»æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„ã€‚1.22 æœ‰ alpha ç‰¹æ€§æ”¹ç”¨ cgroups v2ï¼Œå¯ä»¥å…³æ³¨ä¸‹ã€‚</li>
</ul>
</li>
<li>HPA: ä¸€èˆ¬æ¥è¯´ï¼ŒæœŸæœ›å€¼è®¾ä¸º 60% åˆ° 70% å¯èƒ½æ˜¯æ¯”è¾ƒåˆé€‚çš„ï¼Œæœ€å°å‰¯æœ¬æ•°å»ºè®®è®¾ä¸º 2 - 5. ï¼ˆä»…ä¾›å‚è€ƒï¼‰</li>
<li>PodDisruptionBudget: å»ºè®®æŒ‰æœåŠ¡çš„å¥å£®æ€§ä¸ HPA æœŸæœ›å€¼ï¼Œæ¥è®¾ç½® PDBï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œå°±å…ˆç•¥è¿‡äº†</li>
</ul>
</li>
<li>éæ ¸å¿ƒæœåŠ¡
<ul>
<li>requests/limits å€¼: å»ºè®® requests è®¾ä¸º limits çš„ 0.6 - 0.9 å€ï¼ˆä»…ä¾›å‚è€ƒï¼‰ï¼Œå¯¹åº”çš„æœåŠ¡è´¨é‡ç­‰çº§ä¸º Burstable
<ul>
<li>ä¹Ÿå°±æ˜¯è¶…å–äº†èµ„æºï¼Œè¿™æ ·åšä¸»è¦çš„è€ƒé‡ç‚¹æ˜¯ï¼Œå¾ˆå¤šéæ ¸å¿ƒæœåŠ¡è´Ÿè½½éƒ½å¾ˆä½ï¼Œæ ¹æœ¬è·‘ä¸åˆ° limits è¿™ä¹ˆé«˜ï¼Œé™ä½ requests å¯ä»¥æé«˜é›†ç¾¤èµ„æºåˆ©ç”¨ç‡ï¼Œä¹Ÿä¸ä¼šæŸå®³æœåŠ¡ç¨³å®šæ€§ã€‚</li>
</ul>
</li>
<li>HPA: å› ä¸º requests é™ä½äº†ï¼Œæˆ‘ä»¬å¯ä»¥æé«˜ HPA åˆ°æœŸæœ›å€¼ï¼Œæ¯”å¦‚ 80% ~ 90%ï¼Œæœ€å°å‰¯æœ¬æ•°å»ºè®®è®¾ä¸º 1 - 3. ï¼ˆä»…ä¾›å‚è€ƒï¼‰</li>
<li>PodDisruptionBudget: éæ ¸å¿ƒæœåŠ¡å˜›ï¼Œä¿è¯æœ€å°‘å‰¯æœ¬æ•°ä¸º 1 å°±è¡Œäº†ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-hpa-çš„å¸¸è§é—®é¢˜">4. HPA çš„å¸¸è§é—®é¢˜</h3>
<h4 id="41-pod-æ‰©å®¹---é¢„çƒ­é™·é˜±">4.1. Pod æ‰©å®¹ - é¢„çƒ­é™·é˜±</h4>
<blockquote>
<p>é¢„çƒ­ï¼šJava/C# è¿™ç±»è¿è¡Œåœ¨è™šæ‹Ÿæœºä¸Šçš„è¯­è¨€ï¼Œç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ°æŸäº›åŠŸèƒ½æ—¶ï¼Œå¾€å¾€éœ€è¦åˆå§‹åŒ–ä¸€äº›èµ„æºï¼Œä¾‹å¦‚ã€ŒJIT å³æ—¶ç¼–è¯‘ã€ã€‚
å¦‚æœä»£ç é‡Œè¿˜åº”ç”¨äº†åŠ¨æ€ç±»åŠ è½½ä¹‹ç±»çš„åŠŸèƒ½ï¼Œå°±å¾ˆå¯èƒ½å¯¼è‡´å¾®æœåŠ¡æŸäº› API ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œå“åº”ç‰¹åˆ«æ…¢ï¼ˆè¦åŠ¨æ€ç¼–è¯‘ classï¼‰ã€‚
å› æ­¤ Pod åœ¨æä¾›æœåŠ¡å‰ï¼Œéœ€è¦æå‰ã€Œé¢„çƒ­ï¼ˆslow_startï¼‰ã€ä¸€æ¬¡è¿™äº›æ¥å£ï¼Œå°†éœ€è¦ç”¨åˆ°çš„èµ„æºæå‰åˆå§‹åŒ–å¥½ã€‚</p>
</blockquote>
<p>åœ¨è´Ÿè½½å¾ˆé«˜çš„æƒ…å†µä¸‹ï¼ŒHPA ä¼šè‡ªåŠ¨æ‰©å®¹ã€‚
ä½†æ˜¯å¦‚æœæ‰©å®¹çš„ Pod éœ€è¦é¢„çƒ­ï¼Œå°±å¯èƒ½ä¼šé‡åˆ°ã€Œé¢„çƒ­é™·é˜±ã€ã€‚</p>
<p>åœ¨æœ‰å¤§é‡ç”¨æˆ·è®¿é—®çš„æ—¶å€™ï¼Œä¸è®ºä½¿ç”¨ä½•ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œåªè¦è¯·æ±‚è¢«è½¬å‘åˆ°æ–°å»ºçš„ Pod ä¸Šï¼Œè¿™ä¸ªè¯·æ±‚å°±ä¼šã€Œå¡ä½ã€ã€‚
å¦‚æœè¯·æ±‚é€Ÿåº¦å¤ªå¿«ï¼ŒPod å¯åŠ¨çš„ç¬é—´ã€Œå¡ä½ã€çš„è¯·æ±‚å°±è¶Šå¤šï¼Œè¿™å°†ä¼šå¯¼è‡´æ–°å»º Pod å› ä¸ºå‹åŠ›è¿‡å¤§è€Œå®æ‰ã€‚
ç„¶å Pod ä¸€é‡å¯å°±è¢«å‹å®ï¼Œè¿›å…¥ CrashLoopBackoff å¾ªç¯ã€‚</p>
<p>å¦‚æœæ˜¯åœ¨ä½¿ç”¨å¤šçº¿ç¨‹åšè´Ÿè½½æµ‹è¯•æ—¶ï¼Œæ•ˆæœæ›´æ˜æ˜¾ï¼š50 ä¸ªçº¿ç¨‹åœ¨ä¸é—´æ–­åœ°è¯·æ±‚ï¼Œ
åˆ«çš„ Pod å“åº”æ—¶é—´æ˜¯ã€Œæ¯«ç§’çº§ã€ï¼Œè€Œæ–°å»ºçš„ Pod çš„é¦–æ¬¡å“åº”æ˜¯ã€Œç§’çº§ã€ã€‚å‡ ä¹æ˜¯ä¸€ç¬é—´ï¼Œ50 ä¸ªçº¿ç¨‹å°±ä¼šå…¨éƒ¨é™·åœ¨æ–°å»ºçš„ Pod è¿™é‡Œã€‚
è€Œæ–°å»ºçš„ Pod åœ¨å¯åŠ¨çš„ç¬é—´å¯èƒ½ç‰¹åˆ«è„†å¼±ï¼Œç¬é—´çš„ 50 ä¸ªå¹¶å‘è¯·æ±‚å°±å¯ä»¥å°†å®ƒå‹å®ã€‚
ç„¶å Pod ä¸€é‡å¯å°±è¢«å‹å®ï¼Œè¿›å…¥ CrashLoopBackoff å¾ªç¯ã€‚</p>
<p><strong>è§£å†³æ–¹æ³•</strong>ï¼š</p>
<p>å¯ä»¥åœ¨ã€Œåº”ç”¨å±‚é¢ã€è§£å†³ï¼š</p>
<ol>
<li>åœ¨å¯åŠ¨æ¢é’ˆ API çš„åç«¯æ§åˆ¶å™¨é‡Œé¢ï¼Œä¾æ¬¡è°ƒç”¨æ‰€æœ‰éœ€è¦é¢„çƒ­çš„æ¥å£æˆ–è€…å…¶ä»–æ–¹å¼ï¼Œæå‰åˆå§‹åŒ–å¥½æ‰€æœ‰èµ„æºã€‚
<ol>
<li>å¯åŠ¨æ¢é’ˆçš„æ§åˆ¶å™¨ä¸­ï¼Œå¯ä»¥é€šè¿‡ <code>localhost</code> å›ç¯åœ°å€è°ƒç”¨å®ƒè‡ªèº«çš„æ¥å£ã€‚</li>
</ol>
</li>
<li>ä½¿ç”¨ã€ŒAOT é¢„ç¼–è¯‘ã€æŠ€æœ¯ï¼šé¢„çƒ­ï¼Œé€šå¸¸éƒ½æ˜¯å› ä¸ºã€ŒJIT å³æ—¶ç¼–è¯‘ã€å¯¼è‡´çš„é—®é¢˜ï¼Œåœ¨éœ€è¦ç”¨åˆ°æ—¶å®ƒæ‰ç¼–è¯‘ã€‚è€Œ AOT æ˜¯é¢„å…ˆç¼–è¯‘ï¼Œåœ¨ä½¿ç”¨å‰å®Œæˆç¼–è¯‘ï¼Œå› æ­¤ AOT èƒ½è§£å†³é¢„çƒ­çš„é—®é¢˜ã€‚</li>
</ol>
<p>ä¹Ÿå¯ä»¥åœ¨ã€ŒåŸºç¡€è®¾æ–½å±‚é¢ã€è§£å†³ï¼š</p>
<ol>
<li>åƒ AWS ALB TargetGroup ä»¥åŠå…¶ä»–äº‘æœåŠ¡å•†çš„ ALB æœåŠ¡ï¼Œé€šå¸¸éƒ½å¯ä»¥è®¾ç½® <code>slow_start</code> æ—¶é•¿ï¼Œå³å¯¹æ–°åŠ å…¥çš„å®ä¾‹ï¼Œä½¿ç”¨ä¸€å®šæ—¶é—´æ…¢æ…¢åœ°æŠŠæµé‡åˆ‡è¿‡å»ï¼Œæœ€ç»ˆè¾¾åˆ°é¢„æœŸçš„è´Ÿè½½å‡è¡¡çŠ¶æ€ã€‚è¿™ä¸ªå¯ä»¥è§£å†³æœåŠ¡é¢„çƒ­é—®é¢˜ã€‚</li>
<li>Envoy ä¹Ÿå·²ç»æ”¯æŒ <code>slow_start</code> æ¨¡å¼ï¼Œæ”¯æŒåœ¨ä¸€ä¸ªè®¾ç½®å¥½çš„æ—¶é—´çª—å£å†…ï¼ŒæŠŠæµé‡æ…¢æ…¢è´Ÿè½½åˆ°æ–°åŠ å…¥çš„å®ä¾‹ä¸Šï¼Œè¾¾æˆé¢„çƒ­æ•ˆæœã€‚</li>
</ol>
<h4 id="42-hpa-æ‰©ç¼©å®¹è¿‡äºæ•æ„Ÿå¯¼è‡´-pod-æ•°é‡éœ‡è¡">4.2. HPA æ‰©ç¼©å®¹è¿‡äºæ•æ„Ÿï¼Œå¯¼è‡´ Pod æ•°é‡éœ‡è¡</h4>
<p>é€šå¸¸æ¥è®²ï¼ŒEKS ä¸Šç»å¤§éƒ¨åˆ†è´Ÿè½½éƒ½åº”è¯¥é€‰æ‹©ä½¿ç”¨ CPU è¿›è¡Œæ‰©ç¼©å®¹ã€‚å› ä¸º CPU é€šå¸¸èƒ½å¾ˆå¥½çš„åæ˜ æœåŠ¡çš„è´Ÿè½½æƒ…å†µ</p>
<p>ä½†æ˜¯æœ‰äº›æœåŠ¡ä¼šå­˜åœ¨å…¶ä»–å½±å“ CPU ä½¿ç”¨ç‡çš„å› ç´ ï¼Œå¯¼è‡´ä½¿ç”¨ CPU æ‰©ç¼©å®¹å˜å¾—ä¸é‚£ä¹ˆå¯é ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æœ‰äº› Java æœåŠ¡å †å†…å­˜è®¾å¾—å¾ˆå¤§ï¼ŒGC pause ä¹Ÿè®¾å¾—æ¯”è¾ƒé•¿ï¼Œå› æ­¤å†…å­˜ GC ä¼šé€ æˆ CPU é—´æ­‡æ€§é£™å‡ï¼ŒCPU ç›‘æ§ä¼šæœ‰å¤§é‡çš„å°–å³°ã€‚</li>
<li>æœ‰äº›æœåŠ¡æœ‰å®šæ—¶ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ä¸€è¿è¡Œ CPU å°±æ¶¨ï¼Œä½†æ˜¯è¿™è·ŸæœåŠ¡çš„ QPS æ˜¯æ— å…³çš„</li>
<li>æœ‰äº›æœåŠ¡å¯èƒ½ä¸€è¿è¡Œ CPU å°±ä¼šç«‹å³å¤„äºä¸€ä¸ªé«˜ä½çŠ¶æ€ï¼Œå®ƒå¯èƒ½å¸Œæœ›ä½¿ç”¨åˆ«çš„ä¸šåŠ¡ä¾§æŒ‡æ ‡æ¥è¿›è¡Œæ‰©å®¹ï¼Œè€Œä¸æ˜¯ CPU.</li>
</ul>
<p>å› ä¸ºä¸Šè¿°é—®é¢˜å­˜åœ¨ï¼Œä½¿ç”¨ CPU æ‰©ç¼©å®¹ï¼Œå°±å¯èƒ½ä¼šé€ æˆæœåŠ¡é¢‘ç¹çš„æ‰©å®¹ç„¶åç¼©å®¹ï¼Œæˆ–è€…æ— é™æ‰©å®¹ã€‚
è€Œæœ‰äº›æœåŠ¡ï¼ˆå¦‚æˆ‘ä»¬çš„ã€Œæ¨èæœåŠ¡ã€ï¼‰ï¼Œå¯¹ã€Œæ‰©å®¹ã€å’Œã€Œç¼©å®¹ã€éƒ½æ˜¯æ¯”è¾ƒæ•æ„Ÿçš„ï¼Œæ¯æ¬¡æ‰©ç¼©éƒ½ä¼šé€ æˆæœåŠ¡å¯ç”¨ç‡æŠ–åŠ¨ã€‚</p>
<p>å¯¹è¿™ç±»æœåŠ¡è€Œè¨€ï¼ŒHPA æœ‰è¿™å‡ ç§è°ƒæ•´ç­–ç•¥ï¼š</p>
<ul>
<li>é€‰æ‹©ä½¿ç”¨ <strong>QPS</strong> ç­‰ç›¸å¯¹æ¯”è¾ƒå¹³æ»‘ï¼Œæ²¡æœ‰ GC è¿™ç±»å¹²æ‰°çš„æŒ‡æ ‡æ¥è¿›è¡Œæ‰©ç¼©å®¹ï¼Œè¿™éœ€è¦å€ŸåŠ© KEDA ç­‰ç¤¾åŒºç»„ä»¶ã€‚</li>
<li>å¯¹ kubernetes 1.18+ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ HPA çš„ <code>behavior.scaleDown</code> å’Œ <code>behavior.scaleUp</code> ä¸¤ä¸ªå‚æ•°ï¼Œæ§åˆ¶æ¯æ¬¡æ‰©ç¼©å®¹çš„æœ€å¤š pod æ•°é‡æˆ–è€…æ¯”ä¾‹ã€‚ ç¤ºä¾‹å¦‚ä¸‹ï¼š</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nn">---</span><span class="w">
</span><span class="w"></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v2beta2</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">
</span><span class="w">  </span><span class="nt">metrics</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Resource</span><span class="w">
</span><span class="w">    </span><span class="nt">resource</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">cpu</span><span class="w">
</span><span class="w">      </span><span class="nt">target</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Utilization</span><span class="w">
</span><span class="w">        </span><span class="nt">averageUtilization</span><span class="p">:</span><span class="w"> </span><span class="m">50</span><span class="w">  </span><span class="c"># æœŸæœ›çš„ CPU å¹³å‡å€¼</span><span class="w">
</span><span class="w">  </span><span class="nt">behavior</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">scaleUp</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">stabilizationWindowSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c"># é»˜è®¤ä¸º 0ï¼Œåªä½¿ç”¨å½“å‰å€¼è¿›è¡Œæ‰©ç¼©å®¹</span><span class="w">
</span><span class="w">      </span><span class="nt">policies</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">180</span><span class="w">  </span><span class="c"># æ¯ 3 åˆ†é’Ÿæœ€å¤šæ‰©å®¹ 5% çš„ Pods</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Percent</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">      </span>- <span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">  </span><span class="c"># æ¯åˆ†é’Ÿæœ€å¤šæ‰©å®¹ 1 ä¸ª Podï¼Œæ‰©çš„æ…¢ä¸€ç‚¹ä¸»è¦æ˜¯ä¸ºäº†ä¸€ä¸ªä¸ªåœ°é¢„çƒ­ï¼Œé¿å…ä¸€æ¬¡æ‰©å®¹å¤ªå¤šæœªé¢„çƒ­çš„ Pods å¯¼è‡´æœåŠ¡å¯ç”¨ç‡å‰§çƒˆæŠ–åŠ¨</span><span class="w">
</span><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Pods</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">      </span><span class="nt">selectPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Min </span><span class="w"> </span><span class="c"># é€‰æ‹©æœ€å°çš„ç­–ç•¥</span><span class="w">
</span><span class="w">    </span><span class="c"># ä»¥ä¸‹çš„ä¸€åˆ‡é…ç½®ï¼Œéƒ½æ˜¯ä¸ºäº†æ›´å¹³æ»‘åœ°ç¼©å®¹</span><span class="w">
</span><span class="w">    </span><span class="nt">scaleDown</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">stabilizationWindowSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w">  </span><span class="c"># ä½¿ç”¨è¿‡å» 10 mins çš„æœ€å¤§ cpu å€¼è¿›è¡Œç¼©å®¹è®¡ç®—ï¼Œé¿å…è¿‡å¿«ç¼©å®¹</span><span class="w">
</span><span class="w">      </span><span class="nt">policies</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Percent </span><span class="w"> </span><span class="c"># æ¯ 3 mins æœ€å¤šç¼©å®¹ `ceil[å½“å‰å‰¯æœ¬æ•° * 5%]` ä¸ª podï¼ˆ20 ä¸ª pod ä»¥å†…ï¼Œä¸€æ¬¡åªç¼©å®¹ 1 ä¸ª podï¼‰</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">180</span><span class="w">
</span><span class="w">      </span>- <span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Pods </span><span class="w"> </span><span class="c"># æ¯ 1 mins æœ€å¤šç¼©å®¹ 1 ä¸ª pod</span><span class="w">
</span><span class="w">        </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">      </span><span class="nt">selectPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Min </span><span class="w"> </span><span class="c"># ä¸Šé¢çš„ policies åˆ—è¡¨ï¼Œåªç”Ÿæ•ˆå…¶ä¸­æœ€å°çš„å€¼ä½œä¸ºç¼©å®¹é™åˆ¶ï¼ˆä¿è¯å¹³æ»‘ç¼©å®¹ï¼‰</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>è€Œå¯¹äºæ‰©å®¹ä¸å¤Ÿå¹³æ»‘è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘æä¾›ç±»ä¼¼ AWS ALB TargetGroup <code>slow_start</code> çš„åŠŸèƒ½ï¼Œåœ¨æ‰©å®¹æ—¶ç¼“æ…¢å°†æµé‡åˆ‡åˆ°æ–° Pod ä¸Šï¼Œä»¥å®ç°é¢„çƒ­æœåŠ¡ï¼ˆJVM é¢„çƒ­ä»¥åŠæœ¬åœ°ç¼“å­˜é¢„çƒ­ï¼‰ï¼Œè¿™æ ·å°±èƒ½è¾¾åˆ°æ¯”è¾ƒå¥½çš„å¹³æ»‘æ‰©å®¹æ•ˆæœã€‚</p>
<h3 id="5-hpa-æ³¨æ„äº‹é¡¹">5. HPA æ³¨æ„äº‹é¡¹</h3>
<p>æ³¨æ„ kubectl 1.23 ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œé»˜è®¤ä½¿ç”¨ <code>hpa.v1.autoscaling</code> æ¥æŸ¥è¯¢ HPA é…ç½®ï¼Œ<code>v2beta2</code> ç›¸å…³çš„å‚æ•°ä¼šè¢«ç¼–ç åˆ° <code>metadata.annotations</code> ä¸­ã€‚</p>
<p>æ¯”å¦‚ <code>behavior</code> å°±ä¼šè¢«ç¼–ç åˆ° <code>autoscaling.alpha.kubernetes.io/behavior</code> è¿™ä¸ª key æ‰€å¯¹åº”çš„å€¼ä¸­ã€‚</p>
<p>å› æ­¤å¦‚æœä½¿ç”¨äº† v2beta2 çš„ HPAï¼Œä¸€å®šè¦æ˜ç¡®æŒ‡å®šä½¿ç”¨ <code>v2beta2</code> ç‰ˆæœ¬çš„ HPAï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get hpa.v2beta2.autoscaling
</code></pre></td></tr></table>
</div>
</div><p>å¦åˆ™ä¸å°å¿ƒåŠ¨åˆ° <code>annotations</code> ä¸­ç¼–ç çš„æŸäº›å‚æ•°ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ„æ–™ä¹‹å¤–çš„æ•ˆæœï¼Œç”šè‡³ç›´æ¥æŠŠæ§åˆ¶é¢æå´©&hellip;
æ¯”å¦‚è¿™ä¸ª issue: <a href="https://github.com/kubernetes/kubernetes/issues/107038" target="_blank" rel="noopener noreferrer">Nil pointer dereference in KCM after v1 HPA patch request</a></p>
<h3 id="6-å‚è€ƒ">6. å‚è€ƒ</h3>
<ul>
<li><a href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener noreferrer">Pod æ°´å¹³è‡ªåŠ¨ä¼¸ç¼© - Kubernetes Docs</a></li>
<li><a href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener noreferrer">Horizontal Pod Autoscaleræ¼”ç»ƒ - Kubernetes Docs</a></li>
</ul>
<h2 id="k8s-PodDistruptionBuget">ä¸‰ã€<a href="https://kubernetes.io/zh/docs/tasks/run-application/configure-pdb/" target="_blank" rel="noopener noreferrer">èŠ‚ç‚¹ç»´æŠ¤ä¸Podå¹²æ‰°é¢„ç®—</a></h2>
<p>åœ¨æˆ‘ä»¬é€šè¿‡ <code>kubectl drain</code> å°†æŸä¸ªèŠ‚ç‚¹ä¸Šçš„å®¹å™¨é©±é€èµ°çš„æ—¶å€™ï¼Œ
kubernetes ä¼šä¾æ® Pod çš„ã€ŒPodDistruptionBugetã€æ¥è¿›è¡Œ Pod çš„é©±é€ã€‚</p>
<p>å¦‚æœä¸è®¾ç½®ä»»ä½•æ˜ç¡®çš„ PodDistruptionBugetï¼ŒPod å°†ä¼šè¢«ç›´æ¥æ€æ­»ï¼Œç„¶ååœ¨åˆ«çš„èŠ‚ç‚¹é‡æ–°è°ƒåº¦ï¼Œ<strong>è¿™å¯èƒ½å¯¼è‡´æœåŠ¡ä¸­æ–­ï¼</strong></p>
<p>PDB æ˜¯ä¸€ä¸ªå•ç‹¬çš„ CR è‡ªå®šä¹‰èµ„æºï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">policy/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">PodDisruptionBudget</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo-pdb</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># å¦‚æœä¸æ»¡è¶³ PDBï¼ŒPod é©±é€å°†ä¼šå¤±è´¥ï¼</span><span class="w">
</span><span class="w">  </span><span class="nt">minAvailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">      </span><span class="c"># æœ€å°‘ä¹Ÿè¦ç»´æŒä¸€ä¸ª Pod å¯ç”¨</span><span class="w">
</span><span class="w"></span><span class="c">#   maxUnavailable: 1  # æœ€å¤§ä¸å¯ç”¨çš„ Pod æ•°ï¼Œä¸ minAvailable ä¸èƒ½åŒæ—¶é…ç½®ï¼äºŒé€‰ä¸€</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">podinfo</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>å¦‚æœåœ¨è¿›è¡ŒèŠ‚ç‚¹ç»´æŠ¤æ—¶(kubectl drain)ï¼ŒPod ä¸æ»¡è¶³ PDBï¼Œdrain å°†ä¼šå¤±è´¥ï¼Œç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">&gt; kubectl drain node-205 --ignore-daemonsets --delete-local-data
node/node-205 cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/calico-node-nfhj7, kube-system/kube-proxy-94dz5
evicting pod default/podinfo-7c84d8c94d-h9brq
evicting pod default/podinfo-7c84d8c94d-gw6qf
error when evicting pod <span class="s2">&#34;podinfo-7c84d8c94d-h9brq&#34;</span> <span class="o">(</span>will retry after 5s<span class="o">)</span>: Cannot evict pod as it would violate the pod<span class="s1">&#39;s disruption budget.
</span><span class="s1">evicting pod default/podinfo-7c84d8c94d-h9brq
</span><span class="s1">error when evicting pod &#34;podinfo-7c84d8c94d-h9brq&#34; (will retry after 5s): Cannot evict pod as it would violate the pod&#39;</span>s disruption budget.
evicting pod default/podinfo-7c84d8c94d-h9brq
error when evicting pod <span class="s2">&#34;podinfo-7c84d8c94d-h9brq&#34;</span> <span class="o">(</span>will retry after 5s<span class="o">)</span>: Cannot evict pod as it would violate the pod<span class="err">&#39;</span>s disruption budget.
evicting pod default/podinfo-7c84d8c94d-h9brq
pod/podinfo-7c84d8c94d-gw6qf evicted
pod/podinfo-7c84d8c94d-h9brq evicted
node/node-205 evicted
</code></pre></td></tr></table>
</div>
</div><p>ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œpodinfo ä¸€å…±æœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œéƒ½è¿è¡Œåœ¨ node-205 ä¸Šé¢ã€‚æˆ‘ç»™å®ƒè®¾ç½®äº†å¹²æ‰°é¢„ç®— PDB <code>minAvailable: 1</code>ã€‚</p>
<p>ç„¶åä½¿ç”¨ <code>kubectl drain</code> é©±é€ Pod æ—¶ï¼Œå…¶ä¸­ä¸€ä¸ª Pod è¢«ç«‹å³é©±é€èµ°äº†ï¼Œè€Œå¦ä¸€ä¸ª Pod å¤§æ¦‚åœ¨ 15 ç§’å†…ä¸€ç›´é©±é€å¤±è´¥ã€‚
å› ä¸ºç¬¬ä¸€ä¸ª Pod è¿˜æ²¡æœ‰åœ¨æ–°çš„èŠ‚ç‚¹ä¸Šå¯åŠ¨å®Œæˆï¼Œå®ƒä¸æ»¡è¶³å¹²æ‰°é¢„ç®— PDB <code>minAvailable: 1</code> è¿™ä¸ªæ¡ä»¶ã€‚</p>
<p>å¤§çº¦ 15 ç§’åï¼Œæœ€å…ˆè¢«é©±é€èµ°çš„ Pod åœ¨æ–°èŠ‚ç‚¹ä¸Šå¯åŠ¨å®Œæˆäº†ï¼Œå¦ä¸€ä¸ª Pod æ»¡è¶³äº† PDB æ‰€ä»¥ç»ˆäºä¹Ÿè¢«é©±é€äº†ã€‚è¿™æ‰å®Œæˆäº†ä¸€ä¸ªèŠ‚ç‚¹çš„ drain æ“ä½œã€‚</p>
<blockquote>
<p>ClusterAutoscaler ç­‰é›†ç¾¤èŠ‚ç‚¹ä¼¸ç¼©ç»„ä»¶ï¼Œåœ¨ç¼©å®¹èŠ‚ç‚¹æ—¶ä¹Ÿä¼šè€ƒè™‘ PodDisruptionBudget. å¦‚æœä½ çš„é›†ç¾¤ä½¿ç”¨äº† ClusterAutoscaler ç­‰åŠ¨æ€æ‰©ç¼©å®¹èŠ‚ç‚¹çš„ç»„ä»¶ï¼Œå¼ºçƒˆå»ºè®®è®¾ç½®ä¸ºæ‰€æœ‰æœåŠ¡è®¾ç½® PodDisruptionBudget.</p>
</blockquote>
<h4 id="åœ¨-pdb-ä¸­ä½¿ç”¨ç™¾åˆ†æ¯”çš„æ³¨æ„äº‹é¡¹">åœ¨ PDB ä¸­ä½¿ç”¨ç™¾åˆ†æ¯”çš„æ³¨æ„äº‹é¡¹</h4>
<p>åœ¨ä½¿ç”¨ç™¾åˆ†æ¯”æ—¶ï¼Œè®¡ç®—å‡ºçš„å®ä¾‹æ•°éƒ½ä¼šè¢«å‘ä¸Šå–æ•´ï¼Œè¿™ä¼šé€ æˆä¸¤ä¸ªç°è±¡ï¼š</p>
<ul>
<li>å¦‚æœä½¿ç”¨ <code>minAvailable</code>ï¼Œå®ä¾‹æ•°è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå¯¼è‡´ ALLOWED DISRUPTIONS ä¸º 0</li>
<li>å¦‚æœä½¿ç”¨ <code>maxUnavailable</code>ï¼Œå› ä¸ºæ˜¯å‘ä¸Šå–æ•´ï¼ŒALLOWED DISRUPTIONS çš„å€¼ä¸€å®šä¸ä¼šä½äº 1</li>
</ul>
<p>å› æ­¤ä»ä¾¿äºé©±é€çš„è§’åº¦çœ‹ï¼Œå¦‚æœä½ çš„æœåŠ¡è‡³å°‘æœ‰ 2-3 ä¸ªå®ä¾‹ï¼Œå»ºè®®åœ¨ PDB ä¸­ä½¿ç”¨ç™¾åˆ†æ¯”é…ç½® <code>maxUnavailable</code>ï¼Œè€Œä¸æ˜¯ <code>minAvailable</code>.</p>
<h3 id="æœ€ä½³å®è·µ-deployment--hpa--poddisruptionbudget">æœ€ä½³å®è·µ Deployment + HPA + PodDisruptionBudget</h3>
<p>ä¸€èˆ¬è€Œè¨€ï¼Œä¸€ä¸ªæœåŠ¡çš„æ¯ä¸ªç‰ˆæœ¬ï¼Œéƒ½åº”è¯¥åŒ…å«å¦‚ä¸‹ä¸‰ä¸ªèµ„æºï¼š</p>
<ul>
<li>Deployment: ç®¡ç†æœåŠ¡è‡ªèº«çš„ Pods å˜›</li>
<li>HPA: è´Ÿè´£ Pods çš„æ‰©ç¼©å®¹ï¼Œé€šå¸¸ä½¿ç”¨ CPU æŒ‡æ ‡è¿›è¡Œæ‰©ç¼©å®¹</li>
<li>PodDisruptionBudget(PDB): å»ºè®®æŒ‰ç…§ HPA çš„ç›®æ ‡å€¼ï¼Œæ¥è®¾ç½® PDB.
<ul>
<li>æ¯”å¦‚ HPA CPU ç›®æ ‡å€¼ä¸º 60%ï¼Œå°±å¯ä»¥è€ƒè™‘è®¾ç½® PDB <code>minAvailable=65%</code>ï¼Œä¿è¯è‡³å°‘æœ‰ 65% çš„ Pod å¯ç”¨ã€‚è¿™æ ·ç†è®ºä¸Šæé™æƒ…å†µä¸‹ QPS å‡æ‘Šåˆ°å‰©ä¸‹ 65% çš„ Pods ä¸Šä¹Ÿä¸ä¼šé€ æˆé›ªå´©ï¼ˆè¿™é‡Œå‡è®¾ QPS å’Œ CPU æ˜¯å®Œå…¨çš„çº¿æ€§å…³ç³»ï¼‰</li>
</ul>
</li>
</ul>
<h2 id="k8s-affinity">å››ã€èŠ‚ç‚¹äº²å’Œæ€§ä¸èŠ‚ç‚¹ç»„</h2>
<p>æˆ‘ä»¬ä¸€ä¸ªé›†ç¾¤ï¼Œé€šå¸¸ä¼šä½¿ç”¨ä¸åŒçš„æ ‡ç­¾ä¸ºèŠ‚ç‚¹ç»„è¿›è¡Œåˆ†ç±»ï¼Œæ¯”å¦‚ kubernetes è‡ªåŠ¨ç”Ÿæˆçš„ä¸€äº›èŠ‚ç‚¹æ ‡ç­¾ï¼š</p>
<ul>
<li><code>kubernetes.io/os</code>: é€šå¸¸éƒ½ç”¨ <code>linux</code></li>
<li><code>kubernetes.io/arch</code>: <code>amd64</code>, <code>arm64</code></li>
<li><code>topology.kubernetes.io/region</code> å’Œ <code>topology.kubernetes.io/zone</code>: äº‘æœåŠ¡çš„åŒºåŸŸåŠå¯ç”¨åŒº</li>
</ul>
<p>æˆ‘ä»¬ä½¿ç”¨å¾—æ¯”è¾ƒå¤šçš„ï¼Œæ˜¯ã€ŒèŠ‚ç‚¹äº²å’Œæ€§ã€ä»¥åŠã€ŒPod åäº²å’Œæ€§ã€ï¼Œå¦å¤–ä¸¤ä¸ªç­–ç•¥è§†æƒ…å†µä½¿ç”¨ã€‚</p>
<h3 id="1-èŠ‚ç‚¹äº²å’Œæ€§">1. èŠ‚ç‚¹äº²å’Œæ€§</h3>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ awsï¼Œé‚£ aws æœ‰ä¸€äº›è‡ªå®šä¹‰çš„èŠ‚ç‚¹æ ‡ç­¾ï¼š</p>
<ul>
<li><code>eks.amazonaws.com/nodegroup</code>: aws eks èŠ‚ç‚¹ç»„çš„åç§°ï¼ŒåŒä¸€ä¸ªèŠ‚ç‚¹ç»„ä½¿ç”¨åŒæ ·çš„ aws ec2 å®ä¾‹æ¨¡æ¿
<ul>
<li>æ¯”å¦‚ arm64 èŠ‚ç‚¹ç»„ã€amd64/x64 èŠ‚ç‚¹ç»„</li>
<li>å†…å­˜æ¯”ä¾‹é«˜çš„èŠ‚ç‚¹ç»„å¦‚ m ç³»å®ä¾‹ï¼Œè®¡ç®—æ€§èƒ½é«˜çš„èŠ‚ç‚¹ç»„å¦‚ c ç³»åˆ—</li>
<li>ç«ä»·å®ä¾‹èŠ‚ç‚¹ç»„ï¼šè¿™ä¸ªçœé’±å•Šï¼Œä½†æ˜¯åŠ¨æ€æ€§å¾ˆé«˜ï¼Œéšæ—¶å¯èƒ½è¢«å›æ”¶</li>
<li>æŒ‰é‡ä»˜è´¹èŠ‚ç‚¹ç»„ï¼šè¿™ç±»å®ä¾‹è´µï¼Œä½†æ˜¯ç¨³å®šã€‚</li>
</ul>
</li>
</ul>
<p>å‡è®¾ä½ å¸Œæœ›ä¼˜å…ˆé€‰æ‹©ç«ä»·å®ä¾‹è·‘ä½ çš„ Podï¼Œå¦‚æœç«ä»·å®ä¾‹æš‚æ—¶è·‘æ»¡äº†ï¼Œå°±é€‰æ‹©æŒ‰é‡ä»˜è´¹å®ä¾‹ã€‚
é‚£ <code>nodeSelector</code> å°±æ»¡è¶³ä¸äº†ä½ çš„éœ€æ±‚äº†ï¼Œä½ éœ€è¦ä½¿ç”¨ <code>nodeAffinity</code>ï¼Œç¤ºä¾‹å¦‚ä¸‹:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">nodeAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="c"># ä¼˜å…ˆé€‰æ‹© spot-group-c çš„èŠ‚ç‚¹</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">preference</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">eks.amazonaws.com/nodegroup</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">spot-group-c</span><span class="w">
</span><span class="w">            </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹</span><span class="w">
</span><span class="w">          </span>- <span class="nt">preference</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="c"># ä¼˜å…ˆé€‰æ‹© aws c6i çš„æœºå™¨</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node.kubernetes.io/instance-type</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.2xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.4xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c6i.8xlarge&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">70</span><span class="w">
</span><span class="w">          </span>- <span class="nt">preference</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="c"># å…¶æ¬¡é€‰æ‹© aws c5 çš„æœºå™¨</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">node.kubernetes.io/instance-type</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.2xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.4xlarge&#34;</span><span class="w">
</span><span class="w">                </span>- <span class="s2">&#34;c5.9xlarge&#34;</span><span class="w">
</span><span class="w">            </span><span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">60</span><span class="w">
</span><span class="w">         </span><span class="c"># å¦‚æœæ²¡ spot-group-c å¯ç”¨ï¼Œä¹Ÿå¯é€‰æ‹© ondemand-group-c çš„èŠ‚ç‚¹è·‘</span><span class="w">
</span><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>- <span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">eks.amazonaws.com/nodegroup</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">spot-group-c</span><span class="w">
</span><span class="w">                </span>- <span class="l">ondemand-group-c</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># ...</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="2-pod-åäº²å’Œæ€§">2. Pod åäº²å’Œæ€§</h3>
<p>é€šå¸¸å»ºè®®ä¸ºæ¯ä¸ª Deployment çš„ template é…ç½® Pod åäº²å’Œæ€§ï¼ŒæŠŠ Pods æ‰“æ•£åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">xxx</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w">      </span><span class="nt">affinity</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">podAntiAffinity</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">preferredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w"> </span><span class="c"># éå¼ºåˆ¶æ€§æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">weight</span><span class="p">:</span><span class="w"> </span><span class="m">100</span><span class="w">  </span><span class="c"># weight ç”¨äºä¸ºèŠ‚ç‚¹è¯„åˆ†ï¼Œä¼šä¼˜å…ˆé€‰æ‹©è¯„åˆ†æœ€é«˜çš„èŠ‚ç‚¹</span><span class="w">
</span><span class="w">            </span><span class="nt">podAffinityTerm</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">xxx</span><span class="w">
</span><span class="w">                </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                  </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                  </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                  </span>- <span class="l">v12</span><span class="w">
</span><span class="w">              </span><span class="c"># å°† pod å°½é‡æ‰“æ•£åœ¨å¤šä¸ªå¯ç”¨åŒº</span><span class="w">
</span><span class="w">              </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">topology.kubernetes.io/zone</span><span class="w">
</span><span class="w">          </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span><span class="w">  </span><span class="c"># å¼ºåˆ¶æ€§è¦æ±‚</span><span class="w">
</span><span class="w">          </span><span class="c"># æ³¨æ„è¿™ä¸ªæ²¡æœ‰ weightsï¼Œå¿…é¡»æ»¡è¶³åˆ—è¡¨ä¸­çš„æ‰€æœ‰æ¡ä»¶</span><span class="w">
</span><span class="w">          </span>- <span class="nt">labelSelector</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">app</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">xxx</span><span class="w">
</span><span class="w">              </span>- <span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">version</span><span class="w">
</span><span class="w">                </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l">In</span><span class="w">
</span><span class="w">                </span><span class="nt">values</span><span class="p">:</span><span class="w">
</span><span class="w">                </span>- <span class="l">v12</span><span class="w">
</span><span class="w">            </span><span class="c"># Pod å¿…é¡»è¿è¡Œåœ¨ä¸åŒçš„èŠ‚ç‚¹ä¸Š</span><span class="w">
</span><span class="w">            </span><span class="nt">topologyKey</span><span class="p">:</span><span class="w"> </span><span class="l">kubernetes.io/hostname</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="k8s-container-probe">äº”ã€Pod çš„å°±ç»ªæ¢é’ˆã€å­˜æ´»æ¢é’ˆä¸å¯åŠ¨æ¢é’ˆ</h2>
<p>Pod æä¾›å¦‚ä¸‹ä¸‰ç§æ¢é’ˆï¼Œå‡æ”¯æŒä½¿ç”¨ Commandã€HTTP APIã€TCP Socket è¿™ä¸‰ç§æ‰‹æ®µæ¥è¿›è¡ŒæœåŠ¡å¯ç”¨æ€§æ¢æµ‹ã€‚</p>
<ul>
<li><code>startupProbe</code> å¯åŠ¨æ¢é’ˆï¼ˆKubernetes v1.18 [beta]ï¼‰: æ­¤æ¢é’ˆé€šè¿‡åï¼Œã€Œå°±ç»ªæ¢é’ˆã€ä¸ã€Œå­˜æ´»æ¢é’ˆã€æ‰ä¼šè¿›è¡Œå­˜æ´»æ€§ä¸å°±ç»ªæ£€æŸ¥
<ul>
<li>ç”¨äºå¯¹æ…¢å¯åŠ¨å®¹å™¨è¿›è¡Œå­˜æ´»æ€§æ£€æµ‹ï¼Œé¿å…å®ƒä»¬åœ¨å¯åŠ¨è¿è¡Œä¹‹å‰å°±è¢«æ€æ‰
<ul>
<li>startupProbe æ˜¾ç„¶æ¯” livenessProbe çš„ initialDelaySeconds å‚æ•°æ›´çµæ´»ã€‚</li>
<li>åŒæ—¶å®ƒä¹Ÿèƒ½å»¶è¿Ÿ readinessProbe çš„ç”Ÿæ•ˆæ—¶é—´ï¼Œè¿™ä¸»è¦æ˜¯ä¸ºäº†é¿å…æ— æ„ä¹‰çš„æ¢æµ‹ã€‚å®¹å™¨éƒ½è¿˜æ²¡ startUpï¼Œæ˜¾ç„¶æ˜¯ä¸å¯èƒ½å°±ç»ªçš„ã€‚</li>
</ul>
</li>
<li>ç¨‹åºå°†æœ€å¤šæœ‰ <code>failureThreshold * periodSeconds</code> çš„æ—¶é—´ç”¨äºå¯åŠ¨ï¼Œæ¯”å¦‚è®¾ç½® <code>failureThreshold=20</code>ã€<code>periodSeconds=5</code>ï¼Œç¨‹åºå¯åŠ¨æ—¶é—´æœ€é•¿å°±ä¸º 100sï¼Œå¦‚æœè¶…è¿‡ 100s ä»ç„¶æœªé€šè¿‡ã€Œå¯åŠ¨æ¢æµ‹ã€ï¼Œå®¹å™¨ä¼šè¢«æ€æ­»ã€‚</li>
</ul>
</li>
<li><code>readinessProbe</code> å°±ç»ªæ¢é’ˆ:
<ul>
<li>å°±ç»ªæ¢é’ˆå¤±è´¥æ¬¡æ•°è¶…è¿‡ <code>failureThreshold</code> é™åˆ¶ï¼ˆé»˜è®¤ä¸‰æ¬¡ï¼‰ï¼ŒæœåŠ¡å°†è¢«æš‚æ—¶ä» Service çš„ Endpoints ä¸­è¸¢å‡ºï¼Œç›´åˆ°æœåŠ¡å†æ¬¡æ»¡è¶³ <code>successThreshold</code>.</li>
</ul>
</li>
<li><code>livenessProbe</code> å­˜æ´»æ¢é’ˆ: æ£€æµ‹æœåŠ¡æ˜¯å¦å­˜æ´»ï¼Œå®ƒå¯ä»¥æ•æ‰åˆ°æ­»é”ç­‰æƒ…å†µï¼ŒåŠæ—¶æ€æ­»è¿™ç§å®¹å™¨ã€‚
<ul>
<li>å­˜æ´»æ¢é’ˆå¤±è´¥å¯èƒ½çš„åŸå› ï¼š
<ul>
<li>æœåŠ¡å‘ç”Ÿæ­»é”ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚å‡æ— å“åº”</li>
<li>æœåŠ¡çº¿ç¨‹å…¨éƒ¨å¡åœ¨å¯¹å¤–éƒ¨ redis/mysql ç­‰å¤–éƒ¨ä¾èµ–çš„ç­‰å¾…ä¸­ï¼Œå¯¼è‡´è¯·æ±‚æ— å“åº”</li>
</ul>
</li>
<li>å­˜æ´»æ¢é’ˆå¤±è´¥æ¬¡æ•°è¶…è¿‡ <code>failureThreshold</code> é™åˆ¶ï¼ˆé»˜è®¤ä¸‰æ¬¡ï¼‰ï¼Œå®¹å™¨å°†è¢«æ€æ­»ï¼Œéšåæ ¹æ®é‡å¯ç­–ç•¥æ‰§è¡Œé‡å¯ã€‚
<ul>
<li><code>kubectl describe pod</code> ä¼šæ˜¾ç¤ºé‡å¯åŸå› ä¸º <code>State.Last State.Reason = Error, Exit Code=137</code>ï¼ŒåŒæ—¶ Events ä¸­ä¼šæœ‰ <code>Liveness probe failed: ...</code> è¿™æ ·çš„æè¿°ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ä¸Šè¿°ä¸‰ç±»æ¢æµ‹å™¨çš„å‚æ•°éƒ½æ˜¯é€šç”¨çš„ï¼Œäº”ä¸ªæ—¶é—´ç›¸å…³çš„å‚æ•°åˆ—ä¸¾å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="c"># ä¸‹é¢çš„å€¼å°±æ˜¯ k8s çš„é»˜è®¤å€¼</span><span class="w">
</span><span class="w"></span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">  </span><span class="c"># é»˜è®¤æ²¡æœ‰ delay æ—¶é—´</span><span class="w">
</span><span class="w"></span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="w"></span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w"></span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span><span class="w"></span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>ç¤ºä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#  ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/app/my-app:v3</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent </span><span class="w">
</span><span class="w">        </span><span class="c"># ... çœç•¥è‹¥å¹²é…ç½®</span><span class="w">
</span><span class="w">        </span><span class="nt">startupProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç›´æ¥ä½¿ç”¨å¥åº·æ£€æŸ¥æ¥å£å³å¯</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">20</span><span class="w">  </span><span class="c"># æœ€å¤šæä¾›ç»™æœåŠ¡ 5s * 20 çš„å¯åŠ¨æ—¶é—´</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># spring çš„é€šç”¨å¥åº·æ£€æŸ¥è·¯å¾„</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="c"># Readiness probes are very important for a RollingUpdate to work properly,</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># ç®€å•èµ·è§å¯ç›´æ¥ä½¿ç”¨ livenessProbe ç›¸åŒçš„æ¥å£ï¼Œå½“ç„¶ä¹Ÿå¯é¢å¤–å®šä¹‰</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ Kubernetes 1.18 ä¹‹å‰ï¼Œé€šç”¨çš„æ‰‹æ®µæ˜¯ä¸ºã€Œå°±ç»ªæ¢é’ˆã€æ·»åŠ è¾ƒé•¿çš„ <code>initialDelaySeconds</code> æ¥å®ç°ç±»ä¼¼ã€Œå¯åŠ¨æ¢é’ˆã€çš„åŠŸèƒ½åŠ¨ï¼Œé¿å…å®¹å™¨å› ä¸ºå¯åŠ¨å¤ªæ…¢ï¼Œå­˜æ´»æ¢é’ˆå¤±è´¥å¯¼è‡´å®¹å™¨è¢«é‡å¯ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># ...</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c">#  ...</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-app-v3</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">xxx.com/app/my-app:v3</span><span class="w">
</span><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent </span><span class="w">
</span><span class="w">        </span><span class="c"># ... çœç•¥è‹¥å¹²é…ç½®</span><span class="w">
</span><span class="w">        </span><span class="nt">livenessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health </span><span class="w"> </span><span class="c"># spring çš„é€šç”¨å¥åº·æ£€æŸ¥è·¯å¾„</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">120</span><span class="w">  </span><span class="c"># å‰ä¸¤åˆ†é’Ÿï¼Œéƒ½å‡è®¾æœåŠ¡å¥åº·ï¼Œé¿å… livenessProbe å¤±è´¥å¯¼è‡´æœåŠ¡é‡å¯</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">        </span><span class="c"># å®¹å™¨ä¸€å¯åŠ¨ï¼ŒReadiness probes å°±ä¼šä¸æ–­è¿›è¡Œæ£€æµ‹</span><span class="w">
</span><span class="w">        </span><span class="nt">readinessProbe</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">httpGet</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/actuator/health</span><span class="w">
</span><span class="w">            </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span><span class="w">          </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">  </span><span class="c"># readiness probe ä¸éœ€è¦è®¾å¤ªé•¿æ—¶é—´ï¼Œä½¿ Pod å°½å¿«åŠ å…¥åˆ° Endpoints.</span><span class="w">
</span><span class="w">          </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">timeoutSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">          </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span><span class="w">          </span><span class="nt">successThreshold</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="k8s-pod-security">å…­ã€Pod å®‰å…¨</h2>
<p>è¿™é‡Œåªä»‹ç» Pod ä¸­å®‰å…¨ç›¸å…³çš„å‚æ•°ï¼Œå…¶ä»–è¯¸å¦‚é›†ç¾¤å…¨å±€çš„å®‰å…¨ç­–ç•¥ï¼Œä¸åœ¨è¿™é‡Œè®¨è®ºã€‚</p>
<h3 id="1-pod-securitycontexthttpskubernetesiodocstasksconfigure-pod-containersecurity-context">1. <a href="https://kubernetes.io/docs/tasks/configure-pod-container/security-context/" target="_blank" rel="noopener noreferrer">Pod SecurityContext</a></h3>
<p>é€šè¿‡è®¾ç½® Pod çš„ SecurityContextï¼Œå¯ä»¥ä¸ºæ¯ä¸ª Pod è®¾ç½®ç‰¹å®šçš„å®‰å…¨ç­–ç•¥ã€‚</p>
<p>SecurityContext æœ‰ä¸¤ç§ç±»å‹ï¼š</p>
<ol>
<li><code>spec.securityContext</code>: è¿™æ˜¯ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#podsecuritycontext-v1-core" target="_blank" rel="noopener noreferrer">PodSecurityContext</a> å¯¹è±¡
<ul>
<li>é¡¾åæ€ä¹‰ï¼Œå®ƒå¯¹ Pod ä¸­çš„æ‰€æœ‰ contaienrs éƒ½æœ‰æ•ˆã€‚</li>
</ul>
</li>
<li><code>spec.containers[*].securityContext</code>: è¿™æ˜¯ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#securitycontext-v1-core" target="_blank" rel="noopener noreferrer">SecurityContext</a> å¯¹è±¡
<ul>
<li>container ç§æœ‰çš„ SecurityContext</li>
</ul>
</li>
</ol>
<p>è¿™ä¸¤ä¸ª SecurityContext çš„å‚æ•°åªæœ‰éƒ¨åˆ†é‡å ï¼Œé‡å çš„éƒ¨åˆ† <code>spec.containers[*].securityContext</code> ä¼˜å…ˆçº§æ›´é«˜ã€‚</p>
<p>æˆ‘ä»¬æ¯”è¾ƒå¸¸é‡åˆ°çš„ä¸€äº›<strong>æå‡æƒé™</strong>çš„å®‰å…¨ç­–ç•¥ï¼š</p>
<ol>
<li>ç‰¹æƒå®¹å™¨ï¼š<code>spec.containers[*].securityContext.privileged</code></li>
<li>æ·»åŠ ï¼ˆCapabilitiesï¼‰å¯é€‰çš„ç³»ç»Ÿçº§èƒ½åŠ›: <code>spec.containers[*].securityContext.capabilities.add</code>
<ol>
<li>åªæœ‰ ntp åŒæ­¥æœåŠ¡ç­‰å°‘æ•°å®¹å™¨ï¼Œå¯ä»¥å¼€å¯è¿™é¡¹åŠŸèƒ½ã€‚è¯·æ³¨æ„è¿™éå¸¸å±é™©ã€‚</li>
</ol>
</li>
<li>Sysctls: ç³»ç»Ÿå‚æ•°: <code>spec.securityContext.sysctls</code></li>
</ol>
<p><strong>æƒé™é™åˆ¶</strong>ç›¸å…³çš„å®‰å…¨ç­–ç•¥æœ‰ï¼ˆ<strong>å¼ºçƒˆå»ºè®®åœ¨æ‰€æœ‰ Pod ä¸ŠæŒ‰éœ€é…ç½®å¦‚ä¸‹å®‰å…¨ç­–ç•¥ï¼</strong>ï¼‰ï¼š</p>
<ol>
<li><code>spec.volumes</code>: æ‰€æœ‰çš„æ•°æ®å·éƒ½å¯ä»¥è®¾å®šè¯»å†™æƒé™</li>
<li><code>spec.securityContext.runAsNonRoot: true</code> Pod å¿…é¡»ä»¥é root ç”¨æˆ·è¿è¡Œ</li>
<li><code>spec.containers[*].securityContext.readOnlyRootFileSystem:true</code> <strong>å°†å®¹å™¨å±‚è®¾ä¸ºåªè¯»ï¼Œé˜²æ­¢å®¹å™¨æ–‡ä»¶è¢«ç¯¡æ”¹ã€‚</strong>
<ol>
<li>å¦‚æœå¾®æœåŠ¡éœ€è¦è¯»å†™æ–‡ä»¶ï¼Œå»ºè®®é¢å¤–æŒ‚è½½ <code>emptydir</code> ç±»å‹çš„æ•°æ®å·ã€‚</li>
</ol>
</li>
<li><code>spec.containers[*].securityContext.allowPrivilegeEscalation: false</code> ä¸å…è®¸ Pod åšä»»ä½•æƒé™æå‡ï¼</li>
<li><code>spec.containers[*].securityContext.capabilities.drop</code>: ç§»é™¤ï¼ˆCapabilitiesï¼‰å¯é€‰çš„ç³»ç»Ÿçº§èƒ½åŠ›</li>
</ol>
<p>è¿˜æœ‰å…¶ä»–è¯¸å¦‚æŒ‡å®šå®¹å™¨çš„è¿è¡Œç”¨æˆ·(user)/ç”¨æˆ·ç»„(group)ç­‰åŠŸèƒ½æœªåˆ—å‡ºï¼Œè¯·è‡ªè¡ŒæŸ¥é˜… Kubernetes ç›¸å…³æ–‡æ¡£ã€‚</p>
<p>ä¸€ä¸ªæ— çŠ¶æ€çš„å¾®æœåŠ¡ Pod é…ç½®ä¸¾ä¾‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;Pod name&gt;</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">â€Š </span><span class="nt">-â€Šname</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;container name&gt;</span><span class="w">
</span><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;image&gt;</span><span class="w">
</span><span class="w">    </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">IfNotPresent </span><span class="w">
</span><span class="w">    </span><span class="c"># ......æ­¤å¤„çœç•¥ 500 å­—</span><span class="w">
</span><span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">readOnlyRootFilesystem</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># å°†å®¹å™¨å±‚è®¾ä¸ºåªè¯»ï¼Œé˜²æ­¢å®¹å™¨æ–‡ä»¶è¢«ç¯¡æ”¹ã€‚</span><span class="w">
</span><span class="w">      </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">  </span><span class="c"># ç¦æ­¢ Pod åšä»»ä½•æƒé™æå‡</span><span class="w">
</span><span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">drop</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="c"># ç¦æ­¢å®¹å™¨ä½¿ç”¨ raw å¥—æ¥å­—ï¼Œé€šå¸¸åªæœ‰ hacker æ‰ä¼šç”¨åˆ° raw å¥—æ¥å­—ã€‚</span><span class="w">
</span><span class="w">        </span><span class="c"># raw_socket å¯è‡ªå®šä¹‰ç½‘ç»œå±‚æ•°æ®ï¼Œé¿å¼€ tcp/udp åè®®æ ˆï¼Œç›´æ¥æ“ä½œåº•å±‚çš„ ip/icmp æ•°æ®åŒ…ã€‚å¯å®ç° ip ä¼ªè£…ã€è‡ªå®šä¹‰åè®®ç­‰åŠŸèƒ½ã€‚</span><span class="w">
</span><span class="w">        </span><span class="c"># å»æ‰ net_raw ä¼šå¯¼è‡´ tcpdump æ— æ³•ä½¿ç”¨ï¼Œæ— æ³•è¿›è¡Œå®¹å™¨å†…æŠ“åŒ…ã€‚éœ€è¦æŠ“åŒ…æ—¶å¯ä¸´æ—¶å»é™¤è¿™é¡¹é…ç½®</span><span class="w">
</span><span class="w">        </span>- <span class="l">NET_RAW</span><span class="w">
</span><span class="w">        </span><span class="c"># æ›´å¥½çš„é€‰æ‹©ï¼šç›´æ¥ç¦ç”¨æ‰€æœ‰ capabilities</span><span class="w">
</span><span class="w">        </span><span class="c"># - ALL</span><span class="w">
</span><span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="c"># runAsUser: 1000  # è®¾å®šç”¨æˆ·</span><span class="w">
</span><span class="w">    </span><span class="c"># runAsGroup: 1000  # è®¾å®šç”¨æˆ·ç»„</span><span class="w">
</span><span class="w">    </span><span class="nt">runAsNonRoot</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># Pod å¿…é¡»ä»¥é root ç”¨æˆ·è¿è¡Œ</span><span class="w">
</span><span class="w">    </span><span class="nt">seccompProfile</span><span class="p">:</span><span class="w">  </span><span class="c"># security compute mode</span><span class="w">
</span><span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RuntimeDefault</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="2-seccomp-security-compute-mode">2. seccomp: security compute mode</h3>
<p>seccomp å’Œ seccomp-bpf å…è®¸å¯¹ç³»ç»Ÿè°ƒç”¨è¿›è¡Œè¿‡æ»¤ï¼Œå¯ä»¥é˜²æ­¢ç”¨æˆ·çš„äºŒè¿›åˆ¶æ–‡å¯¹ä¸»æœºæ“ä½œç³»ç»Ÿä»¶æ‰§è¡Œé€šå¸¸æƒ…å†µä¸‹å¹¶ä¸éœ€è¦çš„å±é™©æ“ä½œã€‚å®ƒå’Œ Falco æœ‰äº›ç±»ä¼¼ï¼Œä¸è¿‡ Seccomp æ²¡æœ‰ä¸ºå®¹å™¨æä¾›ç‰¹åˆ«çš„æ”¯æŒã€‚</p>
<p>è§†é¢‘:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=Ro4QRx7VPsY&amp;list=PLj6h78yzYM2Pn8RxfLh2qrXBDftr6Qjut$index=22" target="_blank" rel="noopener noreferrer">Seccomp: What Can It Do For You? - Justin Cormack, Docker</a></li>
</ul>
<h2 id="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</h2>
<ul>
<li>ä¸åŒèŠ‚ç‚¹ç±»å‹çš„æ€§èƒ½æœ‰å·®è·ï¼Œå¯¼è‡´ QPS å‡è¡¡çš„æƒ…å†µä¸‹ï¼ŒCPU è´Ÿè½½ä¸å‡è¡¡
<ul>
<li>è§£å†³åŠæ³•ï¼ˆæœªéªŒè¯ï¼‰ï¼š
<ul>
<li>å°½é‡ä½¿ç”¨æ€§èƒ½ç›¸åŒçš„å®ä¾‹ç±»å‹ï¼šé€šè¿‡ <code>podAffinity</code> åŠ <code>nodeAffinity</code> æ·»åŠ èŠ‚ç‚¹ç±»å‹çš„äº²å’Œæ€§</li>
</ul>
</li>
</ul>
</li>
</ul>
]]></description></item><item><title>ä½¿ç”¨ Istio è¿›è¡Œ JWT èº«ä»½éªŒè¯ï¼ˆå……å½“ API ç½‘å…³ï¼‰</title><link>https://ryan4yin.space/posts/use-istio-for-jwt-auth/</link><pubDate>Mon, 06 Apr 2020 21:48:26 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/use-istio-for-jwt-auth/</guid><description><![CDATA[<blockquote>
<p>æœ¬æ–‡åŸºäº Istio1.5 ç¼–å†™æµ‹è¯•</p>
</blockquote>
<p>Istio æ”¯æŒä½¿ç”¨ JWT å¯¹ç»ˆç«¯ç”¨æˆ·è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆIstio End User Authenticationï¼‰ï¼Œæ”¯æŒå¤šç§ JWT ç­¾åç®—æ³•ã€‚</p>
<p>ç›®å‰ä¸»æµçš„ JWT ç®—æ³•æ˜¯ RS256/ES256ã€‚ï¼ˆè¯·å¿½ç•¥ HS256ï¼Œè¯¥ç®—æ³•ä¸é€‚åˆåˆ†å¸ƒå¼ JWT éªŒè¯ï¼‰</p>
<p>è¿™é‡Œä»¥ RSA256 ç®—æ³•ä¸ºä¾‹è¿›è¡Œä»‹ç»ï¼ŒES256 çš„é…ç½®æ–¹å¼ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="1-ä»‹ç»-jwk-ä¸-jwks">1. ä»‹ç» JWK ä¸ JWKS</h3>
<p>Istio è¦æ±‚æä¾› JWKS æ ¼å¼çš„ä¿¡æ¯ï¼Œç”¨äº JWT ç­¾åéªŒè¯ã€‚å› æ­¤è¿™é‡Œå¾—å…ˆä»‹ç»ä¸€ä¸‹ JWK å’Œ JWKS.</p>
<p>JWKS ï¼Œä¹Ÿå°±æ˜¯ JWK Setï¼Œjson ç»“æ„å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{
&#34;keys&#34;: [
  &lt;jwk-1&gt;,
  &lt;jwk-2&gt;,
  ...
]}
</code></pre></td></tr></table>
</div>
</div><p>JWKS æè¿°ä¸€ç»„ JWK å¯†é’¥ã€‚å®ƒèƒ½åŒæ—¶æè¿°å¤šä¸ªå¯ç”¨çš„å…¬é’¥ï¼Œåº”ç”¨åœºæ™¯ä¹‹ä¸€æ˜¯å¯†é’¥çš„ Rotate.</p>
<p>è€Œ JWKï¼Œå…¨ç§°æ˜¯ Json Web Keyï¼Œå®ƒæè¿°äº†ä¸€ä¸ªåŠ å¯†å¯†é’¥ï¼ˆå…¬é’¥æˆ–ç§é’¥ï¼‰çš„å„é¡¹å±æ€§ï¼ŒåŒ…æ‹¬å¯†é’¥çš„å€¼ã€‚</p>
<p>Istio ä½¿ç”¨ JWK æè¿°éªŒè¯ JWT ç­¾åæ‰€éœ€è¦çš„ä¿¡æ¯ã€‚åœ¨ä½¿ç”¨ RSA ç­¾åç®—æ³•æ—¶ï¼ŒJWK æè¿°çš„åº”è¯¥æ˜¯ç”¨äºéªŒè¯çš„ RSA å…¬é’¥ã€‚</p>
<p>ä¸€ä¸ª RSA å…¬é’¥çš„ JWK æè¿°å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">{
    &#34;alg&#34;: &#34;RS256&#34;,  # ç®—æ³•ã€Œå¯é€‰å‚æ•°ã€
    &#34;kty&#34;: &#34;RSA&#34;,    # å¯†é’¥ç±»å‹
    &#34;use&#34;: &#34;sig&#34;,    # è¢«ç”¨äºç­¾åã€Œå¯é€‰å‚æ•°ã€
    &#34;kid&#34;: &#34;NjVBRjY5MDlCMUIwNzU4RTA2QzZFMDQ4QzQ2MDAyQjVDNjk1RTM2Qg&#34;,  # key çš„å”¯ä¸€ id
    &#34;n&#34;: &#34;yeNlzlub94YgerT030codqEztjfU_S6X4DbDA_iVKkjAWtYfPHDzz_sPCT1Axz6isZdf3lHpq_gYX4Sz-cbe4rjmigxUxr-FgKHQy3HeCdK6hNq9ASQvMK9LBOpXDNn7mei6RZWom4wo3CMvvsY1w8tjtfLb-yQwJPltHxShZq5-ihC9irpLI9xEBTgG12q5lGIFPhTl_7inA1PFK97LuSLnTJzW0bj096v_TMDg7pOWm_zHtF53qbVsI0e3v5nmdKXdFf9BjIARRfVrbxVxiZHjU6zL6jY5QJdh1QCmENoejj_ytspMmGW7yMRxzUqgxcAqOBpVm0b-_mW3HoBdjQ&#34;,
    &#34;e&#34;: &#34;AQAB&#34;
}
</code></pre></td></tr></table>
</div>
</div><p>RSA æ˜¯åŸºäºå¤§æ•°åˆ†è§£çš„åŠ å¯†/ç­¾åç®—æ³•ï¼Œä¸Šè¿°å‚æ•°ä¸­ï¼Œ<code>e</code> æ˜¯å…¬é’¥çš„æ¨¡æ•°(modulus)ï¼Œ<code>n</code> æ˜¯å…¬é’¥çš„æŒ‡æ•°(exponent)ï¼Œä¸¤ä¸ªå‚æ•°éƒ½æ˜¯ base64 å­—ç¬¦ä¸²ã€‚</p>
<p>JWK ä¸­ RSA å…¬é’¥çš„å…·ä½“å®šä¹‰å‚è§ <a href="https://tools.ietf.org/html/rfc7518#page-30" target="_blank" rel="noopener noreferrer">RSA Keys - JSON Web Algorithms (JWA)</a></p>
<h3 id="2-jwk-çš„ç”Ÿæˆ">2. JWK çš„ç”Ÿæˆ</h3>
<p>è¦ç”Ÿæˆ JWK å…¬é’¥ï¼Œéœ€è¦å…ˆç”Ÿæˆç§é’¥ï¼Œç”Ÿæˆæ–¹æ³•å‚è§ <a href="/posts/jwt-algorithm-key-generation/#ä½¿ç”¨-openssl-ç”Ÿæˆ-rsaecc-å…¬ç§é’¥" rel="">JWT ç­¾åç®—æ³• HS256ã€RS256 åŠ ES256 åŠå¯†é’¥ç”Ÿæˆ</a>ã€‚</p>
<blockquote>
<p>å…¬é’¥ä¸éœ€è¦ç”¨ä¸Šè¿°æ–¹æ³•ç”Ÿæˆï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦çš„æ˜¯ JWK æ ¼å¼çš„å…¬é’¥ã€‚åé¢ä¼šé€šè¿‡ python ç”Ÿæˆå‡º JWK å…¬é’¥ã€‚</p>
</blockquote>
<p>ä¸Šé¢çš„å‘½ä»¤ä¼šå°†ç”Ÿæˆå‡ºçš„ RSA ç§é’¥å†™å…¥ key.pem ä¸­ï¼ŒæŸ¥çœ‹ä¸€ä¸‹ç§é’¥å†…å®¹ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ryan@RYAN-MI-DESKTOP:~/istio$ cat key.pem
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAt1cKkQqPh8iOv5BhKh7Rx6A2+1ldpO/jczML/0GBKu4X+lHr
Y8YbJrt29jyAXlWM8vHC7tXsqgUG+WziRD0D8nhnh10XC14SeH+3mVuBqph+TqhX
TWsh9gtAIbeUHJjEI4I79QK4/wquPHHIGZBQDQQnuMh6vAS3VaUYJdEIoKvUBnAy
Y35kJZgyJSbrxLsEExL2zujUD/OY+/In2bq/3rFtDGNlgHyC7Gu2zXSXvfOA4O5m
9BBXOc7eEqj7PoOKNaTxLN3YcuRtgR6NIXL4KLb6oyvIzoeiprt4+9q7sc3Dnkc5
EV9kwWlEW2DHzhP6VYca0WXIIXc53U1AM3ewxwIDAQABAoIBABIKhaaqJF+XM7zU
B0uuxrPfJynqrFVbqcUfQ9H1bzF7Rm7CeuhRiUBxeA5Y+8TMpFcPxT/dWzGL1xja
RxWx715/zKg8V9Uth6HF55o2r/bKlLtGw3iBz1C34LKwrul1eu+HlEDS6MNoGKco
BynE0qvFOedsCu/Pgv7xhQPLow60Ty1uM0AhbcPgi6yJ5ksRB1XjtEnW0t+c8yQS
nU3mU8k230SdMhf4Ifud/5TPLjmXdFpyPi9uYiVdJ5oWsmMWEvekXoBnHWDDF/eT
VkVMiTBorT4qn+Ax1VjHL2VOMO5ZbXEcpbIc3Uer7eZAaDQ0NPZK37IkIn9TiZ21
cqzgbCkCgYEA5enHZbD5JgfwSNWCaiNrcBhYjpCtvfbT82yGW+J4/Qe/H+bY/hmJ
RRTKf0kVPdRwZzq7GphVMWIuezbOk0aFGhk/SzIveW8QpLY0FV/5xFnGNjV9AuNc
xrmgVshUsyQvr1TFkbdkC6yuvNgQfXfnbEoaPsXYEMCii2zqdF5lWGUCgYEAzCR2
6g8vEQx0hdRS5d0zD2/9IRYNzfP5oK0+F3KHH2OuwlmQVIo7IhCiUgqserXNBDef
hj+GNcU8O/yXLomAXG7VG/cLWRrpY8d9bcRMrwb0/SkNr0yNrkqHiWQ/PvR+2MLk
viWFZTTp8YizPA+8pSC/oFd1jkZF0UhKVAREM7sCgYB5+mfxyczFopyW58ADM7uC
g0goixXCnTuiAEfgY+0wwXVjJYSme0HaxscQdOOyJA1ml0BBQeShCKgEcvVyKY3g
ZNixunR5hrVbzdcgKAVJaR/CDuq+J4ZHYKByqmJVkLND4EPZpWSM1Rb31eIZzw2W
5FG8UBbr/GfAdQ6GorY+CQKBgQCzWQHkBmz6VG/2t6AQ9LIMSP4hWEfOfh78q9dW
MDdIO4JomtkzfLIQ7n49B8WalShGITwUbLDTgrG1neeQahsMmg6+X99nbD5JfBTV
H9WjG8CWvb+ZF++NhUroSNtLyu+6LhdaeopkbQVvPwMArG62wDu6ebv8v/5MrG8o
uwrUSwKBgQCxV43ZqTRnEuDlF7jMN+2JZWhpbrucTG5INoMPOC0ZVatePszZjYm8
LrmqQZHer2nqtFpyslwgKMWgmVLJTH7sVf0hS9po0+iSYY/r8e/c85UdUreb0xyT
x8whrOnMMODCAqu4W/Rx1Lgf2vXIx0pZmlt8Df9i2AVg/ePR6jO3Nw==
-----END RSA PRIVATE KEY-----
</code></pre></td></tr></table>
</div>
</div><p>æ¥ä¸‹æ¥é€šè¿‡ Python ç¼–ç¨‹ç”Ÿæˆ RSA Public Key å’Œ JWKï¼ˆjwk å…¶å®å°±æ˜¯å…¬é’¥çš„å¦ä¸€ä¸ªè¡¨è¿°å½¢å¼è€Œå·²ï¼‰:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># éœ€è¦å…ˆå®‰è£…ä¾èµ–: pip install jwcrypto
from jwcrypto.jwk import JWK
from pathlib import Path

private_key = Path(&#34;key.pem&#34;).read_bytes()
jwk = JWK.from_pem(private_key)

# å¯¼å‡ºå…¬é’¥ RSA Public Key
public_key = jwk.public().export_to_pem()
print(public_key)

print(&#34;=&#34;*30)

# å¯¼å‡º JWK
jwk_bytes = jwk.public().export()
print(jwk_bytes)
</code></pre></td></tr></table>
</div>
</div><p>Istio éœ€è¦ JWK è¿›è¡Œ JWT éªŒè¯ï¼Œè€Œæˆ‘ä»¬æ‰‹åŠ¨éªŒè¯ JWT æ—¶ä¸€èˆ¬éœ€è¦ç”¨åˆ° Public Key. æ–¹ä¾¿èµ·è§ï¼Œä¸Šè¿°ä»£ç æŠŠè¿™ä¸¤ä¸ªéƒ½æ‰“å°äº†å‡ºæ¥ã€‚å†…å®¹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># Public Key å†…å®¹ï¼Œä¸åŒ…å«è¿™è¡Œæ³¨é‡Š
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAt1cKkQqPh8iOv5BhKh7R
x6A2+1ldpO/jczML/0GBKu4X+lHrY8YbJrt29jyAXlWM8vHC7tXsqgUG+WziRD0D
8nhnh10XC14SeH+3mVuBqph+TqhXTWsh9gtAIbeUHJjEI4I79QK4/wquPHHIGZBQ
DQQnuMh6vAS3VaUYJdEIoKvUBnAyY35kJZgyJSbrxLsEExL2zujUD/OY+/In2bq/
3rFtDGNlgHyC7Gu2zXSXvfOA4O5m9BBXOc7eEqj7PoOKNaTxLN3YcuRtgR6NIXL4
KLb6oyvIzoeiprt4+9q7sc3Dnkc5EV9kwWlEW2DHzhP6VYca0WXIIXc53U1AM3ew
xwIDAQAB
-----END PUBLIC KEY-----
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback"># jwk å†…å®¹
{
 &#39;e&#39;: &#39;AQAB&#39;,
 &#39;kid&#39;: &#39;oyYwZSLCLVVPHdVp0jXIcLNpGn6dMCumlY-6wSenmFo&#39;,
 &#39;kty&#39;: &#39;RSA&#39;,
 &#39;n&#39;: &#39;t1cKkQqPh8iOv5BhKh7Rx6A2-1ldpO_jczML_0GBKu4X-lHrY8YbJrt29jyAXlWM8vHC7tXsqgUG-WziRD0D8nhnh10XC14SeH-3mVuBqph-TqhXTWsh9gtAIbeUHJjEI4I79QK4_wquPHHIGZBQDQQnuMh6vAS3VaUYJdEIoKvUBnAyY35kJZgyJSbrxLsEExL2zujUD_OY-_In2bq_3rFtDGNlgHyC7Gu2zXSXvfOA4O5m9BBXOc7eEqj7PoOKNaTxLN3YcuRtgR6NIXL4KLb6oyvIzoeiprt4-9q7sc3Dnkc5EV9kwWlEW2DHzhP6VYca0WXIIXc53U1AM3ewxw&#39;
}
</code></pre></td></tr></table>
</div>
</div><h3 id="4-æµ‹è¯•å¯†é’¥å¯ç”¨æ€§">4. æµ‹è¯•å¯†é’¥å¯ç”¨æ€§</h3>
<p>æ¥ä¸‹æ¥åœ¨ <a href="https://jwt.io" target="_blank" rel="noopener noreferrer">jwt.io</a> ä¸­å¡«å…¥æµ‹è¯•ç”¨çš„å…¬é’¥ç§é’¥ï¼Œè¿˜æœ‰ Header/Payloadã€‚ä¸€æ˜¯æµ‹è¯•å…¬ç§é’¥çš„å¯ç”¨æ€§ï¼ŒäºŒæ˜¯ç”Ÿæˆå‡º JWT ä¾›åç»­æµ‹è¯• Istio JWT éªŒè¯åŠŸèƒ½çš„å¯ç”¨æ€§ã€‚
</p>
<p>å¯ä»¥çœ‹åˆ°å·¦ä¸‹è§’æ˜¾ç¤ºã€ŒSignature Verifiedã€ï¼ŒæˆåŠŸåœ°ç”Ÿæˆå‡ºäº† JWTã€‚åç»­å¯ä»¥ä½¿ç”¨è¿™ä¸ª JWT è®¿é—® Istio ç½‘å…³ï¼Œæµ‹è¯• Istio JWT éªŒè¯åŠŸèƒ½ã€‚</p>
<h3 id="5-å¯ç”¨-istio-çš„èº«ä»½éªŒè¯">5. å¯ç”¨ Istio çš„èº«ä»½éªŒè¯</h3>
<p>ç¼–å†™ istio é…ç½®ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;security.istio.io/v1beta1&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;RequestAuthentication&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;jwt-example&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system </span><span class="w"> </span><span class="c"># istio-system åå­—ç©ºé—´ä¸­çš„é…ç½®ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šåº”ç”¨åˆ°æ‰€æœ‰åå­—ç©ºé—´</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">istio</span><span class="p">:</span><span class="w"> </span><span class="l">ingressgateway</span><span class="w">
</span><span class="w">  </span><span class="nt">jwtRules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="c"># issuer å³ç­¾å‘è€…ï¼Œéœ€è¦å’Œ JWT payload ä¸­çš„ iss å±æ€§å®Œå…¨ä¸€è‡´ã€‚</span><span class="w">
</span><span class="w">  </span>- <span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;testing@secure.istio.io&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">jwks</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    {
</span><span class="sd">        &#34;keys&#34;: [
</span><span class="sd">            {
</span><span class="sd">                &#34;e&#34;: &#34;AQAB&#34;,
</span><span class="sd">                &#34;kid&#34;: &#34;oyYwZSLCLVVPHdVp0jXIcLNpGn6dMCumlY-6wSenmFo&#34;,  # kid éœ€è¦ä¸ jwt header ä¸­çš„ kid å®Œå…¨ä¸€è‡´ã€‚
</span><span class="sd">                &#34;kty&#34;: &#34;RSA&#34;,
</span><span class="sd">                &#34;n&#34;: &#34;t1cKkQqPh8iOv5BhKh7Rx6A2-1ldpO_jczML_0GBKu4X-lHrY8YbJrt29jyAXlWM8vHC7tXsqgUG-WziRD0D8nhnh10XC14SeH-3mVuBqph-TqhXTWsh9gtAIbeUHJjEI4I79QK4_wquPHHIGZBQDQQnuMh6vAS3VaUYJdEIoKvUBnAyY35kJZgyJSbrxLsEExL2zujUD_OY-_In2bq_3rFtDGNlgHyC7Gu2zXSXvfOA4O5m9BBXOc7eEqj7PoOKNaTxLN3YcuRtgR6NIXL4KLb6oyvIzoeiprt4-9q7sc3Dnkc5EV9kwWlEW2DHzhP6VYca0WXIIXc53U1AM3ewxw&#34;
</span><span class="sd">            }
</span><span class="sd">        ]
</span><span class="sd">    }
</span><span class="sd">      # jwks æˆ– jwksUri äºŒé€‰å…¶ä¸€
</span><span class="sd">      # jwksUri: &#34;http://nginx.test.local/istio/jwks.json&#34;</span><span class="w">    
</span></code></pre></td></tr></table>
</div>
</div><p>ç°åœ¨ <code>kubectl apply</code> ä¸€ä¸‹ï¼ŒJWT éªŒè¯å°±æ·»åŠ åˆ°å…¨å±€äº†ã€‚</p>
<p>å¯ä»¥çœ‹åˆ° jwtRules æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå› æ­¤å¯ä»¥ä¸ºæ¯ä¸ª issuers é…ç½®ä¸åŒçš„ jwtRule.</p>
<p>å¯¹åŒä¸€ä¸ª issuersï¼ˆjwt ç­¾å‘è€…ï¼‰ï¼Œå¯ä»¥é€šè¿‡ jwks è®¾ç½®å¤šä¸ªå…¬é’¥ï¼Œä»¥å®ç°JWTç­¾åå¯†é’¥çš„è½®è½¬ã€‚
JWT çš„éªŒè¯è§„åˆ™æ˜¯ï¼š</p>
<ol>
<li>JWT çš„ payload ä¸­æœ‰ issuer å±æ€§ï¼Œé¦–å…ˆé€šè¿‡ issuer åŒ¹é…åˆ°å¯¹åº”çš„ istio ä¸­é…ç½®çš„ jwksã€‚</li>
<li>JWT çš„ header ä¸­æœ‰ kid å±æ€§ï¼Œç¬¬äºŒæ­¥åœ¨ jwks çš„å…¬é’¥åˆ—è¡¨ä¸­ï¼Œä¸­æ‰¾åˆ° kid ç›¸åŒçš„å…¬é’¥ã€‚</li>
<li>ä½¿ç”¨æ‰¾åˆ°çš„å…¬é’¥è¿›è¡Œ JWT ç­¾åéªŒè¯ã€‚</li>
</ol>
<h3 id="6-å¯ç”¨-payload-è½¬å‘authorization-è½¬å‘">6. å¯ç”¨ Payload è½¬å‘/Authorization è½¬å‘</h3>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒIstio åœ¨å®Œæˆäº†èº«ä»½éªŒè¯ä¹‹åï¼Œä¼šå»æ‰ Authorization è¯·æ±‚å¤´å†è¿›è¡Œè½¬å‘ã€‚
è¿™å°†å¯¼è‡´æˆ‘ä»¬çš„åç«¯æœåŠ¡è·å–ä¸åˆ°å¯¹åº”çš„ Payloadï¼Œæ— æ³•åˆ¤æ–­ End User çš„èº«ä»½ã€‚
å› æ­¤æˆ‘ä»¬éœ€è¦å¯ç”¨ Istio çš„ Authorization è¯·æ±‚å¤´çš„è½¬å‘åŠŸèƒ½ï¼Œåœ¨å‰è¿°çš„ <code>RequestAuthentication</code> yaml é…ç½®ä¸­æ·»åŠ ä¸€ä¸ªå‚æ•°å°±è¡Œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;security.istio.io/v1beta1&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;RequestAuthentication&#34;</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;jwt-example&#34;</span><span class="w">
</span><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">istio-system</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">istio</span><span class="p">:</span><span class="w"> </span><span class="l">ingressgateway</span><span class="w">
</span><span class="w">  </span><span class="nt">jwtRules</span><span class="p">:</span><span class="w">
</span><span class="w">  </span>- <span class="nt">issuer</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;testing@secure.istio.io&#34;</span><span class="w">
</span><span class="w">    </span><span class="nt">jwks</span><span class="p">:</span><span class="w"> </span><span class="p">|</span><span class="sd">
</span><span class="sd">    {
</span><span class="sd">        &#34;keys&#34;: [
</span><span class="sd">            {
</span><span class="sd">                &#34;e&#34;: &#34;AQAB&#34;,
</span><span class="sd">                &#34;kid&#34;: &#34;oyYwZSLCLVVPHdVp0jXIcLNpGn6dMCumlY-6wSenmFo&#34;,
</span><span class="sd">                &#34;kty&#34;: &#34;RSA&#34;,
</span><span class="sd">                &#34;n&#34;: &#34;t1cKkQqPh8iOv5BhKh7Rx6A2-1ldpO_jczML_0GBKu4X-lHrY8YbJrt29jyAXlWM8vHC7tXsqgUG-WziRD0D8nhnh10XC14SeH-3mVuBqph-TqhXTWsh9gtAIbeUHJjEI4I79QK4_wquPHHIGZBQDQQnuMh6vAS3VaUYJdEIoKvUBnAyY35kJZgyJSbrxLsEExL2zujUD_OY-_In2bq_3rFtDGNlgHyC7Gu2zXSXvfOA4O5m9BBXOc7eEqj7PoOKNaTxLN3YcuRtgR6NIXL4KLb6oyvIzoeiprt4-9q7sc3Dnkc5EV9kwWlEW2DHzhP6VYca0WXIIXc53U1AM3ewxw&#34;
</span><span class="sd">            }
</span><span class="sd">        ]
</span><span class="sd">    }</span><span class="w">    
</span><span class="w"></span><span class="c"># ===================== æ·»åŠ å¦‚ä¸‹å‚æ•°===========================</span><span class="w">
</span><span class="w">    </span><span class="nt">forwardOriginalToken</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">  </span><span class="c"># è½¬å‘ Authorization è¯·æ±‚å¤´</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>åŠ äº†è½¬å‘åï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼ˆéœ€è¦ mermaid æ¸²æŸ“ï¼‰ï¼š</p>
<div class="mermaid" id="id-1"></div>
<h2 id="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</h2>
<h3 id="1-authorizationpolicy">1. AuthorizationPolicy</h3>
<p>Istio çš„ JWT éªŒè¯è§„åˆ™ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šç›´æ¥å¿½ç•¥ä¸å¸¦ Authorization è¯·æ±‚å¤´çš„æµé‡ï¼Œå› æ­¤è¿™ç±»æµé‡èƒ½ç›´æ¥è¿›å…¥ç½‘æ ¼å†…éƒ¨ã€‚å¦‚æœéœ€è¦ç¦æ­¢ä¸å¸¦ Authorization å¤´çš„æµé‡ï¼Œéœ€è¦é¢å¤–é…ç½® AuthorizationPolicy ç­–ç•¥ã€‚</p>
<p>RequestsAuthentication éªŒè¯å¤±è´¥çš„è¯·æ±‚ï¼ŒIstio ä¼šè¿”å› 401 çŠ¶æ€ç ã€‚
AuthorizationPolicy éªŒè¯å¤±è´¥çš„è¯·æ±‚ï¼ŒIstio ä¼šè¿”å› 403 çŠ¶æ€ç ã€‚</p>
<p>è¿™ä¼šå¯¼è‡´åœ¨ä½¿ç”¨ AuthorizationPolicy ç¦æ­¢äº†ä¸å¸¦ Authorization å¤´çš„æµé‡åï¼Œè¿™ç±»è¯·æ±‚ä¼šç›´æ¥è¢«è¿”å› 403ã€‚ã€‚ã€‚åœ¨ä½¿ç”¨ RESTful API æ—¶ï¼Œè¿™ç§æƒ…å†µå¯èƒ½ä¼šé€ æˆä¸€å®šçš„é—®é¢˜ã€‚</p>
<h3 id="2-response-headers">2. Response Headers</h3>
<p>RequestsAuthentication ä¸æ”¯æŒè‡ªå®šä¹‰å“åº”å¤´ä¿¡æ¯ï¼Œè¿™å¯¼è‡´å¯¹äºå‰åç«¯åˆ†ç¦»çš„ Web API è€Œè¨€ï¼Œ
ä¸€æ—¦ JWT å¤±æ•ˆï¼ŒIstio ä¼šç›´æ¥å°† 401 è¿”å›ç»™å‰ç«¯ Web é¡µé¢ã€‚
å› ä¸ºå“åº”å¤´ä¸­ä¸åŒ…å« <code>Access-Crontrol-Allow-Origin</code>ï¼Œå“åº”å°†è¢«æµè§ˆå™¨æ‹¦æˆªï¼</p>
<p>è¿™å¯èƒ½éœ€è¦é€šè¿‡ EnvoyFilter è‡ªå®šä¹‰å“åº”å¤´ï¼Œæ·»åŠ è·¨åŸŸä¿¡æ¯ã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://auth0.com/docs/tokens/references/jwks-properties" target="_blank" rel="noopener noreferrer">JSON Web Key Set Properties - Auth0</a></li>
<li><a href="https://tools.ietf.org/html/rfc7517" target="_blank" rel="noopener noreferrer">JWK - RFC7517</a></li>
<li><a href="https://github.com/istio/istio/tree/master/security/tools/jwt/samples" target="_blank" rel="noopener noreferrer">Sample JWT and JWKS data for demo - Istio Security</a></li>
<li><a href="https://istio.io/docs/tasks/security/authentication/authn-policy/#end-user-authentication" target="_blank" rel="noopener noreferrer">End User Authentication - Istio</a></li>
<li><a href="https://istio.io/docs/reference/config/security/jwt/" target="_blank" rel="noopener noreferrer">JWTRule - Istio</a></li>
<li><a href="https://jwt.io/" target="_blank" rel="noopener noreferrer">jwt.io - åŠ¨æ€ç”Ÿæˆ jwt</a></li>
</ul>]]></description></item><item><title>Kubernetes å¸¸è§é”™è¯¯ã€åŸå› åŠå¤„ç†æ–¹æ³•</title><link>https://ryan4yin.space/posts/kubernetes-common-errors-and-solutions/</link><pubDate>Sun, 24 Nov 2019 19:26:54 +0800</pubDate><author>xiaoyin_c@qq.com</author><dc:creator>ryan4yin</dc:creator><guid>https://ryan4yin.space/posts/kubernetes-common-errors-and-solutions/</guid><description><![CDATA[<h2 id="pod-å¸¸è§é”™è¯¯">Pod å¸¸è§é”™è¯¯</h2>
<ol>
<li>OOMKilled: Pod çš„å†…å­˜ä½¿ç”¨è¶…å‡ºäº† resources.limits ä¸­çš„é™åˆ¶ï¼Œè¢«å¼ºåˆ¶æ€æ­»ã€‚</li>
<li><a href="https://cloud.tencent.com/developer/article/1411527" target="_blank" rel="noopener noreferrer">SandboxChanged: Pod sandbox changed, it will be killed and re-created</a>: å¾ˆå¯èƒ½æ˜¯ç”±äºå†…å­˜é™åˆ¶å¯¼è‡´å®¹å™¨è¢« OOMKilledï¼Œæˆ–è€…å…¶ä»–èµ„æºä¸è¶³
<ol>
<li>å¦‚æœæ˜¯ OOMï¼Œå®¹å™¨é€šå¸¸ä¼šè¢«é‡å¯ï¼Œ<code>kubectl describe</code> èƒ½çœ‹åˆ°å®¹å™¨ä¸Šæ¬¡è¢«é‡å¯çš„åŸå›  <code>State.Last State.Reason = OOMKilled, Exit Code=137</code>.</li>
</ol>
</li>
<li>Pod ä¸æ–­è¢«é‡å¯ï¼Œ<code>kubectl describe</code> æ˜¾ç¤ºé‡å¯åŸå›  <code>State.Last State.Reason = Error, Exit Code=137</code>ï¼Œ137 å¯¹åº” SIGKILL(<code>kill -9</code>) ä¿¡å·ï¼Œè¯´æ˜å®¹å™¨è¢«å¼ºåˆ¶é‡å¯ã€‚å¯èƒ½çš„åŸå› ï¼š
<ol>
<li>æœ€æœ‰å¯èƒ½çš„åŸå› æ˜¯ï¼Œå­˜æ´»æ¢é’ˆï¼ˆlivenessProbeï¼‰æ£€æŸ¥å¤±è´¥</li>
<li>èŠ‚ç‚¹èµ„æºä¸è¶³ï¼Œå†…æ ¸å¼ºåˆ¶å…³é—­äº†è¿›ç¨‹ä»¥é‡Šæ”¾èµ„æºï¼Œè¿™ç§æƒ…å†µå¯ä»¥é€šè¿‡ <code>journalctl -k</code> æŸ¥çœ‹è¯¦ç»†çš„ç³»ç»Ÿæ—¥å¿—ã€‚</li>
</ol>
</li>
<li>CrashLoopBackoff: Pod è¿›å…¥ <strong>å´©æºƒ-é‡å¯</strong>å¾ªç¯ï¼Œé‡å¯é—´éš”æ—¶é—´ä» 10 20 40 80 ä¸€ç›´ç¿»å€åˆ°ä¸Šé™ 300 ç§’ï¼Œç„¶åä»¥ 300 ç§’ä¸ºé—´éš”æ— é™é‡å¯ã€‚</li>
<li>Pod ä¸€ç›´ Pending: è¿™è¯´æ˜æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹èƒ½æ»¡è¶³ Pod çš„è¦æ±‚ï¼Œå®¹å™¨æ— æ³•è¢«è°ƒåº¦ã€‚æ¯”å¦‚ç«¯å£è¢«åˆ«çš„å®¹å™¨ç”¨ hostPort å ç”¨ï¼ŒèŠ‚ç‚¹æœ‰æ±¡ç‚¹ç­‰ã€‚</li>
<li><a href="" rel="">FailedCreateSandBox: Failed create pod sandbox: rpc error: code = DeadlineExceeded desc = context deadline exceeded</a>ï¼šå¾ˆå¯èƒ½æ˜¯ CNI ç½‘ç»œæ’ä»¶çš„é—®é¢˜ï¼ˆæ¯”å¦‚ ip åœ°å€æº¢å‡ºï¼‰ï¼Œ</li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/55094" target="_blank" rel="noopener noreferrer">FailedSync: error determining status: rpc error: code = DeadlineExceeded desc = context deadline exceeded</a>: å¸¸å’Œå‰ä¸¤ä¸ªé”™è¯¯å…ˆåå‡ºç°ï¼Œå¾ˆå¯èƒ½æ˜¯ CNI ç½‘ç»œæ’ä»¶çš„é—®é¢˜ã€‚</li>
<li>å¼€å‘é›†ç¾¤ï¼Œä¸€æ¬¡æ€§éƒ¨ç½²æ‰€æœ‰æœåŠ¡æ—¶ï¼Œå„ Pod äº’ç›¸äº‰æŠ¢èµ„æºï¼Œå¯¼è‡´ Pod ç”Ÿå­˜æ¢é’ˆå¤±è´¥ï¼Œä¸æ–­é‡å¯ï¼Œé‡å¯è¿›ä¸€æ­¥åŠ é‡èµ„æºä½¿ç”¨ã€‚æ¶æ€§å¾ªç¯ã€‚
<ul>
<li><strong>éœ€è¦ç»™æ¯ä¸ª Pod åŠ ä¸Š resources.requestsï¼Œè¿™æ ·èµ„æºä¸è¶³æ—¶ï¼Œåç»­ Pod ä¼šåœæ­¢è°ƒåº¦ï¼Œç›´åˆ°èµ„æºæ¢å¤æ­£å¸¸ã€‚</strong></li>
</ul>
</li>
<li>Pod å‡ºç°å¤§é‡çš„ Failed è®°å½•ï¼ŒDeployment ä¸€ç›´é‡å¤å»ºç«‹ Pod: é€šè¿‡ <code>kubectl describe/edit pod &lt;pod-name&gt;</code> æŸ¥çœ‹ pod <code>Events</code> å’Œ <code>Status</code>ï¼Œä¸€èˆ¬ä¼šçœ‹åˆ°å¤±è´¥ä¿¡æ¯ï¼Œå¦‚èŠ‚ç‚¹å¼‚å¸¸å¯¼è‡´ Pod è¢«é©±é€ã€‚</li>
<li><a href="https://zhuanlan.zhihu.com/p/70031676" target="_blank" rel="noopener noreferrer">Kubernetes é—®é¢˜æ’æŸ¥ï¼šPod çŠ¶æ€ä¸€ç›´ Terminating</a></li>
<li>åˆ›å»ºäº† Deployment åï¼Œå´æ²¡æœ‰è‡ªåŠ¨åˆ›å»º Pod: ç¼ºå°‘æŸäº›åˆ›å»º Pod å¿…è¦çš„ä¸œè¥¿ï¼Œæ¯”å¦‚è®¾å®šçš„ ServiceAccount ä¸å­˜åœ¨ã€‚</li>
<li>Pod è¿è¡Œå¤±è´¥ï¼ŒçŠ¶æ€ä¸º MatchNodeSelector: å¯¹ä¸»èŠ‚ç‚¹è¿›è¡Œå…³æœºã€è¿ç§»ç­‰æ“ä½œï¼Œå¯¼è‡´ä¸»è°ƒåº¦å™¨ä¸‹çº¿æ—¶ï¼Œä¼šåœ¨ä¸€æ®µæ—¶é—´å†…å¯¼è‡´ Pod è°ƒåº¦å¤±è´¥ï¼Œè°ƒåº¦å¤±è´¥ä¼šæŠ¥è¿™ä¸ªé”™ã€‚</li>
<li>Pod ä»ç„¶å­˜åœ¨ï¼Œä½†æ˜¯ <code>Service</code> çš„ Endpoints å´ä¸ºç©ºï¼Œæ‰¾ä¸åˆ°å¯¹åº”çš„ Pod IPs: é‡åˆ°è¿‡ä¸€æ¬¡ï¼Œæ˜¯å› ä¸ºæ—¶é—´è·³å˜ï¼ˆä»æœªæ¥çš„æ—¶é—´æ”¹å›äº†å½“å‰æ—¶é—´ï¼‰å¯¼è‡´çš„é—®é¢˜ã€‚</li>
</ol>
<h3 id="æ§åˆ¶é¢æ•…éšœå¯èƒ½ä¼šå¯¼è‡´å„ç±»å¥‡æ€ªçš„å¼‚å¸¸ç°è±¡">æ§åˆ¶é¢æ•…éšœå¯èƒ½ä¼šå¯¼è‡´å„ç±»å¥‡æ€ªçš„å¼‚å¸¸ç°è±¡</h3>
<p>å¯¹äºç”Ÿäº§ç¯å¢ƒçš„é›†ç¾¤ï¼Œå› ä¸ºæœ‰é«˜å¯ç”¨ï¼Œé€šå¸¸æˆ‘ä»¬æ¯”è¾ƒå°‘é‡åˆ°æ§åˆ¶é¢æ•…éšœé—®é¢˜ã€‚ä½†æ˜¯ä¸€æ—¦æ§åˆ¶é¢å‘ç”Ÿæ•…éšœï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´å„ç±»å¥‡æ€ªçš„å¼‚å¸¸ç°è±¡ã€‚
å¦‚æœèƒ½åœ¨æ’æŸ¥é—®é¢˜æ—¶ï¼ŒæŠŠæ§åˆ¶é¢å¼‚å¸¸è€ƒè™‘è¿›æ¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±èƒ½èŠ‚çº¦å¤§é‡çš„æ’æŸ¥æ—¶é—´ï¼Œå¿«é€Ÿå®šä½åˆ°é—®é¢˜ã€‚</p>
<p>å…¶ä¸­æ¯”è¾ƒéšæ™¦çš„å°±æ˜¯ controller-manager æ•…éšœå¯¼è‡´çš„å¼‚å¸¸ï¼š</p>
<ol>
<li>èŠ‚ç‚¹çš„æœåŠ¡å™¨å·²ç»è¢«ç»ˆæ­¢ï¼Œä½†æ˜¯ Kuberntes é‡Œè¿˜æ˜¾ç¤º node ä¸º Ready çŠ¶æ€ï¼Œä¸ä¼šæ›´æ–°ä¸º NotReady.</li>
<li>è¢«åˆ é™¤çš„ Pods å¯èƒ½ä¼šå¡åœ¨ Terminating çŠ¶æ€ï¼Œåªæœ‰å¼ºåˆ¶åˆ é™¤æ‰èƒ½åˆ é™¤æ‰å®ƒä»¬ã€‚å¹¶ä¸”ç¡®è®¤ Pod æ²¡æœ‰ <code>metadata.finalizers</code> å±æ€§</li>
<li>HPA çš„åŠ¨æ€ä¼¸ç¼©åŠŸèƒ½å¤±æ•ˆ</li>
<li>&hellip;</li>
</ol>
<p>å¦‚æœè¿™äº›ç°è±¡åŒæ—¶å‘ç”Ÿï¼Œå°±è¦æ€€ç–‘æ˜¯å¦æ˜¯ kube-controller-manager å‡ºé—®é¢˜äº†.</p>
<p>å…¶ä»–æ§åˆ¶é¢å¼‚å¸¸çš„è¯¦ç»†åˆ†æï¼Œå‚è§ <a href="./kubernetes%20%e6%8e%a7%e5%88%b6%e9%9d%a2%e6%95%85%e9%9a%9c%e7%8e%b0%e8%b1%a1%e5%8f%8a%e5%88%86%e6%9e%90.md" rel="">kubernetes æ§åˆ¶é¢æ•…éšœç°è±¡åŠåˆ†æ</a></p>
<h3 id="pod-æ— æ³•åˆ é™¤">Pod æ— æ³•åˆ é™¤</h3>
<p>å¯èƒ½æ˜¯æŸäº›èµ„æºæ— æ³•è¢«GCï¼Œè¿™ä¼šå¯¼è‡´å®¹å™¨å·²ç» Exited äº†ï¼Œä½†æ˜¯ Pod ä¸€ç›´å¤„äº Terminating çŠ¶æ€ã€‚</p>
<p>è¿™ä¸ªé—®é¢˜åœ¨ç½‘ä¸Šèƒ½æœåˆ°å¾ˆå¤šæ¡ˆä¾‹,ä½†å¤§éƒ½åªæ˜¯æä¾›äº†å¦‚ä¸‹çš„å¼ºåˆ¶æ¸…ç†å‘½ä»¤ï¼Œæœªåˆ†æå…·ä½“åŸå› ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl delete pods &lt;pod&gt; --grace-period<span class="o">=</span><span class="m">0</span> --force
</code></pre></td></tr></table>
</div>
</div><p>æœ€è¿‘æ‰¾åˆ°å‡ ç¯‡è¯¦ç»†çš„åŸå› åˆ†ææ–‡ç« ï¼Œå€¼å¾—ä¸€çœ‹ï¼š</p>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1680612" target="_blank" rel="noopener noreferrer">è…¾è®¯äº‘åŸç”Ÿ -ã€Pod TerminatingåŸå› è¿½è¸ªç³»åˆ—ã€‘ä¹‹ containerd ä¸­è¢«æ¼æ‰çš„ runc é”™è¯¯ä¿¡æ¯</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1680613" target="_blank" rel="noopener noreferrer">è…¾è®¯äº‘åŸç”Ÿ -ã€Pod TerminatingåŸå› è¿½è¸ªç³»åˆ—ä¹‹äºŒã€‘execè¿æ¥æœªå…³é—­å¯¼è‡´çš„äº‹ä»¶é˜»å¡</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1689486" target="_blank" rel="noopener noreferrer">è…¾è®¯äº‘åŸç”Ÿ -ã€Pod TerminatingåŸå› è¿½è¸ªç³»åˆ—ä¹‹ä¸‰ã€‘è®©dockeräº‹ä»¶å¤„ç†ç½¢å·¥çš„cancelçŠ¶æ€ç </a></li>
<li><a href="https://www.likakuli.com/posts/docker-pod-terminating/" target="_blank" rel="noopener noreferrer">Pod terminating - é—®é¢˜æ’æŸ¥ - KaKu Li</a></li>
</ul>
<p>å¤§è‡´æ€»ç»“ä¸€ä¸‹ï¼Œä¸»è¦åŸå› æ¥è‡ª docker 18.06 ä»¥åŠ kubernetes çš„ docker-shim è¿è¡Œæ—¶çš„åº•å±‚é€»è¾‘ï¼Œå·²ç»åœ¨æ–°ç‰ˆæœ¬è¢«ä¿®å¤äº†ã€‚</p>
<h3 id="initcontainers-ä¸æ–­-restartä½†æ˜¯-containers-å´éƒ½æ˜¾ç¤ºå·²-ready">initContainers ä¸æ–­ restartï¼Œä½†æ˜¯ Containers å´éƒ½æ˜¾ç¤ºå·² ready</h3>
<p>Kubernetes åº”è¯¥ç¡®ä¿æ‰€æœ‰ initContainers éƒ½ Completedï¼Œç„¶åæ‰èƒ½å¯åŠ¨ Containers.</p>
<p>ä½†æ˜¯æˆ‘ä»¬å‘ç°æœ‰ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæ‰€æœ‰åŒ…å« initContainers çš„ Podï¼ŒçŠ¶æ€å…¨éƒ½æ˜¯ <code>Init:CrashLoopBackOff</code> æˆ–è€… <code>Init:Error</code>.</p>
<p>è€Œä¸”è¿›ä¸€æ­¥ <code>kubectl describe po</code> æŸ¥çœ‹ç»†èŠ‚ï¼Œå‘ç° initContainer çš„çŠ¶æ€ä¸º:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">...
    State:          Waiting
      Reason:       CrashLoopBackOff
    Last State:     Terminated
      Reason:       Error
      Exit Code:    2
      Started:      Tue, 03 Aug 2021 06:02:42 +0000
      Finished:     Tue, 03 Aug 2021 06:02:42 +0000
    Ready:          False
    Restart Count:  67
...
</code></pre></td></tr></table>
</div>
</div><p>è€Œ Containers çš„çŠ¶æ€å±…ç„¶æ˜¯ ready:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">...
    Host Port:      0/TCP
    State:          Running
      Started:      Tue, 03 Aug 2021 00:35:30 +0000
    Ready:          True
    Restart Count:  0
...
</code></pre></td></tr></table>
</div>
</div><p>initContainers è¿˜æœªè¿è¡ŒæˆåŠŸï¼Œè€Œ Containers å´ Ready äº†ï¼Œéå¸¸ç–‘æƒ‘ã€‚</p>
<p>ä»”ç»†æƒ³äº†ä¸‹ï¼Œæ—©ä¸Šå› ä¸ºç£ç›˜ä½™é‡å‘Šè­¦ï¼Œæœ‰æ‰‹åŠ¨è¿è¡Œè¿‡ <code>docker system prune</code> å‘½ä»¤ï¼Œé‚£ä¹ˆé—®é¢˜å¯èƒ½å°±æ˜¯è¿™æ¡å‘½ä»¤æ¸…ç†æ‰äº†å·²ç» exited çš„ initContainers å®¹å™¨ï¼Œå¯¼è‡´ k8s æ•…éšœï¼Œä¸æ–­å°è¯•é‡å¯è¯¥å®¹å™¨ã€‚</p>
<p>ç½‘ä¸Šä¸€æœç¡®å®æœ‰ç›¸å…³çš„ä¿¡æ¯ï¼š</p>
<ul>
<li><a href="https://stackoverflow.com/questions/62333064/cant-delete-exited-init-container">https://stackoverflow.com/questions/62333064/cant-delete-exited-init-container</a></li>
<li><a href="https://github.com/kubernetes/kubernetes/issues/62362">https://github.com/kubernetes/kubernetes/issues/62362</a></li>
</ul>
<p>ç»“è®ºï¼šä½¿ç”¨å¤–éƒ¨çš„åƒåœ¾æ¸…ç†å‘½ä»¤å¯èƒ½å¯¼è‡´ k8s è¡Œä¸ºå¼‚å¸¸ã€‚</p>
<h2 id="èŠ‚ç‚¹å¸¸è§é”™è¯¯">èŠ‚ç‚¹å¸¸è§é”™è¯¯</h2>
<ol>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/#node-conditions" target="_blank" rel="noopener noreferrer">DiskPressure</a>ï¼šèŠ‚ç‚¹çš„å¯ç”¨ç©ºé—´ä¸è¶³ã€‚ï¼ˆé€šè¿‡<code>df -h</code> æŸ¥çœ‹ï¼Œä¿è¯å¯ç”¨ç©ºé—´ä¸å°äº 15%ï¼‰</li>
<li>The node was low on resource: ephemeral-storage: åŒä¸Šï¼ŒèŠ‚ç‚¹çš„å­˜å‚¨ç©ºé—´ä¸å¤Ÿäº†ã€‚</li>
</ol>
<p>èŠ‚ç‚¹å­˜å‚¨å‘Šè­¦å¯èƒ½çš„åŸå› ï¼š</p>
<ol>
<li>kubelet çš„èµ„æº GC è®¾ç½®æœ‰é—®é¢˜ï¼Œé—ç•™çš„é•œåƒç­‰èµ„æºæœªåŠæ—¶ GC å¯¼è‡´å‘Šè­¦</li>
<li>å­˜åœ¨è¿è¡Œçš„ pod ä½¿ç”¨äº†å¤§é‡å­˜å‚¨ç©ºé—´ï¼Œåœ¨èŠ‚ç‚¹ä¸Šé€šè¿‡ <code>docker ps -a --size | grep G</code> å¯ä»¥æŸ¥çœ‹åˆ°</li>
<li>å¦‚æœä½¿ç”¨çš„æ˜¯ EKSï¼Œå¹¶ä¸”ç£ç›˜å‘Šè­¦çš„æŒ‚è½½ç‚¹ä¸º <code>/var/lib/kubelet/plugins/kubernetes.io/aws-ebs/mounts/aws/us-east-1b/vol-xxxxx</code>
<ol>
<li>æ˜¾ç„¶æ˜¯ EBS å­˜å‚¨å·å¿«æ»¡äº†å¯¼è‡´çš„</li>
<li>å¯é€šè¿‡ <code> kubectl get pv -A -o yaml | grep -C 30 vol-xxxxx</code> æ¥å®šä½åˆ°å…·ä½“çš„å­˜å‚¨å·</li>
</ol>
</li>
</ol>
<h2 id="ç½‘ç»œå¸¸è§é”™è¯¯">ç½‘ç»œå¸¸è§é”™è¯¯</h2>
<h3 id="1-ingressistio-gateway-è¿”å›å€¼">1. Ingress/Istio Gateway è¿”å›å€¼</h3>
<ol>
<li>404ï¼šä¸å­˜åœ¨è¯¥ Service/Istio Gatewayï¼Œæˆ–è€…æ˜¯æœåŠ¡è‡ªèº«è¿”å› 404</li>
<li>500ï¼šå¤§æ¦‚ç‡æ˜¯æœåŠ¡è‡ªèº«çš„é”™è¯¯å¯¼è‡´ 500ï¼Œå°æ¦‚ç‡æ˜¯ä»£ç†ï¼ˆSidecar/Ingress ç­‰ï¼‰çš„é”™è¯¯</li>
<li>503ï¼šæœåŠ¡ä¸å¯ç”¨ï¼Œæœ‰å¦‚ä¸‹å‡ ç§å¯èƒ½çš„åŸå› ï¼š
<ol>
<li>Service å¯¹åº”çš„ Pods ä¸å­˜åœ¨ï¼Œendpoints ä¸ºç©º</li>
<li>Service å¯¹åº”çš„ Pods å…¨éƒ¨éƒ½ NotReadyï¼Œå¯¼è‡´ endpoints ä¸ºç©º</li>
<li>ä¹Ÿæœ‰å¯èƒ½æ˜¯æœåŠ¡è‡ªèº«å‡ºé”™è¿”å›çš„ 503</li>
<li>å¦‚æœä½ ä½¿ç”¨äº† envoy sidecarï¼Œ 503 å¯èƒ½çš„åŸå› å°±å¤šäº†ã€‚åŸºæœ¬ä¸Š sidecar ä¸ä¸»å®¹å™¨é€šä¿¡è¿‡ç¨‹ä¸­çš„ä»»ä½•é—®é¢˜éƒ½ä¼šä½¿ envoy è¿”å› 503ï¼Œä½¿å®¢æˆ·ç«¯é‡è¯•ã€‚
<ol>
<li>è¯¦è§ <a href="https://blog.fleeto.us/post/istio-503-uc-debug/" target="_blank" rel="noopener noreferrer">Istioï¼š503ã€UC å’Œ TCP</a></li>
</ol>
</li>
</ol>
</li>
<li>502ï¼šBad Gatewayï¼Œé€šå¸¸æ˜¯ç”±äºä¸Šæ¸¸æœªè¿”å›æ­£ç¡®çš„å“åº”å¯¼è‡´çš„ï¼Œå¯èƒ½çš„æ ¹æœ¬åŸå› ï¼š
<ol>
<li>åº”ç”¨ç¨‹åºæœªæ­£ç¡®å¤„ç† SIGTERM ä¿¡å·ï¼Œåœ¨è¯·æ±‚æœªå¤„ç†å®Œæ¯•æ—¶ç›´æ¥ç»ˆæ­¢äº†è¿›ç¨‹ã€‚è¯¦è§ <a href="./%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5.md" rel="">ä¼˜é›…åœæ­¢ï¼ˆGracful Shutdownï¼‰ä¸ 502/504 æŠ¥é”™ - K8s æœ€ä½³å®è·µ</a></li>
<li>ç½‘ç»œæ’ä»¶ bug</li>
</ol>
</li>
<li>504ï¼šç½‘å…³è¯·æ±‚ upstream è¶…æ—¶ï¼Œä¸»è¦æœ‰ä¸¤ç§å¯èƒ½
<ol>
<li>è€ƒè™‘æ˜¯ä¸æ˜¯ Ingress Controller çš„ IP åˆ—è¡¨æœªæ›´æ–°ï¼Œå°†è¯·æ±‚ä»£ç†åˆ°äº†ä¸å­˜åœ¨çš„ ipï¼Œå¯¼è‡´å¾—ä¸åˆ°å“åº”</li>
<li>Service Endpoints ç§»é™¤ä¸å¤ŸåŠæ—¶ï¼Œåœ¨ Pod å·²ç»è¢«ç»ˆæ­¢åï¼Œä»ç„¶æœ‰ä¸ªåˆ«è¯·æ±‚è¢«è·¯ç”±åˆ°äº†è¯¥ Podï¼Œå¾—ä¸åˆ°å“åº”å¯¼è‡´ 504ã€‚è¯¦è§ <a href="./%e6%9c%80%e4%bd%b3%e5%ae%9e%e8%b7%b5.md" rel="">ä¼˜é›…åœæ­¢ï¼ˆGracful Shutdownï¼‰ä¸ 502/504 æŠ¥é”™ - K8s æœ€ä½³å®è·µ</a></li>
<li>Pod å“åº”å¤ªæ…¢ï¼Œä»£ç é—®é¢˜</li>
</ol>
</li>
</ol>
<p>å†æ€»ç»“ä¸€ä¸‹å¸¸è§çš„å‡ ç§é”™è¯¯ï¼š</p>
<ul>
<li>æœªè®¾ç½®ä¼˜é›…åœæ­¢ï¼Œå¯¼è‡´ Pod è¢«é‡æ–°ç»ˆæ­¢æ—¶ï¼Œæœ‰æ¦‚ç‡å‡ºç° 502/504</li>
<li>æœåŠ¡çš„æ‰€æœ‰ Pods çš„çŠ¶æ€åœ¨ã€Œå°±ç»ªã€å’Œã€Œæœªå°±ç»ªã€ä¹‹é—´æ‘†åŠ¨ï¼Œå¯¼è‡´é—´æ­‡æ€§åœ°å‡ºç°å¤§é‡ 503 é”™è¯¯</li>
<li>æœåŠ¡è¿”å› 5xx é”™è¯¯å¯¼è‡´å®¢æˆ·ç«¯ä¸æ–­é‡è¯•ï¼Œè¯·æ±‚æµé‡è¢«æ”¾å¤§ï¼Œå¯¼è‡´æœåŠ¡ä¸€ç›´èµ·ä¸æ¥
<ul>
<li>è§£å†³åŠæ³•ï¼šé™æµã€ç†”æ–­ï¼ˆç½‘å…³å±‚ç›´æ¥è¿”å›å›ºå®šçš„ç›¸åº”å†…å®¹ï¼‰</li>
</ul>
</li>
</ul>
<p>Ingress ç›¸å…³ç½‘ç»œé—®é¢˜çš„æ’æŸ¥æµç¨‹ï¼š</p>
<ol>
<li>Which ingress controller?</li>
<li>Timeout between client and ingress controller, or between ingress controller and backend service/pod?</li>
<li>HTTP/504 generated by the ingress controller, proven by logs from the ingress controller?</li>
<li>If you port-forward to skip the internet between client and ingress controller, does the timeout still happen?</li>
</ol>
<h3 id="2-ä¸Šäº†-istio-sidecar-ååº”ç”¨ç¨‹åºå¶å°”é—´éš”å‡ å¤©åŠä¸ªæœˆä¼š-redis-è¿æ¥ç›¸å…³çš„é”™è¯¯">2. ä¸Šäº† istio sidecar åï¼Œåº”ç”¨ç¨‹åºå¶å°”ï¼ˆé—´éš”å‡ å¤©åŠä¸ªæœˆï¼‰ä¼š redis è¿æ¥ç›¸å…³çš„é”™è¯¯</h3>
<p>è€ƒè™‘æ˜¯å¦å’Œ tcp é•¿æ—¶é—´ä½¿ç”¨æœ‰å…³ï¼Œæ¯”å¦‚è¿æ¥é•¿æ—¶é—´ç©ºé—²çš„è¯ï¼Œå¯èƒ½ä¼šè¢« istio sidecar æ–­å¼€ã€‚
å¦‚æœç¨‹åºè‡ªèº«çš„é‡è¿æœºåˆ¶æœ‰é—®é¢˜ï¼Œå°±ä¼šå¯¼è‡´è¿™ç§ç°è±¡ã€‚</p>
<p>ç¡®è®¤æ–¹æ³•ï¼š</p>
<ol>
<li>æ£€æŸ¥ istio çš„ <code>idleTimeout</code> æ—¶é•¿ï¼ˆé»˜è®¤ 1hï¼‰</li>
<li>åˆ›å»ºä¸‰äº”ä¸ªæ²¡æµé‡çš„ Pod æ”¾ç½® 1hï¼ˆä¸ istio idleTimeout æ—¶é•¿ä¸€è‡´ï¼‰ï¼Œçœ‹çœ‹æ˜¯å¦ä¼šå‡†æ—¶å¼€å§‹æŠ¥ redis çš„é”™ã€‚</li>
<li>å¯¹ç…§ç»„ï¼šåˆ›å»ºä¸‰äº”ä¸ªåŒæ ·æ²¡æµé‡çš„ Podï¼Œä½†æ˜¯ä¸æ³¨å…¥ istio sidecarï¼Œåº”è¯¥ä¸€ç›´å¾ˆæ­£å¸¸</li>
</ol>
<p>è¿™æ ·å°±èƒ½ç¡®è®¤é—®é¢˜ï¼Œåç»­å¤„ç†ï¼š</p>
<ol>
<li>æŠ“åŒ…è§‚å¯Ÿç¨‹åºåœ¨å‡ºé”™åçš„ tcp å±‚è¡Œä¸º</li>
<li>æŸ¥é˜… redis sdk çš„ç›¸å…³ issueã€ä»£ç ï¼Œé€šè¿‡å‡çº§ SDK åº”è¯¥èƒ½è§£å†³é—®é¢˜ã€‚</li>
</ol>
<h2 id="åå­—ç©ºé—´å¸¸è§é”™è¯¯">åå­—ç©ºé—´å¸¸è§é”™è¯¯</h2>
<h3 id="åå­—ç©ºé—´æ— æ³•åˆ é™¤">åå­—ç©ºé—´æ— æ³•åˆ é™¤</h3>
<p>è¿™é€šå¸¸æ˜¯æŸäº›èµ„æºå¦‚ CR(custom resources)/å­˜å‚¨ç­‰èµ„æºæ— æ³•é‡Šæ”¾å¯¼è‡´çš„ã€‚
æ¯”å¦‚å¸¸è§çš„ monitoring åå­—ç©ºé—´æ— æ³•åˆ é™¤ï¼Œåº”è¯¥å°±æ˜¯ CR æ— æ³• GC å¯¼è‡´çš„ã€‚</p>
<p>å¯æ‰‹åŠ¨åˆ é™¤ namespace é…ç½®ä¸­çš„ææ„å™¨ï¼ˆspec.finalizerï¼Œåœ¨åå­—ç©ºé—´ç”Ÿå‘½å‘¨æœŸç»“æŸå‰ä¼šç”Ÿæˆçš„é…ç½®é¡¹ï¼‰ï¼Œè¿™æ ·åå­—ç©ºé—´å°±ä¼šç›´æ¥è·³è¿‡ GC æ­¥éª¤ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ç¼–è¾‘åå­—ç©ºé—´çš„é…ç½®</span>
kubectl edit namespace &lt;ns-name&gt;
<span class="c1"># å°† spec.finalizers æ”¹æˆç©ºåˆ—è¡¨ []</span>
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœä¸Šè¿°æ–¹æ³•ä¹Ÿæ— æ³•åˆ é™¤åå­—ç©ºé—´ï¼Œä¹Ÿæ‰¾ä¸åˆ°å…·ä½“çš„é—®é¢˜ï¼Œå°±åªèƒ½ç›´æ¥ä» etcd ä¸­åˆ é™¤æ‰å®ƒäº†(æœ‰é£é™©ï¼Œè°¨æ…æ“ä½œï¼)ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell"><span class="c1"># ç™»å½•åˆ° etcd å®¹å™¨ä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</span>
<span class="nb">export</span> <span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span>
<span class="nb">cd</span> /etc/kubernetes/pki/etcd/
<span class="c1"># åˆ—å‡ºæ‰€æœ‰åå­—ç©ºé—´</span>
etcdctl --cacert ca.crt --cert peer.crt --key peer.key get /registry/namespaces --prefix --keys-only

<span class="c1"># ï¼ˆè°¨æ…æ“ä½œï¼ï¼ï¼ï¼‰å¼ºåˆ¶åˆ é™¤åå­—ç©ºé—´ `monitoring`ã€‚è¿™å¯èƒ½å¯¼è‡´ç›¸å…³èµ„æºæ— æ³•è¢« GCï¼</span>
etcdctl --cacert ca.crt --cert peer.crt --key peer.key del /registry/namespaces/monitoring
</code></pre></td></tr></table>
</div>
</div><h2 id="kubectlistioctl-ç­‰å®¢æˆ·ç«¯å·¥å…·å¼‚å¸¸">kubectl/istioctl ç­‰å®¢æˆ·ç«¯å·¥å…·å¼‚å¸¸</h2>
<ol>
<li><code>socat not found</code>: kubectl ä½¿ç”¨ <code>socat</code> è¿›è¡Œç«¯å£è½¬å‘ï¼Œé›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä»¥åŠæœ¬æœºéƒ½å¿…é¡»å®‰è£…æœ‰ <code>socat</code> å·¥å…·ã€‚</li>
</ol>
<h2 id="æ‰¹é‡æ¸…ç†-evicted-è®°å½•">æ‰¹é‡æ¸…ç† Evicted è®°å½•</h2>
<p>æœ‰æ—¶å€™ Pod å› ä¸ºèŠ‚ç‚¹é€‰æ‹©å™¨çš„é—®é¢˜ï¼Œè¢«ä¸æ–­è°ƒåº¦åˆ°æœ‰é—®é¢˜çš„ Node ä¸Šï¼Œå°±ä¼šä¸æ–­è¢« Evictedï¼Œå¯¼è‡´å‡ºç°å¤§é‡çš„ Evicted Podsã€‚
æ’æŸ¥å®Œé—®é¢˜åï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†æ‰è¿™äº› Evicted Pods.</p>
<p>æ‰¹é‡åˆ é™¤ Evicted è®°å½•:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">kubectl get pods <span class="p">|</span> grep Evicted <span class="p">|</span> awk <span class="s1">&#39;{print $1}&#39;</span> <span class="p">|</span> xargs kubectl delete pod
</code></pre></td></tr></table>
</div>
</div><h2 id="å®¹å™¨é•œåƒgcpodé©±é€ä»¥åŠèŠ‚ç‚¹å‹åŠ›">å®¹å™¨é•œåƒGCã€Podé©±é€ä»¥åŠèŠ‚ç‚¹å‹åŠ›</h2>
<p>èŠ‚ç‚¹å‹åŠ› DiskPressure ä¼šå¯¼è‡´ Pod è¢«é©±é€ï¼Œä¹Ÿä¼šè§¦å‘å®¹å™¨é•œåƒçš„ GCã€‚</p>
<p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/out-of-resource" target="_blank" rel="noopener noreferrer">é…ç½®èµ„æºä¸è¶³æ—¶çš„å¤„ç†æ–¹å¼</a>ï¼ŒKubelet æä¾›å¦‚ä¸‹ç”¨äºé…ç½®å®¹å™¨ GC åŠ Evicetion çš„é˜ˆå€¼ï¼š</p>
<ol>
<li><code>--eviction-hard</code> å’Œ <code>eviction-soft</code>: å¯¹åº”æ—§å‚æ•° <code>--image-gc-high-threshold</code>ï¼Œè¿™ä¸¤ä¸ªå‚æ•°é…ç½®é•œåƒ GC åŠé©±é€çš„è§¦å‘é˜ˆå€¼ã€‚ç£ç›˜ä½¿ç”¨ç‡çš„é˜ˆå€¼é»˜è®¤ä¸º 85%
<ol>
<li>åŒºåˆ«åœ¨äº <code>eviction-hard</code> æ˜¯ç«‹å³é©±é€ï¼Œè€Œ <code>eviction-soft</code> åœ¨è¶…è¿‡ <code>eviction-soft-grace-period</code> ä¹‹åæ‰é©±é€ã€‚</li>
</ol>
</li>
<li><code>--eviction-minimum-reclaim</code>: å¯¹åº”æ—§å‚æ•° <code>--image-gc-low-threshold</code>ã€‚è¿™æ˜¯è¿›è¡Œèµ„æºå›æ”¶ï¼ˆé•œåƒGCã€Podé©±é€ç­‰ï¼‰åæœŸæœ›è¾¾åˆ°çš„ç£ç›˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”ã€‚ç£ç›˜ä½¿ç”¨ç‡çš„é˜ˆå€¼é»˜è®¤å€¼ä¸º 80%ã€‚</li>
</ol>
<p>é—®ï¼šèƒ½å¦ä¸º ImageGC è®¾ç½®ä¸€ä¸ªæ¯” DiskPressure æ›´ä½çš„é˜ˆå€¼ï¼Ÿå› ä¸ºæˆ‘ä»¬å¸Œæœ›èƒ½è‡ªåŠ¨è¿›è¡Œé•œåƒ GCï¼Œä½†æ˜¯ä¸æƒ³ç«‹å³è§¦å‘ Pod é©±é€ã€‚</p>
<p>ç­”ï¼šè¿™åº”è¯¥å¯ä»¥é€šè¿‡è®¾ç½® <code>eviction-soft</code> å’Œé•¿ä¸€ç‚¹çš„ <code>eviction-soft-grace-period</code> æ¥å®ç°ã€‚
å¦å¤– <code>--eviction-minimum-reclaim</code> ä¹Ÿå¯ä»¥è®¾å°ä¸€ç‚¹ï¼Œæ¸…ç†å¾—æ›´å¹²å‡€ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">--eviction-soft<span class="o">=</span>memory.available&lt;1Gi,nodefs.available&lt;2Gi,imagefs.available&lt;200Gi
--eviction-soft-grace-period<span class="o">=</span>3m
--eviction-minimum-reclaim<span class="o">=</span>memory.available<span class="o">=</span>0Mi,nodefs.available<span class="o">=</span>1Gi,imagefs.available<span class="o">=</span>2Gi
</code></pre></td></tr></table>
</div>
</div><h2 id="å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</h2>
<h2 id="éš”å¤©-istio-ç­‰å·¥å…·çš„-sidecar-è‡ªåŠ¨æ³¨å…¥è«åå…¶å¦™å¤±æ•ˆäº†">éš”å¤© Istio ç­‰å·¥å…·çš„ sidecar è‡ªåŠ¨æ³¨å…¥è«åå…¶å¦™å¤±æ•ˆäº†</h2>
<p>å¦‚æœæœåŠ¡å™¨æ™šä¸Šä¼šå…³æœºï¼Œå¯èƒ½å¯¼è‡´ç¬¬äºŒå¤©ç½‘ç»œæ’ä»¶å‡ºé—®é¢˜ï¼Œå¯¼è‡´ sidecar æ³¨å…¥å™¨æ— æ³•è§‚å¯Ÿåˆ° pod çš„åˆ›å»ºï¼Œä¹Ÿå°±æ— æ³•å®Œæˆ sidecar æ³¨å…¥ã€‚</p>
<h3 id="å¦‚ä½•é‡æ–°è¿è¡Œä¸€ä¸ª-job">å¦‚ä½•é‡æ–°è¿è¡Œä¸€ä¸ª Jobï¼Ÿ</h3>
<p>æˆ‘ä»¬æœ‰ä¸€ä¸ª Job å› ä¸ºå¤–éƒ¨åŸå› è¿è¡Œå¤±è´¥äº†ï¼Œä¿®å¤å¥½åå°±éœ€è¦é‡æ–°è¿è¡Œå®ƒã€‚</p>
<p>æ–¹æ³•æ˜¯ï¼šåˆ é™¤æ—§çš„ Jobï¼Œå†ä½¿ç”¨åŒä¸€ä»½é…ç½®é‡å»º Job.</p>
<p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ fluxcd è¿™ç±» GitOps å·¥å…·ï¼Œå°±åªéœ€è¦æ‰‹å·¥åˆ é™¤æ—§ Podï¼Œfluxcd ä¼šå®šæ—¶è‡ªåŠ¨ apply æ‰€æœ‰é…ç½®ï¼Œè¿™å°±å®Œæˆäº† Job çš„é‡å»ºã€‚</p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<ul>
<li><a href="https://yq.aliyun.com/articles/703971?type=2" target="_blank" rel="noopener noreferrer">Kubernetesç®¡ç†ç»éªŒ</a></li>
<li><a href="https://www.reddit.com/r/kubernetes/comments/ced0py/504_gateway_timeout_when_accessing_workload_via/" target="_blank" rel="noopener noreferrer">504 Gateway Timeout when accessing workload via ingress</a></li>
<li><a href="https://k8s.af/" target="_blank" rel="noopener noreferrer">Kubernetes Failure Stories</a></li>
<li><a href="https://blog.fleeto.us/post/istio-503-uc-debug/" target="_blank" rel="noopener noreferrer">Istioï¼š503ã€UC å’Œ TCP</a></li>
</ul>
]]></description></item></channel></rss>