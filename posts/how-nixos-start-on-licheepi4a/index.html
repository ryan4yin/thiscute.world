<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>NixOS 在 Lichee Pi 4A 上是如何启动的 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:url" content="https://thiscute.world/posts/how-nixos-start-on-licheepi4a/"><meta property="og:site_name" content="This Cute World"><meta property="og:title" content="NixOS 在 Lichee Pi 4A 上是如何启动的"><meta property="og:description" content="文章是 2023-08-07 写的，后面就完全忘掉这回事了，今天偶然翻到它才想起要整理发布下…所以注意文章中的时间线是 2023 年 8 月。
零、前言我从今年 5 月份初收到了内测板的 Lichee Pi 4A，这是当下性能最高的 RISC-V 开发板之一，不过当时没怎么折腾。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-29T00:58:57+08:00"><meta property="article:modified_time" content="2024-01-29T00:58:57+08:00"><meta property="article:tag" content="Linux"><meta property="article:tag" content="NixOS"><meta property="article:tag" content="LicheePi4A"><meta property="article:tag" content="Embedded"><meta property="article:tag" content="U-Boot"><meta property="article:tag" content="RISC-V"><meta property="og:image" content="https://thiscute.world/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp"><meta property="og:see_also" content="https://thiscute.world/posts/my-experience-of-nixos/"><meta property="og:see_also" content="https://thiscute.world/posts/nixos-and-flake-basics/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp"><meta name=twitter:title content="NixOS 在 Lichee Pi 4A 上是如何启动的"><meta name=twitter:description content="文章是 2023-08-07 写的，后面就完全忘掉这回事了，今天偶然翻到它才想起要整理发布下…所以注意文章中的时间线是 2023 年 8 月。
零、前言我从今年 5 月份初收到了内测板的 Lichee Pi 4A，这是当下性能最高的 RISC-V 开发板之一，不过当时没怎么折腾。"><meta name=twitter:site content="@ryan4yin"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><meta name=twitter:creator content="@ryan4yin"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/><link rel=prev href=https://thiscute.world/posts/2023-summary/><link rel=next href=https://thiscute.world/posts/an-incomplete-guide-to-data-security/><link rel=stylesheet href=/css/main.min.css><link rel=stylesheet href=/css/style.min.css><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NixOS 在 Lichee Pi 4A 上是如何启动的","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://thiscute.world/posts/how-nixos-start-on-licheepi4a/"},"image":[{"@type":"ImageObject","url":"https://thiscute.world/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp","width":4096,"height":3072}],"genre":"posts","keywords":["Linux","NixOS","LicheePi4A","Embedded","U-Boot","RISC-V"],"wordcount":12256,"url":"https://thiscute.world/posts/how-nixos-start-on-licheepi4a/","datePublished":"2024-01-29T00:58:57+08:00","dateModified":"2024-01-29T00:58:57+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https://thiscute.world/avatar/myself.png"},"author":[{"@type":"Person","name":"於清樂","url":null}],"description":""}</script></head><body data-instant-intensity=viewport><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.className=e,document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),e==="light"?document.documentElement.classList.remove("tw-dark"):document.documentElement.classList.add("tw-dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#161b22"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class="desktop print:!tw-hidden" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行 </a><a class=menu-item href=/series/>系列 </a><a class=menu-item href=/categories/tech/>技术 </a><a class=menu-item href=/categories/life/>生活 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/friends/>朋友们 </a><a class=menu-item href=/now/>此刻 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><button class="menu-item language" aria-label=选择语言>Simplified Chinese<svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
<select class=language-select aria-label=选择语言 id=language-select-desktop onchange="location=this.value"><option value=/posts/how-nixos-start-on-licheepi4a/ selected>Simplified Chinese</option></select>
</button><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<button class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear" id=search-clear-desktop title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-desktop><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
</span></span><button class="menu-item theme-switch" aria-label=切换主题>
<svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg></button></div></div></div></header><header class="mobile print:!tw-hidden" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<button class="search-button search-toggle tw-h-10" id=search-toggle-mobile title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear" id=search-clear-mobile title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-mobile><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg></span></div><button class=search-cancel id=search-cancel-mobile>
取消</button></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><button class="menu-item theme-switch tw-w-full" aria-label=切换主题>
<svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
</button><button class="menu-item tw-w-full" title>Simplified Chinese<svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
<select class=language-select title onchange="location=this.value"><option value=/posts/how-nixos-start-on-licheepi4a/ selected>Simplified Chinese</option></select></button></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="toc print:!tw-hidden" id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#零前言>零、前言</a></li><li><a href=#一基础知识介绍>一、基础知识介绍</a><ul><li><a href=#1-lichee-pi-4a-介绍>1. Lichee Pi 4A 介绍</a></li><li><a href=#2-nixos-介绍>2. NixOS 介绍</a></li></ul></li><li><a href=#二移植思路>二、移植思路</a></li><li><a href=#三nixos-启动流程分析>三、NixOS 启动流程分析</a><ul><li><a href=#1-bootloader-配置与系统文件树分析>1. Bootloader 配置与系统文件树分析</a></li><li><a href=#2-实际启动日志分析>2. 实际启动日志分析</a></li><li><a href=#3-init-程序分析>3. init 程序分析</a></li><li><a href=#4-activate-程序分析>4. activate 程序分析</a></li></ul></li><li><a href=#四硬件驱动部分>四、硬件驱动部分</a><ul><li><a href=#1-u-bootu-boot-splu-boot-tpl-的关系>1. u-boot，u-boot-spl，u-boot-tpl 的关系</a></li><li><a href=#2-risc-v-的启动流程>2. RISC-V 的启动流程</a></li><li><a href=#3-opensbi>3. OpenSBI</a></li><li><a href=#4-fw_dynamicbin-跟-u-boot-splbin-两个文件>4. fw_dynamic.bin 跟 u-boot-spl.bin 两个文件</a></li><li><a href=#5-t-head-官方的编译工具链>5. T-Head 官方的编译工具链</a></li></ul></li><li><a href=#五我是如何构建出一个可以在-licheepi-4a-上运行的-nixos-镜像的>五、我是如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像的</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single print:!tw-w-full print:!tw-max-w-none print:!tw-m-0 print:!tw-p-0"><h1 class=single-title data-pagefind-meta=date:2024-01-29 data-pagefind-body>NixOS 在 Lichee Pi 4A 上是如何启动的</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><span class=screen-reader-text></span><a href=https://thiscute.world/authors/ryan4yin><img class="tw-inline-block tw-max-h-4 tw-rounded-full tw-translate-y-[-2px] tw-mr-1" src=/avatar/myself.webp alt="於清樂 avatar" height=16 width=16>於清樂</a></span>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><svg class="icon" viewBox="0 0 512 512"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>Tech</a></span>&nbsp;<span class=post-category>和</span>&nbsp;<span class=post-series>系列 <a href><svg class="icon" viewBox="0 0 512 512"><path d="M464 32H48C21.49 32 0 53.49.0 80v352c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V86a6 6 0 016-6h404a6 6 0 016 6v340a6 6 0 01-6 6zm-42-92v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm-252 12c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36z"/></svg></a></span></div><div class=post-meta-line><svg class="icon" viewBox="0 0 448 512"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;<time datetime=2024-01-29>2024-01-29</time>&nbsp;<svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>&nbsp;<time datetime=2024-01-29>2024-01-29</time>&nbsp;<svg class="icon" viewBox="0 0 512 512"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;约 12256 字&nbsp;
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;预计阅读 54 分钟&nbsp;</div></div><div class=featured-image><img loading=eager src=/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp height=3072 width=4096></div><div class="details series-nav open"><div class="details-summary series-title"><span>系列 - NixOS 与 Nix Flakes</span>
<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class="details-content series-content"><nav><ul><li><a href=/posts/my-experience-of-nixos/>OS as Code - 我的 NixOS 使用体会</a></li><li><span class=active>NixOS 在 Lichee Pi 4A 上是如何启动的</span></li><li><a href=/posts/nixos-and-flake-basics/>NixOS 与 Nix Flakes 新手入门</a></li></ul></nav></div></div><div class="details toc print:!tw-block" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#零前言>零、前言</a></li><li><a href=#一基础知识介绍>一、基础知识介绍</a><ul><li><a href=#1-lichee-pi-4a-介绍>1. Lichee Pi 4A 介绍</a></li><li><a href=#2-nixos-介绍>2. NixOS 介绍</a></li></ul></li><li><a href=#二移植思路>二、移植思路</a></li><li><a href=#三nixos-启动流程分析>三、NixOS 启动流程分析</a><ul><li><a href=#1-bootloader-配置与系统文件树分析>1. Bootloader 配置与系统文件树分析</a></li><li><a href=#2-实际启动日志分析>2. 实际启动日志分析</a></li><li><a href=#3-init-程序分析>3. init 程序分析</a></li><li><a href=#4-activate-程序分析>4. activate 程序分析</a></li></ul></li><li><a href=#四硬件驱动部分>四、硬件驱动部分</a><ul><li><a href=#1-u-bootu-boot-splu-boot-tpl-的关系>1. u-boot，u-boot-spl，u-boot-tpl 的关系</a></li><li><a href=#2-risc-v-的启动流程>2. RISC-V 的启动流程</a></li><li><a href=#3-opensbi>3. OpenSBI</a></li><li><a href=#4-fw_dynamicbin-跟-u-boot-splbin-两个文件>4. fw_dynamic.bin 跟 u-boot-spl.bin 两个文件</a></li><li><a href=#5-t-head-官方的编译工具链>5. T-Head 官方的编译工具链</a></li></ul></li><li><a href=#五我是如何构建出一个可以在-licheepi-4a-上运行的-nixos-镜像的>五、我是如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像的</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content data-pagefind-body><blockquote><p>文章是 2023-08-07 写的，后面就完全忘掉这回事了，今天偶然翻到它才想起要整理发布下&mldr;所以注意文章中的时间线是 2023 年 8 月。</p></blockquote><h2 id=零前言 class=headerLink><a href=#%e9%9b%b6%e5%89%8d%e8%a8%80 class=header-mark></a>零、前言</h2><p>我从今年 5 月份初收到了内测板的 Lichee Pi 4A，这是当下性能最高的 RISC-V 开发板之一，不过当时没怎么折腾。</p><p>6 月初的时候我开始尝试在 Orange Pi 5 上运行 NixOS，在<a href=https://matrix.to/#/#nixos-on-arm:nixos.org target=_blank rel="noopener noreferrer">NixOS on ARM 的 Matrix 群组</a> 中得到了俄罗斯老哥 @K900 的帮助，没费多大劲就成功了，一共就折腾了三天。</p><p>于是我接着尝试在 Lichee Pi 4A 上运行 NixOS，因为已经拥有了 Orange Pi 5 上的折腾经验，我以为这次会很顺利。但是实际难度远远超出了我的预期，我从 6 月 13 号开始断断续续折腾到 7 月 3
号，接触了大量的新东西，包括 U-Boot、OpenSBI、SPL Flash、RISCV Boot Flows 等等，还参考了
@chainsx 的 Fedora for Lichee Pi 4A 方案，请教了 @NickCao 许多 NixOS 相关的问题，@revy 帮我修了好几个 revyos/thead-kernel 在标准工具链上编译的 bug，期间也请教过 @HougeLangley 他折腾 Lichee Pi 4A 的经验。我在付出了这么多的努力后，才最终成功编译出了 NixOS 的系统镜像（包含 boot 跟 rootfs 两个分区）。</p><p>但是！现在要说「但是」了。</p><p>镜像是有了，系统却无法启动&mldr;找了各种资料也没解决，也没好意思麻烦各位大佬，搞得有点心灰意冷，就先把这部分工作放下了。</p><p>接着就隔了一个多月没碰 Lichee Pi 4A，直到 8 月 5 号，外国友人 @JayDeLux 在<a href=https://t.me/linux4rv target=_blank rel="noopener noreferrer">Mainline Linux for RISC-V</a> TG 群组中询问我 NixOS 移植工作的进展如何（之前有在群里提过我在尝试移植），我才决定再次尝试一下。</p><p>在之前工作的基础上一番骚操作后，我在 8 月 6 号晚上终于成功启动了 NixOS，这次意外的顺利，后续也成功通过一份 Nix Flake 配置编译出了可用的 NixOS 镜像。</p><p>最终成果：<a href=https://github.com/ryan4yin/nixos-licheepi4a target=_blank rel="noopener noreferrer">https://github.com/ryan4yin/nixos-licheepi4a</a></p><p>整个折腾过程相当曲折，虽然最终达成了目标，但是期间遭受的折磨也真的不少。总的来说仍然是一次很有趣的经历，既学到了许多新技术知识、认识了些有趣的外国友人（@JayDeLux 甚至还给我打了 $50
美刀表示感谢），也跟 @HougeLangley 、@chainsx 、@Rabenda(revy) 等各位大佬混了个脸熟。</p><p>这篇文章就是记录下我在这个折腾过程中学到的所有知识，以飨读者，同时也梳理一下自己的收获。</p><p>本文的写作思路是自顶向下的，先从 NixOS 镜像的 boot 分区配置、启动脚本开始分析，过渡到实际的启动日志，再接续分析下后续的启动流程。NixOS 分析完了后，再看看与 RISC-V 相关的硬件固件与
bootloader 部分要如何与 NixOS 协同工作，使得 NixOS 能够在 Lichee Pi 4A 上正常启动。</p><h2 id=一基础知识介绍 class=headerLink><a href=#%e4%b8%80%e5%9f%ba%e7%a1%80%e7%9f%a5%e8%af%86%e4%bb%8b%e7%bb%8d class=header-mark></a>一、基础知识介绍</h2><h3 id=1-lichee-pi-4a-介绍 class=headerLink><a href=#1-lichee-pi-4a-%e4%bb%8b%e7%bb%8d class=header-mark></a>1. Lichee Pi 4A 介绍</h3><p>LicheePi 4A 是当前市面上性能最高的 RISC-V Linux 开发板之一，它以 TH1520 为主控核心
（4xC910@1.85G， RV64GCV，4TOPS@int8 NPU， 50GFLOP GPU），板载最大 16GB 64bit
LPDDR4X，128GB eMMC，支持 HDMI+MIPI 双4K 显示输出，支持 4K 摄像头接入，双千兆网口（其中一个支持POE供电）和 4 个 USB3.0 接口，多种音频输入输出（由专用 C906 核心处理）。</p><p>以上来自 Lichee Pi 4A 官方文档<a href=https://wiki.sipeed.com/hardware/zh/lichee/th1520/lpi4a/1_intro.html target=_blank rel="noopener noreferrer">Lichee Pi 4A - Sipeed Wiki</a>.</p><p>总之它是我手上性能最高的 RISC-V 开发板。</p><p>LicheePi 4A 官方主要支持 <a href=https://github.com/revyos/revyos/ target=_blank rel="noopener noreferrer">RevyOS</a>—— 一款针对 T-Head 芯片生态的 Debian 优化定制发行版。根据猴哥（@HougeLangley）文章介绍，它也是目前唯一且确实能够启用 Lichee Pi 4A 板载 GPU 的发行版，</p><h3 id=2-nixos-介绍 class=headerLink><a href=#2-nixos-%e4%bb%8b%e7%bb%8d class=header-mark></a>2. NixOS 介绍</h3><p>这个感觉就不用多说了，我在这几个月已经给 NixOS 写了非常多的文字了，感兴趣请直接移步<a href=https://github.com/ryan4yin/nixos-and-flakes-book target=_blank rel="noopener noreferrer">ryan4yin/nixos-and-flakes-book</a>.</p><p>在 4 月份接触了 NixOS 后，我成了 NixOS 铁粉。作为一名铁粉，我当然想把我手上的所有性能好点的板子都装上 NixOS，Lichee Pi 4A 自然也不例外。</p><p>我目前主要完成了两块板子的 NixOS 移植工作，一块是 Orange Pi 5，另一块就是 Lichee Pi 4A。
Orange Pi 5 是 ARM64 架构的，刚好也遇到了拥有该板子的 NixOS 用户 @K900，在他的帮助下我很顺利地就完成了移植工作。</p><p>而 Lichee Pi 4A 就比较曲折，也比较有话题性。所以才有了这篇文章。</p><h2 id=二移植思路 class=headerLink><a href=#%e4%ba%8c%e7%a7%bb%e6%a4%8d%e6%80%9d%e8%b7%af class=header-mark></a>二、移植思路</h2><p>一个完整的嵌入式 Linux 系统，通常包含了 U-Boot、kernel、设备树以及根文件系统（rootfs）四个部分。</p><p>其中 U-Boot，kernel 跟设备树，都是与硬件相关的，需要针对不同的硬件进行定制。而 rootfs 的大部分内容（比如说 NixOS 系统的 rootfs 本身），都是与硬件无关的，可以通用。</p><p>我的移植思路是，从 LicheePi4A 官方使用的 RevyOS 中拿出跟硬件相关的部分（也就是 U-Boot,
kernel 跟设备树这三个），再结合上跟硬件无关的 NixOS rootfs，组合成一个完整的、可在
LicheePi4A 上正常启动运行的 NixOS 系统。</p><p>RevyOS 针对 LicheePi4A 定制的几个项目源码如下：</p><ul><li><a href=https://github.com/revyos/thead-kernel.git target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-kernel.git</a></li><li><a href=https://github.com/revyos/thead-u-boot.git target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-u-boot.git</a></li><li><a href=https://github.com/revyos/thead-opensbi.git target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-opensbi.git</a></li></ul><p>思路很清晰，但因为 NixOS 本身的特殊性，实际操作起来，现有的 Gentoo, Arch Linux, Fedora 的移植仓库代码全都无法直接使用，需要做的工作还是不少的。</p><h2 id=三nixos-启动流程分析 class=headerLink><a href=#%e4%b8%89nixos-%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b%e5%88%86%e6%9e%90 class=header-mark></a>三、NixOS 启动流程分析</h2><p>要做移植，首先就要了解 NixOS 系统本身的文件树结构以及系统启动流程，搞明白它跟 Arch Linux,
Fedora 等其他发行版的区别，这样才好参考其他发行版的移植工作，搞明白该如何入手。</p><h3 id=1-bootloader-配置与系统文件树分析 class=headerLink><a href=#1-bootloader-%e9%85%8d%e7%bd%ae%e4%b8%8e%e7%b3%bb%e7%bb%9f%e6%96%87%e4%bb%b6%e6%a0%91%e5%88%86%e6%9e%90 class=header-mark></a>1. Bootloader 配置与系统文件树分析</h3><p>这里方便起见，我直接使用我自己为 LicheePi4A 构建好的 NixOS 镜像进行分析。首先参照<a href=https://github.com/ryan4yin/nixos-licheepi4a target=_blank rel="noopener noreferrer">ryan4yin/nixos-licheepi4a</a> 的 README 下载解压镜像，再使用 losetup 跟 mount 直接挂载镜像中的各分区进行初步分析：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-1 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># 解压镜像</span>
</span></span><span class=line><span class=cl>› mv nixos-licheepi4a-sd-image-*-riscv64-linux.img.zst nixos-lp4a.img.zst
</span></span><span class=line><span class=cl>› zstd -d nixos-lp4a.img.zst
</span></span><span class=line><span class=cl><span class=c1># 将 img 文件作为虚拟 loop 设备连接到系统中</span>
</span></span><span class=line><span class=cl>› sudo losetup --find --partscan nixos-lp4a.img
</span></span><span class=line><span class=cl><span class=c1># 查看挂载的 loop 设备</span>
</span></span><span class=line><span class=cl>› lsblk <span class=p>|</span> grep loop
</span></span><span class=line><span class=cl>loop0               7:0    <span class=m>0</span>  1.9G  <span class=m>0</span> loop
</span></span><span class=line><span class=cl>├─loop0p1         259:8    <span class=m>0</span>  200M  <span class=m>0</span> part
</span></span><span class=line><span class=cl>└─loop0p2         259:9    <span class=m>0</span>  1.7G  <span class=m>0</span> part
</span></span><span class=line><span class=cl><span class=c1># 分别挂载镜像中的 boot 跟 rootfs 分区</span>
</span></span><span class=line><span class=cl>› mkdir boot root
</span></span><span class=line><span class=cl>› sudo mount /dev/loop0p1 boot
</span></span><span class=line><span class=cl>› sudo mount /dev/loop0p2 root
</span></span><span class=line><span class=cl><span class=c1># 查看 boot 分区内容</span>
</span></span><span class=line><span class=cl>› ls boot/
</span></span><span class=line><span class=cl>╭───┬───────────────────────────┬──────┬─────────┬──────────────╮
</span></span><span class=line><span class=cl>│ <span class=c1># │           name            │ type │  size   │   modified   │</span>
</span></span><span class=line><span class=cl>├───┼───────────────────────────┼──────┼─────────┼──────────────┤
</span></span><span class=line><span class=cl>│ <span class=m>0</span> │ boot/extlinux             │ dir  │  4.1 KB │ <span class=m>44</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>1</span> │ boot/fw_dynamic.bin       │ file │ 85.9 KB │ <span class=m>24</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>2</span> │ boot/light_aon_fpga.bin   │ file │ 50.3 KB │ <span class=m>24</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>3</span> │ boot/light_c906_audio.bin │ file │ 16.4 KB │ <span class=m>24</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>4</span> │ boot/nixos                │ dir  │  4.1 KB │ <span class=m>44</span> years ago │
</span></span><span class=line><span class=cl>╰───┴───────────────────────────┴──────┴─────────┴──────────────╯
</span></span><span class=line><span class=cl><span class=c1># 查看 root 分区内容</span>
</span></span><span class=line><span class=cl>› ls root/
</span></span><span class=line><span class=cl>╭───┬────────────────────────────┬──────┬──────────┬──────────────╮
</span></span><span class=line><span class=cl>│ <span class=c1># │            name            │ type │   size   │   modified   │</span>
</span></span><span class=line><span class=cl>├───┼────────────────────────────┼──────┼──────────┼──────────────┤
</span></span><span class=line><span class=cl>│ <span class=m>0</span> │ root/boot                  │ dir  │   4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>1</span> │ root/lost+found            │ dir  │  16.4 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>2</span> │ root/nix                   │ dir  │   4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>3</span> │ root/nix-path-registration │ file │ 242.0 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>╰───┴────────────────────────────┴──────┴──────────┴──────────────╯</span></span></code></pre></div><p>可以看到 NixOS 整个根目录（<code>/root</code>）下一共就四个文件夹，其中真正保存有系统数据的文件夹只有<code>/boot</code> 跟 <code>/nix</code> 这两个，这与传统的 Linux 发行版大相径庭。有一点 Linux 使用经验的朋友都应该清楚，传统的 Linux 发行版遵循 UNIX 系统的<a href=https://en.wikipedia.org/wiki/Filesystem_Hierarchy_Standard target=_blank rel="noopener noreferrer">FHS</a> 标准，根目录下会有很多文件夹，比如<code>/bin</code>、<code>/etc</code>、<code>/home</code>、<code>/lib</code>、<code>/opt</code>、<code>/root</code>、<code>/sbin</code>、<code>/srv</code>、<code>/tmp</code>、<code>/usr</code>、<code>/var</code>
等等。</p><p>那 NixOS 它这么玩，真的能正常启动么？这就是我在构建出镜像后却发现无法在 LicheePi 4A 上启动时，最先产生的疑问。在询问 @chainsx 跟 @revy 系统无法启动的解决思路的时候，他们也一脸懵逼，觉得这个文件树有点奇葩，很怀疑是我构建流程有问题导致文件树不完整。</p><p>但实际上 NixOS 就是这么玩的，它 rootfs 中所有的数据全都存放在 <code>/nix/store</code> 这个目录下并且被挂载为只读，其他的文件夹以及其中的文件都是在运行时动态创建的。这是它实现声明式系统配置、可回滚更新、可并行安装多个版本的软件包等等特性的基础。</p><p>下面继续分析，先仔细看下 <code>/boot</code> 的内容：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-2 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>› tree boot
</span></span><span class=line><span class=cl>boot
</span></span><span class=line><span class=cl>├── extlinux
</span></span><span class=line><span class=cl>│   └── extlinux.conf
</span></span><span class=line><span class=cl>├── fw_dynamic.bin
</span></span><span class=line><span class=cl>├── light_aon_fpga.bin
</span></span><span class=line><span class=cl>├── light_c906_audio.bin
</span></span><span class=line><span class=cl>└── nixos
</span></span><span class=line><span class=cl>    ├── 2n6fjh4lhzaswbyacaf72zmz6mdsmm8l-initrd-k-riscv64-unknown-linux-gnu-initrd
</span></span><span class=line><span class=cl>    ├── l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-dtbs
</span></span><span class=line><span class=cl>    │   ├── sifive
</span></span><span class=line><span class=cl>    │   │   └── hifive-unleashed-a00.dtb
</span></span><span class=line><span class=cl>    │   └── thead
</span></span><span class=line><span class=cl>    │       ├── fire-emu-crash.dtb
</span></span><span class=line><span class=cl>    │       ├── fire-emu.dtb
</span></span><span class=line><span class=cl>    │       ├── ...... <span class=o>(</span>省略<span class=o>)</span>
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-audio.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-dsi0-hdmi.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-dsp.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-gpu.dtb
</span></span><span class=line><span class=cl>    │       ├── light-fm-emu-hdmi.dtb
</span></span><span class=line><span class=cl>    │       ├── light-lpi4a-ddr2G.dtb
</span></span><span class=line><span class=cl>    │       └── light_mpw.dtb
</span></span><span class=line><span class=cl>    └── l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-Image
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=m>6</span> directories, <span class=m>64</span> files</span></span></code></pre></div><p>可以看到：</p><ol><li>它使用 <code>/boot/extlinux/extlinux.conf</code> 作为 U-Boot 的启动项配置，据<a href=https://github.com/ARM-software/u-boot/blob/master/doc/README.distro target=_blank rel="noopener noreferrer">U-Boot 官方的 Distro 文档</a>
所言，这是 U-Boot 的标准配置文件。</li><li>另外还有一些 <code>xxx.bin</code> 文件，这些是一些硬件固件，其中的 <code>light_c906_audio.bin</code> 显然是<a href="https://www.t-head.cn/product/C906?lang=zh" target=_blank rel="noopener noreferrer">玄铁 906</a> 这个 IP 核的音频固件，其他的后面再研究。</li><li>NixOS 的 <code>initrd</code>, <code>dtbs</code> 以及 <code>Image</code> 文件都是在 <code>/boot/nixos</code> 下，这三个文件也都是跟
Linux 的启动相关的，现在不用管它们，下一步会分析。</li></ol><p>再看下 <code>/boot/extlinux/extlinux.conf</code> 的内容：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-3 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>› cat boot/extlinux/extlinux.conf
</span></span><span class=line><span class=cl><span class=c1># Generated file, all changes will be lost on nixos-rebuild!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Change this to e.g. nixos-42 to temporarily boot to an older configuration.</span>
</span></span><span class=line><span class=cl>DEFAULT nixos-default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>MENU TITLE ------------------------------------------------------------
</span></span><span class=line><span class=cl>TIMEOUT <span class=m>50</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>LABEL nixos-default
</span></span><span class=line><span class=cl>  MENU LABEL NixOS - Default
</span></span><span class=line><span class=cl>  LINUX ../nixos/l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-Image
</span></span><span class=line><span class=cl>  INITRD ../nixos/2n6fjh4lhzaswbyacaf72zmz6mdsmm8l-initrd-k-riscv64-unknown-linux-gnu-initrd
</span></span><span class=line><span class=cl>  APPEND <span class=nv>init</span><span class=o>=</span>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/init <span class=nv>console</span><span class=o>=</span>ttyS0,115200 <span class=nv>root</span><span class=o>=</span><span class=nv>UUID</span><span class=o>=</span>14e19a7b-0ae0-484d-9d54-43bd6fdc20c7 <span class=nv>rootfstype</span><span class=o>=</span>ext4 rootwait rw earlycon clk_ignore_unused <span class=nv>eth</span><span class=o>=</span><span class=nv>$ethaddr</span> <span class=nv>rootrwoptions</span><span class=o>=</span>rw,noatime <span class=nv>rootrwreset</span><span class=o>=</span>yes <span class=nv>loglevel</span><span class=o>=</span><span class=m>4</span>
</span></span><span class=line><span class=cl>  FDT ../nixos/l18cz7jd37n35dwyf8wc8divm46k7sdf-k-riscv64-unknown-linux-gnu-dtbs/thead/light-lpi4a.dtb</span></span></code></pre></div><p>从上述配置中能获得这些信息：</p><ol><li>它创建了一个名为 <code>nixos-default</code> 的启动项并将它设为了默认启动项，extlinux 在启动阶段会根据该配置启动 NixOS 系统</li><li>启动项中的 <code>LINUX</code> <code>INITRD</code> <code>FDT</code> 三个参数分别指定了 kernel(Image 文件)、initrd 以及设备树（dtb）的位置，这三个文件我们在前面已经看到了，都在 <code>/boot/nixos</code> 下。<ol><li>根据 Linux 官方文档<a href=https://docs.kernel.org/admin-guide/initrd.html target=_blank rel="noopener noreferrer">Using the initial RAM disk (initrd)</a>
所言，在使用了 initrd 这个内存盘的情况下，Linux 的启动流程如下：<ol><li>bootloader(这里是 u-boot) 根据配置加载 kernel 文件（<code>Image</code>）、dtb 设备树文件以及<code>initrd</code> 文件系统，然后以设备树跟 initrd 的地址为参数启动 Kernel.</li><li>Kernel 将传入的 initrd 转换成一个内存盘并挂载为根文件系统，然后释放 initrd 的内存。</li><li>Kernel 接着运行 <code>init</code> 参数指定的可执行程序，这里是<code>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/init</code>，
这个 init 程序会挂载真正的根文件系统，并在其上执行后续的启动流程。</li><li>initrd 文件系统被移除，系统启动完毕。</li></ol></li><li><code>initrd</code> 这样一个临时的内存盘，通常用于在系统启动阶段加载一些内核中未内置但启动却必需的驱动或数据文件供 <code>init</code> 程序使用，以便后续能够挂载真正的根文件系统。<ol><li>比如说挂载一个 LUKS 加密的根文件系统，这通常会涉及到提示用户输入 passphrase、从某个地方读取解密用的 keyfile 或者与插入的 USB 硬件密钥交互，这会需要读取内核之外的
keyfile 文件、用到内核之外的加密模块、USB 驱动、HID 用户输入输出模块或者其他因为许可协议、模块大小等问题无法被静态链接到内核中的各种内核模块或程序。initrd 就是用来解决这些问题的。</li></ol></li></ol></li><li><code>APPEND</code> 参数包含有许多关键信息：<ol><li>系统的 init 程序，也就是传说中的 1 号进程（PID 1），被设置为<code>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/init</code>，
这实际是一个 shell 脚本，我们下一步会重点分析它。<ol><li>在传统的 Linux 发行版中，init 通常使用默认值 <code>/sbin/init</code>，它会被链接到<code>/lib/systemd/systemd</code>，也就是直接使用 systemd 作为 1 号进程。你可以在
Fedora/Ubuntu 等传统发行版中运行 <code>ls -al /sbin/init</code> 确认这一点，以及检查它们的<code>/boot/grub/grub.cfs</code> 启动项配置，看看它们有无自定义内核的 <code>init</code> 参数。</li></ol></li><li>系统的 rootfs 分区为 <code>/dev/disk/by-uuid/14e19a7b-0ae0-484d-9d54-43bd6fdc20c7</code>，使用的文件系统为 ext4.</li><li><code>earlycon</code>(early console) 表示在系统启动早期就启用控制台输出，这样可以在系统启动阶段通过 UAER/HDMI 等接口看到相关的启动日志，方便调试。</li><li>其他参数先不管。</li></ol></li></ol><p>这样一分析就能得出结论：在执行 <code>init</code> 程序之前的启动流程都未涉及到真正的根文件系统，NixOS
与其他发行版在该流程中并无明显差异。</p><h3 id=2-实际启动日志分析 class=headerLink><a href=#2-%e5%ae%9e%e9%99%85%e5%90%af%e5%8a%a8%e6%97%a5%e5%bf%97%e5%88%86%e6%9e%90 class=header-mark></a>2. 实际启动日志分析</h3><p>为了方便后续内容的理解，先看下 NixOS 系统在 LicheePi 4A 上的实际启动日志是个很不错的选择。</p><p>按我项目中的 README 正常烧录好系统后，使用 USB 转串口工具连接到 LicheePi 4A 的 UART0 串口，然后启动系统，就能看到 NixOS 的启动日志。</p><p>接线示例：</p><p><figure><img src=/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-1.webp width=80%><figcaption><h4>LicheePi4A UART 调试接线 - 正面</h4></figcaption></figure><figure><img src=/posts/how-nixos-start-on-licheepi4a/lp4a-pinout-debuglog-2.webp width=80%><figcaption><h4>LicheePi4A UART 调试接线 - 反面</h4></figcaption></figure></p><p>接好线后使用 minicom 查看日志：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-4 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>› ls /dev/ttyUSB0
</span></span><span class=line><span class=cl>╭───┬──────────────┬─────────────┬──────┬───────────────╮
</span></span><span class=line><span class=cl>│ <span class=c1># │     name     │    type     │ size │   modified    │</span>
</span></span><span class=line><span class=cl>├───┼──────────────┼─────────────┼──────┼───────────────┤
</span></span><span class=line><span class=cl>│ <span class=m>0</span> │ /dev/ttyUSB0 │ char device │  <span class=m>0</span> B │ <span class=m>6</span> minutes ago │
</span></span><span class=line><span class=cl>╰───┴──────────────┴─────────────┴──────┴───────────────╯
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>› minicom -d /dev/ttyusb0 -b <span class=m>115200</span></span></span></code></pre></div><p>一个正常的启动日志示例如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">text</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-5 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=n>Welcome</span> <span class=n>to</span> <span class=n>minicom</span> <span class=mf>2.8</span>
</span></span><span class=line><span class=cl><span class=n>brom_ver</span> <span class=mi>8</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>APP</span><span class=p>][</span><span class=n>E</span><span class=p>]</span> <span class=n>protocol_connect</span> <span class=n>failed</span><span class=p>,</span> <span class=n>exit</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>OpenSBI</span> <span class=n>v0</span><span class=o>.</span><span class=mi>9</span>
</span></span><span class=line><span class=cl>   <span class=n>____</span>                    <span class=n>_____</span> <span class=n>____</span> <span class=n>_____</span>
</span></span><span class=line><span class=cl>  <span class=o>/</span> <span class=n>__</span> \                  <span class=o>/</span> <span class=n>____</span><span class=o>|</span>  <span class=n>_</span> \<span class=n>_</span>   <span class=n>_</span><span class=o>|</span>
</span></span><span class=line><span class=cl> <span class=o>|</span> <span class=o>|</span>  <span class=o>|</span> <span class=o>|</span><span class=n>_</span> <span class=n>__</span>   <span class=n>___</span> <span class=n>_</span> <span class=n>__</span> <span class=o>|</span> <span class=p>(</span><span class=n>___</span> <span class=o>|</span> <span class=o>|</span><span class=n>_</span><span class=p>)</span> <span class=o>||</span> <span class=o>|</span>
</span></span><span class=line><span class=cl> <span class=o>|</span> <span class=o>|</span>  <span class=o>|</span> <span class=o>|</span> <span class=s1>&#39;_ \ / _ \ &#39;</span><span class=n>_</span> \ \<span class=n>___</span> \<span class=o>|</span>  <span class=n>_</span> <span class=o>&lt;</span> <span class=o>|</span> <span class=o>|</span>
</span></span><span class=line><span class=cl> <span class=o>|</span> <span class=o>|</span><span class=n>__</span><span class=o>|</span> <span class=o>|</span> <span class=o>|</span><span class=n>_</span><span class=p>)</span> <span class=o>|</span>  <span class=n>__</span><span class=o>/</span> <span class=o>|</span> <span class=o>|</span> <span class=o>|</span><span class=n>____</span><span class=p>)</span> <span class=o>|</span> <span class=o>|</span><span class=n>_</span><span class=p>)</span> <span class=o>||</span> <span class=o>|</span><span class=n>_</span>
</span></span><span class=line><span class=cl>  \<span class=n>____</span><span class=o>/|</span> <span class=o>.</span><span class=n>__</span><span class=o>/</span> \<span class=n>___</span><span class=o>|</span><span class=n>_</span><span class=o>|</span> <span class=o>|</span><span class=n>_</span><span class=o>|</span><span class=n>_____</span><span class=o>/|</span><span class=n>____</span><span class=o>/</span><span class=n>_____</span><span class=o>|</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>        <span class=o>|</span><span class=n>_</span><span class=o>|</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=n>Name</span>             <span class=p>:</span> <span class=n>T</span><span class=o>-</span><span class=n>HEAD</span> <span class=ne>Light</span> <span class=n>Lichee</span> <span class=n>Pi</span> <span class=mi>4</span><span class=n>A</span> <span class=n>configuration</span> <span class=k>for</span> <span class=mi>8</span><span class=n>GB</span> <span class=n>DDR</span> <span class=n>board</span>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=n>Features</span>         <span class=p>:</span> <span class=n>mfdeleg</span>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=n>HART</span> <span class=n>Count</span>       <span class=p>:</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=n>IPI</span> <span class=n>Device</span>       <span class=p>:</span> <span class=n>clint</span>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=ne>Timer</span> <span class=n>Device</span>     <span class=p>:</span> <span class=n>clint</span>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=n>Console</span> <span class=n>Device</span>   <span class=p>:</span> <span class=n>uart8250</span>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=n>HSM</span> <span class=n>Device</span>       <span class=p>:</span> <span class=o>---</span>
</span></span><span class=line><span class=cl><span class=n>Platform</span> <span class=n>SysReset</span> <span class=n>Device</span>  <span class=p>:</span> <span class=n>thead_reset</span>
</span></span><span class=line><span class=cl><span class=n>Firmware</span> <span class=n>Base</span>             <span class=p>:</span> <span class=mh>0x0</span>
</span></span><span class=line><span class=cl><span class=n>Firmware</span> <span class=n>Size</span>             <span class=p>:</span> <span class=mi>132</span> <span class=n>KB</span>
</span></span><span class=line><span class=cl><span class=n>Runtime</span> <span class=n>SBI</span> <span class=n>Version</span>       <span class=p>:</span> <span class=mf>0.3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Name</span>              <span class=p>:</span> <span class=n>root</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Boot</span> <span class=n>HART</span>         <span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>HARTs</span>             <span class=p>:</span> <span class=mi>0</span><span class=o>*</span><span class=p>,</span><span class=mi>1</span><span class=o>*</span><span class=p>,</span><span class=mi>2</span><span class=o>*</span><span class=p>,</span><span class=mi>3</span><span class=o>*</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Region00</span>          <span class=p>:</span> <span class=mh>0x000000ffdc000000</span><span class=o>-</span><span class=mh>0x000000ffdc00ffff</span> <span class=p>(</span><span class=n>I</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Region01</span>          <span class=p>:</span> <span class=mh>0x0000000000000000</span><span class=o>-</span><span class=mh>0x000000000003ffff</span> <span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Region02</span>          <span class=p>:</span> <span class=mh>0x0000000000000000</span><span class=o>-</span><span class=mh>0xffffffffffffffff</span> <span class=p>(</span><span class=n>R</span><span class=p>,</span><span class=n>W</span><span class=p>,</span><span class=n>X</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Next</span> <span class=n>Address</span>      <span class=p>:</span> <span class=mh>0x0000000000200000</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Next</span> <span class=n>Arg1</span>         <span class=p>:</span> <span class=mh>0x0000000001f00000</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>Next</span> <span class=n>Mode</span>         <span class=p>:</span> <span class=n>S</span><span class=o>-</span><span class=n>mode</span>
</span></span><span class=line><span class=cl><span class=n>Domain0</span> <span class=n>SysReset</span>          <span class=p>:</span> <span class=n>yes</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>ID</span>              <span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>Domain</span>          <span class=p>:</span> <span class=n>root</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>ISA</span>             <span class=p>:</span> <span class=n>rv64imafdcvsux</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>Features</span>        <span class=p>:</span> <span class=n>scounteren</span><span class=p>,</span><span class=n>mcounteren</span><span class=p>,</span><span class=n>time</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>PMP</span> <span class=n>Count</span>       <span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>PMP</span> <span class=n>Granularity</span> <span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>PMP</span> <span class=n>Address</span> <span class=n>Bits</span><span class=p>:</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>MHPM</span> <span class=n>Count</span>      <span class=p>:</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>MHPM</span> <span class=n>Count</span>      <span class=p>:</span> <span class=mi>16</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>MIDELEG</span>         <span class=p>:</span> <span class=mh>0x0000000000000222</span>
</span></span><span class=line><span class=cl><span class=n>Boot</span> <span class=n>HART</span> <span class=n>MEDELEG</span>         <span class=p>:</span> <span class=mh>0x000000000000b109</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>0.000000</span><span class=p>]</span> <span class=n>Linux</span> <span class=n>version</span> <span class=mf>5.10</span><span class=o>.</span><span class=mi>113</span> <span class=p>(</span><span class=n>nixbld</span><span class=err>@</span><span class=n>localhost</span><span class=p>)</span> <span class=p>(</span><span class=n>riscv64</span><span class=o>-</span><span class=n>unknown</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>-</span><span class=n>gcc</span> <span class=p>(</span><span class=n>GCC</span><span class=p>)</span> <span class=mf>13.1</span><span class=o>.</span><span class=mi>0</span><span class=p>,</span> <span class=n>GN0</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>0.000000</span><span class=p>]</span> <span class=n>OF</span><span class=p>:</span> <span class=n>fdt</span><span class=p>:</span> <span class=n>Ignoring</span> <span class=n>memory</span> <span class=nb>range</span> <span class=mh>0x0</span> <span class=o>-</span> <span class=mh>0x200000</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>0.000000</span><span class=p>]</span> <span class=n>earlycon</span><span class=p>:</span> <span class=n>uart0</span> <span class=n>at</span> <span class=n>MMIO32</span> <span class=mh>0x000000ffe7014000</span> <span class=p>(</span><span class=n>options</span> <span class=s1>&#39;115200n8&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>0.000000</span><span class=p>]</span> <span class=n>printk</span><span class=p>:</span> <span class=n>bootconsole</span> <span class=p>[</span><span class=n>uart0</span><span class=p>]</span> <span class=n>enabled</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>2.292495</span><span class=p>]</span> <span class=p>(</span><span class=n>NULL</span> <span class=n>device</span> <span class=o>*</span><span class=p>):</span> <span class=n>failed</span> <span class=n>to</span> <span class=n>find</span> <span class=n>vdmabuf_reserved_memory</span> <span class=n>node</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>2.453953</span><span class=p>]</span> <span class=n>spi</span><span class=o>-</span><span class=n>nor</span> <span class=n>spi0</span><span class=o>.</span><span class=mi>0</span><span class=p>:</span> <span class=n>unrecognized</span> <span class=n>JEDEC</span> <span class=n>id</span> <span class=n>bytes</span><span class=p>:</span> <span class=n>ff</span> <span class=n>ff</span> <span class=n>ff</span> <span class=n>ff</span> <span class=n>ff</span> <span class=n>ff</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>2.460971</span><span class=p>]</span> <span class=n>dw_spi_mmio</span> <span class=n>ffe700c000</span><span class=o>.</span><span class=n>spi</span><span class=p>:</span> <span class=n>cs1</span> <span class=o>&gt;=</span> <span class=nb>max</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>2.466001</span><span class=p>]</span> <span class=n>spi_master</span> <span class=n>spi0</span><span class=p>:</span> <span class=n>spi_device</span> <span class=n>register</span> <span class=n>error</span> <span class=o>/</span><span class=n>soc</span><span class=o>/</span><span class=n>spi</span><span class=err>@</span><span class=n>ffe700c000</span><span class=o>/</span><span class=n>spidev</span><span class=err>@</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>2.497453</span><span class=p>]</span> <span class=n>sdhci</span><span class=o>-</span><span class=n>dwcmshc</span> <span class=n>ffe70a0000</span><span class=o>.</span><span class=n>sd</span><span class=p>:</span> <span class=n>can</span><span class=s1>&#39;t request region for resource [mem 0xffef014064-0xffef01]</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>2.509014</span><span class=p>]</span> <span class=n>misc</span> <span class=n>vhost</span><span class=o>-</span><span class=n>vdmabuf</span><span class=p>:</span> <span class=n>failed</span> <span class=n>to</span> <span class=n>find</span> <span class=n>vdmabuf_reserved_memory</span> <span class=n>node</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>3.386036</span><span class=p>]</span> <span class=n>debugfs</span><span class=p>:</span> <span class=ne>File</span> <span class=s1>&#39;SDOUT&#39;</span> <span class=ow>in</span> <span class=n>directory</span> <span class=s1>&#39;dapm&#39;</span> <span class=n>already</span> <span class=n>present</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>3.392692</span><span class=p>]</span> <span class=n>debugfs</span><span class=p>:</span> <span class=ne>File</span> <span class=s1>&#39;Playback&#39;</span> <span class=ow>in</span> <span class=n>directory</span> <span class=s1>&#39;dapm&#39;</span> <span class=n>already</span> <span class=n>present</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>3.399524</span><span class=p>]</span> <span class=n>debugfs</span><span class=p>:</span> <span class=ne>File</span> <span class=s1>&#39;Capture&#39;</span> <span class=ow>in</span> <span class=n>directory</span> <span class=s1>&#39;dapm&#39;</span> <span class=n>already</span> <span class=n>present</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>3.406262</span><span class=p>]</span> <span class=n>debugfs</span><span class=p>:</span> <span class=ne>File</span> <span class=s1>&#39;Playback&#39;</span> <span class=ow>in</span> <span class=n>directory</span> <span class=s1>&#39;dapm&#39;</span> <span class=n>already</span> <span class=n>present</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>3.413067</span><span class=p>]</span> <span class=n>debugfs</span><span class=p>:</span> <span class=ne>File</span> <span class=s1>&#39;Capture&#39;</span> <span class=ow>in</span> <span class=n>directory</span> <span class=s1>&#39;dapm&#39;</span> <span class=n>already</span> <span class=n>present</span><span class=o>!</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>3.425466</span><span class=p>]</span> <span class=n>aw87519_pa</span> <span class=mi>5</span><span class=o>-</span><span class=mi>0058</span><span class=p>:</span> <span class=n>aw87519_parse_dt</span><span class=p>:</span> <span class=n>no</span> <span class=n>reset</span> <span class=n>gpio</span> <span class=n>provided</span> <span class=n>failed</span>
</span></span><span class=line><span class=cl><span class=p>[</span>    <span class=mf>3.432752</span><span class=p>]</span> <span class=n>aw87519_pa</span> <span class=mi>5</span><span class=o>-</span><span class=mi>0058</span><span class=p>:</span> <span class=n>aw87519_i2c_probe</span><span class=p>:</span> <span class=n>failed</span> <span class=n>to</span> <span class=n>parse</span> <span class=n>device</span> <span class=n>tree</span> <span class=n>node</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&lt;&lt;&lt;</span> <span class=n>NixOS</span> <span class=n>Stage</span> <span class=mi>1</span> <span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>running</span> <span class=n>udev</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>Starting</span> <span class=n>systemd</span><span class=o>-</span><span class=n>udevd</span> <span class=n>version</span> <span class=mf>253.6</span>
</span></span><span class=line><span class=cl><span class=n>kbd_mode</span><span class=p>:</span> <span class=n>KDSKBMODE</span><span class=p>:</span> <span class=n>Inappropriate</span> <span class=n>ioctl</span> <span class=k>for</span> <span class=n>device</span>
</span></span><span class=line><span class=cl><span class=n>Gstarting</span> <span class=n>device</span> <span class=n>mapper</span> <span class=ow>and</span> <span class=n>LVM</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>checking</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>fsck</span> <span class=p>(</span><span class=n>busybox</span> <span class=mf>1.36</span><span class=o>.</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=n>fsck</span><span class=o>.</span><span class=n>ext4</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=o>--</span> <span class=o>/</span><span class=n>mnt</span><span class=o>-</span><span class=n>root</span><span class=o>/</span><span class=p>]</span> <span class=n>fsck</span><span class=o>.</span><span class=n>ext4</span> <span class=o>-</span><span class=n>a</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span>
</span></span><span class=line><span class=cl><span class=n>NIXOS_SD</span><span class=p>:</span> <span class=n>recovering</span> <span class=n>journal</span>
</span></span><span class=line><span class=cl><span class=n>NIXOS_SD</span><span class=p>:</span> <span class=n>clean</span><span class=p>,</span> <span class=mi>148061</span><span class=o>/</span><span class=mi>248000</span> <span class=n>files</span><span class=p>,</span> <span class=mi>818082</span><span class=o>/</span><span class=mi>984159</span> <span class=n>blocks</span>
</span></span><span class=line><span class=cl><span class=n>mounting</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span> <span class=n>on</span> <span class=o>/...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>&lt;&lt;&lt;</span> <span class=n>NixOS</span> <span class=n>Stage</span> <span class=mi>2</span> <span class=o>&gt;&gt;&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>running</span> <span class=n>activation</span> <span class=n>script</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=n>setting</span> <span class=n>up</span> <span class=o>/</span><span class=n>etc</span><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=o>++</span> <span class=o>/</span><span class=n>nix</span><span class=o>/</span><span class=n>store</span><span class=o>/</span><span class=mi>2</span><span class=n>w8nachmhqvbjswrrsdia5cx1afxxx60</span><span class=o>-</span><span class=n>util</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>riscv64</span><span class=o>-</span><span class=n>unknown</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>-</span><span class=mf>2.38</span><span class=o>.</span><span class=mi>1</span><span class=o>-</span><span class=n>bin</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>findm</span><span class=o>/</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=n>rootPart</span><span class=o>=/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span>
</span></span><span class=line><span class=cl><span class=o>++</span> <span class=n>lsblk</span> <span class=o>-</span><span class=n>npo</span> <span class=n>PKNAME</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=n>bootDevice</span><span class=o>=/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1</span>
</span></span><span class=line><span class=cl><span class=o>++</span> <span class=n>lsblk</span> <span class=o>-</span><span class=n>npo</span> <span class=n>MAJ</span><span class=p>:</span><span class=n>MIN</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span>
</span></span><span class=line><span class=cl><span class=o>++</span> <span class=o>/</span><span class=n>nix</span><span class=o>/</span><span class=n>store</span><span class=o>/</span><span class=n>zag1z2yvsh2ccpsbgsda7xhv4sfha7mj</span><span class=o>-</span><span class=n>gawk</span><span class=o>-</span><span class=n>riscv64</span><span class=o>-</span><span class=n>unknown</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>-</span><span class=mf>5.2</span><span class=o>.</span><span class=mi>1</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>awk</span> <span class=o>-</span><span class=n>F</span><span class=p>:</span> <span class=s1>&#39;{print &#39;</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=n>partNum</span><span class=o>=</span><span class=s1>&#39;26 &#39;</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=n>echo</span> <span class=p>,</span><span class=o>+</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=n>sfdisk</span> <span class=o>-</span><span class=n>N26</span> <span class=o>--</span><span class=n>no</span><span class=o>-</span><span class=n>reread</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1</span>
</span></span><span class=line><span class=cl><span class=n>GPT</span> <span class=n>PMBR</span> <span class=n>size</span> <span class=n>mismatch</span> <span class=p>(</span><span class=mi>8332023</span> <span class=o>!=</span> <span class=mi>122894335</span><span class=p>)</span> <span class=n>will</span> <span class=n>be</span> <span class=n>corrected</span> <span class=n>by</span> <span class=n>write</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>backup</span> <span class=n>GPT</span> <span class=n>table</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>on</span> <span class=n>the</span> <span class=n>end</span> <span class=n>of</span> <span class=n>the</span> <span class=n>device</span><span class=o>.</span> <span class=n>This</span> <span class=n>problem</span> <span class=n>will</span> <span class=n>be</span> <span class=n>corrected</span> <span class=n>by</span> <span class=n>write</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>warning</span><span class=p>:</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1</span><span class=p>:</span> <span class=n>partition</span> <span class=mi>26</span> <span class=n>is</span> <span class=ow>not</span> <span class=n>defined</span> <span class=n>yet</span>
</span></span><span class=line><span class=cl><span class=n>Disk</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1</span><span class=p>:</span> <span class=mf>58.6</span> <span class=n>GiB</span><span class=p>,</span> <span class=mi>62921900032</span> <span class=n>bytes</span><span class=p>,</span> <span class=mi>122894336</span> <span class=n>sectors</span>
</span></span><span class=line><span class=cl><span class=n>Units</span><span class=p>:</span> <span class=n>sectors</span> <span class=n>of</span> <span class=mi>1</span> <span class=o>*</span> <span class=mi>512</span> <span class=o>=</span> <span class=mi>512</span> <span class=n>bytes</span>
</span></span><span class=line><span class=cl><span class=n>Sector</span> <span class=n>size</span> <span class=p>(</span><span class=n>logical</span><span class=o>/</span><span class=n>physical</span><span class=p>):</span> <span class=mi>512</span> <span class=n>bytes</span> <span class=o>/</span> <span class=mi>512</span> <span class=n>bytes</span>
</span></span><span class=line><span class=cl><span class=n>I</span><span class=o>/</span><span class=n>O</span> <span class=n>size</span> <span class=p>(</span><span class=n>minimum</span><span class=o>/</span><span class=n>optimal</span><span class=p>):</span> <span class=mi>512</span> <span class=n>bytes</span> <span class=o>/</span> <span class=mi>512</span> <span class=n>bytes</span>
</span></span><span class=line><span class=cl><span class=n>Disklabel</span> <span class=n>type</span><span class=p>:</span> <span class=n>gpt</span>
</span></span><span class=line><span class=cl><span class=n>Disk</span> <span class=n>identifier</span><span class=p>:</span> <span class=mi>58</span><span class=n>B10C85</span><span class=o>-</span><span class=n>BB4D</span><span class=o>-</span><span class=n>F94A</span><span class=o>-</span><span class=mi>9194</span><span class=o>-</span><span class=mi>82020</span><span class=n>FC9DC23</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Old</span> <span class=n>situation</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Device</span>          <span class=n>Start</span>     <span class=n>End</span> <span class=n>Sectors</span>  <span class=n>Size</span> <span class=n>Type</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1p1</span>  <span class=mi>16384</span>  <span class=mi>425983</span>  <span class=mi>409600</span>  <span class=mi>200</span><span class=n>M</span> <span class=n>Microsoft</span> <span class=n>basic</span> <span class=n>data</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1p2</span> <span class=mi>425984</span> <span class=mi>8331990</span> <span class=mi>7906007</span>  <span class=mf>3.8</span><span class=n>G</span> <span class=n>Linux</span> <span class=n>filesystem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1p26</span><span class=p>:</span> <span class=n>Created</span> <span class=n>a</span> <span class=n>new</span> <span class=n>partition</span> <span class=mi>3</span> <span class=n>of</span> <span class=n>type</span> <span class=s1>&#39;Linux filesystem&#39;</span> <span class=ow>and</span> <span class=n>of</span> <span class=n>size</span> <span class=mf>54.6</span> <span class=n>GiB</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>New</span> <span class=n>situation</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=n>Disklabel</span> <span class=n>type</span><span class=p>:</span> <span class=n>gpt</span>
</span></span><span class=line><span class=cl><span class=n>Disk</span> <span class=n>identifier</span><span class=p>:</span> <span class=mi>58</span><span class=n>B10C85</span><span class=o>-</span><span class=n>BB4D</span><span class=o>-</span><span class=n>F94A</span><span class=o>-</span><span class=mi>9194</span><span class=o>-</span><span class=mi>82020</span><span class=n>FC9DC23</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Device</span>           <span class=n>Start</span>       <span class=n>End</span>   <span class=n>Sectors</span>  <span class=n>Size</span> <span class=n>Type</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1p1</span>   <span class=mi>16384</span>    <span class=mi>425983</span>    <span class=mi>409600</span>  <span class=mi>200</span><span class=n>M</span> <span class=n>Microsoft</span> <span class=n>basic</span> <span class=n>data</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1p2</span>  <span class=mi>425984</span>   <span class=mi>8331990</span>   <span class=mi>7906007</span>  <span class=mf>3.8</span><span class=n>G</span> <span class=n>Linux</span> <span class=n>filesystem</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mmcblk1p3</span> <span class=mi>8333312</span> <span class=mi>122892287</span> <span class=mi>114558976</span> <span class=mf>54.6</span><span class=n>G</span> <span class=n>Linux</span> <span class=n>filesystem</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>partition</span> <span class=n>table</span> <span class=n>has</span> <span class=n>been</span> <span class=n>altered</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>Calling</span> <span class=n>ioctl</span><span class=p>()</span> <span class=n>to</span> <span class=n>re</span><span class=o>-</span><span class=n>read</span> <span class=n>partition</span> <span class=n>table</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>Re</span><span class=o>-</span><span class=n>reading</span> <span class=n>the</span> <span class=n>partition</span> <span class=n>table</span> <span class=n>failed</span><span class=o>.</span><span class=p>:</span> <span class=n>Device</span> <span class=ow>or</span> <span class=n>resource</span> <span class=n>busy</span>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>kernel</span> <span class=n>still</span> <span class=n>uses</span> <span class=n>the</span> <span class=n>old</span> <span class=n>table</span><span class=o>.</span> <span class=n>The</span> <span class=n>new</span> <span class=n>table</span> <span class=n>will</span> <span class=n>be</span> <span class=n>used</span> <span class=n>at</span> <span class=n>the</span> <span class=n>next</span> <span class=n>reboot</span> <span class=ow>or</span> <span class=n>after</span> <span class=n>you</span> <span class=n>run</span> <span class=n>part</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=n>Syncing</span> <span class=n>disks</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=o>/</span><span class=n>nix</span><span class=o>/</span><span class=n>store</span><span class=o>/</span><span class=n>wm9ynqbkqi7gagggb4y6f4l454kkga32</span><span class=o>-</span><span class=n>parted</span><span class=o>-</span><span class=n>riscv64</span><span class=o>-</span><span class=n>unknown</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>-</span><span class=mf>3.6</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>partprobe</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=o>/</span><span class=n>nix</span><span class=o>/</span><span class=n>store</span><span class=o>/</span><span class=n>yln7ma9dldr3f2dva4l0iq275s4brxml</span><span class=o>-</span><span class=n>e2fsprogs</span><span class=o>-</span><span class=n>riscv64</span><span class=o>-</span><span class=n>unknown</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>-</span><span class=mf>1.46</span><span class=o>.</span><span class=mi>6</span><span class=o>-</span><span class=n>bin</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>resize2D</span>
</span></span><span class=line><span class=cl><span class=n>resize2fs</span> <span class=mf>1.46</span><span class=o>.</span><span class=mi>6</span> <span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>Feb</span><span class=o>-</span><span class=mi>2023</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Filesystem</span> <span class=n>at</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span> <span class=n>is</span> <span class=n>mounted</span> <span class=n>on</span> <span class=o>/</span><span class=p>;</span> <span class=n>on</span><span class=o>-</span><span class=n>line</span> <span class=n>resizing</span> <span class=n>required</span>
</span></span><span class=line><span class=cl><span class=n>old_desc_blocks</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>new_desc_blocks</span> <span class=o>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=n>The</span> <span class=n>filesystem</span> <span class=n>on</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>disk</span><span class=o>/</span><span class=n>by</span><span class=o>-</span><span class=n>label</span><span class=o>/</span><span class=n>NIXOS_SD</span> <span class=n>is</span> <span class=n>now</span> <span class=mi>988250</span> <span class=p>(</span><span class=mi>4</span><span class=n>k</span><span class=p>)</span> <span class=n>blocks</span> <span class=n>long</span><span class=o>.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=o>/</span><span class=n>nix</span><span class=o>/</span><span class=n>store</span><span class=o>/</span><span class=n>f5w7dd1f195bxkashhr5x0a788nxrxvc</span><span class=o>-</span><span class=n>nix</span><span class=o>-</span><span class=n>riscv64</span><span class=o>-</span><span class=n>unknown</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>-</span><span class=mf>2.13</span><span class=o>.</span><span class=mi>3</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>nix</span><span class=o>-</span><span class=n>store</span> <span class=o>--</span><span class=nb>load</span><span class=o>-</span><span class=n>b</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=n>touch</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>NIXOS</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=o>/</span><span class=n>nix</span><span class=o>/</span><span class=n>store</span><span class=o>/</span><span class=n>f5w7dd1f195bxkashhr5x0a788nxrxvc</span><span class=o>-</span><span class=n>nix</span><span class=o>-</span><span class=n>riscv64</span><span class=o>-</span><span class=n>unknown</span><span class=o>-</span><span class=n>linux</span><span class=o>-</span><span class=n>gnu</span><span class=o>-</span><span class=mf>2.13</span><span class=o>.</span><span class=mi>3</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>nix</span><span class=o>-</span><span class=n>env</span> <span class=o>-</span><span class=n>p</span> <span class=o>/</span><span class=n>nix</span><span class=o>/</span><span class=n>vm</span>
</span></span><span class=line><span class=cl><span class=o>+</span> <span class=n>rm</span> <span class=o>-</span><span class=n>f</span> <span class=o>/</span><span class=n>nix</span><span class=o>-</span><span class=n>path</span><span class=o>-</span><span class=n>registration</span>
</span></span><span class=line><span class=cl><span class=n>starting</span> <span class=n>systemd</span><span class=o>...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Welcome</span> <span class=n>to</span> <span class=n>NixOS</span> <span class=mf>23.05</span> <span class=p>(</span><span class=n>Stoat</span><span class=p>)</span><span class=o>!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>[</span>  <span class=n>OK</span>  <span class=p>]</span> <span class=n>Created</span> <span class=n>slice</span> <span class=n>Slice</span> <span class=o>/</span><span class=n>system</span><span class=o>/</span><span class=n>getty</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=p>[</span>  <span class=n>OK</span>  <span class=p>]</span> <span class=n>Created</span> <span class=n>slice</span> <span class=n>Slice</span> <span class=o>/</span><span class=n>system</span><span class=o>/</span><span class=n>modprobe</span><span class=o>.</span>
</span></span><span class=line><span class=cl><span class=p>[</span>  <span class=n>OK</span>  <span class=p>]</span> <span class=n>Created</span> <span class=n>slice</span> <span class=n>Slice</span> <span class=o>/</span><span class=n>system</span><span class=o>/</span><span class=n>serial</span><span class=o>-</span><span class=n>getty</span><span class=o>.......</span>
</span></span><span class=line><span class=cl><span class=o>......</span></span></span></code></pre></div><p>简单总结下日志中的信息：</p><ol><li>整个启动流程被分成了三个阶段，分别是：<ol><li>OpenSBI: 这个阶段貌似进行了一些硬件相关的初始化，比如说串口、SPI、SD 卡等，貌似还有些报错，先不管。</li><li>NixOS Stage 1: 这应该就是 <code>initrd</code> 阶段干的活，内核加载了 systemd udev 内核模块，然后使用 busybox 的 fsck 检查了根文件系统，接着挂载了根文件系统。</li><li>NixOS Stage 2:<ol><li>运行了一个什么<code>activation script</code>，它首先设置好了 <code>/etc</code> 文件夹，然后检查了根分区文件系统的情况，并自动执行了分区与文件系统的扩容操作。</li><li>接着通过 <code>nix-env -p /nix/vm...</code> 大概是切换了个运行环境。</li><li>最后启动了 systemd，这之后的流程就跟其他发行版没啥区别了（都是 systemd）。</li></ol></li></ol></li></ol><h3 id=3-init-程序分析 class=headerLink><a href=#3-init-%e7%a8%8b%e5%ba%8f%e5%88%86%e6%9e%90 class=header-mark></a>3. init 程序分析</h3><p>有了上面这些信息，我们就可以比较容易地理解 init 这个程序了，它主要对应前面日志中的 NixOS
Stage 2，即在真正挂载根文件系统之后，执行的第一个用户态程序。</p><p>在 NixOS 中这个 init 程序实际上是一个 shell 脚本，可以直接通过 <code>cat</code> 或者 <code>vim</code> 来查看它的内容：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-6 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>› cat /nix/store/a5gnycsy3cq4ix2k8624649zj8xqzkxc-nixos-system-nixos-23.05.20230624.3ef8b37/init
</span></span><span class=line><span class=cl><span class=c1>#! /nix/store/91hllz70n1b0qkb0r9iw1bg9xzx66a3b-bash-5.2-p15-riscv64-unknown-linux-gnu/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>systemConfig</span><span class=o>=</span>/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>HOME</span><span class=o>=</span>/root <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/nix/store/fifbf1h3i83jvan2vkk7xm4fraq7drm7-coreutils-riscv64-unknown-linux-gnu-9.1/bin:/nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin/bin&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Process the kernel command line.</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> o in <span class=k>$(</span>&lt;/proc/cmdline<span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>        <span class=k>case</span> <span class=nv>$o</span> in
</span></span><span class=line><span class=cl>            boot.debugtrace<span class=o>)</span>
</span></span><span class=line><span class=cl>                <span class=c1># Show each command.</span>
</span></span><span class=line><span class=cl>                <span class=nb>set</span> -x
</span></span><span class=line><span class=cl>                <span class=p>;;</span>
</span></span><span class=line><span class=cl>        <span class=k>esac</span>
</span></span><span class=line><span class=cl>    <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Print a greeting.</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -e <span class=s2>&#34;\e[1;32m&lt;&lt;&lt; NixOS Stage 2 &gt;&gt;&gt;\e[0m&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Normally, stage 1 mounts the root filesystem read/writable.</span>
</span></span><span class=line><span class=cl>    <span class=c1># However, in some environments, stage 2 is executed directly, and the</span>
</span></span><span class=line><span class=cl>    <span class=c1># root is read-only.  So make it writable here.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$container</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        mount -n -o remount,rw none /
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Likewise, stage 1 mounts /proc, /dev and /sys, so if we don&#39;t have a</span>
</span></span><span class=line><span class=cl><span class=c1># stage 1, we need to do that here.</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -e /proc/1 <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    specialMount<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>mountPoint</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>options</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$3</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>local</span> <span class=nv>fsType</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$4</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># We must not overwrite this mount because it&#39;s bind-mounted</span>
</span></span><span class=line><span class=cl>        <span class=c1># from stage 1&#39;s /run</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>mountPoint</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> /run <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span>
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        install -m <span class=m>0755</span> -d <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>        mount -n -t <span class=s2>&#34;</span><span class=nv>$fsType</span><span class=s2>&#34;</span> -o <span class=s2>&#34;</span><span class=nv>$options</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>source</span> /nix/store/vn0sga6rn69vkdbs0d2njh0aig7zmzi6-mounts.sh
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;booting system configuration </span><span class=si>${</span><span class=nv>systemConfig</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;booting system configuration </span><span class=nv>$systemConfig</span><span class=s2>&#34;</span> &gt; /dev/kmsg
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make /nix/store a read-only bind mount to enforce immutability of</span>
</span></span><span class=line><span class=cl><span class=c1># the Nix store.  Note that we can&#39;t use &#34;chown root:nixbld&#34; here</span>
</span></span><span class=line><span class=cl><span class=c1># because users/groups might not exist yet.</span>
</span></span><span class=line><span class=cl><span class=c1># Silence chown/chmod to fail gracefully on a readonly filesystem</span>
</span></span><span class=line><span class=cl><span class=c1># like squashfs.</span>
</span></span><span class=line><span class=cl>chown -f 0:30000 /nix/store
</span></span><span class=line><span class=cl>chmod -f <span class=m>1775</span> /nix/store
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;1&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34;</span><span class=k>$(</span>findmnt --noheadings --output OPTIONS /nix/store<span class=k>)</span><span class=s2>&#34;</span> <span class=o>=</span>~ ro<span class=o>(</span>,<span class=p>|</span>$<span class=o>)</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$container</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>            mount --bind /nix/store /nix/store
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>            mount --rbind /nix/store /nix/store
</span></span><span class=line><span class=cl>        <span class=k>fi</span>
</span></span><span class=line><span class=cl>        mount -o remount,ro,bind /nix/store
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Use /etc/resolv.conf supplied by systemd-nspawn, if applicable.</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> -e /etc/resolv.conf <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        resolvconf -m <span class=m>1000</span> -a host &lt;/etc/resolv.conf
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Log the script output to /dev/kmsg or /run/log/stage-2-init.log.</span>
</span></span><span class=line><span class=cl>    <span class=c1># Only at this point are all the necessary prerequisites ready for these commands.</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> <span class=o>{</span>logOutFd<span class=o>}</span>&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=o>{</span>logErrFd<span class=o>}</span>&gt;<span class=p>&amp;</span><span class=m>2</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>test</span> -w /dev/kmsg<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>exec</span> &gt; &gt;<span class=o>(</span>tee -i /proc/self/fd/<span class=s2>&#34;</span><span class=nv>$logOutFd</span><span class=s2>&#34;</span> <span class=p>|</span> <span class=k>while</span> <span class=nb>read</span> -r line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nb>test</span> -n <span class=s2>&#34;</span><span class=nv>$line</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>                <span class=nb>echo</span> <span class=s2>&#34;&lt;7&gt;stage-2-init: </span><span class=nv>$line</span><span class=s2>&#34;</span> &gt; /dev/kmsg
</span></span><span class=line><span class=cl>            <span class=k>fi</span>
</span></span><span class=line><span class=cl>        <span class=k>done</span><span class=o>)</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        mkdir -p /run/log
</span></span><span class=line><span class=cl>        <span class=nb>exec</span> &gt; &gt;<span class=o>(</span>tee -i /run/log/stage-2-init.log<span class=o>)</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Required by the activation script</span>
</span></span><span class=line><span class=cl>install -m <span class=m>0755</span> -d /etc /etc/nixos
</span></span><span class=line><span class=cl>install -m <span class=m>01777</span> -d /tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run the script that performs all configuration activation that does</span>
</span></span><span class=line><span class=cl><span class=c1># not have to be done at boot time.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;running activation script...&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>$systemConfig</span>/activate
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Record the boot configuration.</span>
</span></span><span class=line><span class=cl>ln -sfn <span class=s2>&#34;</span><span class=nv>$systemConfig</span><span class=s2>&#34;</span> /run/booted-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Run any user-specified commands.</span>
</span></span><span class=line><span class=cl>/nix/store/91hllz70n1b0qkb0r9iw1bg9xzx66a3b-bash-5.2-p15-riscv64-unknown-linux-gnu/bin/bash /nix/store/cmvnjz39iq4bx4cq3lvri2jj0sjq5h24-local-cmds
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure systemd doesn&#39;t try to populate /etc, by forcing its first-boot</span>
</span></span><span class=line><span class=cl><span class=c1># heuristic off. It doesn&#39;t matter what&#39;s in /etc/machine-id for this purpose,</span>
</span></span><span class=line><span class=cl><span class=c1># and systemd will immediately fill in the file when it starts, so just</span>
</span></span><span class=line><span class=cl><span class=c1># creating it is enough. This `: &gt;&gt;` pattern avoids forking and avoids changing</span>
</span></span><span class=line><span class=cl><span class=c1># the mtime if the file already exists.</span>
</span></span><span class=line><span class=cl>: &gt;&gt; /etc/machine-id
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># No need to restore the stdout/stderr streams we never redirected and</span>
</span></span><span class=line><span class=cl><span class=c1># especially no need to start systemd</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>IN_NIXOS_SYSTEMD_STAGE1</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=nb>true</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=c1># Reset the logging file descriptors.</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> 1&gt;<span class=p>&amp;</span><span class=nv>$logOutFd</span> 2&gt;<span class=p>&amp;</span><span class=nv>$logErrFd</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> <span class=o>{</span>logOutFd<span class=o>}</span>&gt;<span class=p>&amp;</span>- <span class=o>{</span>logErrFd<span class=o>}</span>&gt;<span class=p>&amp;</span>-
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Start systemd in a clean environment.</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;starting systemd...&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exec</span> /run/current-system/systemd/lib/systemd/systemd <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span></span></span></code></pre></div><p>简单总结下这个脚本的功能：</p><ol><li>通过 <code>mount -o remount,ro,bind /nix/store</code> 将 <code>/nix/store</code> 目录重新挂载为只读，确保 Nix
Store 的不可变性，从而使系统状态可复现。</li><li>直接开始执行 <code>$systemConfig/activate</code> 这个程序。</li><li>activate 完毕后，启动真正的 1 号进程 systemd，进入后续启动流程。</li></ol><h3 id=4-activate-程序分析 class=headerLink><a href=#4-activate-%e7%a8%8b%e5%ba%8f%e5%88%86%e6%9e%90 class=header-mark></a>4. activate 程序分析</h3><p>前面的 init 程序其实没干啥，根据我们看过的启动日志，大部分的功能应该都是在<code>$systemConfig/activate</code> 这个程序中完成的。</p><p>再看看其中的 $systemConfig/activate 的内容，它同样是一个 shell 脚本，直接 <code>cat</code>/<code>vim</code> 查看下：</p><div class="code-block highlight is-closed show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-7 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>› cat root/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b/activate
</span></span><span class=line><span class=cl><span class=c1>#!/nix/store/91hllz70n1b0qkb0r9iw1bg9xzx66a3b-bash-5.2-p15-riscv64-unknown-linux-gnu/bin/bash</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>systemConfig</span><span class=o>=</span><span class=s1>&#39;/nix/store/71wh9lvf94i1jcd6qpqw228fy5s8fv24-nixos-system-lp4a-23.05.20230806.240472b&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span>/empty
</span></span><span class=line><span class=cl><span class=k>for</span> i in /nix/store/fifbf1h3i83jvan2vkk7xm4fraq7drm7-coreutils-riscv64-unknown-linux-gnu-9.1 /nix/store/x3hfwbwcqgl9zpqrk8kvm3p2kjns9asm-gnugrep-riscv64-unknown-linux-gnu-3.7 /nix/store/qn0yhj5d7r432rdh1885cn40gz184ww9-findutils-riscv64-unknown-linux-gnu-4.9.0 /nix/store/slwk77dzar2l1c4h9fikdw93ig4wdfy1-getent-glibc-riscv64-unknown-linux-gnu-2.37-8 /nix/store/yrf57f5h1rwmf3q70msx35a2p9f0rsjr-glibc-riscv64-unknown-linux-gnu-2.37-8-bin /nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13 /nix/store/2imxx6v9xhy8mbbx9q1r2d991m81inar-net-tools-riscv64-unknown-linux-gnu-2.10 /nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nv>PATH</span><span class=o>=</span><span class=nv>$PATH</span>:<span class=nv>$i</span>/bin:<span class=nv>$i</span>/sbin
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>_status</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nb>trap</span> <span class=s2>&#34;_status=1 _localstatus=\$?&#34;</span> ERR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Ensure a consistent umask.</span>
</span></span><span class=line><span class=cl><span class=nb>umask</span> <span class=m>0022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet specialfs:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>specialMount<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>device</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>mountPoint</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$2</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>options</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$3</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>local</span> <span class=nv>fsType</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$4</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> mountpoint -q <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>options</span><span class=o>=</span><span class=s2>&#34;remount,</span><span class=nv>$options</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>else</span>
</span></span><span class=line><span class=cl>    mkdir -m <span class=m>0755</span> -p <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  mount -t <span class=s2>&#34;</span><span class=nv>$fsType</span><span class=s2>&#34;</span> -o <span class=s2>&#34;</span><span class=nv>$options</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$device</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$mountPoint</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> /nix/store/vn0sga6rn69vkdbs0d2njh0aig7zmzi6-mounts.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;specialfs&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet binfmt:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>mkdir -p -m <span class=m>0755</span> /run/binfmt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;binfmt&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet stdio:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;stdio&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet binsh:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Create the required /bin/sh symlink; otherwise lots of things</span>
</span></span><span class=line><span class=cl><span class=c1># (notably the system() function) won&#39;t work.</span>
</span></span><span class=line><span class=cl>mkdir -m <span class=m>0755</span> -p /bin
</span></span><span class=line><span class=cl>ln -sfn <span class=s2>&#34;/nix/store/4y83vxk3mfk216d1jjfjgckkxwrbassi-bash-interactive-5.2-p15-riscv64-unknown-linux-gnu/bin/sh&#34;</span> /bin/.sh.tmp
</span></span><span class=line><span class=cl>mv /bin/.sh.tmp /bin/sh <span class=c1># atomically replace /bin/sh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;binsh&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet check-manual-docbook:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=k>$(</span>cat /nix/store/xzgmgymf510dicgppghq27lrh9fjpxfi-options-used-docbook<span class=k>)</span> <span class=o>=</span> <span class=m>1</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> -e <span class=s2>&#34;\e[31;1mwarning\e[0m: This configuration contains option documentation in docbook.&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>          <span class=s2>&#34;Support for docbook is deprecated and will be removed after NixOS 23.05.&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>          <span class=s2>&#34;See nix-store --read-log /nix/store/n232fhpqqqnlfjl0rj59xxms419glja2-options.json.drv&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;check-manual-docbook&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet domain:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;domain&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet users:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>install -m <span class=m>0700</span> -d /root
</span></span><span class=line><span class=cl>install -m <span class=m>0755</span> -d /home
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>/nix/store/6fap9xv6snx5fr2m7m804v4gc23pb1jh-perl-riscv64-unknown-linux-gnu-5.36.0-env/bin/perl <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>-w /nix/store/gx91fdp4a099jpfwdkbdw2imvl3lalsk-update-users-groups.pl /nix/store/1zj6fk93qkqd3z8n34s4r40xnby2ci21-users-groups.json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;users&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet groups:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;groups&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet etc:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Set up the statically computed bits of /etc.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;setting up /etc...&#34;</span>
</span></span><span class=line><span class=cl>/nix/store/habrmd12my31s9r9fdby78l2dg5p7qyx-perl-riscv64-unknown-linux-gnu-5.36.0-env/bin/perl /nix/store/rg5rf512szdxmnj9qal3wfdnpfsx38qi-setup-etc.pl /nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;etc&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet hashes:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=nv>users</span><span class=o>=()</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span>: <span class=nb>read</span> -r user <span class=nb>hash</span> tail<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$hash</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;</span>$<span class=s2>&#34;</span>* <span class=o>&amp;&amp;</span> ! <span class=s2>&#34;</span><span class=nv>$hash</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^<span class=se>\$</span><span class=o>(</span>y<span class=p>|</span>gy<span class=p>|</span>7<span class=p>|</span>2b<span class=p>|</span>2y<span class=p>|</span>2a<span class=p>|</span>6<span class=o>)</span><span class=se>\$</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nv>users</span><span class=o>+=(</span><span class=s2>&#34;</span><span class=nv>$user</span><span class=s2>&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span> &lt;/etc/shadow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> <span class=s2>&#34;</span><span class=si>${#</span><span class=nv>users</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;
</span></span></span><span class=line><span class=cl><span class=s2>WARNING: The following user accounts rely on password hashing algorithms
</span></span></span><span class=line><span class=cl><span class=s2>that have been removed. They need to be renewed as soon as possible, as
</span></span></span><span class=line><span class=cl><span class=s2>they do prevent their users from logging in.&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s1>&#39; - %s\n&#39;</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>users</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;hashes&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet hostname:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>hostname <span class=s2>&#34;lp4a&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;hostname&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet modprobe:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Allow the kernel to find our wrapped modprobe (which searches</span>
</span></span><span class=line><span class=cl><span class=c1># in the right location in the Nix store for kernel modules).</span>
</span></span><span class=line><span class=cl><span class=c1># We need this when the kernel (or some module) auto-loads a</span>
</span></span><span class=line><span class=cl><span class=c1># module.</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> /nix/store/wv00igsmj6mkk1ybssdch52hx0hx0x67-kmod-riscv64-unknown-linux-gnu-30/bin/modprobe &gt; /proc/sys/kernel/modprobe
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;modprobe&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet nix:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>install -m <span class=m>0755</span> -d /nix/var/nix/<span class=o>{</span>gcroots,profiles<span class=o>}</span>/per-user
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;nix&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet nix-channel:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Subscribe the root user to the NixOS channel by default.</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> ! -e <span class=s2>&#34;/root/.nix-channels&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;https://nixos.org/channels/nixos-23.05 nixos&#34;</span> &gt; <span class=s2>&#34;/root/.nix-channels&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;nix-channel&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet systemd-timesyncd-init-clock:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! <span class=o>[</span> -f /var/lib/systemd/timesync/clock <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>test</span> -d /var/lib/systemd/timesync <span class=o>||</span> mkdir -p /var/lib/systemd/timesync
</span></span><span class=line><span class=cl>  touch /var/lib/systemd/timesync/clock
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;systemd-timesyncd-init-clock&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet udevd:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># The deprecated hotplug uevent helper is not used anymore</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -e /proc/sys/kernel/hotplug <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;&#34;</span> &gt; /proc/sys/kernel/hotplug
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Allow the kernel to find our firmware.</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -e /sys/module/firmware_class/parameters/path <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/ann0ayjx9qf296pssrk2b26fry235idz-firmware/lib/firmware&#34;</span> &gt; /sys/module/firmware_class/parameters/path
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;udevd&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet usrbinenv:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>mkdir -m <span class=m>0755</span> -p /usr/bin
</span></span><span class=line><span class=cl>ln -sfn /nix/store/fifbf1h3i83jvan2vkk7xm4fraq7drm7-coreutils-riscv64-unknown-linux-gnu-9.1/bin/env /usr/bin/.env.tmp
</span></span><span class=line><span class=cl>mv /usr/bin/.env.tmp /usr/bin/env <span class=c1># atomically replace /usr/bin/env</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;usrbinenv&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet var:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl><span class=c1># Various log/runtime directories.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir -m <span class=m>1777</span> -p /var/tmp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Empty, immutable home directory of many system accounts.</span>
</span></span><span class=line><span class=cl>mkdir -p /var/empty
</span></span><span class=line><span class=cl><span class=c1># Make sure it&#39;s really empty</span>
</span></span><span class=line><span class=cl>/nix/store/yln7ma9dldr3f2dva4l0iq275s4brxml-e2fsprogs-riscv64-unknown-linux-gnu-1.46.6-bin/bin/chattr -f -i /var/empty <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>find /var/empty -mindepth <span class=m>1</span> -delete
</span></span><span class=line><span class=cl>chmod <span class=m>0555</span> /var/empty
</span></span><span class=line><span class=cl>chown root:root /var/empty
</span></span><span class=line><span class=cl>/nix/store/yln7ma9dldr3f2dva4l0iq275s4brxml-e2fsprogs-riscv64-unknown-linux-gnu-1.46.6-bin/bin/chattr -f +i /var/empty <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;var&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#### Activation script snippet wrappers:</span>
</span></span><span class=line><span class=cl><span class=nv>_localstatus</span><span class=o>=</span><span class=m>0</span>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> <span class=s2>&#34;/run/wrappers&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># We want to place the tmpdirs for the wrappers to the parent dir.</span>
</span></span><span class=line><span class=cl><span class=nv>wrapperDir</span><span class=o>=</span><span class=k>$(</span>mktemp --directory --tmpdir<span class=o>=</span><span class=s2>&#34;/run/wrappers&#34;</span> wrappers.XXXXXXXXXX<span class=k>)</span>
</span></span><span class=line><span class=cl>chmod a+rx <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/chsh&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/chsh&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/jqk530wxiq3832zyiqn8qi6i2pr3snnl-dbus-riscv64-unknown-linux-gnu-1.14.8/libexec/dbus-daemon-launch-helper&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl>chown root:messagebus <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+rx,o-rx&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/dbus-daemon-launch-helper&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/2d68cpnlqls47ijrwss83swjk2q1v953-fuse-riscv64-unknown-linux-gnu-2.9.9/bin/fusermount&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/06w8lm5k9i2n1xhkszsf4pa9hw9l0r5s-fuse-riscv64-unknown-linux-gnu-3.11.0/bin/fusermount3&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/fusermount3&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin/bin/mount&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/mount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/newgidmap&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/newgrp&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newgrp&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/newuidmap&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/newuidmap&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/passwd&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/passwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/mckzq3q58m31d8ax04gnjqx43niamis0-iputils-riscv64-unknown-linux-gnu-20221126/bin/ping&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set desired capabilities on the file plus cap_setpcap so</span>
</span></span><span class=line><span class=cl><span class=c1># the wrapper program can elevate the capabilities set on</span>
</span></span><span class=line><span class=cl><span class=c1># its file into the Ambient set.</span>
</span></span><span class=line><span class=cl>/nix/store/z2gpziznsj8rnv55vyq5n287g5cvx7lg-libcap-riscv64-unknown-linux-gnu-2.68/bin/setcap <span class=s2>&#34;cap_setpcap,cap_net_raw+p&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Set the executable bit</span>
</span></span><span class=line><span class=cl>chmod u+rx,g+x,o+x <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/ping&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/9al8xczxbm72i5q63n91fli5rynrfprl-shadow-riscv64-unknown-linux-gnu-4.13/bin/sg&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sg&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/gbp100zp8a8gja22dyjz4nwv0qsxb7qy-shadow-riscv64-unknown-linux-gnu-4.13-su/bin/su&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/su&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/scywdc7rd6cjfvji166a6d0bsjj90vys-sudo-riscv64-unknown-linux-gnu-1.9.13p3/bin/sudo&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudo&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/scywdc7rd6cjfvji166a6d0bsjj90vys-sudo-riscv64-unknown-linux-gnu-1.9.13p3/bin/sudoedit&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/sudoedit&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/2w8nachmhqvbjswrrsdia5cx1afxxx60-util-linux-riscv64-unknown-linux-gnu-2.38.1-bin/bin/umount&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/umount&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>cp /nix/store/wl1c1dgxb1zklpy5inpk7p798pm4zcca-security-wrapper-riscv64-unknown-linux-gnu/bin/security-wrapper <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s2>&#34;/nix/store/cn72qv0n576vg61mgaran7g2vj6gdjwn-linux-pam-riscv64-unknown-linux-gnu-1.5.2/bin/unix_chkpwd&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd.real&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent races</span>
</span></span><span class=line><span class=cl>chmod <span class=m>0000</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl>chown root:root <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=s2>&#34;u+s,g-s,u+rx,g+x,o+x&#34;</span> <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>/unix_chkpwd&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -L /run/wrappers/bin <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=c1># Atomically replace the symlink</span>
</span></span><span class=line><span class=cl>  <span class=c1># See https://axialcorps.com/2013/07/03/atomically-replacing-files-and-directories/</span>
</span></span><span class=line><span class=cl>  <span class=nv>old</span><span class=o>=</span><span class=k>$(</span>readlink -f /run/wrappers/bin<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[</span> -e <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    rm --force --recursive <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl>  ln --symbolic --force --no-dereference <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>&#34;</span> <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span>
</span></span><span class=line><span class=cl>  mv --no-target-directory <span class=s2>&#34;/run/wrappers/bin-tmp&#34;</span> <span class=s2>&#34;/run/wrappers/bin&#34;</span>
</span></span><span class=line><span class=cl>  rm --force --recursive <span class=s2>&#34;</span><span class=nv>$old</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>  <span class=c1># For initial setup</span>
</span></span><span class=line><span class=cl>  ln --symbolic <span class=s2>&#34;</span><span class=nv>$wrapperDir</span><span class=s2>&#34;</span> <span class=s2>&#34;/run/wrappers/bin&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>((</span> _localstatus &gt; <span class=m>0</span> <span class=o>))</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>printf</span> <span class=s2>&#34;Activation script snippet &#39;%s&#39; failed (%s)\n&#34;</span> <span class=s2>&#34;wrappers&#34;</span> <span class=s2>&#34;</span><span class=nv>$_localstatus</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Make this configuration the current configuration.</span>
</span></span><span class=line><span class=cl><span class=c1># The readlink is there to ensure that when $systemConfig = /system</span>
</span></span><span class=line><span class=cl><span class=c1># (which is a symlink to the store), /run/current-system is still</span>
</span></span><span class=line><span class=cl><span class=c1># used as a garbage collection root.</span>
</span></span><span class=line><span class=cl>ln -sfn <span class=s2>&#34;</span><span class=k>$(</span>readlink -f <span class=s2>&#34;</span><span class=nv>$systemConfig</span><span class=s2>&#34;</span><span class=k>)</span><span class=s2>&#34;</span> /run/current-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Prevent the current configuration from being garbage-collected.</span>
</span></span><span class=line><span class=cl>mkdir -p /nix/var/nix/gcroots
</span></span><span class=line><span class=cl>ln -sfn /run/current-system /nix/var/nix/gcroots/current-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=nv>$_status</span></span></span></code></pre></div><p>这个脚本有点长，简单总结下它干了啥：</p><ol><li>通过 <code>source /nix/store/vn0sga6rn69vkdbs0d2njh0aig7zmzi6-mounts.sh</code> 挂载一些目录，看下这个文件内容就知道，挂的是 <code>/proc</code> <code>/sys</code> <code>/dev</code> <code>/rum</code> 等几个临时目录。</li><li>通过 <code>mkdir</code>/<code>install</code> 等指令自动创建 <code>/home</code> <code>/root</code> <code>/bin</code> <code>/usr</code> <code>/usr/bin</code> 等目录</li><li>通过<code>perl /nix/store/rg5rf512szdxmnj9qal3wfdnpfsx38qi-setup-etc.pl /nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc</code>
配置生成 <code>/etc</code> 目录中的各种文件。</li><li>通过 <code>ln</code> 命令添加其他各种软链接，以及一些别的设置。</li></ol><p>其中第三步 etc 目录的设置，实际数据基本都来自该脚本的第二个参数：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-8 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>› ls root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc
</span></span><span class=line><span class=cl>╭────┬──────────────────────────────────────────────────────────────────────────┬─────────┬────────┬──────────────╮
</span></span><span class=line><span class=cl>│  <span class=c1># │                                   name                                   │  type   │  size  │   modified   │</span>
</span></span><span class=line><span class=cl>├────┼──────────────────────────────────────────────────────────────────────────┼─────────┼────────┼──────────────┤
</span></span><span class=line><span class=cl>│  <span class=m>0</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/bashrc           │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>1</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/binfmt.d         │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>2</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/dbus-1           │ symlink │   <span class=m>50</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>3</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/default          │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>4</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/dhcpcd.exit-hook │ symlink │   <span class=m>60</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>5</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/fonts            │ symlink │   <span class=m>69</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>6</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/fstab            │ symlink │   <span class=m>53</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>7</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/fuse.conf        │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>8</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/host.conf        │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│  <span class=m>9</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/hostname         │ symlink │   <span class=m>56</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>10</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/hosts            │ symlink │   <span class=m>49</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>11</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/inputrc          │ symlink │   <span class=m>51</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>12</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/issue            │ symlink │   <span class=m>49</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>13</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/kbd              │ symlink │   <span class=m>61</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>14</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/locale.conf      │ symlink │   <span class=m>55</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>15</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/login.defs       │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>16</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/lsb-release      │ symlink │   <span class=m>59</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>17</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/lvm              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>18</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/man_db.conf      │ symlink │   <span class=m>59</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>19</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/modprobe.d       │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>20</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/modules-load.d   │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>21</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nanorc           │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>22</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/netgroup         │ symlink │   <span class=m>56</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>23</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nix              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>24</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nscd.conf        │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>25</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/nsswitch.conf    │ symlink │   <span class=m>61</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>26</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/os-release       │ symlink │   <span class=m>58</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>27</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pam              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>28</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pam.d            │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>29</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pki              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>30</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/profile          │ symlink │   <span class=m>55</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>31</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/protocols        │ symlink │   <span class=m>75</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>32</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/pulse            │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>33</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/resolvconf.conf  │ symlink │   <span class=m>63</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>34</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/rpc              │ symlink │   <span class=m>90</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>35</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/samba            │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>36</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/services         │ symlink │   <span class=m>74</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>37</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/set-environment  │ symlink │   <span class=m>59</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>38</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/shells           │ symlink │   <span class=m>54</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>39</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/ssh              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>40</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/ssl              │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>41</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers          │ symlink │   <span class=m>51</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>42</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers.gid      │ file    │    <span class=m>3</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>43</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers.mode     │ file    │    <span class=m>5</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>44</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sudoers.uid      │ file    │    <span class=m>3</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>45</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/sysctl.d         │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>46</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/systemd          │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>47</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/terminfo         │ symlink │   <span class=m>70</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>48</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/tmpfiles.d       │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>49</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/udev             │ dir     │ 4.1 KB │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>50</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/vconsole.conf    │ symlink │   <span class=m>57</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>│ <span class=m>51</span> │ root/nix/store/qsbx6lnsbs54yszy7d1ni7xgz6h6ayjd-etc/etc/zoneinfo         │ symlink │   <span class=m>97</span> B │ <span class=m>54</span> years ago │
</span></span><span class=line><span class=cl>├────┼──────────────────────────────────────────────────────────────────────────┼─────────┼────────┼──────────────┤
</span></span><span class=line><span class=cl>│  <span class=c1># │                                   name                                   │  type   │  size  │   modified   │</span>
</span></span><span class=line><span class=cl>╰────┴──────────────────────────────────────────────────────────────────────────┴─────────┴────────┴──────────────╯</span></span></code></pre></div><p>这个 perl 脚本基本就是根据这个 nix store 中的 etc 文件夹，生成 <code>/etc</code> 目录中的各种文件或软链接。</p><h2 id=四硬件驱动部分 class=headerLink><a href=#%e5%9b%9b%e7%a1%ac%e4%bb%b6%e9%a9%b1%e5%8a%a8%e9%83%a8%e5%88%86 class=header-mark></a>四、硬件驱动部分</h2><p>NixOS 要能在 LicheePi 4A 上正常启动，还需要有硬件固件的支持，因此光了解 NixOS 的启动流程还不够，还需要了解硬件固件的启动流程。这里简要介绍下 Linux 在 RISC-V 上的启动流程。</p><h3 id=1-u-bootu-boot-splu-boot-tpl-的关系 class=headerLink><a href=#1-u-bootu-boot-splu-boot-tpl-%e7%9a%84%e5%85%b3%e7%b3%bb class=header-mark></a>1. u-boot，u-boot-spl，u-boot-tpl 的关系</h3><p>U-Boot 是嵌入式领域最常用的 bootloader，</p><p>对于一般嵌入式系统而言只需要一个 u-boot 作为 bootloader 即可，但入今的嵌入式 IC 已经转向
SOC 片上系统，其内部不仅仅是一颗 CPU 核，还可能包含各种各样的其他 IP，因而相关的上层软件也需要针对性的划分不同的功能域，操作域，安全域等上层应用。为了支持这些复杂而碎片化的应用需求，又或者因为 SRAM 太小以致无法放下整个 bootloader，SOC 的 Boot 阶段衍生出了多级
BootLoader，u-boot 为此定义了二三级加载器:</p><ul><li>spl：Secondary Program Loader，二级加载器</li><li>tpl：Tertiary Program Loader，三级加载器</li></ul><p>spl 和 tpl 走 u-boot 完全相同的 boot 流程，不过在 spl 和 tpl 中大多数驱动和功能被去除了，
根据需要只保留一部分 spl 和 tpl 需要的功能，通过 CONFIG_SPL_BUILD 和 CONFIG_TPL_BUILD 控制；一般只用 spl 就足够了，spl 完成 ddr 初始化，并完成一些外设驱动初始化，比如 usb，emmc，
以此从其他外围设备加载 u-boot，但是如果对于小系统 spl 还是太大了，则可以继续加入 tpl，tpl
只做 ddr 等的特定初始化保证代码体积极小，以此再次从指定位置加载 spl，spl 再去加载 u-boot。</p><p>LicheePi4A 就使用了二级加载器，它甚至写死了 eMMC 的分区表，要求我们使用 fastboot 往对应的分区写入 u-boot-spl.bin，官方给出的命令如下：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">bash</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-9 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl><span class=c1># flash u-boot into spl partition</span>
</span></span><span class=line><span class=cl>sudo fastboot flash ram u-boot-with-spl.bin
</span></span><span class=line><span class=cl>sudo fastboot reboot
</span></span><span class=line><span class=cl><span class=c1># flash uboot partition</span>
</span></span><span class=line><span class=cl>sudo fastboot flash uboot u-boot-with-spl.bin</span></span></code></pre></div><h3 id=2-risc-v-的启动流程 class=headerLink><a href=#2-risc-v-%e7%9a%84%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b class=header-mark></a>2. RISC-V 的启动流程</h3><p>网上找到的一个图，涉及到一些 RISC-V 指令集相关的知识点：</p><figure><img src=/posts/how-nixos-start-on-licheepi4a/current-riscv-boot-flow.webp width=80%><figcaption><h4>RISCV 开发版当前的引导流程</h4></figcaption></figure><p>根据我们前面的 NixOS 启动日志，跟这个图还是比较匹配的，但我们没观察到任何 U-Boot 日志，有可能是因为 U-Boot 没开日志，暂时不打算细究。</p><h3 id=3-opensbi class=headerLink><a href=#3-opensbi class=header-mark></a>3. OpenSBI</h3><p>前面的 NixOS 启动日志跟启动流程图中都出现了 OpenSBI，那么 OpenSBI 是什么呢？为什么 ARM 开发版的启动流程中没有这么个玩意儿？</p><p>查了下资料，大概是说因为 RISC-V 是一个开放指令集，任何人都可以基于 RISC-V 开发自己的定制指令集，或者定制 IC 布局。这显然存在很明显的碎片化问题。OpenSBI 就是为了避免此问题而设计的，
它提供了一个标准的接口，即 Supervisor Binary Interface, SBI. 上层系统只需要适配 SBI 就可以了，不需要关心底层硬件的细节。IC 开发商也只需要实现 SBI 的接口，就可以让任何适配了 SBI 的上层系统能在其硬件平台上正常运行。</p><p>而 OpenSBI 则是 SBI 标准的一个开源实现，IC 开发商只需要将 OpenSBI 移植到自己的硬件平台上即可支持 SBI 标准。</p><p>而 ARM 跟 X86 等指令集则是封闭的，不允许其他公司修改与拓展其指令集，因此不存在碎片化的问题，也就不需要 OpenSBI 这样的东西。</p><h3 id=4-fw_dynamicbin-跟-u-boot-splbin-两个文件 class=headerLink><a href=#4-fw_dynamicbin-%e8%b7%9f-u-boot-splbin-%e4%b8%a4%e4%b8%aa%e6%96%87%e4%bb%b6 class=header-mark></a>4. fw_dynamic.bin 跟 u-boot-spl.bin 两个文件</h3><ol><li><code>fw_dynamic.bin</code>: 我们 NixOS 镜像的 <code>/boot</code> 中就有这个固件，它是 OpenSBI 的编译产物。<ol><li>RevyOS 的定制 OpenSBI 构建方法：<a href=https://github.com/revyos/thead-opensbi/blob/lpi4a/.github/workflows/build.yml target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-opensbi/blob/lpi4a/.github/workflows/build.yml</a></li></ol></li><li><code>u-boot-spl.bin</code>: 这个文件是 u-boot 的编译产物，它是二级加载器。<ol><li>RevyOS 的定制 u-boot 构建方法：<a href=https://github.com/revyos/thead-u-boot/blob/lpi4a/.github/workflows/build.yml target=_blank rel="noopener noreferrer">https://github.com/revyos/thead-u-boot/blob/lpi4a/.github/workflows/build.yml</a></li></ol></li></ol><h3 id=5-t-head-官方的编译工具链 class=headerLink><a href=#5-t-head-%e5%ae%98%e6%96%b9%e7%9a%84%e7%bc%96%e8%af%91%e5%b7%a5%e5%85%b7%e9%93%be class=header-mark></a>5. T-Head 官方的编译工具链</h3><p>因为历史原因，TH1520 设计时貌似 RVV 还没出正式的规范，因此它使用了一些非标准的指令集，GCC
官方貌似宣称了永远不会支持这些指令集&mldr;（个人理解，可能有误哈）</p><p>因此为了获得最佳性能，LicheePi4A 官方文档建议使用 T-Head 提供的工具链编译整个系统。</p><p>但我在研究了 NixOS 的工具链实现，以及咨询了 @NickCao 后，确认了在 NixOS 上这几乎是不可行的。NixOS 因为不遵循 FHS 标准，它对 GCC 等工具链做了非常多的魔改，要在 NixOS 上使用 T-Head
的工具链，就要使这一堆魔改的东西在 T-Head 的工具链上也能 Work，这个工作量很大，也很有技术难度。</p><p>所以最终选择了用 NixOS 的标准工具链编译系统，@revy 老师也为此帮我做了些适配工作，解决了一些标准工具链上的编译问题。</p><p>Issue 区也有人提到了这个问题，Revy 老师也帮助补充了些相关信息：<a href=https://github.com/ryan4yin/nixos-licheepi4a/issues/14 target=_blank rel="noopener noreferrer">https://github.com/ryan4yin/nixos-licheepi4a/issues/14</a></p><h2 id=五我是如何构建出一个可以在-licheepi-4a-上运行的-nixos-镜像的 class=headerLink><a href=#%e4%ba%94%e6%88%91%e6%98%af%e5%a6%82%e4%bd%95%e6%9e%84%e5%bb%ba%e5%87%ba%e4%b8%80%e4%b8%aa%e5%8f%af%e4%bb%a5%e5%9c%a8-licheepi-4a-%e4%b8%8a%e8%bf%90%e8%a1%8c%e7%9a%84-nixos-%e9%95%9c%e5%83%8f%e7%9a%84 class=header-mark></a>五、我是如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像的</h2><p>到这里，NixOS 在 LicheePI4A 上启动的整个流程就基本讲清楚了， <strong>NixOS 跟其他传统发行版在启动流程中最大的区别是它自定义了一个 init 脚本，在启动 systemd 之前，它会先执行这个脚本进行文件系统的初始化操作，准备好最基础的 FHS 目录结构，使得后续的 systemd 以及其他服务能正常启动</strong>。正是因为这个 init 脚本，NixOS 才能在仅有 <code>/boot</code> 与 <code>/nix</code> 这两个目录的情况下正常启动整个系统。</p><blockquote><p>NixOS 数据的集中化只读存储使更多的骚操作成为可能，比如直接使用 tmpfs 作为根文件系统，将需要持久化的目录挂载到外部存储设备上，这样每次重启系统时，所有预期之外的临时数据都会被清空，进一步保证了系统的可复现性与安全性。如果你有系统洁癖，而且有兴趣折腾，那就快来看看
@LanTian 写的<a href=https://lantian.pub/article/modify-computer/nixos-impermanence.lantian/ target=_blank rel="noopener noreferrer">NixOS 系列（四）：「无状态」操作系统</a>
吧~</p></blockquote><p>最终在 LicheePi4A 成功启动后的登录的截图：</p><figure><img src=/posts/how-nixos-start-on-licheepi4a/nixos-licheepi-neofetch.webp width=80%><figcaption><h4>NixOS 成功启动</h4></figcaption></figure><p>那么基于我们到目前为止学到的知识，要如何构建出一个可以在 LicheePi 4A 上运行的 NixOS 镜像呢？</p><p>这个讲起来就很费时间了，涉及到了 NixOS
的<a href=https://nixos-and-flakes.thiscute.world/zh/development/cross-platform-compilation target=_blank rel="noopener noreferrer">交叉编译系统</a>，<a href=https://nixos-and-flakes.thiscute.world/zh/development/kernel-development target=_blank rel="noopener noreferrer">内核 override</a>,<a href=https://nixos-and-flakes.thiscute.world/zh/nixos-with-flakes/introduction-to-flakes target=_blank rel="noopener noreferrer">flakes</a>,<a href=https://github.com/ryan4yin/nixos-licheepi4a/blob/main/modules/sd-image/sd-image.nix target=_blank rel="noopener noreferrer">镜像构建</a>等等，要展开讲的话也是下一篇文章了，有兴趣的可以直接看我的 NixOS on LicheePi4A 仓库：<a href=https://github.com/ryan4yin/nixos-licheepi4a target=_blank rel="noopener noreferrer">https://github.com/ryan4yin/nixos-licheepi4a</a>.</p><p>简单的说，NixOS 跟传统 Linux 发行版的系统镜像构建思路是一致的，但因为其声明式与可复现性的特点，实际实现时出现了非常大的区别。以我的项目仓库为例，整个项目完全使用 Nix 语言声明式编写（内嵌了部分 Shell 脚本&mldr;），而且这份配置也可用于系统后续的持续声明式更新部署（我还给出了一个 demo）。</p><p>最后，再推荐一波我的 NixOS 入门指南：<a href=https://github.com/ryan4yin/nixos-and-flakes-book target=_blank rel="noopener noreferrer">ryan4yin/nixos-and-flakes-book</a>，
对 NixOS 感兴趣的读者们，快进我碗里来（</p><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><ul><li><a href=https://github.com/nixcon/NixConContent/blob/main/NixCon%20NA%202024%20-%20California/Day%202%20-%20Keynotes/systemd-stage-1.pdf target=_blank rel="noopener noreferrer">Systemd Stage 1 - NixCon NA 2024 - California</a></li><li><a href=https://litterhougelangley.club/blog/2023/05/27/licheepi-4a-%e8%bf%99%e4%b8%aa%e5%b0%8f%e6%9d%bf%e6%9c%89%e7%82%b9%e6%84%8f%e6%80%9d%ef%bc%88%e7%ac%ac%e4%b8%80%e9%83%a8%e5%88%86%ef%bc%89/ target=_blank rel="noopener noreferrer">LicheePi 4A —— 这个小板有点意思（第一部分） - HougeLangley</a></li><li><a href=https://opensource.com/article/18/1/analyzing-linux-boot-process target=_blank rel="noopener noreferrer">Analyzing the Linux boot process - By Alison Chaiken</a></li><li><a href=https://github.com/riscv-software-src/opensbi/blob/master/docs/firmware/fw.md target=_blank rel="noopener noreferrer">OpenSBI Platform Firmwares</a></li><li><a href=https://crvf2019.github.io/pdf/43.pdf target=_blank rel="noopener noreferrer">An Introduction to RISC-V Boot flow: Overview, Blob vs Blobfree standards</a></li><li><a href=https://quard-star-tutorial.readthedocs.io/zh_CN/latest/ch5-1.html target=_blank rel="noopener noreferrer">基于 qemu-riscv 从 0 开始构建嵌入式 linux 系统 ch5-1. 什么是多级 BootLoader 与 opensbi(上)¶</a></li><li><a href=https://docs.kernel.org/admin-guide/initrd.html target=_blank rel="noopener noreferrer">Using the initial RAM disk (initrd) - kernel.org</a></li><li><a href=https://www.baeldung.com/linux/kernel-images target=_blank rel="noopener noreferrer">Differences Between vmlinux, vmlinuz, vmlinux.bin, zimage, and bzimage</a></li><li><a href=https://github.com/ARM-software/u-boot/blob/master/doc/README.distro target=_blank rel="noopener noreferrer">U-Boot 官方的 Distro 文档</a></li></ul></div><h2>相关内容</h2><div class=related-container><div class=related-item-container><div class=related-image><a href=/posts/linux-desktop-explained/><img src=/posts/linux-desktop-explained/featured-image.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/linux-desktop-explained/>Linux 桌面系统组件概览与故障排查指南</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/my-experience-of-nixos/><img src=/posts/my-experience-of-nixos/nixos-and-flakes-book-202402.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/my-experience-of-nixos/>OS as Code - 我的 NixOS 使用体会</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/an-incomplete-guide-to-data-security/><img src=/posts/an-incomplete-guide-to-data-security/datasecurity.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/an-incomplete-guide-to-data-security/>个人数据安全不完全指南</a></h2></div></div><div class="sponsor print:tw-hidden"><div class=sponsor-avatar><img src=/avatar/myself.webp></div><p class=sponsor-bio><em>如果你觉得这篇文章对你有所帮助，欢迎评论、分享、打赏~</em></p><a href=https://afdian.com/a/ryan4yin title=Sponsor target=_blank class=sponsor-button rel="noopener noreferrer"><span style=color:#ec6cb9><svg class="icon" viewBox="0 0 512 512"><path d="M458.4 64.3C400.6 15.7 311.3 23 256 79.3 200.7 23 111.4 15.6 53.6 64.3-21.6 127.6-10.6 230.8 43 285.5l175.4 178.7c10 10.2 23.4 15.9 37.6 15.9 14.3.0 27.6-5.6 37.6-15.8L469 285.6c53.5-54.7 64.7-157.9-10.6-221.3zm-23.6 187.5L259.4 430.5c-2.4 2.4-4.4 2.4-6.8.0L77.2 251.8c-36.5-37.2-43.9-107.6 7.3-150.7 38.9-32.7 98.9-27.8 136.5 10.5l35 35.7 35-35.7c37.8-38.5 97.8-43.2 136.5-10.6 51.1 43.1 43.5 113.9 7.3 150.8z"/></svg></span>
<span>赞赏</span></a></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-01-29</span></div><div class=post-info-license></div></div><div class="post-info-line print:!tw-hidden"><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/ data-title="NixOS 在 Lichee Pi 4A 上是如何启动的" data-via=ryan4yin data-hashtags=Linux,NixOS,LicheePi4A,Embedded,U-Boot,RISC-V><svg class="icon" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></button><button title="分享到 Hacker News" data-sharer=hackernews data-url=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/ data-title="NixOS 在 Lichee Pi 4A 上是如何启动的"><svg class="icon" viewBox="0 0 448 512"><path d="M0 32v448h448V32H0zm21.2 197.2H21c.1-.1.2-.3.3-.4.0.1.0.3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg></button><button title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/how-nixos-start-on-licheepi4a/><svg class="icon" viewBox="0 0 512 512"><path d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="分享到 Mastodon" onclick='shareOnMastodon("NixOS 在 Lichee Pi 4A 上是如何启动的","https://thiscute.world/posts/how-nixos-start-on-licheepi4a/")'><svg class="icon" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></button></div></div></div><div class=post-info-more><section class=post-tags><svg class="icon" viewBox="0 0 640 512"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg>&nbsp;<a href=/tags/linux/>Linux</a>,&nbsp;<a href=/tags/nixos/>NixOS</a>,&nbsp;<a href=/tags/licheepi4a/>LicheePi4A</a>,&nbsp;<a href=/tags/embedded/>Embedded</a>,&nbsp;<a href=/tags/u-boot/>U-Boot</a>,&nbsp;<a href=/tags/risc-v/>RISC-V</a></section><section class=print:!tw-hidden><span><button class="tw-text-fgColor-link-muted hover:tw-text-fgColor-link-muted-hover" onclick=window.history.back()>返回</button></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class="post-nav print:tw-hidden"><a href=/posts/2023-summary/ class=prev rel=prev title="我的 2023 - 认识更多有趣的人，见识更宽广的世界"><svg class="icon" viewBox="0 0 256 512"><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9.0l22.6 22.6c9.4 9.4 9.4 24.6.0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6.0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9.0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>我的 2023 - 认识更多有趣的人，见识更宽广的世界</a>
<a href=/posts/an-incomplete-guide-to-data-security/ class=next rel=next title=个人数据安全不完全指南>个人数据安全不完全指南<svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></a></div></div><div id=comments class="print:!tw-hidden tw-pt-32 tw-pb-8"><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://img.foreverblog.cn/logo_en_default.png alt style=display:inline-block;width:auto;height:20px>
</a><a href=https://www.foreverblog.cn/go.html target=_blank><img src=https://img.foreverblog.cn/wormhole_3.gif alt style=display:inline-block;width:auto;height:20px title=穿梭虫洞-随机访问十年之约友链博客></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.150.0">Hugo</a> 强力驱动&nbsp;|&nbsp;托管在 <a title=Vercel href=https://vercel.com/ target=_blank rel="noopener noreffer">Vercel</a> 上&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg> DoIt</a></div><div class=footer-line><svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532.0-2e2-89.451-2e2-2e2.0-110.531 89.451-2e2 2e2-2e2 110.532.0 2e2 89.451 2e2 2e2.0 110.532-89.451 2e2-2e2 2e2zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43.0-140.484-61.425-140.484-141.567.0-79.152 60.275-139.401 139.762-139.401 55.531.0 88.738 26.62 97.593 34.779a11.965 11.965.0 011.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303.0-77.916 35.33-77.916 80.082.0 41.589 26.888 83.692 78.277 83.692 32.657.0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947.0 01-1.152 15.518z"/></svg>2021 - 2025<span class=author>&nbsp;<a href=/ target=_blank rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class=license> <a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons class=print:!tw-hidden><a href=#back-to-top id=back-to-top-button class="fixed-button tw-transition-opacity tw-opacity-0" title=回到顶部><svg class="icon" viewBox="0 0 448 512"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg>
</a><a href=#comments id=view-comments class=fixed-button title=查看评论><svg class="icon" viewBox="0 0 512 512"><path d="M256 32C114.6 32 0 125.1.0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3.0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4.0 256-93.1 256-208S397.4 32 256 32z"/></svg></a></div><script>window.config={"algoliasearch.min.js":"/lib/algoliasearch/algoliasearch-lite.umd.min.js","autocomplete.min.js":"/lib/autocomplete/autocomplete.min.js",comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script src=/lib/sharer/sharer.min.js></script><script src=/lib/typeit/typeit.min.js></script><script src=/js/theme.min.js defer></script><script src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script><script type=speculationrules>
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script></body></html>