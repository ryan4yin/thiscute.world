<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>NAT 网关、NAT 穿越以及虚拟网络 - This Cute World</title><meta name=Description content="This Cute World"><meta property="og:url" content="https://thiscute.world/posts/about-nat/"><meta property="og:site_name" content="This Cute World"><meta property="og:title" content="NAT 网关、NAT 穿越以及虚拟网络"><meta property="og:description" content="个人笔记，不一定正确…
当前文章完成度 - 70%
前言NAT，即 Network Address Translation，是 IPv4 网络中非常重要的一个功能，用于执行 IP 地址与端口的转换。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-13T11:46:00+08:00"><meta property="article:modified_time" content="2022-05-13T11:46:00+08:00"><meta property="article:tag" content="NAT"><meta property="article:tag" content="网络"><meta property="article:tag" content="NAT 穿越"><meta property="article:tag" content="内网穿透"><meta property="article:tag" content="虚拟网络"><meta property="article:tag" content="P2P"><meta property="og:image" content="https://thiscute.world/posts/about-nat/nat.webp"><meta property="og:see_also" content="https://thiscute.world/posts/wireguard-on-linux/"><meta property="og:see_also" content="https://thiscute.world/posts/iptables-and-container-networks/"><meta property="og:see_also" content="https://thiscute.world/posts/linux-virtual-network-interfaces/"><meta property="og:see_also" content="https://thiscute.world/posts/socat-netcat/"><meta property="og:see_also" content="https://thiscute.world/posts/tcpdump-and-wireshark/"><meta property="og:see_also" content="https://thiscute.world/posts/about-dns-protocol/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://thiscute.world/posts/about-nat/nat.webp"><meta name=twitter:title content="NAT 网关、NAT 穿越以及虚拟网络"><meta name=twitter:description content="个人笔记，不一定正确…
当前文章完成度 - 70%
前言NAT，即 Network Address Translation，是 IPv4 网络中非常重要的一个功能，用于执行 IP 地址与端口的转换。"><meta name=twitter:site content="@ryan4yin"><meta name=application-name content="This Cute World"><meta name=apple-mobile-web-app-title content="This Cute World"><meta name=theme-color content="#f8f8f8"><meta name=twitter:creator content="@ryan4yin"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://thiscute.world/posts/about-nat/><link rel=prev href=https://thiscute.world/posts/finops-for-kubernetes/><link rel=next href=https://thiscute.world/posts/death-is-but-a-dream/><link rel=stylesheet href=/css/main.min.css><link rel=stylesheet href=/css/style.min.css><meta name=google-site-verification content="E8bpp1lVVlb9YnSJcUzPL1dLAG17Nl_sp5Ru9a8tUDQ"><meta name=baidu-site-verification content="code-ZZtDruAnX1"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"NAT 网关、NAT 穿越以及虚拟网络","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://thiscute.world/posts/about-nat/"},"image":[{"@type":"ImageObject","url":"https://thiscute.world/posts/about-nat/nat.webp","width":728,"height":250}],"genre":"posts","keywords":["NAT","网络","NAT 穿越","内网穿透","虚拟网络","P2P","WebRTC"],"wordcount":11667,"url":"https://thiscute.world/posts/about-nat/","datePublished":"2022-05-13T11:46:00+08:00","dateModified":"2022-05-13T11:46:00+08:00","publisher":{"@type":"Organization","name":"ryan4yin","logo":"https://thiscute.world/avatar/myself.png"},"author":[{"@type":"Person","name":"於清樂","url":null}],"description":""}</script></head><body data-instant-intensity=viewport><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.className=e,document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),e==="light"?document.documentElement.classList.remove("tw-dark"):document.documentElement.classList.add("tw-dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else"auto"==="light"||"auto"==="dark"?(setTheme("auto"),saveTheme("auto")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#161b22"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class="desktop print:!tw-hidden" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=desktop-header-typeit class=typeit></span></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/statistics/>阅读排行 </a><a class=menu-item href=/series/>系列 </a><a class=menu-item href=/categories/tech/>技术 </a><a class=menu-item href=/categories/life/>生活 </a><a class=menu-item href=/tags/>标签 </a><a class=menu-item href=/friends/>朋友们 </a><a class=menu-item href=/now/>此刻 </a><a class=menu-item href=/about/>关于 </a><span class="menu-item delimiter"></span><button class="menu-item language" aria-label=选择语言>Simplified Chinese<svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
<select class=language-select aria-label=选择语言 id=language-select-desktop onchange="location=this.value"><option value=/posts/about-nat/ selected>Simplified Chinese</option></select>
</button><span class="menu-item search" id=search-desktop>
<input type=text placeholder=搜索文章标题或内容... id=search-input-desktop>
<button class="search-button search-toggle" id=search-toggle-desktop title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear" id=search-clear-desktop title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-desktop><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg>
</span></span><button class="menu-item theme-switch" aria-label=切换主题>
<svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg></button></div></div></div></header><header class="mobile print:!tw-hidden" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="This Cute World"><span id=mobile-header-typeit class=typeit></span></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容... id=search-input-mobile>
<button class="search-button search-toggle tw-h-10" id=search-toggle-mobile title=搜索>
<svg class="icon" viewBox="0 0 512 512"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</button>
<button class="search-button search-clear" id=search-clear-mobile title=清空>
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm121.6 313.1c4.7 4.7 4.7 12.3.0 17L338 377.6c-4.7 4.7-12.3 4.7-17 0L256 312l-65.1 65.6c-4.7 4.7-12.3 4.7-17 0L134.4 338c-4.7-4.7-4.7-12.3.0-17l65.6-65-65.6-65.1c-4.7-4.7-4.7-12.3.0-17l39.6-39.6c4.7-4.7 12.3-4.7 17 0l65 65.7 65.1-65.6c4.7-4.7 12.3-4.7 17 0l39.6 39.6c4.7 4.7 4.7 12.3.0 17L312 256l65.6 65.1z"/></svg>
</button>
<span class="search-button search-loading tw-animate-spin" id=search-loading-mobile><svg class="icon" viewBox="0 0 512 512"><path d="M304 48c0 26.51-21.49 48-48 48s-48-21.49-48-48 21.49-48 48-48 48 21.49 48 48zm-48 368c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zm208-208c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48zM96 256c0-26.51-21.49-48-48-48S0 229.49.0 256s21.49 48 48 48 48-21.49 48-48zm12.922 99.078c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.491-48-48-48zm294.156.0c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48c0-26.509-21.49-48-48-48zM108.922 60.922c-26.51.0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.491-48-48-48z"/></svg></span></div><button class=search-cancel id=search-cancel-mobile>
取消</button></div><a class=menu-item href=/statistics/ title>阅读排行</a><a class=menu-item href=/series/ title>系列</a><a class=menu-item href=/categories/tech/ title>技术</a><a class=menu-item href=/categories/life/ title>生活</a><a class=menu-item href=/tags/ title>标签</a><a class=menu-item href=/friends/ title>朋友们</a><a class=menu-item href=/now/ title>此刻</a><a class=menu-item href=/about/ title>关于</a><button class="menu-item theme-switch tw-w-full" aria-label=切换主题>
<svg class="icon" viewBox="0 0 512 512"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
</button><button class="menu-item tw-w-full" title>Simplified Chinese<svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
<select class=language-select title onchange="location=this.value"><option value=/posts/about-nat/ selected>Simplified Chinese</option></select></button></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class="toc print:!tw-hidden" id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#nat-如何工作>NAT 如何工作</a></li><li><a href=#nat-的地址映射方式>NAT 的地址映射方式</a><ul><li><a href=#1-一对一-nat>1. 一对一 NAT</a></li><li><a href=#2-一对多-nat---napt>2. 一对多 NAT - NAPT</a><ul><li><a href=#rfc3489-定义的-nat-类型四种>RFC3489 定义的 NAT 类型（四种）</a><ul><li><a href=#1-full-cone-nat>1. Full-cone NAT</a></li><li><a href=#2-address-restricted-cone-nat>2. (Address-)Restricted cone NAT</a></li><li><a href=#3-port-restricted-cone-nat>3. Port-Restricted cone NAT</a></li><li><a href=#4-symmetric-nat>4. Symmetric NAT</a></li><li><a href=#5-linux-中的-napt>5. Linux 中的 NAPT</a></li></ul></li><li><a href=#rfc5389-定义的-nat-类型九种>RFC5389 定义的 NAT 类型（九种）</a><ul><li><a href=#1-映射规则>1. 映射规则</a></li><li><a href=#2-过滤规则>2. 过滤规则</a></li><li><a href=#3-rfc3489-与-rfc5389-的-nat-类型定义关系>3. RFC3489 与 RFC5389 的 NAT 类型定义关系</a></li></ul></li></ul></li></ul></li><li><a href=#nat-的弊端>NAT 的弊端</a></li><li><a href=#nat-穿越---nat-traversal>NAT 穿越 - NAT Traversal</a><ul><li><a href=#1-dmz-主机或者定向-dnat-转发>1. 「DMZ 主机」或者「定向 DNAT 转发」</a></li><li><a href=#2-静态端口转发>2. 静态端口转发</a></li><li><a href=#3-upnp-动态端口转发>3. UPnP 动态端口转发</a></li><li><a href=#4-nat-穿越协议---stunturnice>4. NAT 穿越协议 - STUN/TURN/ICE</a><ul><li><a href=#stunturnice-的-nat-类型检测>STUN/TURN/ICE 的 NAT 类型检测</a></li><li><a href=#stunturnice-协议如何实现-nat-打洞>STUN/TURN/ICE 协议如何实现 NAT 打洞</a><ul><li><a href=#1-a-与-b-在同一局域网中>1. A 与 B 在同一局域网中</a></li><li><a href=#2-a-与-b-分别在不同的局域网中>2. A 与 B 分别在不同的局域网中</a></li><li><a href=#3-a-与-b-之间隔着三层以上的-nat>3. A 与 B 之间隔着三层以上的 NAT</a></li><li><a href=#4-特殊穿越方案---服务器中继>4. 特殊穿越方案 - 服务器中继</a></li></ul></li></ul></li><li><a href=#特定协议的自穿越技术>特定协议的自穿越技术</a></li><li><a href=#nat-algapplication-level-gateway>NAT ALG(Application Level Gateway)</a></li></ul></li><li><a href=#使用-go-实验-nat-穿透>使用 Go 实验 NAT 穿透</a></li><li><a href=#虚拟网络overlay-与-underlay>虚拟网络、Overlay 与 Underlay</a><ul><li><a href=#相关工具>相关工具</a></li><li><a href=#vpn-协议>VPN 协议</a></li></ul></li><li><a href=#拓展知识>拓展知识</a><ul><li><a href=#symmetric-nat-允许的最大并发-tcp-连接数是多少>Symmetric NAT 允许的最大并发 TCP 连接数是多少？</a></li><li><a href=#aws-vpc-与-nat>AWS VPC 与 NAT</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","true")</script><article class="page single print:!tw-w-full print:!tw-max-w-none print:!tw-m-0 print:!tw-p-0"><h1 class=single-title data-pagefind-meta=date:2022-05-13 data-pagefind-body>NAT 网关、NAT 穿越以及虚拟网络</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><span class=screen-reader-text></span><a href=https://thiscute.world/authors/ryan4yin><img class="tw-inline-block tw-max-h-4 tw-rounded-full tw-translate-y-[-2px] tw-mr-1" src=/avatar/myself.webp alt="於清樂 avatar" height=16 width=16>於清樂</a></span>
</span>&nbsp;<span class=post-category>收录于 </span>&nbsp;<span class=post-category>类别 <a href=/categories/tech/><svg class="icon" viewBox="0 0 512 512"><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>Tech</a></span>&nbsp;<span class=post-category>和</span>&nbsp;<span class=post-series>系列 <a href=/series/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3/><svg class="icon" viewBox="0 0 512 512"><path d="M464 32H48C21.49 32 0 53.49.0 80v352c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V80c0-26.51-21.49-48-48-48zm-6 4e2H54a6 6 0 01-6-6V86a6 6 0 016-6h404a6 6 0 016 6v340a6 6 0 01-6 6zm-42-92v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm0-96v24c0 6.627-5.373 12-12 12H204c-6.627.0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h2e2c6.627.0 12 5.373 12 12zm-252 12c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36zm0 96c0 19.882-16.118 36-36 36s-36-16.118-36-36 16.118-36 36-36 36 16.118 36 36z"/></svg>计算机网络相关</a></span></div><div class=post-meta-line><svg class="icon" viewBox="0 0 448 512"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;<time datetime=2022-05-13>2022-05-13</time>&nbsp;<svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>&nbsp;<time datetime=2022-05-13>2022-05-13</time>&nbsp;<svg class="icon" viewBox="0 0 512 512"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;约 11667 字&nbsp;
<svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;预计阅读 52 分钟&nbsp;</div></div><div class=featured-image><img loading=eager src=/posts/about-nat/nat.webp height=250 width=728></div><div class="details series-nav open"><div class="details-summary series-title"><span>系列 - 计算机网络相关</span>
<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class="details-content series-content"><nav><ul><li><a href=/posts/wireguard-on-linux/>Linux 上的 WireGuard 网络分析（一）</a></li><li><span class=active>NAT 网关、NAT 穿越以及虚拟网络</span></li><li><a href=/posts/iptables-and-container-networks/>iptables 及 docker 容器网络分析</a></li><li><a href=/posts/linux-virtual-network-interfaces/>Linux 中的虚拟网络接口</a></li><li><a href=/posts/socat-netcat/>Linux 网络工具中的瑞士军刀 - socat & netcat</a></li><li><a href=/posts/tcpdump-and-wireshark/>使用 tcpdump 和 Wireshark 进行远程实时抓包分析</a></li><li><a href=/posts/about-dns-protocol/>Linux网络学习笔记（二）：域名解析(DNS)——以 CoreDNS 为例</a></li></ul></nav></div></div><div class="details toc print:!tw-block" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span class=details-icon><svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#nat-如何工作>NAT 如何工作</a></li><li><a href=#nat-的地址映射方式>NAT 的地址映射方式</a><ul><li><a href=#1-一对一-nat>1. 一对一 NAT</a></li><li><a href=#2-一对多-nat---napt>2. 一对多 NAT - NAPT</a><ul><li><a href=#rfc3489-定义的-nat-类型四种>RFC3489 定义的 NAT 类型（四种）</a><ul><li><a href=#1-full-cone-nat>1. Full-cone NAT</a></li><li><a href=#2-address-restricted-cone-nat>2. (Address-)Restricted cone NAT</a></li><li><a href=#3-port-restricted-cone-nat>3. Port-Restricted cone NAT</a></li><li><a href=#4-symmetric-nat>4. Symmetric NAT</a></li><li><a href=#5-linux-中的-napt>5. Linux 中的 NAPT</a></li></ul></li><li><a href=#rfc5389-定义的-nat-类型九种>RFC5389 定义的 NAT 类型（九种）</a><ul><li><a href=#1-映射规则>1. 映射规则</a></li><li><a href=#2-过滤规则>2. 过滤规则</a></li><li><a href=#3-rfc3489-与-rfc5389-的-nat-类型定义关系>3. RFC3489 与 RFC5389 的 NAT 类型定义关系</a></li></ul></li></ul></li></ul></li><li><a href=#nat-的弊端>NAT 的弊端</a></li><li><a href=#nat-穿越---nat-traversal>NAT 穿越 - NAT Traversal</a><ul><li><a href=#1-dmz-主机或者定向-dnat-转发>1. 「DMZ 主机」或者「定向 DNAT 转发」</a></li><li><a href=#2-静态端口转发>2. 静态端口转发</a></li><li><a href=#3-upnp-动态端口转发>3. UPnP 动态端口转发</a></li><li><a href=#4-nat-穿越协议---stunturnice>4. NAT 穿越协议 - STUN/TURN/ICE</a><ul><li><a href=#stunturnice-的-nat-类型检测>STUN/TURN/ICE 的 NAT 类型检测</a></li><li><a href=#stunturnice-协议如何实现-nat-打洞>STUN/TURN/ICE 协议如何实现 NAT 打洞</a><ul><li><a href=#1-a-与-b-在同一局域网中>1. A 与 B 在同一局域网中</a></li><li><a href=#2-a-与-b-分别在不同的局域网中>2. A 与 B 分别在不同的局域网中</a></li><li><a href=#3-a-与-b-之间隔着三层以上的-nat>3. A 与 B 之间隔着三层以上的 NAT</a></li><li><a href=#4-特殊穿越方案---服务器中继>4. 特殊穿越方案 - 服务器中继</a></li></ul></li></ul></li><li><a href=#特定协议的自穿越技术>特定协议的自穿越技术</a></li><li><a href=#nat-algapplication-level-gateway>NAT ALG(Application Level Gateway)</a></li></ul></li><li><a href=#使用-go-实验-nat-穿透>使用 Go 实验 NAT 穿透</a></li><li><a href=#虚拟网络overlay-与-underlay>虚拟网络、Overlay 与 Underlay</a><ul><li><a href=#相关工具>相关工具</a></li><li><a href=#vpn-协议>VPN 协议</a></li></ul></li><li><a href=#拓展知识>拓展知识</a><ul><li><a href=#symmetric-nat-允许的最大并发-tcp-连接数是多少>Symmetric NAT 允许的最大并发 TCP 连接数是多少？</a></li><li><a href=#aws-vpc-与-nat>AWS VPC 与 NAT</a></li></ul></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content data-pagefind-body><blockquote><p>个人笔记，不一定正确&mldr;</p></blockquote><blockquote><p>当前文章完成度 - 70%</p></blockquote><h2 id=前言 class=headerLink><a href=#%e5%89%8d%e8%a8%80 class=header-mark></a>前言</h2><p>NAT，即 Network Address Translation，是 IPv4 网络中非常重要的一个功能，用于执行 IP 地址与端口的转换。</p><p>IPv4 的设计者没预料到因特网技术的发展会如此之快，在设计时只使用了 32bits 的地址空间，随着因特网的飞速发展，它很快就变得不够用了。后来虽然设计了新的 IPv6 协议，但是它与 IPv4 不兼容，需要新的硬件设备以及各种网络程序支持，无法快速普及。</p><p>NAT 就是在 IPv6 普及前，临时解决 IPv4 地址空间不够用而开发的技术，通俗地讲 NAT 就是用来给
IPv4 续命的。它解决 IPv4 地址短缺问题的方法是：</p><ul><li>每个家庭、组织、企业，在内部都使用局域网通讯，不占用公网 IPv4 资源</li><li>在局域网与上层网络的交界处（路由器），使用 NAT 技术进行 IP/port 转换，使用户能正常访问上层网络</li></ul><p>在曾经 IPv4 地址还不是特别短缺的时候，普通家庭的网络架构通常是：「家庭局域网」=>「NAT 网关
（家庭路由器）」=>「因特网」。</p><p>但是互联网主要发展于欧美，因此许多欧美的组织与机构在初期被分配了大量的 IPv4 资源，而后入场的中国分配到的 IPv4 地址就不太能匹配上我们的人口。因此相比欧美，中国的 IPv4 地址是非常短缺的，即使使用上述这样的网络架构——也就是给每个家庭（或组织）分配一个 IPv4 地址——都有点捉襟见肘了。于是中国电信等运营商不得不再加一层 NAT，让多个家庭共用同一个 IP 地址，这时网络架构会变成这样：「家庭局域网」=>「家庭 NAT 网关」=>「运营商广域网」=>「运营商 NAT 网关」=>「公共因特网」。由于此架构通过两层 NAT 网关串联了三个不同的 IPv4 网络，它也被形象地称为<strong>NAT444</strong> 技术，详见<a href=https://zh.wikipedia.org/wiki/%E7%94%B5%E4%BF%A1%E7%BA%A7NAT target=_blank rel="noopener noreferrer">电信级NAT - 维基百科</a>。</p><blockquote><p><a href=https://www.v2ex.com/t/875867 target=_blank rel="noopener noreferrer">据 v2ex 上传闻</a>国内运营商甚至开始尝试使用 <strong>NAT4444</strong>
了&mldr; 目的是给用户分配一个假公网 IP 地址&mldr;</p></blockquote><blockquote><p>不过 IPv6 也正在变得越来越流行，看 v2ex 上最近（2022-08）就很多人在聊，一些城市在试点
ipv4 over ipv6 隧道技术，底层完全换成 IPv6 协议加 IPoE 拨号了，带来的问题是没法桥接，详见<a href=https://www.v2ex.com/t/875362 target=_blank rel="noopener noreferrer">电信又一新动作：上网业务不再使用 PPPoE 新装宽带无法改桥接 - v2ex</a>。</p></blockquote><p>总的来说，NAT 是一项非常成功的技术，它成功帮 IPv4 续命了几十年，甚至到如今 2022 年，全球网络仍然是 IPv4 的天下。</p><h2 id=nat-如何工作 class=headerLink><a href=#nat-%e5%a6%82%e4%bd%95%e5%b7%a5%e4%bd%9c class=header-mark></a>NAT 如何工作</h2><p>NAT 的工作方式，使用图例描述是这样的：</p><figure><img src=/images/about-nat/NAT-demo.webp><figcaption><h4>NAT 示例</h4></figcaption></figure><p>从外部网络看一个 NAT 网关（一个启用了 NAT 的路由器），它只是拥有一个 IPv4 地址的普通设备，
所有从局域网发送到公网的流量，其 IP 地址都是这个路由器的 WAN IP 地址，在上图中，这个 IP 地址是 <code>138.76.29.7</code>.</p><p>本质上，NAT 网关隐藏了家庭网络的细节，从外部网络上看，整个家庭网络就像一台普通的网络设备。</p><p>下面我们会学习到，上述这个 NAT 工作方式实际上是 NAPT，它同时使用 L3/L4 的信息进行地址转换工作。</p><h2 id=nat-的地址映射方式 class=headerLink><a href=#nat-%e7%9a%84%e5%9c%b0%e5%9d%80%e6%98%a0%e5%b0%84%e6%96%b9%e5%bc%8f class=header-mark></a>NAT 的地址映射方式</h2><p>NAT 的具体实现有许多的变种，不存在统一的规范，但是大体上能分为两种模型：「一对一 NAT」与「一对多 NAT」，下面分别进行介绍。</p><h3 id=1-一对一-nat class=headerLink><a href=#1-%e4%b8%80%e5%af%b9%e4%b8%80-nat class=header-mark></a>1. 一对一 NAT</h3><p>一对一 NAT，这种类型的 NAT 在 <a href=https://datatracker.ietf.org/doc/html/rfc2663 target=_blank rel="noopener noreferrer">RFC2663</a> 中被称为 Basic NAT。它在技术上比较简单，只利用网络层的信息，对 IP 地址进行转换。</p><p>简单的说，Basic NAT 要求每个内网 IP 都需要绑定一个唯一的公网 IP，才能连通外部网络。</p><p>其<strong>主要应用场景是，公网用户需要访问到内网主机</strong>。</p><p>Basic NAT 有三种类型：「<strong>静态 NAT</strong>」、「<strong>动态 NAT</strong>」以及「<strong>NAT Server</strong>」。</p><p>现在的很多家庭路由器都自带一个被称为 DMZ 主机的功能，它是「Demilitarized Zone」的缩写，意为隔离区。它允许将某一台内网主机设置为 DMZ 主机（或者叫隔离区主机，仅此主机可供外网访问），所有从外部进来的流量，都会被通过 Basic NAT 修改为对应的内网 IP 地址，然后直接发送到该主机。路由器的这种 DMZ 技术就是「静态 NAT」，因为 DMZ 主机对应的内网 IP 需要手动配置，不会动态变化。</p><figure><img src=/images/about-nat/dmz-host-topology.webp><figcaption><h4>DMZ 主机拓扑结构</h4></figcaption></figure><p>而「<strong>动态 NAT</strong>」则需要一个公网 IP 地址池，每次用户需要访问公网时，动态 NAT 会给它分配一个动态公网 IP 并自动配置相应的 NAT 规则，使用完再回收。</p><p>第三种是「<strong>NAT Server</strong>」，云服务商提供的「<strong>公网 IP</strong>」就是通过「<strong>NAT Server</strong>」实现的，在云服务器中使用 <code>ip addr ls</code> 查看你会发现，该主机上实际只配了局域网 IP 地址，但是它却能正常使用公网 IP 通信，原因就是云服务商在「<strong>NAT Server</strong>」上为这些服务器配置了 IP 转发规则。为一台云服务器绑定一个公网 IP，实际上就是请求「<strong>NAT Server</strong>」从公网 IP 地址池中取出一个，并配置对应的 NAT 规则到这台云服务器的局域网 IP。</p><p>示例如下，其中的 Internet Gateway 实际上就是个一对一 NAT Server：</p><figure><img src=/images/about-nat/aws-vpc-nat-internet-gateway.webp><figcaption><h4>AWS VPC 中的 NAT 网关以及 Internet 网关</h4></figcaption></figure><blockquote><p>云服务 VPC 中的公有子网，实际上就是一个 DMZ(Demilitarized Zone) 隔离区，是不安全的。而私有子网则是安全区，公网无法直接访问到其中的主机。</p></blockquote><p>而「动态 NAT」则需要路由器维护一个<strong>公网 IP 地址池</strong>，内网服务器需要访问公网时，动态 NAT
就从地址池中拿出一个公网 IP 给它使用，用完再回收。这种场景需要一个公网 IP 地址池，每当内部有服务需要请求外网时，就动态地为它分配一个公网 IP 地址，使用完再回收。</p><p>Basic NAT 的好处是，它仅工作在 L3 网络层，网络层上的协议都可以正常使用（比如 P2P），不需要啥「内网穿越」技术。</p><h3 id=2-一对多-nat---napt class=headerLink><a href=#2-%e4%b8%80%e5%af%b9%e5%a4%9a-nat---napt class=header-mark></a>2. 一对多 NAT - NAPT</h3><p>一对多 NAT，也被称为 NAPT（network address and port translation），同样在<a href=https://datatracker.ietf.org/doc/html/rfc2663#section-4.0 target=_blank rel="noopener noreferrer">RFC2663</a> 中被定义。Easy IP 是
NAPT 的一个特殊形式。</p><p><strong>NAPT 的主要应用场景是，内网用户需要访问到公网主机</strong>。绝大多数的家庭网络、办公网络都是
NAPT 类型的。原因应该很好理解——家庭网络或办公网络都包含许多联网设备，但是这类网络通常只有一个或数个公网 IP，使用一对一 NAT 的话公网 IP 显然是不够用的，所以需要使用一对多 NAT.</p><p>NAPT 通过同时利用 L3 的 IP 信息，以及 L4 传输层的端口信息，来为局域网设备提供透明的、配置方便的、支持超高并发连接的外部网络通信，示意图如下：</p><figure><img src=/images/about-nat/napt.webp></figure><p>NAPT 的端口分配与转换规则（<strong>Mapping Behavior</strong>）以及对外来流量的过滤规则（<strong>Filtering
Behavior</strong>）都存在许多不同的实现，没有统一的规范与标准，但是存在两种分类规范，这种分类方法主要用在 NAT 穿越技术中。</p><h4 id=rfc3489-定义的-nat-类型四种 class=headerLink><a href=#rfc3489-%e5%ae%9a%e4%b9%89%e7%9a%84-nat-%e7%b1%bb%e5%9e%8b%e5%9b%9b%e7%a7%8d class=header-mark></a>RFC3489 定义的 NAT 类型（四种）</h4><p>在 <a href=https://datatracker.ietf.org/doc/html/rfc3489#section-5 target=_blank rel="noopener noreferrer">RFC3489</a> 中将 NAPT 分为四种类型，这也是应用最为广泛的 NAT 分类方法，如下图：</p><figure><img src=/images/about-nat/nat-types-defined-in-stun.webp></figure><p>下面我们逐一介绍这四种不同的 NAPT 类型。</p><blockquote><p>从这里开始，下文中的 NAT 特指 NAPT，如果涉及「一对一 NAT」会使用它的全名。</p></blockquote><h5 id=1-full-cone-nat class=headerLink><a href=#1-full-cone-nat class=header-mark></a>1. Full-cone NAT</h5><p>Full-cone NAT 的特点如下：</p><ul><li>数据包流出：一旦内部地址（iAddr:iPort）映射到外部地址（eAddr:ePort），所有发自
iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。</li><li>数据包流入：任意主机发送到 eAddr:ePort 的数据包，都能通过 NAT 到达 iAddr:iPort.<ul><li>也就是不对外部进来的数据做任何限制，全部放行。</li><li>cone 圆锥，个人理解是一个比喻，任意发送进来的数据（多），都能通过 NAT 到达这个内部地址
（一），就像一个圆锥。</li></ul></li></ul><p>允许任意主机发送到 eAddr:ePort 的数据到达内部地址是很危险的行为，因为内部主机不一定配置了合适的安全策略。因此 <strong>Full-cone NAT 比较少见</strong>，就算路由器等 NAT 设备支持 Full-cone NAT，
通常也不会是默认选项。我们会在后面更详细地介绍它。</p><h5 id=2-address-restricted-cone-nat class=headerLink><a href=#2-address-restricted-cone-nat class=header-mark></a>2. (Address-)Restricted cone NAT</h5><ul><li>数据包流出：（跟 Full-cone NAT 完全一致）一旦内部地址（iAddr:iPort）映射到外部地址
（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。</li><li>数据包流入：只有内部地址（iAddr:iPort）主动连接过的<strong>外部主机</strong>（nAddr:<strong>any</strong>），发送到
eAddr:ePort 的数据包，才能通过 NAT 到达 iAddr:iPort.<ul><li>跟 Full-cone NAT 的区别在于，它<strong>限制了外部主机的 IP 地址</strong>。只有主动连接过的主机，才能发送数据到 NAT 内部。这<strong>提升了一些安全性</strong>。</li></ul></li></ul><h5 id=3-port-restricted-cone-nat class=headerLink><a href=#3-port-restricted-cone-nat class=header-mark></a>3. Port-Restricted cone NAT</h5><ul><li>数据包流出：（跟 Full-cone NAT 完全一致）一旦内部地址（iAddr:iPort）映射到外部地址
（eAddr:ePort），所有发自 iAddr:iPort 的数据包都经由 eAddr:ePort 向外发送。</li><li>数据包流入：只有内部地址（iAddr:iPort）主动连接过的<strong>外部程序</strong>（nAddr:<strong>nPort</strong>），发送到 eAddr:ePort 的数据包，才能通过 NAT 到达 iAddr:iPort.<ul><li>与 Address-Restricted cone NAT 的区别在于，它<strong>同时限制了外部主机的 IP 与端口</strong>，可以说是更<strong>进一步地提升了安全性</strong>。</li></ul></li></ul><h5 id=4-symmetric-nat class=headerLink><a href=#4-symmetric-nat class=header-mark></a>4. Symmetric NAT</h5><ul><li>数据包流出：同一个内部地址（iAddr:iPort）与不同外部主机（nAddr:nPort）的通信，会随机使用不同的 NAT 外部端口（eAddr:<strong>randomPort</strong>）。也就是说内部地址与 NAT 外部地址的关系也是<strong>一对多</strong>！<ul><li>为每个连接都随机选择一个不同的 NAT 端口，这实际是进一步强化了 NAT 内网的安全性。<strong>但这也是 NAT 穿越最大的难点——它导致 Symmetric NAT 的端口难以预测</strong>！</li></ul></li><li>数据包流入：只有内部地址（iAddr:iPort）主动连接过的外部程序（nAddr:nPort），发送到
eAddr:ePort 的数据包，才能通过 NAT 到达 iAddr:iPort.<ul><li>这个数据流入规则，与 Port-Restricted cone NAT 是完全一致的。</li></ul></li></ul><p><strong>对称 NAT 是最安全的一种 NAT 结构，限制最为严格，应该也是应用最广泛的 NAT 结构</strong>。但是它导致所有的 TCP 连接都只能由从内部主动发起，外部发起的 TCP 连接请求会直接被 NAT 拒绝，因此它也是 P2P 玩家最头疼的一种 NAT 类型。解决方案是通过 UDP 迂回实现连接的建立，我们会在后面讨论这个问题。</p><h5 id=5-linux-中的-napt class=headerLink><a href=#5-linux-%e4%b8%ad%e7%9a%84-napt class=header-mark></a>5. Linux 中的 NAPT</h5><p>Linux 的网络栈中，可通过 <code>iptables/netfilter</code> 的 <code>SNAT/MASQUERADE</code> 实现 NAPT 网关，这种方式只能实现一个 Symmetric NAT.</p><p>也就是说绝大多数基于 Linux 实现的家庭局域网、Docker 虚拟网络、Kubernetes 虚拟网络、云服务的虚拟网络，都是 Symmetric NAT.</p><p>只有一些有 Full-cone NAT 需求的网吧、ISP 的 LSN(Large Scale NAT) 网关等组织，会使用非
Linux 内核的企业级路由器提供 Full-cone NAT 能力，这些设备可能是基于 FPGA 等专用芯片设计的。</p><p>想要将 Symmetric NAT 内的主机提供给外部访问，只能通过端口映射、一对一 NAT 等方式实现，后面会详细介绍这些方法。</p><h4 id=rfc5389-定义的-nat-类型九种 class=headerLink><a href=#rfc5389-%e5%ae%9a%e4%b9%89%e7%9a%84-nat-%e7%b1%bb%e5%9e%8b%e4%b9%9d%e7%a7%8d class=header-mark></a>RFC5389 定义的 NAT 类型（九种）</h4><p>RFC3489 这个早期 RFC 存在一些问题，问题之一就是它对 NAT 归类过于笼统，很多 NAPT 网关都无法很好的匹配上其中某个类别。</p><p>于是后来，RFC3489 被废弃并由 <a href=https://www.rfc-editor.org/rfc/rfc5389 target=_blank rel="noopener noreferrer">RFC5389</a> 来替代，在
RFC5389 中，将 Mapping Behavior（映射规则）和 Filtering Behavior（过滤规则）分开来，定义了
3 种 Mapping Behavior（映射规则）和 3 种 Filtering Behavior（过滤规则），一共有 9 种组合。</p><h5 id=1-映射规则 class=headerLink><a href=#1-%e6%98%a0%e5%b0%84%e8%a7%84%e5%88%99 class=header-mark></a>1. 映射规则</h5><p>三种映射规则如图所示，假设一个内网主机 HostX 的内网 IP 地址为 X，端口号为 x，经 NAT 映射后的外网 IP 地址为 M，端口号为 m。为方便描述，将内网的 Endpoint 记为 <code>Endpoint(X,x)</code>，映射后外网的 Endpoint 记为 <code>Endpoint(M,m)</code>。内网 <code>Endpoint(X,x)</code> 发往外网 HostD1 的 IP 地址和端口号记为目的 <code>Endpoint(D1,d1)</code>；发往外网 HostD2 的 IP 地址和端口号记为目的<code>Endpoint(D2,d2)</code>。</p><figure><img src=/images/about-nat/rfc5389-mapping-behavior.webp><figcaption><h4>NAT 映射规则</h4></figcaption></figure><ul><li><strong>EIM</strong>(Endpoint-Independent Mapping) 外部地址无关映射<ul><li>对于一个内网 <code>Endpoint(X,x)</code>，其映射的外网 <code>Endpoint(M,m)</code> 是固定的。即从相同的<code>Endpoint(X,x)</code> 发送到任何外部 IP 地址和任何外部端口的报文在 NAT 设备上使用相同的映射。</li></ul></li><li><strong>ADM</strong>(Address-Dependent Mapping) 外部地址相关映射：对于一个内网 <code>Endpoint(X,x)</code>，发往目的 <code>Endpoint(D1,d1)</code> 的报文，<code>Endpoint(X,x)</code> 被映射成 <code>Endpoint(M1,m1)</code>；发往目的<code>Endpoint(D2,d2)</code> 的报文，<code>Endpoint(X,x)</code> 被映射成 <code>Endpoint(M2,m2)</code>。只要D1=D2，不管d1
和d2是多少，都有 <code>Endpoint(M1,m1)=Endpoint(M2,m2)</code>。即从相同的 <code>Endpoint(X,x)</code> 发送到相同外部 IP 地址和任何外部端口的报文在 NAT 设备上使用相同的映射。</li><li><strong>APDM</strong>（Address and Port-Dependent Mapping）外部地址和端口相关映射：对于一个内网<code>Endpoint(X,x)</code>，发往目的 <code>Endpoint(D1,d1)</code> 的报文，<code>Endpoint(X,x)</code> 被映射成<code>Endpoint(M1,m1)</code>；发往目的 <code>Endpoint(D2,d2)</code> 的报文， <code>Endpoint(X,x)</code> 被映射成<code>Endpoint(M2,m2)</code>。只有当D1=D2，且d1=d2，才有 <code>Endpoint(M1,m1)=Endpoint(M2,m2)</code>。即从相同的 Endpoint(X,x) 发送到相同外部IP地址和相同外部端口的报文在NAT设备上使用相同的映射。</li></ul><h5 id=2-过滤规则 class=headerLink><a href=#2-%e8%bf%87%e6%bb%a4%e8%a7%84%e5%88%99 class=header-mark></a>2. 过滤规则</h5><figure><img src=/images/about-nat/rfc5389-filtering-behavior.webp><figcaption><h4>NAT 过滤规则</h4></figcaption></figure><ul><li><p><strong>EIF</strong>（Endpoint-Independent Filtering）外部地址无关过滤：对于一个内网<code>Endpoint(X,x)</code>，只要它曾经向外网发送过数据，外网主机就可以获取到它经 NAT 映射后的外网<code>Endpoint(M,m)</code> 。那么只要是发给 <code>Endpoint(M,m)</code> 的报文，不管来源于 D1 还是 D2，都能被转换并发往内网，其他报文被过滤掉。</p></li><li><p><strong>ADF</strong>（Address-Dependent Filtering）外部地址相关过滤：对于一个内网 <code>Endpoint(X,x)</code> ，
只有它曾经向 IP 地址为 D1 的外网主机发送过报文，那么来自外网 HostD1 返回的任何端口的报文，都能被转换并发往内网，其他报文被过滤掉。</p></li><li><p><strong>APDF</strong>（Address and Port-Dependent Filtering）外部地址和端口相关过滤：对于一个内网<code>Endpoint(X,x)</code> ，只有它曾经向 IP 地址为 D1，端口号为 d1 的外网目的 <code>Endpoint(D1,d1)</code> 发送过报文，那么也只有外网 HostD1 中来自<code>Endpoint(D1,d1)</code>返回的报文，才能被转换并发往内网，其他报文被过滤掉。</p></li></ul><h5 id=3-rfc3489-与-rfc5389-的-nat-类型定义关系 class=headerLink><a href=#3-rfc3489-%e4%b8%8e-rfc5389-%e7%9a%84-nat-%e7%b1%bb%e5%9e%8b%e5%ae%9a%e4%b9%89%e5%85%b3%e7%b3%bb class=header-mark></a>3. RFC3489 与 RFC5389 的 NAT 类型定义关系</h5><ul><li>Full Cone NAT 是 EIM 和 EIF 的组合。</li><li>Restricted Cone NAT 是 EIM 和 ADF 的组合。</li><li>Port Restricted Cone NAT 是 EIM 和 APDF 的组合。</li><li>Symmetric NAT 是 APDM 和 APDF 的组合。</li></ul><h2 id=nat-的弊端 class=headerLink><a href=#nat-%e7%9a%84%e5%bc%8a%e7%ab%af class=header-mark></a>NAT 的弊端</h2><ul><li><strong>IP 会话的保持时效变短</strong>：NAT 需要维护一个会话列表，如果会话静默时间超过一个阈值，将会被从列表中移除。<ul><li>为了避免这种情况，就需要定期发送心跳包来维持 NAT 会话。俗称心跳保活</li></ul></li><li><strong>IP 跟踪机制失效</strong>：一对多 NAT 使得多个局域网主机共用一个公网 IP，这导致基于公网 IP 进行流量分析的逻辑失去意义。<ul><li>比如很多站点都加了基于 IP 的访问频率限制，这会造成局域网内多个用户之间的服务抢占与排队。</li></ul></li><li><strong>NAT 的工作机制依赖于修改IP包头的信息，这会妨碍一些安全协议的工作</strong>。<ul><li>因为 NAT 篡改了 IP 地址、传输层端口号和校验和，这会导致 IP 层的认证协议彻底不能工作，
因为认证目的就是要保证这些信息在传输过程中没有变化。</li><li>对于一些隧道协议，NAT 的存在也导致了额外的问题，因为隧道协议通常用外层地址标识隧道实体，穿过 NAT 的隧道会有 IP 复用关系，在另一端需要小心处理。</li><li>ICMP 是一种网络控制协议，它的工作原理也是在两个主机之间传递差错和控制消息，因为IP的对应关系被重新映射，ICMP 也要进行复用和解复用处理，很多情况下因为 ICMP 报文载荷无法提供足够的信息，解复用会失败。</li><li>IP 分片机制是在信息源端或网络路径上，需要发送的 IP 报文尺寸大于路径实际能承载最大尺寸时，IP 协议层会将一个报文分成多个片断发送，然后在接收端重组这些片断恢复原始报文。IP 这样的分片机制会导致传输层的信息只包括在第一个分片中，NAT难以识别后续分片与关联表的对应关系，因此需要特殊处理。</li></ul></li></ul><h2 id=nat-穿越---nat-traversal class=headerLink><a href=#nat-%e7%a9%bf%e8%b6%8a---nat-traversal class=header-mark></a>NAT 穿越 - NAT Traversal</h2><p>天下苦 NAT 久矣，尤其是对各种 P2P 玩家，如 NAS 玩家、P2P 游戏玩家，以及需要搭建 VPN 虚拟私有网络的网络管理员而言。在常见的联机游戏、BitTorrent 文件共享协议、P2P 聊天等点对点通讯场景中，通讯双方客户端通常都运行在家庭局域网中，也就是说中间隔着两层家庭路由器的 NAT，路由器的默认配置都是安全优先的，存在很多安全限制，直接进行 P2P 通讯大概率会失败。</p><p>为了穿越这些 NAT 网关进行 P2P 通讯，就需要借助<a href=https://en.wikipedia.org/wiki/NAT_traversal target=_blank rel="noopener noreferrer">NAT 穿越技术</a>。</p><blockquote><p>这里讨论的前提是，你的网络只有单层 NAT，如果外部还存在公寓 NAT、ISP 广域网 NAT，那下面介绍的 NAT 提升技术实际上就没啥意义了。</p></blockquote><h3 id=1-dmz-主机或者定向-dnat-转发 class=headerLink><a href=#1-dmz-%e4%b8%bb%e6%9c%ba%e6%88%96%e8%80%85%e5%ae%9a%e5%90%91-dnat-%e8%bd%ac%e5%8f%91 class=header-mark></a>1. 「DMZ 主机」或者「定向 DNAT 转发」</h3><p>最简单的方法是 DMZ 主机功能，前面已经介绍过了，DMZ 可以直接给内网服务器绑定路由器的外部
IP，从该 IP 进来的所有流量都会直接被发送给这台内网服务器。被指定的 DMZ 主机，其 NAT 类型将从 NAPT 变成一对一 NAT，而一对一 NAT 对 P2P 通讯而言是透明的，这样就可以愉快地玩耍了。</p><p>在 Linux 路由器上实现类似 DMZ 的功能，只需要两行 iptables 命令，这可以称作「定向 DNAT 转发」：</p><div class="code-block highlight is-open show-line-numbers tw-group tw-my-2"><div class="code-block-title
tw-flex
tw-flex-row
tw-justify-between
tw-w-full tw-bg-bgColor-secondary"><button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-rotate-90
tw-transition-[transform]
tw-duration-500
tw-ease-in-out
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 320 512"><path d="M285.476 272.971 91.132 467.314c-9.373 9.373-24.569 9.373-33.941.0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941.0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg></button><div class="code-block-title-bar tw-w-full"><p class="tw-select-none !tw-my-1">shell</p></div><div class=tw-flex><button class="line-number-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.show-line-numbers]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle line numbers"><svg class="icon" viewBox="0 0 512 512"><path d="M61.77 401l17.5-20.15a19.92 19.92.0 005.07-14.19v-3.31C84.34 356 80.5 352 73 352H16a8 8 0 00-8 8v16a8 8 0 008 8h22.83a157.41 157.41.0 00-11 12.31l-5.61 7c-4 5.07-5.25 10.13-2.8 14.88l1.05 1.93c3 5.76 6.29 7.88 12.25 7.88h4.73c10.33.0 15.94 2.44 15.94 9.09.0 4.72-4.2 8.22-14.36 8.22a41.54 41.54.0 01-15.47-3.12c-6.49-3.88-11.74-3.5-15.6 3.12l-5.59 9.31c-3.72 6.13-3.19 11.72 2.63 15.94 7.71 4.69 20.38 9.44 37 9.44 34.16.0 48.5-22.75 48.5-44.12-.03-14.38-9.12-29.76-28.73-34.88zM496 224H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zM16 160h64a8 8 0 008-8v-16a8 8 0 00-8-8H64V40a8 8 0 00-8-8H32a8 8 0 00-7.14 4.42l-8 16A8 8 0 0024 64h8v64H16a8 8 0 00-8 8v16a8 8 0 008 8zm-3.91 160H80a8 8 0 008-8v-16a8 8 0 00-8-8H41.32c3.29-10.29 48.34-18.68 48.34-56.44.0-29.06-25-39.56-44.47-39.56-21.36.0-33.8 10-40.46 18.75-4.37 5.59-3 10.84 2.8 15.37l8.58 6.88c5.61 4.56 11 2.47 16.12-2.44a13.44 13.44.0 019.46-3.84c3.33.0 9.28 1.56 9.28 8.75C51 248.19.0 257.31.0 304.59v4C0 316 5.08 320 12.09 320z"/></svg></button>
<button class="wrap-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
group-[.is-wrap]:tw-text-fgColor-link
print:!tw-hidden" title="Toggle code wrap"><svg class="icon" viewBox="0 0 448 512"><path d="M16 132h416c8.837.0 16-7.163 16-16V76c0-8.837-7.163-16-16-16H16C7.163 60 0 67.163.0 76v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16zm0 160h416c8.837.0 16-7.163 16-16v-40c0-8.837-7.163-16-16-16H16c-8.837.0-16 7.163-16 16v40c0 8.837 7.163 16 16 16z"/></svg></button>
<button class="copy-code-button
tw-select-none
tw-mx-2
tw-hidden
group-[.is-open]:tw-block
hover:tw-text-fgColor-link
print:!tw-hidden" title="Copy code">
<span class="copy-icon tw-block"><svg class="icon" viewBox="0 0 448 512"><path d="M433.941 65.941l-51.882-51.882A48 48 0 00348.118.0H176c-26.51.0-48 21.49-48 48v48H48c-26.51.0-48 21.49-48 48v320c0 26.51 21.49 48 48 48h224c26.51.0 48-21.49 48-48v-48h80c26.51.0 48-21.49 48-48V99.882a48 48 0 00-14.059-33.941zM266 464H54a6 6 0 01-6-6V150a6 6 0 016-6h74v224c0 26.51 21.49 48 48 48h96v42a6 6 0 01-6 6zm128-96H182a6 6 0 01-6-6V54a6 6 0 016-6h106v88c0 13.255 10.745 24 24 24h88v202a6 6 0 01-6 6zm6-256h-64V48h9.632c1.591.0 3.117.632 4.243 1.757l48.368 48.368a6 6 0 011.757 4.243V112z"/></svg></span>
<span class="check-icon tw-hidden"><svg class="icon" viewBox="0 0 512 512"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206.0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204.0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204.0l36.203 36.204c9.997 9.997 9.997 26.206.0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"/></svg></span>
</button>
<button class="tw-select-none
tw-mx-2
tw-block
group-[.is-open]:tw-hidden
print:!tw-hidden" disabled aria-hidden=true><svg class="icon" viewBox="0 0 512 512"><path d="M328 256c0 39.8-32.2 72-72 72s-72-32.2-72-72 32.2-72 72-72 72 32.2 72 72zm104-72c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72zm-352 0c-39.8.0-72 32.2-72 72s32.2 72 72 72 72-32.2 72-72-32.2-72-72-72z"/></svg></button></div></div><pre style=counter-reset:codeblock class="tw-block tw-m-0 tw-p-0"><code id=codeblock-id-1 class="chroma
!tw-block
tw-p-0
tw-m-0
tw-transition-[max-height]
tw-duration-500
tw-ease-in-out
group-[.is-closed]:!tw-max-h-0
group-[.is-wrap]:tw-text-wrap
tw-overflow-y-hidden
tw-overflow-x-auto
tw-scrollbar-thin"><span class=line><span class=cl>iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE <span class=c1># 普通的SNAT</span>
</span></span><span class=line><span class=cl>iptables -t nat -A PREROUTING -i eth0 -j DNAT --to-destination 192.168.1.3 <span class=c1># 将入站流量DNAT转发到内网主机192.168.1.3</span></span></span></code></pre></div><p>这两项技术的缺点是只能将一台主机提供给外网访问，而且将整台主机开放到公网实际上是很危险的，
如果不懂网络<strong>很容易被黑客入侵</strong>。</p><h3 id=2-静态端口转发 class=headerLink><a href=#2-%e9%9d%99%e6%80%81%e7%ab%af%e5%8f%a3%e8%bd%ac%e5%8f%91 class=header-mark></a>2. 静态端口转发</h3><p>退一步，可以直接用静态端口转发功能，就是在路由器上手动设置某个端口号的所有 TCP/UDP 流量，
都直接 NAT 转发到到内网的指定地址。也就是往 NAT 的转发表中手动添加内容，示意图：</p><figure><img src=/images/about-nat/NAPT-en.svg><figcaption><h4>NAPT tables</h4></figcaption></figure><p>设置好端口转发后，只要使用的是被设定的端口，NAT 对 P2P 通信而言将完全透明。绝大多数路由器都支持这项功能，NAS 发烧友们想玩 P2P 下载分享，基本都是这么搞的。</p><h3 id=3-upnp-动态端口转发 class=headerLink><a href=#3-upnp-%e5%8a%a8%e6%80%81%e7%ab%af%e5%8f%a3%e8%bd%ac%e5%8f%91 class=header-mark></a>3. UPnP 动态端口转发</h3><blockquote><p>最流行的 UPnP 实现是 <a href=https://github.com/miniupnp/miniupnp target=_blank rel="noopener noreferrer">https://github.com/miniupnp/miniupnp</a></p></blockquote><p>静态端口转发对用户的技术要求较高，我作为一个网络小白，希望有一个傻瓜式的开关能让我愉快地玩耍 Xbox/PS5 联机游戏，该怎么办呢？你需要的只是在路由器上启用 UPnP(Universal Plug and Play)
协议，启用它后，内网游戏设备就可以通过 UPnP 向路由器动态申请一个端口号供其使用，UPnP 会自动配置对应的端口转发规则。 <strong>现在新出的路由器基本都支持 UPnP 功能，它是最简单有效的 NAT 提升方式</strong>。</p><p>UPnP 解决了「静态端口转发」需要手动配置的问题，在启用了 UPnP 后，对所有支持 UPnP 的内网程序而言，NAT 类型将提升到 Full-cone NAT.</p><h3 id=4-nat-穿越协议---stunturnice class=headerLink><a href=#4-nat-%e7%a9%bf%e8%b6%8a%e5%8d%8f%e8%ae%ae---stunturnice class=header-mark></a>4. NAT 穿越协议 - STUN/TURN/ICE</h3><p>如果很不幸前面提到的「DMZ 主机」/「静态端口转发」/「UPnP」 三项技术，你的路由器都不支持，
那你就只能借助 NAT 穿越协议了。</p><p>目前有如下几个 NAT 穿越协议标准：</p><ul><li><a href=https://datatracker.ietf.org/doc/html/rfc3489 target=_blank rel="noopener noreferrer">RFC3489</a> Classic STUN<ul><li>Classic STUN 是一个早期的 STUN 规范，它定义了一整套完整的 NAT 穿越方案，但是因为存在许多问题，已经被废弃。</li></ul></li><li><a href=https://datatracker.ietf.org/doc/html/rfc5389 target=_blank rel="noopener noreferrer">RFC5389 - Simple Traversal of UDP Through NATs (STUN)</a><ul><li>RFC5389 所定义的 STUN 协议是对 Classic STUN 的改进，它的定位不再是一个完整的 NAT 穿越解决方案，而是作为其他协议（例如SIP、FTP、DNS）处理 NAT 穿越问题的一个工具。</li><li>其可以用于检查网络中NAT设备的存在，并确定两个通信端点被NAT设备分配的IP地址和端口号。然后，通过ICE（Interactive Connectivity Establishment），自动创建一条能够进行NAT穿越的数据通道。</li><li>STUN 支持除 Symmetric NAT 之外的另外三种 NAT 类型</li></ul></li><li><a href=https://tools.ietf.org/html/rfc5766 target=_blank rel="noopener noreferrer">RFC5766 - Traversal Using Relays around NAT (TURN)</a><ul><li>TURN 在 STUN 协议之上添加了一个中继，以确保在无法实现 NAT 穿越的情况下，可以 fallback
到直接使用中继服务器进行通信。</li><li>这个中继的原理类似反向代理，单纯负责数据的转发</li><li>在美国有一项数据表示在进行 P2P 穿越的时候，穿越成功的概率为 70%，但是在国内这个成功率
50% 可能都到不了。因此就有必要使用 TURN 协议，这样才能保证在穿越失败的情况下，用户仍然能正常通信。</li></ul></li><li><a href=https://datatracker.ietf.org/doc/html/rfc8445 target=_blank rel="noopener noreferrer">RFC8445 - Interactive Connectivity Establishment (ICE)</a><ul><li>一个 NAT 穿越的协商协议，它统一了 STUN 与 TURN 两种协议，会尝试遍历所有可能的连接方案。</li></ul></li></ul><p>总的来说，标准的 NAT 穿越协议优先使用打洞
（<strong><a href=https://en.wikipedia.org/wiki/Hole_punching_%28networking%29 target=_blank rel="noopener noreferrer">NAT Hole Pounching</a></strong>）技术，如果打洞失败，就使用中继服务器技术兜底，确保能成功穿越。</p><h4 id=stunturnice-的-nat-类型检测 class=headerLink><a href=#stunturnice-%e7%9a%84-nat-%e7%b1%bb%e5%9e%8b%e6%a3%80%e6%b5%8b class=header-mark></a>STUN/TURN/ICE 的 NAT 类型检测</h4><p>RFC5389 定义了对 NAT 映射类型以及过滤类型的检测方法。</p><p>TBD</p><h4 id=stunturnice-协议如何实现-nat-打洞 class=headerLink><a href=#stunturnice-%e5%8d%8f%e8%ae%ae%e5%a6%82%e4%bd%95%e5%ae%9e%e7%8e%b0-nat-%e6%89%93%e6%b4%9e class=header-mark></a>STUN/TURN/ICE 协议如何实现 NAT 打洞</h4><p>首先 P2P 双方如果只隔着 0-1 层 NAT，那是不需要使用 NAT 打洞技术的，可以直连或者反向连接。</p><p>下面就讨论下 P2P 双方隔着 2 层及以上 NAT 的场景下，如何利用 UDP 协议实现 NAT 打洞。</p><p>一个完整的 NAT 打洞方案，需要包含如下功能：</p><ul><li>A 跟 B 需要知道对方的公网 IP 以及监听的端口号<ul><li>解决方法：需要一个公网<strong>中介</strong>来介绍双方认识（交换 IP/port）</li></ul></li><li>NAT 连通性测试，需要借助公网主机，<strong>检测双方中间网络的类型</strong></li><li>针对不同的 NAT 类型，存在哪些穿越手段？以何种顺序进行<strong>穿越尝试</strong>？</li></ul><p>NAT 打洞可以使用 UDP/TCP 两种 L4 协议，但是 TCP 面向连接的特性使它在这个场景中限制性更大
（具体限制见参考文章，我有空再补充），因此各种 NAT 穿越协议通常都基于 UDP 实现。</p><p>此外，因为 NAT 的具体行为是非标准化的，路由器的防火墙策略也存在很大变动空间，再有就是
RF3489 的这种 NAT 分类方法不够精确，这些因素导致 NAT 穿透能否成功通常都是谈概率。</p><h5 id=1-a-与-b-在同一局域网中 class=headerLink><a href=#1-a-%e4%b8%8e-b-%e5%9c%a8%e5%90%8c%e4%b8%80%e5%b1%80%e5%9f%9f%e7%bd%91%e4%b8%ad class=header-mark></a>1. A 与 B 在同一局域网中</h5><p>这是最简单的情况，最佳方案是直接走内网通讯，不经过 NAT.</p><p>第二个方案是，这两个同一局域网内的客户端不走内网，仍然通过 NAT 通讯。这种通讯方式被称作「回环 NAT(Loopback NAT)」或者「发夹 NAT(Hairpin NAT)」。对于不支持或未启用「Hairpin NAT」的网关设备而言，这样的通讯尝试将会失败！</p><h5 id=2-a-与-b-分别在不同的局域网中 class=headerLink><a href=#2-a-%e4%b8%8e-b-%e5%88%86%e5%88%ab%e5%9c%a8%e4%b8%8d%e5%90%8c%e7%9a%84%e5%b1%80%e5%9f%9f%e7%bd%91%e4%b8%ad class=header-mark></a>2. A 与 B 分别在不同的局域网中</h5><p>这样实际上 A 与 B 中间就隔了两个 NAT 网关，这是最普遍的一种情况。</p><p>STUN/TURN 的 NAT 穿透流程大致如下：</p><ul><li>首先，A 跟 B 两个程序启动时，需要把自己的内外网 IP 及端口信息上报到一台中介服务器 S</li><li>现在假设 A 想要跟 B 建立一个 P2P 连接，首先他们需要从 S 获得对方的 ID</li><li>A 将 B 的 ID 发送给中介服务器 S，请求与 B 建立 P2P 连接</li><li>中介服务器将 B 的内外网 IP 及端口信息发送给 A，同时将 A 的网络信息发送给 B</li><li>A 尝试请求 B 的公网地址 <code>B_public_ip:B_public_port</code><ul><li>这肯定会失败，但是会在 A 的 NAT 网关上留下记录：A 曾经请求过这个地址，那之后这个地址发到 A 的 NAT 网关的流量就可以进来了。</li></ul></li><li>B 尝试请求 A 的公网地址 <code>A_public_ip:A_public_port</code><ul><li>同样这肯定也会失败，但是会在 B 的 NAT 网关上流量记录：B 曾经请求过这个地址，那之后这个地址发到 B 的 NAT 网关的流量就可以进来了</li></ul></li><li>中间的两层 NAT 网关均形成 NAT 穿越记录，<strong>穿越完成</strong>。</li><li>现在 A 尝试请求 B 的公网地址 <code>B_public_ip:B_public_port</code>，由于 B 的 NAT 已有记录，流量顺利通过 NAT 到达程序 B</li><li>B 发送给 A 的数据也同样，可以顺利到达 A</li></ul><p>上述流程中的关键点在于，如何查出内网服务器被 NAT 分配的外部 IP 及端口，只要有了这两个信息，就可以通过 STUN 中介服务器交换这个信息，然后完成连接的建立了。家庭服务器通常都只有一个公网 IP，所以基本可以认为 IP 是固定的，因此最关键的问题就是「<strong>如何知道 NAT 为会话分配的端口地址</strong>」。</p><p>对端口的限制严格程度跟 NAPT 的类型有关，<strong>Full-cone 跟 Restricted cone 对端口都没有任何限制，所以上述流程肯定可以成功</strong>；</p><p>TBD</p><p>一个穿越 Symmetric NATs 的 STUN 草案：<a href=https://tools.ietf.org/id/draft-takeda-symmetric-nat-traversal-00.txt target=_blank rel="noopener noreferrer">Symmetric NAT Traversal using STUN</a></p><p>在使用 STUN/TURN 进行 NAT 穿越时，支持的的 NAT 类型如下表。行与列分别代表双方的 NAT 类型，✅ 表示支持 UDP 穿越，❌ 表示 TURN 无法进行 UDP 穿越：</p><div class=table-wrapper><table><thead><tr><th style=text-align:>NAT 类型</th><th style=text-align:>Full Cone</th><th style=text-align:>Restricted</th><th style=text-align:>Port-Restricted</th><th style=text-align:>Symmetric</th></tr></thead><tbody><tr><td style=text-align:>Full Cone</td><td style=text-align:>✅</td><td style=text-align:>✅</td><td style=text-align:>✅</td><td style=text-align:>✅</td></tr><tr><td style=text-align:>Restricted</td><td style=text-align:>✅</td><td style=text-align:>✅</td><td style=text-align:>✅</td><td style=text-align:>✅</td></tr><tr><td style=text-align:>Port-Restricted</td><td style=text-align:>✅</td><td style=text-align:>✅</td><td style=text-align:>✅</td><td style=text-align:>❌</td></tr><tr><td style=text-align:>Symmetric</td><td style=text-align:>✅</td><td style=text-align:>✅</td><td style=text-align:>❌</td><td style=text-align:>❌</td></tr></tbody></table></div><p>这种场景下 TURN 协议给出的解决方案是，fallback 到中继服务器策略作为兜底方案，保证连接能成功，但是这会给中继服务器带来很大压力，延迟等参数将不可避免地变差。</p><h5 id=3-a-与-b-之间隔着三层以上的-nat class=headerLink><a href=#3-a-%e4%b8%8e-b-%e4%b9%8b%e9%97%b4%e9%9a%94%e7%9d%80%e4%b8%89%e5%b1%82%e4%bb%a5%e4%b8%8a%e7%9a%84-nat class=header-mark></a>3. A 与 B 之间隔着三层以上的 NAT</h5><p>这种情况较为常见的有：</p><ul><li>ISP 为了节约使用公网 IP，给用户分配了个广域网 IP，中间就多了个广域网 NAT</li><li>大城市的各种租房公寓通常只会从 ISP 购买一两根宽带，二次分销给整栋楼的租客共用，这就造成中间多了一层公寓的 NAT</li></ul><p>这是最复杂的一种情况，基本上就没什么 NAT 穿透的希望了，只能走下面介绍的兜底策略——服务器中继。</p><p>TBD 待续</p><h5 id=4-特殊穿越方案---服务器中继 class=headerLink><a href=#4-%e7%89%b9%e6%ae%8a%e7%a9%bf%e8%b6%8a%e6%96%b9%e6%a1%88---%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%ad%e7%bb%a7 class=header-mark></a>4. 特殊穿越方案 - 服务器中继</h5><p>Relay 服务器中继是兼容性最佳，但是性能最差的方案，因为这个方案下，所有的 P2P 连接都需要经过中继服务器转发，在使用人数众多时这会给中继服务器造成很大的压力。</p><p>因此这个方案通常是用于兜底的。</p><h3 id=特定协议的自穿越技术 class=headerLink><a href=#%e7%89%b9%e5%ae%9a%e5%8d%8f%e8%ae%ae%e7%9a%84%e8%87%aa%e7%a9%bf%e8%b6%8a%e6%8a%80%e6%9c%af class=header-mark></a>特定协议的自穿越技术</h3><p>在所有方法中最复杂也最可靠的就是自己解决自己的问题。比如 IKE 和 IPsec 技术，在设计时就考虑了到如何穿越 NAT 的问题。因为这个协议是一个自加密的协议并且具有报文防修改的鉴别能力，其他通用方法爱莫能助。因为实际应用的 NAT 网关基本都是 NAPT 方式，所有通过传输层协议承载的报文可以顺利通过 NAT。IKE 和 IPsec 采用的方案就是用 UDP 在报文外面再加一层封装，而内部的报文就不再受到影响。IKE 中还专门增加了 NAT 网关是否存在的检查能力以及绕开 NAT 网关检测 IKE 协议的方法。</p><h3 id=nat-algapplication-level-gateway class=headerLink><a href=#nat-algapplication-level-gateway class=header-mark></a>NAT ALG(Application Level Gateway)</h3><p>NAT ALG 是一种解决应用层协议（例如DNS、FTP）报文穿越 NAT 的技术，已经被 NAT 设备产商广泛采用，是 NAT 设备的必备功能。</p><p>TLDR 一句话介绍：NAT ALG 通过识别协议，直接修改报文数据部分（payload）的 IP 地址和端口信息，解决某些应用协议的报文穿越 NAT 问题。NAT ALG 工作在 L3-L7 层。</p><p>NAT ALG 的原理是利用带有 ALG 功能的 NAT 设备对特定应用层协议的支持，当设备检测到新的连接请求时，先根据传输层端口信息判断是否为已知应用类型。如果判断为已知应用，则调用该应用协议的
ALG 功能对报文的深层内容进行检查。若发现任何形式表达的 IP 地址和端口信息，NAT 都会将这些信息同步进行转换，并为这个新的连接建立一个附加的转换表项。当报文到达外网侧的目的主机时，应用层协议中携带的信息就是 NAT 设备转换后的IP地址和端口号，这样，就可以解决某些应用协议的报文穿越 NAT 问题。</p><p>目前支持NAT ALG功能的协议包括：DNS、FTP、SIP、PPTP和RTSP。NAT ALG 在对这些特定应用层协议进行 NAT 转换时，通过 NAT 的状态信息来改变封装在 IP 报文数据部分的特定数据，最终使应用层协议可以跨越不同范围运行。</p><h2 id=使用-go-实验-nat-穿透 class=headerLink><a href=#%e4%bd%bf%e7%94%a8-go-%e5%ae%9e%e9%aa%8c-nat-%e7%a9%bf%e9%80%8f class=header-mark></a>使用 Go 实验 NAT 穿透</h2><p>Go 可用的 NAT 穿越库有：</p><ul><li><a href=https://github.com/coturn/coturn target=_blank rel="noopener noreferrer">coturn</a>: 貌似是最流行的 STUN/TURN/ICE server</li><li><a href=https://github.com/ccding/go-stun target=_blank rel="noopener noreferrer">go-stun</a>: 一个简洁的 stun client 实现，大概适合用于学习？</li><li><a href=https://github.com/pion/turn target=_blank rel="noopener noreferrer">pion/turn</a>: 一个 STUN/TURN/ICE client/client 实现</li><li><a href=https://github.com/pion/ice target=_blank rel="noopener noreferrer">pion/ice</a>: 一个 ice 实现</li></ul><p>TBD 待完善</p><h2 id=虚拟网络overlay-与-underlay class=headerLink><a href=#%e8%99%9a%e6%8b%9f%e7%bd%91%e7%bb%9coverlay-%e4%b8%8e-underlay class=header-mark></a>虚拟网络、Overlay 与 Underlay</h2><p>虚拟网络就是在物理网络之上，构建的逻辑网络，也被称作 overlay 网络。比如 AWS VPC、Docker 容器网络、QEMU 的默认网络，都是虚拟网络。</p><p>而 underlay 网络，则是指承载 overlay 网络的底层网络。我个人理解，它是一个相对的概念，物理网络一定是 underlay 网络，但是虚拟网络之上如果还承载了其他虚拟网络（套娃），那它相对上层网络而言，也是一个 underlay 网络。</p><p>overlay 本质上就是一种隧道技术，将原生态的二层数据帧报文进行封装后通过隧道进行传输。常见的
overlay 网络协议主要是 vxlan 以及新一代的 geneve，它俩都是使用 UDP 包来封装链路层的以太网帧。</p><p>vxlan 在 2014 年标准化，而 geneve 在 2020 年底才通过草案阶段，目前尚未形成最终标准。但是目前 linux/cilium 都已经支持了 geneve.</p><p>geneve 相对 vxlan 最大的变化，是它更灵活——它的 header 长度是可变的。</p><p>目前所有 overlay 的跨主机容器网络方案，几乎都是基于 vxlan 实现的（例外：cilium 也支持
geneve）。</p><p>vxlan/geneve 的详细介绍，参见<a href=https://thiscute.world/posts/linux-virtual-network-interfaces/#vxlan-geneve target=_blank rel="noopener noreferrer">Linux 中的虚拟网络接口 - vxlan/geneve</a></p><p>顺带再提一嘴，cilium/calico/kube-ovn 等 overlay 容器网络，都是 SDN 软件定义网络。</p><h3 id=相关工具 class=headerLink><a href=#%e7%9b%b8%e5%85%b3%e5%b7%a5%e5%85%b7 class=header-mark></a>相关工具</h3><p>有一些专门用于跨网搭建私有虚拟网络的工具，由于家庭网络设备前面通常都有至少一层 NAT（家庭路由器），因此这些工具都重度依赖 NAT 穿越技术。如果 NAT 层数太多无法穿越，它们会 fallback 到代理模式，也就是由一台公网服务器进行流量中继，但是这会对中继服务器造成很大压力，延迟跟带宽通常都会差很多。</p><p>如下是两个比较流行的 VPN 搭建工具：</p><ul><li><a href=https://github.com/zerotier/ZeroTierOne target=_blank rel="noopener noreferrer">zerotier</a>: 在 P2P 网络之上搭建的 SDN overlay
网络，使用自定义协议。</li><li><a href=https://github.com/tailscale/tailscale target=_blank rel="noopener noreferrer">tailscales</a>: 基于 wireguard 协议快速搭建私有虚拟网络 VPN</li></ul><h3 id=vpn-协议 class=headerLink><a href=#vpn-%e5%8d%8f%e8%ae%ae class=header-mark></a>VPN 协议</h3><p>主流的 VPN 协议有：PPTP、L2TP、IPSec、OpenVPN、SSTP，以及最新潮的 Wireguard.</p><p>TBD</p><h2 id=拓展知识 class=headerLink><a href=#%e6%8b%93%e5%b1%95%e7%9f%a5%e8%af%86 class=header-mark></a>拓展知识</h2><h3 id=symmetric-nat-允许的最大并发-tcp-连接数是多少 class=headerLink><a href=#symmetric-nat-%e5%85%81%e8%ae%b8%e7%9a%84%e6%9c%80%e5%a4%a7%e5%b9%b6%e5%8f%91-tcp-%e8%bf%9e%e6%8e%a5%e6%95%b0%e6%98%af%e5%a4%9a%e5%b0%91 class=header-mark></a>Symmetric NAT 允许的最大并发 TCP 连接数是多少？</h3><p>TCP 并发连接数受许多参数的限制，以 Linux 服务器为例，默认参数无法满足需要，通常都会手动修改它的参数，放宽文件描述符限制以及 TCP 连接队列、缓存相关的限制。</p><p>单纯从网络协议层面分析，对于一个仅有一个公网 IP 的 Symmetric NAT 网关，它与某个外部站点<code>http://x.x.x.x:xx</code> 要建立连接。考虑到 TCP 连接的定义实际上是一个四元组<code>(srcIP, srcPort, dstIP, dstPort)</code>，其中就只有 NAT 网关自己的 <code>srcPort</code> 是唯一的变量了，而端口号是一个 16bits 数字，取值范围为 0 - 65535。此外低于 1024 的数字是操作系统的保留端口，
因此 NAT 一般只会使用 1024-65535 这个区间的端口号，也就是说这个 NAT 网关最多只能与该站点建立 64512 个连接。</p><p>那么对于不同的协议 NAT 是如何处理的呢？NAT 肯定可以通过协议特征区分不同协议的流量，因此不同协议通过 NAT 建立的并发连接不会相互影响。</p><p>对于家庭网络而言 64512 个连接已经完全够用了，但是对于数据中心或者云上的 VPC 而言，就不一定够用了。举个例子，在<a href=https://docs.aws.amazon.com/vpc/latest/userguide/vpc-nat-gateway.html target=_blank rel="noopener noreferrer">AWS NAT 网关的文档</a>中就有提到，AWS NAT 网关最高支持与每个不同的地址建立 55000 个并发连接。destination 的 IP 地址、端口号、(TCP/UDP/ICMP) 任一个发生改变，都可以再建立其他 55000 个并发连接。如果超过这个限制，就会发生「ErrorPortAllocation」错误。如果在 AWS 上遇到这个错误，那就说明你们的云上网络规划有问题了。</p><p>当然除了端口限制外，受限于 NAT 硬件、以太网协议以及其他影响，NAT 网关肯定还有包处理速率、带宽的限制，这个就略过不提了。</p><h3 id=aws-vpc-与-nat class=headerLink><a href=#aws-vpc-%e4%b8%8e-nat class=header-mark></a>AWS VPC 与 NAT</h3><p>AWS VPC(virtual private cloud) 是一个逻辑隔离的虚拟私有网络，云服务架构的最佳实践之一就是通过 VPC 搭建云上私有网络，提升网络安全性。</p><p>AWS VPC 提供两种网关类型：</p><ul><li><a href=https://docs.aws.amazon.com/zh_cn/vpc/latest/userguide/vpc-nat-gateway.html target=_blank rel="noopener noreferrer">NAT 网关</a><ul><li>支持三种协议：TCP, UDP, ICMP</li><li>支持 IPv4 与 IPv6 两种 IP 协议</li><li>支持 5 Gbps 带宽，可自动扩展到 45 Gbps<ul><li>可通过划分子网并在多个子网中添加 NAT 网关的方式，获得超过 45Gbps 的带宽</li></ul></li><li>最高支持与每个不同的地址建立 55000 个并发连接</li><li>NAT 网关从属于 VPC 的子网</li><li>每个 NAT 网关只能绑定一个 IP<ul><li>可通过划分子网并在多个子网中添加 NAT 网关的方式获得多个 IP</li></ul></li><li>可达到 100w packets 每秒的处理速度，并能自动扩展到 400w packets 每秒<ul><li>同样，需要更高的处理速度，请添加更多 NAT 网关</li></ul></li><li>按处理数据量收费</li><li>默认路由到 NAT 子网，被称为「私有子网」（或者没默认路由，那就是无法访问公网的私有子网），连接只能由内网程序主动发起。</li><li>NAT 网关为流量执行「<strong>Symmetric NAT</strong>」</li></ul></li><li><a href=https://docs.aws.amazon.com/zh_cn/vpc/latest/userguide/VPC_Internet_Gateway.html target=_blank rel="noopener noreferrer">IGW 因特网网关</a><ul><li>IGW 是一个高度可用的逻辑组件，不会限制 VPC 的总带宽、处理能力。</li><li>IGW 实例直接关联 VPC，不从属于任何可用区或子网</li><li>IGW 实质上是一个 NAT 设备，为绑定了公网 IP 地址的 ENI/EC2 实例，执行「<strong>一对一 NAT</strong>」</li><li>默认路由到 IGW 的子网，被称为「公有子网」</li></ul></li></ul><h2 id=参考 class=headerLink><a href=#%e5%8f%82%e8%80%83 class=header-mark></a>参考</h2><ul><li><a href=https://info.support.huawei.com/info-finder/encyclopedia/en/NAT.html target=_blank rel="noopener noreferrer">What Is Network Address Translation (NAT)? - Huawei Docs</a></li><li><a href=https://info.support.huawei.com/info-finder/encyclopedia/en/STUN.html target=_blank rel="noopener noreferrer">What Is STUN? - Huawei Docs</a></li><li><a href=https://support.huawei.com/enterprise/zh/doc/EDOC1100112409/fd829977#ZH-CN_CONCEPT_0227014768 target=_blank rel="noopener noreferrer">NetEngine AR V300R019 配置指南-IP业务 - NAT 穿越 - 华为文档</a></li><li><a href=http://www.52im.net/thread-50-1-1.html target=_blank rel="noopener noreferrer">P2P技术详解(一)：NAT详解——详细原理、P2P简介</a></li><li><a href=http://www.52im.net/thread-542-1-1.html target=_blank rel="noopener noreferrer">P2P技术详解(二)：P2P中的NAT穿越(打洞)方案详解</a></li><li><a href=http://www.52im.net/thread-2872-1-1.html target=_blank rel="noopener noreferrer">P2P技术详解(三)：P2P中的NAT穿越(打洞)方案详解(进阶分析篇)</a></li><li><a href=https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Internet_Gateway.html target=_blank rel="noopener noreferrer">Connect to the internet using an internet gateway - AWS VPC Internet Gateway</a></li><li><a href=https://blog.chionlab.moe/2018/02/09/full-cone-nat-with-linux/ target=_blank rel="noopener noreferrer">从DNAT到netfilter内核子系统，浅谈Linux的Full Cone NAT实现</a></li><li><a href=https://en.wikipedia.org/wiki/Network_address_translation target=_blank rel="noopener noreferrer">Network address translation - wikipedia</a></li><li><a href=https://www.liveswitch.io/blog/webrtc-nat-traversal-methods-a-case-for-embedded-turn target=_blank rel="noopener noreferrer">WebRTC NAT Traversal Methods: A Case for Embedded TURN</a></li><li><a href=https://icloudnative.io/posts/wireguard-endpoint-discovery-nat-traversal/ target=_blank rel="noopener noreferrer">WireGuard 教程：使用 DNS-SD 进行 NAT-to-NAT 穿透 - 云原生实验室</a></li></ul></div><h2>相关内容</h2><div class=related-container><div class=related-item-container><div class=related-image><a href=/posts/wireguard-on-linux/><img src=/posts/wireguard-on-linux/wireguard.png height=200 width=400></a></div><h2 class=related-title><a href=/posts/wireguard-on-linux/>Linux 上的 WireGuard 网络分析（一）</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/iptables-and-container-networks/><img src=/posts/iptables-and-container-networks/docker-turtles-networking.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/iptables-and-container-networks/>iptables 及 docker 容器网络分析</a></h2></div><div class=related-item-container><div class=related-image><a href=/posts/linux-virtual-network-interfaces/><img src=/posts/linux-virtual-network-interfaces/linux-network.webp height=200 width=400></a></div><h2 class=related-title><a href=/posts/linux-virtual-network-interfaces/>Linux 中的虚拟网络接口</a></h2></div></div><div class="sponsor print:tw-hidden"><div class=sponsor-avatar><img src=/avatar/myself.webp></div><p class=sponsor-bio><em>如果你觉得这篇文章对你有所帮助，欢迎评论、分享、打赏~</em></p><a href=https://afdian.com/a/ryan4yin title=Sponsor target=_blank class=sponsor-button rel="noopener noreferrer"><span style=color:#ec6cb9><svg class="icon" viewBox="0 0 512 512"><path d="M458.4 64.3C400.6 15.7 311.3 23 256 79.3 200.7 23 111.4 15.6 53.6 64.3-21.6 127.6-10.6 230.8 43 285.5l175.4 178.7c10 10.2 23.4 15.9 37.6 15.9 14.3.0 27.6-5.6 37.6-15.8L469 285.6c53.5-54.7 64.7-157.9-10.6-221.3zm-23.6 187.5L259.4 430.5c-2.4 2.4-4.4 2.4-6.8.0L77.2 251.8c-36.5-37.2-43.9-107.6 7.3-150.7 38.9-32.7 98.9-27.8 136.5 10.5l35 35.7 35-35.7c37.8-38.5 97.8-43.2 136.5-10.6 51.1 43.1 43.5 113.9 7.3 150.8z"/></svg></span>
<span>赞赏</span></a></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-05-13</span></div><div class=post-info-license></div></div><div class="post-info-line print:!tw-hidden"><div class=post-info-md></div><div class=post-info-share><button title="分享到 Twitter" data-sharer=twitter data-url=https://thiscute.world/posts/about-nat/ data-title="NAT 网关、NAT 穿越以及虚拟网络" data-via=ryan4yin data-hashtags="NAT,网络,NAT 穿越,内网穿透,虚拟网络,P2P,WebRTC"><svg class="icon" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></button><button title="分享到 Hacker News" data-sharer=hackernews data-url=https://thiscute.world/posts/about-nat/ data-title="NAT 网关、NAT 穿越以及虚拟网络"><svg class="icon" viewBox="0 0 448 512"><path d="M0 32v448h448V32H0zm21.2 197.2H21c.1-.1.2-.3.3-.4.0.1.0.3-.1.4zm218 53.9V384h-31.4V281.3L128 128h37.3c52.5 98.3 49.2 101.2 59.3 125.6 12.3-27 5.8-24.4 60.6-125.6H320l-80.8 155.1z"/></svg></button><button title="分享到 Reddit" data-sharer=reddit data-url=https://thiscute.world/posts/about-nat/><svg class="icon" viewBox="0 0 512 512"><path d="M201.5 305.5c-13.8.0-24.9-11.1-24.9-24.6.0-13.8 11.1-24.9 24.9-24.9 13.6.0 24.6 11.1 24.6 24.9.0 13.6-11.1 24.6-24.6 24.6zM504 256c0 137-111 248-248 248S8 393 8 256 119 8 256 8s248 111 248 248zm-132.3-41.2c-9.4.0-17.7 3.9-23.8 10-22.4-15.5-52.6-25.5-86.1-26.6l17.4-78.3 55.4 12.5c0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.3 24.9-24.9s-11.1-24.9-24.9-24.9c-9.7.0-18 5.8-22.1 13.8l-61.2-13.6c-3-.8-6.1 1.4-6.9 4.4l-19.1 86.4c-33.2 1.4-63.1 11.3-85.5 26.8-6.1-6.4-14.7-10.2-24.1-10.2-34.9.0-46.3 46.9-14.4 62.8-1.1 5-1.7 10.2-1.7 15.5.0 52.6 59.2 95.2 132 95.2 73.1.0 132.3-42.6 132.3-95.2.0-5.3-.6-10.8-1.9-15.8 31.3-16 19.8-62.5-14.9-62.5zM302.8 331c-18.2 18.2-76.1 17.9-93.6.0-2.2-2.2-6.1-2.2-8.3.0-2.5 2.5-2.5 6.4.0 8.6 22.8 22.8 87.3 22.8 110.2.0 2.5-2.2 2.5-6.1.0-8.6-2.2-2.2-6.1-2.2-8.3.0zm7.7-75c-13.6.0-24.6 11.1-24.6 24.9.0 13.6 11.1 24.6 24.6 24.6 13.8.0 24.9-11.1 24.9-24.6.0-13.8-11-24.9-24.9-24.9z"/></svg></button><script>function shareOnMastodon(e,t){const o="share_mastodon_domain",i=localStorage.getItem(o)??"mastodon.social",n=prompt("Enter your Mastodon domain",i);if(n===null)return;localStorage.setItem(o,n);const a=e+`

`+t,s=new URL("https://"+n);s.pathname="share",s.searchParams.append("text",a),window.open(s,"_blank","width=500,height=500,left=500,toolbar=0,status=0")}</script>
<button title="分享到 Mastodon" onclick='shareOnMastodon("NAT 网关、NAT 穿越以及虚拟网络","https://thiscute.world/posts/about-nat/")'><svg class="icon" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></button></div></div></div><div class=post-info-more><section class=post-tags><svg class="icon" viewBox="0 0 640 512"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg>&nbsp;<a href=/tags/nat/>NAT</a>,&nbsp;<a href=/tags/%E7%BD%91%E7%BB%9C/>网络</a>,&nbsp;<a href></a>,&nbsp;<a href=/tags/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F/>内网穿透</a>,&nbsp;<a href=/tags/%E8%99%9A%E6%8B%9F%E7%BD%91%E7%BB%9C/>虚拟网络</a>,&nbsp;<a href=/tags/p2p/>P2P</a>,&nbsp;<a href=/tags/webrtc/>WebRTC</a></section><section class=print:!tw-hidden><span><button class="tw-text-fgColor-link-muted hover:tw-text-fgColor-link-muted-hover" onclick=window.history.back()>返回</button></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class="post-nav print:tw-hidden"><a href=/posts/finops-for-kubernetes/ class=prev rel=prev title="FinOps for Kubernetes - 如何拆分 Kubernetes 成本"><svg class="icon" viewBox="0 0 256 512"><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9.0l22.6 22.6c9.4 9.4 9.4 24.6.0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6.0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9.0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>FinOps for Kubernetes - 如何拆分 Kubernetes 成本</a>
<a href=/posts/death-is-but-a-dream/ class=next rel=next title="Death Is But a Dream">Death Is But a Dream<svg class="icon" viewBox="0 0 256 512"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9.0l-22.6-22.6c-9.4-9.4-9.4-24.6.0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6.0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9.0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></a></div></div><div id=comments class="print:!tw-hidden tw-pt-32 tw-pb-8"><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><a href=https://www.foreverblog.cn/ target=_blank><img src=https://foreverblog.cn/assets/logo/logo_en_default.png alt style=width:auto;height:16px></a></div><div class=footer-line>由 <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.150.0">Hugo</a> 强力驱动&nbsp;|&nbsp;托管在 <a title=Vercel href=https://vercel.com/ target=_blank rel="noopener noreffer">Vercel</a> 上&nbsp;|&nbsp;主题 - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.4.0"><svg class="icon" viewBox="0 0 576 512"><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1.0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7.0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174 402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7-43.2-43.2c-4.1-4.1-10.8-4.1-14.8.0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg> DoIt</a></div><div class=footer-line><svg class="icon" viewBox="0 0 512 512"><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532.0-2e2-89.451-2e2-2e2.0-110.531 89.451-2e2 2e2-2e2 110.532.0 2e2 89.451 2e2 2e2.0 110.532-89.451 2e2-2e2 2e2zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43.0-140.484-61.425-140.484-141.567.0-79.152 60.275-139.401 139.762-139.401 55.531.0 88.738 26.62 97.593 34.779a11.965 11.965.0 011.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303.0-77.916 35.33-77.916 80.082.0 41.589 26.888 83.692 78.277 83.692 32.657.0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947.0 01-1.152 15.518z"/></svg>2021 - 2025<span class=author>&nbsp;<a href=/ target=_blank rel="noopener noreferrer"></a></span>&nbsp;|&nbsp;<span class=license> <a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons class=print:!tw-hidden><a href=#back-to-top id=back-to-top-button class="fixed-button tw-transition-opacity tw-opacity-0" title=回到顶部><svg class="icon" viewBox="0 0 448 512"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg>
</a><a href=#comments id=view-comments class=fixed-button title=查看评论><svg class="icon" viewBox="0 0 512 512"><path d="M256 32C114.6 32 0 125.1.0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3.0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4.0 256-93.1 256-208S397.4 32 256 32z"/></svg></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/katex/copy-tex.min.css><noscript><link rel=stylesheet href=/lib/katex/copy-tex.min.css></noscript><script>window.config={"algoliasearch.min.js":"/lib/algoliasearch/algoliasearch-lite.umd.min.js","autocomplete.min.js":"/lib/autocomplete/autocomplete.min.js",comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"",lightTheme:"github-light",repo:"ryan4yin/thiscute.world"}},data:{"desktop-header-typeit":"This Cute World","mobile-header-typeit":"This Cute World"},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{algoliaAppID:"747LJ10EI7",algoliaIndex:"ryan-space",algoliaSearchKey:"658db5f2bf056f83458cacf5dd58ec80",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},sharerjs:!0,typeit:{cursorChar:null,cursorSpeed:null,data:{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},duration:null,speed:null}}</script><script src=/lib/sharer/sharer.min.js></script><script src=/lib/typeit/typeit.min.js></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/js/katex.min.js defer></script><script src=/js/theme.min.js defer></script><script src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4V93QVSNFW",{anonymize_ip:!0})</script><script src="https://www.googletagmanager.com/gtag/js?id=G-4V93QVSNFW" async></script><script type=speculationrules>
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script></body></html>